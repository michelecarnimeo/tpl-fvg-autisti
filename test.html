<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TPL FVG - Test Funzionalit√†</title>
    <link rel="stylesheet" href="style1.css">
    <!-- Animazioni e transizioni globali -->
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/components/footer.css">
    <link rel="stylesheet" href="css/components/modals.css">
    <!-- Test Modules (sticky headers, groups, animations) -->
    <link rel="stylesheet" href="css/components/tests/header.css">
    <link rel="stylesheet" href="css/components/tests/groups.css">
    <link rel="stylesheet" href="css/components/tests/test-animations.css">
    <!-- Test Modules (base styles, status, effects) -->
    <link rel="stylesheet" href="css/components/tests/test-base.css">
    <link rel="stylesheet" href="css/components/tests/test-status.css">
    <link rel="stylesheet" href="css/components/tests/test-effects.css">
    <!-- Test Page Specific (settings dropdown, distance, leaflet) -->
    <link rel="stylesheet" href="css/components/tests/test-page-specific.css">
    <!-- Test Device Info (device info cards) -->
    <link rel="stylesheet" href="css/components/tests/test-device-info.css">
    <!-- Test Prezzi Adaptive (tipografia adattiva) -->
    <link rel="stylesheet" href="css/components/tests/test-prezzi-adaptive.css">
    <!-- TOC Sidebar (indice rapido desktop) -->
    <link rel="stylesheet" href="css/components/tests/toc-sidebar.css">
    <!-- Settings (struttura modale) -->
    <link rel="stylesheet" href="css/components/settings/impostazioni.css">
    <link rel="stylesheet" href="css/components/settings/accessibilita.css">
    <link rel="stylesheet" href="css/components/settings/aspetto.css">
    <link rel="stylesheet" href="css/components/settings/info.css">
    <link rel="icon" href="src/tpl.jpg" type="image/jpeg">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body class="bg-background-light text-foreground-light">

    <!-- Navbar -->
    <header class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="navbar-brand-link">
                    <div class="navbar-brand">
                        <div class="navbar-logo-wrapper">
                            <img src="src/logo.png" alt="TPL" class="navbar-logo navbar-logo-default" />
                            <img src="src/logo1.png" alt="TPL" class="navbar-logo navbar-logo-hover" />
                        </div>
                        <div class="navbar-title">
                            <div class="logo-acronym">
                                <div>tpl</div>
                                <div>fvg</div>
                            </div>
                            <div class="logo-text">
                                <div>trasporto</div>
                                <div>pubblico</div>
                                <div>locale</div>
                            </div>
                        </div>
                    </div>
                </a>
                <!-- Hamburger button (mobile only) -->
                <button id="hamburger-toggle" class="hamburger-toggle" aria-label="Menu">
                    <span class="hamburger-icon"></span>
                </button>

                <nav class="navbar-nav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="fermate.html" class="nav-link">Fermate</a>
                    <a href="prezzi.html" class="nav-link">Prezzi</a>
                    <a href="test.html" class="nav-link active">Test</a>

                    <!-- Mega Dropdown Impostazioni (Opzione C) -->
                    <div class="settings-dropdown-container">
                        <button id="test-settings-dropdown-btn" class="nav-settings-dropdown-btn" title="Impostazioni">
                            <span class="settings-icon">‚öôÔ∏è</span>
                            <span class="settings-text">Impostazioni</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>

                        <div id="test-settings-dropdown" class="settings-mega-dropdown">
                            <!-- Sezione Aspetto -->
                            <div class="dropdown-section">
                                <h4 class="dropdown-section-title">üëÅÔ∏è Aspetto</h4>

                                <div class="dropdown-item">
                                    <span class="dropdown-label">üåì Tema</span>
                                    <div class="dropdown-theme-options">
                                        <label class="theme-radio">
                                            <input type="radio" name="test-theme" value="system" checked>
                                            <span>‚öôÔ∏è Sistema</span>
                                        </label>
                                        <label class="theme-radio">
                                            <input type="radio" name="test-theme" value="light">
                                            <span>‚òÄÔ∏è Chiaro</span>
                                        </label>
                                        <label class="theme-radio">
                                            <input type="radio" name="test-theme" value="dark">
                                            <span>üåô Scuro</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="dropdown-item">
                                    <label class="dropdown-label" for="test-animation-toggle">üé¨ Animazione
                                        Sfondo</label>
                                    <label class="dropdown-toggle">
                                        <input type="checkbox" id="test-animation-toggle"
                                            aria-label="Attiva/disattiva animazione sfondo">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Sezione Accessibilit√† -->
                            <div class="dropdown-section">
                                <h4 class="dropdown-section-title">‚ôø Accessibilit√†</h4>

                                <div class="dropdown-item">
                                    <span class="dropdown-label">A Dimensione Testo</span>
                                    <div class="dropdown-font-buttons">
                                        <button class="dropdown-font-btn active" data-size="normal">A</button>
                                        <button class="dropdown-font-btn" data-size="large">A</button>
                                        <button class="dropdown-font-btn" data-size="xlarge">A</button>
                                    </div>
                                </div>

                                <div class="dropdown-item">
                                    <label class="dropdown-label" for="test-high-contrast">üé® Alto Contrasto</label>
                                    <label class="dropdown-toggle">
                                        <input type="checkbox" id="test-high-contrast"
                                            aria-label="Attiva/disattiva alto contrasto">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Sezione Azioni Rapide -->
                            <div class="dropdown-section">
                                <h4 class="dropdown-section-title">‚ö° Azioni Rapide</h4>

                                <button class="dropdown-action-btn" id="test-open-settings-modal">
                                    <span>‚öôÔ∏è</span>
                                    <span>Apri Impostazioni Complete</span>
                                </button>

                                <button class="dropdown-action-btn" id="test-check-updates">
                                    <span>üîÑ</span>
                                    <span>Verifica Aggiornamenti</span>
                                </button>

                                <button class="dropdown-action-btn" id="test-clear-cache">
                                    <span>üóëÔ∏è</span>
                                    <span>Cancella Cache</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pulsanti legacy nascosti per compatibilit√† JS -->
                    <button id="darkmode-toggle" class="dark-mode-toggle" title="Darkmode" style="display: none;">
                        <span>üåô</span>
                    </button>
                    <button id="cache-reset" class="cache-reset-btn" title="Cancella cache e ricarica"
                        style="display: none;"><span>üóëÔ∏è</span></button>
                    <div class="font-size-group" style="display: none;">
                        <button id="font-size-small" class="font-size-btn" data-size="normal" title="Testo normale">
                            <span>A</span>
                        </button>
                        <button id="font-size-medium" class="font-size-btn" data-size="large" title="Testo grande">
                            <span>A</span>
                        </button>
                        <button id="font-size-large" class="font-size-btn" data-size="xlarge"
                            title="Testo molto grande">
                            <span>A</span>
                        </button>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="mobile-menu">
        <div class="mobile-menu-header">
            <span class="mobile-menu-title">Menu</span>
            <button id="mobile-menu-close" class="mobile-menu-close" aria-label="Chiudi menu">√ó</button>
        </div>
        <nav class="mobile-menu-nav">
            <a href="index.html" class="mobile-nav-link">
                <span class="mobile-nav-icon">üè†</span>
                <span>Home</span>
            </a>
            <a href="fermate.html" class="mobile-nav-link">
                <span class="mobile-nav-icon">üöè</span>
                <span>Fermate</span>
            </a>
            <a href="prezzi.html" class="mobile-nav-link">
                <span class="mobile-nav-icon">üí∞</span>
                <span>Prezzi</span>
            </a>
            <a href="test.html" class="mobile-nav-link active">
                <span class="mobile-nav-icon">üß™</span>
                <span>Test</span>
            </a>
            <button id="open-settings" class="mobile-nav-link">
                <span class="mobile-nav-icon">‚öôÔ∏è</span>
                <span>Impostazioni</span>
            </button>
        </nav>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="mobile-menu-overlay"></div>

    <!-- Sidebar Indice Rapido (Desktop) -->
    <aside id="toc-sidebar" class="toc-sidebar">
        <div class="toc-sidebar-header">
            <h3>üß≠ Indice</h3>
        </div>
        <nav class="toc-sidebar-nav">
            <a href="#section-stats" class="toc-sidebar-link" data-section="section-stats">
                <span class="toc-icon">üìä</span>
                <span class="toc-label">Statistiche</span>
            </a>
            <a href="#section-pwa" class="toc-sidebar-link" data-section="section-pwa">
                <span class="toc-icon">üì±</span>
                <span class="toc-label">Modalit√† PWA</span>
            </a>
            <a href="#section-quick-links" class="toc-sidebar-link" data-section="section-quick-links">
                <span class="toc-icon">üîó</span>
                <span class="toc-label">Link Rapidi</span>
            </a>
            <a href="#section-connectivity" class="toc-sidebar-link" data-section="section-connectivity">
                <span class="toc-icon">üåê</span>
                <span class="toc-label">Connettivit√†</span>
            </a>
            <a href="#section-device" class="toc-sidebar-link" data-section="section-device">
                <span class="toc-icon">üì±</span>
                <span class="toc-label">Device & Browser</span>
            </a>
            <a href="#section-geolocation" class="toc-sidebar-link" data-section="section-geolocation">
                <span class="toc-icon">üìç</span>
                <span class="toc-label">Geolocalizzazione</span>
            </a>
            <a href="#section-database" class="toc-sidebar-link toc-completed" data-section="section-database" data-color="blue">
                <span class="toc-icon">üì¶</span>
                <span class="toc-label">Database</span>
            </a>
            <a href="#section-darkmode" class="toc-sidebar-link" data-section="section-darkmode">
                <span class="toc-icon">üåô</span>
                <span class="toc-label">Dark Mode</span>
            </a>
            <a href="#section-storage" class="toc-sidebar-link toc-completed" data-section="section-storage" data-color="green">
                <span class="toc-icon">üíæ</span>
                <span class="toc-label">Storage Module</span>
            </a>
            <a href="#section-prezzi" class="toc-sidebar-link toc-completed" data-section="section-prezzi" data-color="yellow">
                <span class="toc-icon">üí∞</span>
                <span class="toc-label">Prezzi</span>
            </a>
            <a href="#section-route" class="toc-sidebar-link toc-completed" data-section="section-route" data-color="blue">
                <span class="toc-icon">üß≠</span>
                <span class="toc-label">Route Selector</span>
            </a>
            <a href="#section-settings" class="toc-sidebar-link toc-completed" data-section="section-settings" data-color="orange">
                <span class="toc-icon">‚öôÔ∏è</span>
                <span class="toc-label">Settings</span>
            </a>
            <a href="#section-sw" class="toc-sidebar-link" data-section="section-sw">
                <span class="toc-icon">‚öôÔ∏è</span>
                <span class="toc-label">Service Worker</span>
            </a>
            <a href="#section-ui" class="toc-sidebar-link" data-section="section-ui">
                <span class="toc-icon">üé®</span>
                <span class="toc-label">UI</span>
            </a>
            <a href="#section-manifest" class="toc-sidebar-link" data-section="section-manifest">
                <span class="toc-icon">üì±</span>
                <span class="toc-label">Manifest</span>
            </a>
            <a href="#section-performance" class="toc-sidebar-link" data-section="section-performance">
                <span class="toc-icon">‚ö°</span>
                <span class="toc-label">Performance</span>
            </a>
        </nav>
    </aside>

    <div class="test-container test-container-with-sidebar">

        <!-- Indice Rapido (Mobile) -->
        <div id="section-index" class="test-section">
            <h2>üß≠ Indice rapido</h2>
            <div class="toc-grid">
                <a href="#section-stats" class="toc-link" data-section="section-stats" data-label="üìä Statistiche">üìä
                    Statistiche</a>
                <a href="#section-pwa" class="toc-link" data-section="section-pwa" data-label="üì± Modalit√† PWA">üì±
                    Modalit√† PWA</a>
                <a href="#section-quick-links" class="toc-link" data-section="section-quick-links"
                    data-label="üîó Link Rapidi">üîó
                    Link Rapidi</a>
                <a href="#section-connectivity" class="toc-link" data-section="section-connectivity"
                    data-label="üåê Connettivit√†">üåê
                    Connettivit√†</a>
                <a href="#section-device" class="toc-link" data-section="section-device"
                    data-label="üì± Device & Browser">üì±
                    Device & Browser</a>
                <a href="#section-geolocation" class="toc-link" data-section="section-geolocation"
                    data-label="üìç Geolocalizzazione">üìç
                    Geolocalizzazione</a>
                <a href="#section-database" class="toc-link" data-section="section-database" data-label="üì¶ Database">üì¶
                    Database</a>
                <a href="#section-darkmode" class="toc-link" data-section="section-darkmode" data-label="üåô Dark Mode">üåô
                    Dark Mode</a>
                <a href="#section-storage" class="toc-link" data-section="section-storage" data-label="üíæ Storage Module">üíæ
                    Storage Module</a>
                <a href="#section-prezzi" class="toc-link" data-section="section-prezzi" data-label="üí∞ Prezzi">üí∞
                    Prezzi</a>
                <a href="#section-route" class="toc-link" data-section="section-route" data-label="üß≠ Route Selector">üß≠
                    Route Selector</a>
                <a href="#section-settings" class="toc-link" data-section="section-settings" data-label="‚öôÔ∏è Settings">‚öôÔ∏è
                    Settings</a>
                <a href="#section-sw" class="toc-link" data-section="section-sw" data-label="‚öôÔ∏è Service Worker">‚öôÔ∏è
                    Service Worker</a>
                <a href="#section-ui" class="toc-link" data-section="section-ui" data-label="üé® UI">üé®
                    UI</a>
                <a href="#section-manifest" class="toc-link" data-section="section-manifest" data-label="üì± Manifest">üì±
                    Manifest</a>
                <a href="#section-performance" class="toc-link" data-section="section-performance"
                    data-label="‚ö° Performance">‚ö°
                    Performance</a>
            </div>
            <script>
                // Smooth scroll per i link dell'indice
                document.addEventListener('DOMContentLoaded', () => {
                    const toc = document.getElementById('section-index');
                    if (!toc) return;

                    toc.querySelectorAll('a[href^="#"]').forEach(a => {
                        a.addEventListener('click', (e) => {
                            const target = document.querySelector(a.getAttribute('href'));
                            if (target) {
                                e.preventDefault();
                                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                try { history.replaceState(null, '', a.getAttribute('href')); } catch { }
                            }
                        });
                    });
                });
            </script>
        </div>

        <!-- Statistiche -->
        <div id="section-stats" class="test-section">
            <h2>üìä Statistiche Test</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="stat-total">0</div>
                    <div class="stat-label">Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-pass">0</div>
                    <div class="stat-label">Passati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-fail">0</div>
                    <div class="stat-label">Falliti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-pending">0</div>
                    <div class="stat-label">In attesa</div>
                </div>
            </div>
            <button class="run-all-btn" onclick="runAllTests()">‚ñ∂Ô∏è Esegui tutti i test</button>
        </div>

        <!-- Test Modalit√† PWA -->
        <div id="section-pwa" class="test-section">
            <h2>üì± Test Modalit√† PWA</h2>
            <div class="test-item">
                <div>
                    <strong>Simulazione Bottom Navigation</strong>
                    <br>
                    <small>Attiva/disattiva la bottom navigation senza installare la PWA</small>
                </div>
                <div>
                    <button id="toggle-pwa-mode" class="test-btn">
                        <span id="pwa-mode-icon">üì±</span>
                        <span id="pwa-mode-text">Attiva Modalit√† PWA</span>
                    </button>
                </div>
            </div>
            <div id="pwa-mode-status">
                <h4>Status Modalit√† PWA:</h4>
                <div id="pwa-mode-info"></div>
            </div>
        </div>

        <!-- Link Rapidi -->
        <div id="section-quick-links" class="test-section">
            <h2>üîó Link Rapidi</h2>
            <div class="test-item">
                <div>
                    <strong>Pagina Benvenuto</strong>
                    <br>
                    <small>Vai alla pagina di benvenuto dell'app</small>
                </div>
                <div>
                    <a href="benvenuto.html" class="test-btn">
                        <span>üëã</span>
                        <span>Vai a Benvenuto</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Test Connettivit√† -->
        <div id="section-connectivity" class="test-section">
            <h2>üåê Test Connettivit√†</h2>
            <div class="test-item">
                <div>
                    <strong>Simulazione Modalit√† Offline</strong>
                    <br>
                    <small>Simula la perdita di connessione per testare il banner offline</small>
                </div>
                <div>
                    <button id="toggle-offline-mode" class="test-btn">
                        <span id="offline-mode-icon">üì∂</span>
                        <span id="offline-mode-text">Simula Offline</span>
                    </button>
                </div>
            </div>
            <div id="offline-mode-status">
                <h4>Status Connettivit√†:</h4>
                <div id="offline-mode-info"></div>
            </div>
        </div>

        <!-- Info Device/Browser -->
        <div id="section-device" class="test-section">
            <h2>üì± Info Device & Browser</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">Informazioni sul dispositivo e ambiente di esecuzione per
                debug</p>

            <!-- Grid Cards (Desktop) / Lista Compatta (Mobile) -->
            <div id="device-info-container">
                <!-- Device Type -->
                <div class="device-info-card" data-color="purple">
                    <div class="device-info-icon">üì±</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Device Type</div>
                        <div id="device-type" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- OS -->
                <div class="device-info-card" data-color="pink">
                    <div class="device-info-icon">üíª</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Sistema Operativo</div>
                        <div id="device-os" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- Browser -->
                <div class="device-info-card" data-color="blue">
                    <div class="device-info-icon">üåê</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Browser</div>
                        <div id="device-browser" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- Battery -->
                <div class="device-info-card" data-color="orange">
                    <div class="device-info-icon">üîã</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Batteria</div>
                        <div id="device-battery" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- GPS Support -->
                <div class="device-info-card" data-color="amber">
                    <div class="device-info-icon">üõ∞Ô∏è</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Supporto GPS</div>
                        <div id="device-gps" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- Touch Support -->
                <div class="device-info-card" data-color="cyan">
                    <div class="device-info-icon">üëÜ</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Touch Support</div>
                        <div id="device-touch" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- PWA Mode -->
                <div class="device-info-card" data-color="indigo">
                    <div class="device-info-icon">üì≤</div>
                    <div class="device-info-content">
                        <div class="device-info-label">PWA Mode</div>
                        <div id="device-pwa" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- Stato Connessione -->
                <div class="device-info-card" data-color="green">
                    <div>
                        <div>
                            <div class="device-info-icon">
                                <span id="connection-status-icon">üü¢</span>
                            </div>
                            <div class="device-info-content">
                                <div class="device-info-label">Stato Connessione</div>
                                <div id="connection-status-text" class="device-info-value">Rilevamento...</div>
                                <div id="connection-test-date">-</div>
                            </div>
                        </div>
                        <div>
                            <button id="check-connection-btn" class="test-btn" title="Verifica stato connessione">
                                <span>üîÑ</span>
                                <span>Verifica</span>
                            </button>
                            <button id="reset-connection-btn" class="test-btn" title="Reset risultati" disabled>
                                <span>üóëÔ∏è</span>
                                <span>Reset</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Rilevamento Display -->
            <div>
                <h3>üñ•Ô∏è Rilevamento Display</h3>

                <div>

                    <!-- Card Tipo Display -->
                    <div class="display-info-card">
                        <div>
                            <div>üì±</div>
                            <div>
                                <div>Tipo Display</div>
                                <div id="test-display-type">Rilevamento...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Device Pixel Ratio -->
                    <div class="display-info-card">
                        <div>
                            <div>üîç</div>
                            <div>
                                <div>Device Pixel Ratio</div>
                                <div id="test-display-dpr">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Risoluzione Logica -->
                    <div class="display-info-card">
                        <div>
                            <div>üìê</div>
                            <div>
                                <div>Risoluzione Logica</div>
                                <div id="test-display-logical">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Risoluzione Fisica -->
                    <div class="display-info-card">
                        <div>
                            <div>üñºÔ∏è</div>
                            <div>
                                <div>Risoluzione Fisica</div>
                                <div id="test-display-physical">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card High DPI -->
                    <div class="display-info-card">
                        <div>
                            <div>‚ú®</div>
                            <div>
                                <div>High DPI</div>
                                <div id="test-display-highdpi">
                                    <span id="test-display-highdpi-badge">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Viewport -->
                    <div class="display-info-card">
                        <div>
                            <div>üìè</div>
                            <div>
                                <div>Viewport</div>
                                <div id="test-display-viewport">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <button id="test-display-refresh" class="test-btn">
                        <span>üîÑ</span>
                        <span>Aggiorna Rilevamento</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Geolocalizzazione -->
        <div id="section-geolocation" class="test-section">
            <h2>üìç Test Geolocalizzazione</h2>

            <!-- Test Rapido One-Click -->
            <div>
                <div>
                    <div>
                        <h3>‚ö° Test Rapido GPS</h3>
                        <p>Verifica automatica di tutte le funzioni GPS con un click</p>
                    </div>
                    <button id="quick-gps-test-btn">
                        <span id="quick-test-icon">üöÄ</span>
                        <span id="quick-test-text">Avvia Test</span>
                    </button>
                </div>

                <!-- Risultati Test Rapido (nascosto inizialmente) -->
                <div id="quick-test-results">
                    <h4>üìä Risultati Test</h4>
                    <div id="quick-test-items"></div>
                    <div id="quick-test-summary"></div>
                </div>

                <!-- Export Report -->
                <div>
                    <button id="export-json-btn">üìÑ Export JSON</button>
                    <button id="export-txt-btn">üìù Export TXT</button>
                </div>

                <!-- Reset Tutto -->
                <div>
                    <div>
                        <div>
                            <strong>üîÑ Reset Dati GPS</strong>
                            <p>Cancella tutti i dati GPS salvati (fake position, test, ecc.)</p>
                        </div>
                        <button id="reset-gps-btn">üóëÔ∏è Reset</button>
                    </div>
                </div>
            </div>

            <!-- Modal Conferma Reset -->
            <div id="reset-modal-overlay">
                <div>
                    <div id="reset-modal">
                        <!-- Header -->
                        <div>
                            <div>
                                <div>‚ö†Ô∏è</div>
                                <div>
                                    <h3>Conferma Reset</h3>
                                    <p>Questa azione √® irreversibile</p>
                                </div>
                            </div>
                        </div>

                        <!-- Body -->
                        <div>
                            <p>
                                Stai per <strong>cancellare tutti i dati GPS</strong> salvati localmente:
                            </p>

                            <ul>
                                <li>üé≠ Posizione fake simulata</li>
                                <li>üåê Dati simulazione offline</li>
                                <li>üìú Cronologia test GPS</li>
                                <li>üíæ Tutte le impostazioni salvate</li>
                            </ul>

                            <div>
                                <strong>üí° Nota:</strong>
                                <p>
                                    La pagina si ricaricher√† automaticamente dopo il reset.
                                </p>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div>
                            <button id="reset-modal-cancel">‚ùå Annulla</button>
                            <button id="reset-modal-confirm">üóëÔ∏è Conferma Reset</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Permessi -->
            <div id="geo-permission-status">
                <strong>üîê Status Permessi:</strong>
                <span id="geo-permission-text">Verifica in corso...</span>
            </div>

            <!-- Banner HTTPS Warning (solo se non HTTPS/localhost) -->
            <div id="https-warning-banner">
                <div>
                    <div>‚ö†Ô∏è</div>
                    <div>
                        <strong>Attenzione: Geolocalizzazione richiede HTTPS</strong>
                        <p>
                            La geolocalizzazione funziona solo su connessioni sicure (HTTPS) o localhost.
                            <br>
                            <strong>Soluzione:</strong> Assicurati di accedere al sito tramite <code>https://</code>
                        </p>
                    </div>
                </div>
            </div>

            <div class="test-item">
                <div>
                    <strong>Rilevamento Posizione GPS</strong>
                    <span>üü¢ OFFLINE OK</span>
                    <br>
                    <small>Testa il rilevamento della posizione attuale per verificare la funzionalit√† GPS</small>
                </div>
                <div>
                    <button id="test-location-btn" class="test-btn">
                        <span id="test-location-icon">üìç</span>
                        <span id="test-location-text">Rileva Posizione</span>
                    </button>
                </div>
            </div>
            <div id="test-location-result" class="test-result">
                <h4>Risultato Rilevamento:</h4>
                <div id="test-location-info"></div>
            </div>

            <!-- Simulazione Posizione Fake -->
            <div id="fake-position-section">
                <div>
                    <div>
                        <h4>
                            üé≠ Simulazione Posizione
                            <span>üü¢ OFFLINE OK</span>
                        </h4>
                        <p>Usa coordinate fake per test senza GPS reale</p>
                    </div>
                    <label>
                        <input type="checkbox" id="use-fake-position">
                        <span>Attiva</span>
                    </label>
                </div>

                <!-- Contenuto collassabile -->
                <div id="fake-position-content">
                    <!-- Warning -->
                    <div>
                        <strong>‚ö†Ô∏è Modalit√† Test Attiva</strong>
                        <p>
                            Stai usando coordinate simulate. Il GPS reale √® disabilitato.
                        </p>
                    </div>

                    <!-- Preset Citt√† -->
                    <div>
                        <strong>üèôÔ∏è Preset Citt√† FVG:</strong>
                        <div>
                            <button class="fake-position-preset" data-lat="45.6495" data-lng="13.7768"
                                data-name="Trieste">Trieste</button>
                            <button class="fake-position-preset" data-lat="46.0710" data-lng="13.2345"
                                data-name="Udine">Udine</button>
                            <button class="fake-position-preset" data-lat="45.9632" data-lng="12.6603"
                                data-name="Pordenone">Pordenone</button>
                            <button class="fake-position-preset" data-lat="45.9405" data-lng="13.6222"
                                data-name="Gorizia">Gorizia</button>
                        </div>
                    </div>

                    <!-- Input Manuale -->
                    <div>
                        <strong>üìç Coordinate Personalizzate:</strong>
                        <div>
                            <input type="number" id="fake-lat" placeholder="Latitudine" step="0.000001">
                            <input type="number" id="fake-lng" placeholder="Longitudine" step="0.000001">
                        </div>
                        <div>
                            <input type="number" id="fake-accuracy" placeholder="Accuratezza (metri)" value="10" min="1" max="10000">
                            <input type="number" id="fake-altitude" placeholder="Altitudine (metri)" value="0">
                        </div>
                        <div>
                            <input type="number" id="fake-speed" placeholder="Velocit√† (km/h) [opzionale]" min="0" max="300" step="0.1">
                            <input type="number" id="fake-heading" placeholder="Direzione (0-360¬∞) [opzionale]" min="0" max="360" step="1">
                        </div>
                    </div>

                    <!-- Pulsante Applica -->
                    <button id="apply-fake-position">üéØ Applica Posizione Fake</button>

                    <!-- Info Posizione Corrente -->
                    <div id="fake-position-info">
                        <strong>üìç Posizione Fake Attiva:</strong>
                        <div id="fake-position-details"></div>
                    </div>
                </div>
            </div>

            <!-- Watch Position - Monitoraggio Continuo -->
            <div id="watch-position-section">
                <div>
                    <div>
                        <h4>
                            üß≠ Monitoraggio Continuo
                            <span>üü¢ OFFLINE OK</span>
                        </h4>
                        <p>Traccia la posizione GPS in tempo reale mentre ti muovi</p>
                    </div>
                    <button id="toggle-watch-btn">‚ñ∂Ô∏è Avvia</button>
                </div>

                <!-- Status Card -->
                <div id="watch-status-card"
                    style="display: none; padding: 1rem; background: white; border-radius: 10px; border-left: 4px solid #3b82f6; margin-bottom: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <div style="flex: 1;">
                            <strong style="color: #1e40af; font-size: 1rem;">üì° Monitoraggio Attivo</strong>
                            <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.85rem;">Ricevi aggiornamenti
                                automatici ogni volta che ti muovi</p>
                        </div>
                        <div style="text-align: center;">
                            <div id="watch-count"
                                style="font-size: 2rem; font-weight: 700; color: #3b82f6; line-height: 1;">0</div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">aggiornamenti</div>
                        </div>
                    </div>

                    <!-- Ultima Posizione -->
                    <div id="watch-last-position"
                        style="padding: 0.75rem; background: #f8fafc; border-radius: 6px; font-size: 0.9rem;">
                        <strong style="color: #374151;">üìç Ultima Posizione:</strong>
                        <div id="watch-last-position-data" style="margin-top: 0.5rem; color: #666;">
                            In attesa primo aggiornamento...
                        </div>
                    </div>

                    <!-- Distanza Percorsa -->
                    <div id="watch-distance"
                        style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 6px;">
                        <strong style="color: #1e40af;">üìè Distanza Percorsa:</strong>
                        <div style="font-size: 1.25rem; font-weight: 600; color: #1e3a8a; margin-top: 0.25rem;">
                            <span id="watch-distance-value">0</span> metri
                        </div>
                    </div>
                </div>

                <!-- Cronologia Posizioni -->
                <div id="watch-history" style="display: none;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <strong style="color: #374151;">üìú Cronologia Posizioni (ultime 5)</strong>
                        <button id="clear-watch-history-btn"
                            style="padding: 0.375rem 0.75rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.3s;">
                            üóëÔ∏è Cancella
                        </button>
                    </div>
                    <div id="watch-history-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Calcolo Distanza -->
            <div id="distance-calculator"
                style="display: none; margin-top: 1rem; padding: 1.5rem; background: var(--grigio-chiaro); border-radius: 12px; border: 2px solid #f59e0b;">
                <h4 style="margin-top: 0; color: #92400e;">
                    üìè Calcolo Distanza
                    <span
                        style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üü¢
                        OFFLINE OK</span>
                </h4>
                <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">Calcola la distanza dalla tua posizione
                    attuale a un punto di riferimento</p>

                <!-- Preset Citt√† FVG -->
                <div style="margin-bottom: 1rem;">
                    <strong style="display: block; margin-bottom: 0.5rem; color: #374151;">üèôÔ∏è Citt√† Principali
                        FVG:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <button class="distance-preset-btn" data-lat="45.6495" data-lng="13.7768"
                            data-name="Trieste">Trieste</button>
                        <button class="distance-preset-btn" data-lat="46.0710" data-lng="13.2345"
                            data-name="Udine">Udine</button>
                        <button class="distance-preset-btn" data-lat="45.9632" data-lng="12.6603"
                            data-name="Pordenone">Pordenone</button>
                        <button class="distance-preset-btn" data-lat="45.9405" data-lng="13.6222"
                            data-name="Gorizia">Gorizia</button>
                    </div>
                </div>

                <!-- Input Manuale -->
                <div style="margin-bottom: 1rem;">
                    <strong style="display: block; margin-bottom: 0.5rem; color: #374151;">üìç O inserisci coordinate
                        personalizzate:</strong>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <input type="number" id="target-lat" placeholder="Latitudine" step="0.000001"
                            style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                        <input type="number" id="target-lng" placeholder="Longitudine" step="0.000001"
                            style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                    </div>
                </div>

                <!-- Pulsante Calcola -->
                <button id="calculate-distance-btn"
                    style="width: 100%; padding: 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    üìè Calcola Distanza
                </button>

                <!-- Risultato Distanza -->
                <div id="distance-result"
                    style="display: none; margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <div id="distance-info"></div>
                </div>
            </div>

            <!-- Mappa Interattiva -->
            <div id="map-container"
                style="display: none; margin-top: 1rem; padding: 1.5rem; background: var(--grigio-chiaro); border-radius: 12px; border: 2px solid #10b981;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; color: #065f46;">
                            üó∫Ô∏è Mappa Posizione
                            <span
                                style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: linear-gradient(135deg, #fecaca, #fca5a5); color: #7f1d1d; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üî¥
                                RICHIEDE INTERNET</span>
                        </h4>
                        <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.85rem;">Visualizzazione interattiva
                            della tua posizione GPS</p>

                        <!-- Badge Dinamico Status Connessione -->
                        <div id="map-connection-badge"
                            style="display: inline-block; margin-top: 0.5rem; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; transition: all 0.3s;">
                            <span id="map-connection-icon">üü¢</span>
                            <span id="map-connection-text">Online</span>
                        </div>
                    </div>
                    <button id="recenter-map-btn"
                        style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.3s;">
                        üéØ Centra
                    </button>
                </div>

                <!-- Container Mappa Leaflet -->
                <div id="map"
                    style="height: 400px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
                </div>

                <!-- Info Mappa -->
                <div
                    style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px; font-size: 0.85rem; color: #6b7280;">
                    <strong style="color: #374151;">üìç Legenda:</strong>
                    <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; line-height: 1.8;">
                        <li><strong style="color: #3b82f6;">Marker blu</strong> = La tua posizione attuale</li>
                        <li><strong style="color: #3b82f6;">Cerchio blu</strong> = Raggio di accuratezza GPS (¬±metri)
                        </li>
                        <li>Usa <strong>scroll/pinch</strong> per zoom, <strong>drag</strong> per muovere la mappa</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Effetti e Animazioni Attive -->
        <div id="section-effects" class="test-section">
            <h2>üé≠ Effetti e Animazioni Attive</h2>
            <div class="effects-grid" id="effects-grid">
                <!-- Gli effetti verranno popolati dinamicamente -->
            </div>
            <button class="test-button" onclick="updateEffectsStatus()">üîÑ Aggiorna Status</button>
        </div>

        <!-- Test 1: Caricamento Database -->
        <div id="section-database" class="test-section has-module-header">
            <!-- Nuovo header modulo: Database -->
            <div class="test-header" data-module="database">
                <div class="test-header-top">
                    <div class="test-header-left">
                        <div class="test-title">Test Database</div>
                        <div class="test-stats">
                            <span>‚úÖ <span id="db-header-passed">0</span></span>
                            <span>‚ùå <span id="db-header-failed">0</span></span>
                            <span>‚è±Ô∏è <span id="db-header-time">0ms</span></span>
                        </div>
                    </div>
                    <div class="test-header-right">
                        <div class="test-progress" id="db-header-progress">0/17</div>
                        <span class="test-header-status status-pending status-pending-small" id="db-header-status">In attesa</span>
                    </div>
                </div>
                <div class="test-timestamp" id="db-header-timestamp" data-ts="">-</div>
                <div class="test-bar">
                    <div class="test-bar-fill" id="db-header-bar" data-progress="0"></div>
                </div>
            </div>

            <!-- CARD UNICA che contiene tutti i gruppi (stile Mobile 3) -->
            <div class="test-groups-card">

                <!-- Gruppo 1: Caricamento & Struttura -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleDbGroup('group1')">
                        <div class="test-group-bar group-db-1"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Caricamento & Struttura</div>
                            <div id="db-group1-subtitle" class="test-group-subtitle state-pending">5 test da completare</div>
                        </div>
                        <div id="db-group1-badge" class="test-group-badge badge-pending">0/5</div>
                        <div id="db-group1-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="db-group1-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-database-load">
                                <span>üìÑ Caricamento database.json</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-structure">
                                <span>üèóÔ∏è Validazione struttura base</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-lines">
                                <span>üìã Campi obbligatori</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-types">
                                <span>üîç Tipi rigorosi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-null-undefined">
                                <span>üö´ Valori null/undefined</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 2: Validazione Dati -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleDbGroup('group2')">
                        <div class="test-group-bar group-db-2"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Validazione Dati</div>
                            <div id="db-group2-subtitle" class="test-group-subtitle state-pending">4 test da completare</div>
                        </div>
                        <div id="db-group2-badge" class="test-group-badge badge-pending">0/4</div>
                        <div id="db-group2-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="db-group2-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-database-prices">
                                <span>üí∞ Validazione prezzi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-stops">
                                <span>üöè Validazione fermate</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-codes">
                                <span>üè∑Ô∏è Validazione codici</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-encoding">
                                <span>üåê Encoding e caratteri speciali</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 3: Analisi Qualit√† -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleDbGroup('group3')">
                        <div class="test-group-bar group-db-3"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Analisi Qualit√†</div>
                            <div id="db-group3-subtitle" class="test-group-subtitle state-pending">7 test da completare</div>
                        </div>
                        <div id="db-group3-badge" class="test-group-badge badge-pending">0/7</div>
                        <div id="db-group3-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="db-group3-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-database-duplicates">
                                <span>üîÑ Nomi linee duplicati</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-range">
                                <span>üìä Range prezzi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-progression">
                                <span>üìà Progressivit√† prezzi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-format">
                                <span>üî§ Formato codici</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-consistency">
                                <span>üîó Consistenza dati</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-edge-cases">
                                <span>‚ö†Ô∏è Edge cases estremi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-size-limit">
                                <span>üìè Dimensioni massime</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 4: Performance -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleDbGroup('group4')">
                        <div class="test-group-bar group-db-4"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Performance</div>
                            <div id="db-group4-subtitle" class="test-group-subtitle state-pending">1 test da completare</div>
                        </div>
                        <div id="db-group4-badge" class="test-group-badge badge-pending">0/1</div>
                        <div id="db-group4-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="db-group4-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-database-performance">
                                <span>üöÄ Misurazione velocit√†</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                <button class="test-button" onclick="testDatabaseLoad()" style="flex: 1; min-width: 120px;">üß™ Esegui
                    Tutti i Test</button>
                <button class="test-button" onclick="toggleAllDbGroups(true)" style="background: #6b7280; min-width: 100px;">üìÇ Espandi
                    Tutti</button>
                <button class="test-button" onclick="toggleAllDbGroups(false)" style="background: #6b7280; min-width: 100px;">üìÅ Comprimi
                    Tutti</button>
                <button class="test-button" onclick="resetDatabaseTests()" style="background: #ef4444; transition: background-color 0.2s ease; min-width: 100px;">üîÑ Reset
                    Test</button>
            </div>
            <div class="test-output" id="output-database" style="display:none;"></div>
            <div id="db-log-buttons" style="display: none; gap: 0.5rem; margin-top: 0.5rem;">
                <button class="test-button" onclick="copyDatabaseLog()" style="background: #0d9488;">üìã Copia
                    log</button>
                <button class="test-button" onclick="downloadDatabaseLog()" style="background: #3b82f6;">üíæ Scarica
                    log</button>
                <button class="test-button" onclick="clearDatabaseLog()" style="background: #ef4444;">üóëÔ∏è Cancella
                    log</button>
            </div>
        </div>

        <!-- Test 2: LocalStorage -->
        <!-- Test 3: Dark Mode -->
        <div id="section-darkmode" class="test-section">
            <h2>üåô Test Dark Mode</h2>
            <div class="test-item" id="test-darkmode-toggle">
                <span>Toggle dark mode</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-darkmode-persistence">
                <span>Persistenza preferenza</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testDarkMode()">üß™ Test Dark Mode</button>
            <div class="test-output" id="output-darkmode" style="display:none;"></div>
        </div>

        <!-- Test 3.5: Storage Module (js/core/storage.js) -->
        <div id="section-storage" class="test-section has-module-header">
            <!-- Header modulo: Storage -->
            <div class="test-header" data-module="storage">
                    <div class="test-header-top">
                    <div class="test-title">üíæ Test Storage Module</div>
                    <div class="test-progress" id="storage-header-progress">0/24</div>
                    <span class="test-header-status status-pending" id="storage-header-status">In attesa</span>
                </div>
                <div class="test-stats">
                    <span>‚úÖ <span id="storage-header-passed">0</span></span>
                    <span>‚ùå <span id="storage-header-failed">0</span></span>
                    <span>‚è±Ô∏è <span id="storage-header-time">0ms</span></span>
                </div>
                <div class="test-timestamp" id="storage-header-timestamp" data-ts="">-</div>
                <div class="test-bar">
                    <div class="test-bar-fill" id="storage-header-bar" data-progress="0"></div>
                </div>
            </div>

            <!-- CARD UNICA che contiene tutti i gruppi -->
            <div class="test-groups-card">

                <!-- Gruppo 1: Test Base -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group1')">
                        <div class="test-group-bar group-storage-1"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Base</div>
                            <div id="storage-group1-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="storage-group1-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="storage-group1-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group1-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-storage-set-get">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-set-get')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Storage.setItem() e Storage.getItem()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-remove">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-remove')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Storage.removeItem()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-default-value">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-default-value')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Storage.getItem() con defaultValue</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 2: Test JSON -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group2')">
                        <div class="test-group-bar group-storage-2"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test JSON</div>
                            <div id="storage-group2-subtitle" class="test-group-subtitle state-pending">4 test da completare</div>
                        </div>
                        <div id="storage-group2-badge" class="test-group-badge badge-pending">0/4</div>
                        <div id="storage-group2-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group2-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-storage-json-object">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-json-object')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Oggetti JSON</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-json-array">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-json-array')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Array JSON</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-boolean">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-boolean')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Valori boolean</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-number">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-number')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Valori numerici</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 3: Test Funzioni Avanzate -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group3')">
                        <div class="test-group-bar group-storage-3"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Funzioni Avanzate</div>
                            <div id="storage-group3-subtitle" class="test-group-subtitle state-pending">5 test da completare</div>
                        </div>
                        <div id="storage-group3-badge" class="test-group-badge badge-pending">0/5</div>
                        <div id="storage-group3-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group3-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-storage-clear">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-clear')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Storage.clear()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-prefix-get">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-prefix-get')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Storage.getItemsByPrefix()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-prefix-remove">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-prefix-remove')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Storage.removeItemsByPrefix()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-has-item">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-has-item')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Storage.hasItem()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-size">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-size')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Storage.getSize()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 4: Test Edge Cases -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group4')">
                        <div class="test-group-bar group-storage-4"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Edge Cases</div>
                            <div id="storage-group4-subtitle" class="test-group-subtitle state-pending">4 test da completare</div>
                        </div>
                        <div id="storage-group4-badge" class="test-group-badge badge-pending">0/4</div>
                        <div id="storage-group4-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group4-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-storage-retrocompatibility">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-retrocompatibility')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Retrocompatibilit√† localStorage</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-null-undefined">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-null-undefined')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Valori null e undefined</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-special-chars">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-special-chars')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Caratteri speciali</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-large-value">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-large-value')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Valore grande (10KB)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 5: Test Avanzati -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group5')">
                        <div class="test-group-bar group-storage-5"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Avanzati</div>
                            <div id="storage-group5-subtitle" class="test-group-subtitle state-pending">8 test da completare</div>
                        </div>
                        <div id="storage-group5-badge" class="test-group-badge badge-pending">0/8</div>
                        <div id="storage-group5-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group5-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-storage-multiple-operations">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-multiple-operations')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Operazioni multiple</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-performance">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-performance')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Performance (100KB x100)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-iterate-keys">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-iterate-keys')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Iterazione chiavi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-invalid-json">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-invalid-json')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>JSON invalido</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-non-string">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-non-string')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Valori non-stringa</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-namespace">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-namespace')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Namespace prefix (tpl.*)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-migration">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-migration')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Migrazione isDark ‚Üí themeMode</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-storage-timestamp">
                                <button class="test-run-single" onclick="runSingleStorageTest('test-storage-timestamp')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Gestione timestamp</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Fine Card Gruppi Test Storage -->

            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                <button class="test-button" onclick="testStorage()" style="flex: 1; min-width: 150px;">üß™ Test Storage (24 test)</button>
                <button class="test-button" onclick="toggleAllStorageGroups(true)" style="background: #6b7280;">üìÇ Apri Tutti</button>
                <button class="test-button" onclick="toggleAllStorageGroups(false)" style="background: #6b7280;">üìÅ Chiudi Tutti</button>
                <button class="test-button" onclick="resetStorageModuleTests()" style="background: #ef4444; transition: background-color 0.2s ease; min-width: 100px;">üîÑ Reset Test</button>
            </div>
            <div class="test-output" id="output-storage" style="display:none;"></div>
            <div id="storage-log-buttons" style="display: none; gap: 0.5rem; margin-top: 0.5rem;">
                <button class="test-button" onclick="copyStorageLog()" style="background: #0d9488;">üìã Copia log</button>
                <button class="test-button" onclick="downloadStorageLog()" style="background: #3b82f6;">üíæ Scarica log</button>
                <button class="test-button" onclick="clearStorageLog()" style="background: #ef4444;">üóëÔ∏è Cancella log</button>
            </div>
        </div>

        <!-- Test 4: Calcolo Prezzi (Modulo prezzi.js) -->
        <div id="section-prezzi" class="test-section has-module-header">
            <!-- Nuovo header modulo: Prezzi -->
            <div class="test-header" data-module="prezzi">
                <div class="test-header-top">
                    <div class="test-title">üí∞ Test Prezzi</div>
                    <div class="test-progress" id="price-header-progress">0/26</div>
                    <span class="test-header-status status-pending" id="price-header-status">In attesa</span>
                </div>
                <div class="test-stats">
                    <span>‚úÖ <span id="price-header-passed">0</span></span>
                    <span>‚ùå <span id="price-header-failed">0</span></span>
                    <span>‚è±Ô∏è <span id="price-header-time">0ms</span></span>
                </div>
                <div class="test-timestamp" id="price-header-timestamp" data-ts="">-</div>
                <div class="test-bar">
                    <div class="test-bar-fill" id="price-header-bar" data-progress="0"></div>
                </div>
            </div>

            <!-- CARD UNICA che contiene tutti i gruppi (stile Mobile 3) -->
            <div class="test-groups-card">

                <!-- Gruppo 1: Test Unitari -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="togglePriceGroup('group1')">
                        <div class="test-group-bar group-price-1"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Unitari</div>
                            <div id="price-group1-subtitle" class="test-group-subtitle state-pending">5 test da completare</div>
                        </div>
                        <div id="price-group1-badge" class="test-group-badge badge-pending">0/5</div>
                        <div id="price-group1-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="price-group1-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-pricing-calculate">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-calculate')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Pricing.calculatePrice()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-ticket-code">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-ticket-code')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Pricing.getTicketCode()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-format">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-format')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Pricing.formatPrice()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-validation">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-validation')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Pricing.isValidSelection()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-route">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-route')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Pricing.isRouteAvailable()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 2: Edge Cases -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="togglePriceGroup('group2')">
                        <div class="test-group-bar group-price-2"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Edge Cases</div>
                            <div id="price-group2-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="price-group2-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="price-group2-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="price-group2-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-pricing-same-stop">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-same-stop')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Stessa fermata (partenza = arrivo)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-out-of-range">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-out-of-range')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Indici fuori range</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-fallback">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-fallback')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Fallback tariffarioAggiornato</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 3: Test Avanzati -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="togglePriceGroup('group3')">
                        <div class="test-group-bar group-price-3"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Avanzati</div>
                            <div id="price-group3-subtitle" class="test-group-subtitle state-pending">5 test da completare</div>
                        </div>
                        <div id="price-group3-badge" class="test-group-badge badge-pending">0/5</div>
                        <div id="price-group3-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="price-group3-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-pricing-empty-tariffario">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-empty-tariffario')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Tariffario vuoto/null</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-negative-indices">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-negative-indices')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Indici negativi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-string-indices">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-string-indices')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Indici come stringhe ("0", "5")</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-zero-price">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-zero-price')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Prezzo zero (gratuito)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-missing-matrices">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-missing-matrices')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Matrici prezzi/codici mancanti</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 4: Robustezza Dati -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="togglePriceGroup('group4')">
                        <div class="test-group-bar group-price-4"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Robustezza Dati</div>
                            <div id="price-group4-subtitle" class="test-group-subtitle state-pending">16 test da completare</div>
                        </div>
                        <div id="price-group4-badge" class="test-group-badge badge-pending">0/16</div>
                        <div id="price-group4-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="price-group4-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-pricing-null-price">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-null-price')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Prezzo null nella matrice</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-undefined-price">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-undefined-price')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Prezzo undefined nella matrice</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-string-price">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-string-price')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Prezzo come stringa ("3.50")</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-line-not-exists">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-line-not-exists')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Linea non esistente (indice 999)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-result-structure">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-result-structure')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Struttura risultato corretta</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-nan-price">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-nan-price')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Prezzo NaN nella matrice</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-infinity-price">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-infinity-price')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Prezzo Infinity nella matrice</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-negative-price">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-negative-price')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Prezzo negativo</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-fermate-not-array">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-fermate-not-array')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>fermate non array</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-code-with-spaces">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-code-with-spaces')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Codice con spazi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-price-code-only">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-price-code-only')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Solo codice senza prezzo</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-fallback-actual">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-fallback-actual')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Fallback tariffarioAggiornato (funzionamento)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-extreme-values">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-extreme-values')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Valori estremi (grande/piccolo/decimali)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-symmetry">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-symmetry')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Simmetria andata/ritorno</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-multiple-lines">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-multiple-lines')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Test con pi√π linee diverse</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-performance">
                                <button class="test-run-single" onclick="runSinglePriceTest('test-pricing-performance')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Performance (1000 calcoli)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Fine Card Gruppi Test Prezzi -->

            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                <button class="test-button" onclick="testPriceCalculation()" style="flex: 1; min-width: 150px;">üß™ Test
                    Modulo Prezzi</button>
                <button class="test-button" onclick="toggleAllPriceGroups(true)" style="background: #6b7280;">üìÇ Apri
                    Tutti</button>
                <button class="test-button" onclick="toggleAllPriceGroups(false)" style="background: #6b7280;">üìÅ Chiudi
                    Tutti</button>
                <button class="test-button" onclick="resetPriceTests()" style="background: #ef4444; transition: background-color 0.2s ease; min-width: 100px;">üîÑ Reset Test</button>
            </div>
            <div class="test-output" id="output-price" style="display:none;" data-no-copy="true"></div>
            <div id="price-log-buttons" style="display: none; gap: 0.5rem; margin-top: 0.5rem;">
                <button class="test-button" onclick="copyPriceLog()" style="background: #0d9488;">üìã Copia log</button>
                <button class="test-button" onclick="downloadPriceLog()" style="background: #3b82f6;">üíæ Scarica
                    log</button>
                <button class="test-button" onclick="clearPriceLog()" style="background: #ef4444;">üóëÔ∏è Cancella
                    log</button>
            </div>
        </div>

        <!-- Test RouteSelector: Route Selector (Modulo route-selector.js) -->
        <div id="section-route" class="test-section has-module-header">
            <!-- Header modulo: Route Selector -->
            <div class="test-header" data-module="route">
                <div class="test-header-top">
                    <div class="test-title">üß≠ Test Route Selector</div>
                    <div class="test-progress" id="route-header-progress">0/10</div>
                    <span class="test-header-status status-pending" id="route-header-status">In attesa</span>
                </div>
                <div class="test-stats">
                    <span>‚úÖ <span id="route-header-passed">0</span></span>
                    <span>‚ùå <span id="route-header-failed">0</span></span>
                    <span>‚è±Ô∏è <span id="route-header-time">0ms</span></span>
                </div>
                <div class="test-timestamp" id="route-header-timestamp" data-ts="">-</div>
                <div class="test-bar">
                    <div class="test-bar-fill" id="route-header-bar" data-progress="0"></div>
                </div>
            </div>

            <!-- CARD UNICA che contiene tutti i gruppi -->
            <div class="test-groups-card">

                <!-- Gruppo 1: Test Base -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleRouteGroup('group1')">
                        <div class="test-group-bar group-route-1"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Base</div>
                            <div id="route-group1-subtitle" class="test-group-subtitle state-pending">2 test da completare</div>
                        </div>
                        <div id="route-group1-badge" class="test-group-badge badge-pending">0/2</div>
                        <div id="route-group1-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="route-group1-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-route-module">
                                <button class="test-run-single" onclick="runSingleRouteTest('test-route-module')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Disponibilit√† modulo</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-route-initial-state">
                                <button class="test-run-single" onclick="runSingleRouteTest('test-route-initial-state')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Stato iniziale</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 2: Selezione -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleRouteGroup('group2')">
                        <div class="test-group-bar group-route-2"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Selezione</div>
                            <div id="route-group2-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="route-group2-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="route-group2-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="route-group2-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-route-select-linea">
                                <button class="test-run-single" onclick="runSingleRouteTest('test-route-select-linea')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Selezione linea</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-route-select-partenza">
                                <button class="test-run-single" onclick="runSingleRouteTest('test-route-select-partenza')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Selezione partenza</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-route-select-arrivo">
                                <button class="test-run-single" onclick="runSingleRouteTest('test-route-select-arrivo')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Selezione arrivo</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 3: Funzionalit√† -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleRouteGroup('group3')">
                        <div class="test-group-bar group-route-3"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Funzionalit√†</div>
                            <div id="route-group3-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="route-group3-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="route-group3-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="route-group3-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-route-swap">
                                <button class="test-run-single" onclick="runSingleRouteTest('test-route-swap')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Swap partenza/arrivo</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-route-reset">
                                <button class="test-run-single" onclick="runSingleRouteTest('test-route-reset')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Reset selezioni</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-route-getters">
                                <button class="test-run-single" onclick="runSingleRouteTest('test-route-getters')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Metodi getter</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 4: Storage -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleRouteGroup('group4')">
                        <div class="test-group-bar group-route-4"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Storage</div>
                            <div id="route-group4-subtitle" class="test-group-subtitle state-pending">2 test da completare</div>
                        </div>
                        <div id="route-group4-badge" class="test-group-badge badge-pending">0/2</div>
                        <div id="route-group4-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="route-group4-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-route-storage-save">
                                <button class="test-run-single" onclick="runSingleRouteTest('test-route-storage-save')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Salvataggio Storage</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-route-storage-restore">
                                <button class="test-run-single" onclick="runSingleRouteTest('test-route-storage-restore')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Ripristino Storage</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Fine Card Gruppi Test Route Selector -->

            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                <button class="test-button" onclick="testRouteSelector()" style="flex: 1; min-width: 150px;">üß™ Test
                    Route Selector</button>
                <button class="test-button" onclick="toggleAllRouteGroups(true)" style="background: #6b7280;">üìÇ Apri
                    Tutti</button>
                <button class="test-button" onclick="toggleAllRouteGroups(false)" style="background: #6b7280;">üìÅ Chiudi
                    Tutti</button>
                <button class="test-button" onclick="resetRouteTests()" style="background: #ef4444; transition: background-color 0.2s ease; min-width: 100px;">üîÑ Reset Test</button>
            </div>
            <div class="test-output" id="output-route" style="display:none;" data-no-copy="true"></div>
            <div id="route-log-buttons" style="display: none; gap: 0.5rem; margin-top: 0.5rem;">
                <button class="test-button" onclick="copyRouteLog()" style="background: #0d9488;">üìã Copia log</button>
                <button class="test-button" onclick="downloadRouteLog()" style="background: #3b82f6;">üíæ Scarica
                    log</button>
                <button class="test-button" onclick="clearRouteLog()" style="background: #ef4444;">üóëÔ∏è Cancella
                    log</button>
            </div>
        </div>

        <!-- Test 5: Settings (Modulo settings.js) -->
        <div id="section-settings" class="test-section has-module-header">
            <!-- Header modulo: Settings -->
            <div class="test-header" data-module="settings">
                <div class="test-header-top">
                    <div class="test-title">‚öôÔ∏è Test Settings</div>
                    <div class="test-progress" id="settings-header-progress">0/22</div>
                    <span class="test-header-status status-pending" id="settings-header-status">In attesa</span>
                </div>
                <div class="test-stats">
                    <span>‚úÖ <span id="settings-header-passed">0</span></span>
                    <span>‚ùå <span id="settings-header-failed">0</span></span>
                    <span>‚è±Ô∏è <span id="settings-header-time">0ms</span></span>
                </div>
                <div class="test-timestamp" id="settings-header-timestamp" data-ts="">-</div>
                <div class="test-bar">
                    <div class="test-bar-fill" id="settings-header-bar" data-progress="0"></div>
                </div>
            </div>

            <!-- CARD UNICA che contiene tutti i gruppi -->
            <div class="test-groups-card">

                <!-- Gruppo 1: Dimensione Testo -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleSettingsGroup('group1')">
                        <div class="test-group-bar group-settings-1"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Dimensione Testo</div>
                            <div id="settings-group1-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="settings-group1-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="settings-group1-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="settings-group1-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-settings-font-size-normal">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-font-size-normal')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Font Size: Normal</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-font-size-large">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-font-size-large')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Font Size: Large</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-font-size-xlarge">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-font-size-xlarge')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Font Size: XLarge</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 2: Tema -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleSettingsGroup('group2')">
                        <div class="test-group-bar group-settings-2"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Tema</div>
                            <div id="settings-group2-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="settings-group2-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="settings-group2-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="settings-group2-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-settings-theme-light">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-theme-light')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Tema: Light</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-theme-dark">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-theme-dark')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Tema: Dark</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-theme-system">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-theme-system')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Tema: System</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 3: Accessibilit√† -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleSettingsGroup('group3')">
                        <div class="test-group-bar group-settings-3"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Accessibilit√†</div>
                            <div id="settings-group3-subtitle" class="test-group-subtitle state-pending">6 test da completare</div>
                        </div>
                        <div id="settings-group3-badge" class="test-group-badge badge-pending">0/6</div>
                        <div id="settings-group3-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="settings-group3-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-settings-high-contrast">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-high-contrast')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Contrasto Alto</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-touch-friendly">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-touch-friendly')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Touch Friendly</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-reduce-motion">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-reduce-motion')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Riduci Animazioni</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-extra-spacing">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-extra-spacing')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Spaziatura Extra</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-compact-layout">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-compact-layout')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Layout Compatto</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-blue-light-filter">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-blue-light-filter')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Filtro Luce Blu</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 4: Dimensione Interfaccia -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleSettingsGroup('group4')">
                        <div class="test-group-bar group-settings-4"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Dimensione Interfaccia</div>
                            <div id="settings-group4-subtitle" class="test-group-subtitle state-pending">5 test da completare</div>
                        </div>
                        <div id="settings-group4-badge" class="test-group-badge badge-pending">0/5</div>
                        <div id="settings-group4-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="settings-group4-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-settings-interface-scale-75">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-interface-scale-75')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Interface Scale: 75%</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-interface-scale-85">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-interface-scale-85')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Interface Scale: 85%</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-interface-scale-100">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-interface-scale-100')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Interface Scale: 100%</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-interface-scale-115">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-interface-scale-115')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Interface Scale: 115%</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-interface-scale-125">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-interface-scale-125')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Interface Scale: 125%</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 5: Feedback e Persistenza -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleSettingsGroup('group5')">
                        <div class="test-group-bar group-settings-5"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Feedback e Persistenza</div>
                            <div id="settings-group5-subtitle" class="test-group-subtitle state-pending">5 test da completare</div>
                        </div>
                        <div id="settings-group5-badge" class="test-group-badge badge-pending">0/5</div>
                        <div id="settings-group5-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="settings-group5-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-settings-haptic-feedback">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-haptic-feedback')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Feedback Aptico</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-animation-toggle">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-animation-toggle')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Toggle Animazioni</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-keep-screen-on">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-keep-screen-on')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Keep Screen On (Wake Lock)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-localstorage-persistence">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-localstorage-persistence')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Persistenza localStorage</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-settings-css-classes">
                                <button class="test-run-single" onclick="runSingleSettingsTest('test-settings-css-classes')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Classi CSS applicate</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Fine Card Gruppi Test Settings -->

            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                <button class="test-button" onclick="testSettings()" style="flex: 1; min-width: 150px;">üß™ Test Modulo Settings</button>
                <button class="test-button" onclick="toggleAllSettingsGroups(true)" style="background: #6b7280;">üìÇ Apri Tutti</button>
                <button class="test-button" onclick="toggleAllSettingsGroups(false)" style="background: #6b7280;">üìÅ Chiudi Tutti</button>
                <button class="test-button" onclick="resetSettingsTests()" style="background: #ef4444; transition: background-color 0.2s ease; min-width: 100px;">üîÑ Reset Test</button>
            </div>
            <div class="test-output" id="output-settings" style="display:none;" data-no-copy="true"></div>
            <div id="settings-log-buttons" style="display: none; gap: 0.5rem; margin-top: 0.5rem;">
                <button class="test-button" onclick="copySettingsLog()" style="background: #0d9488;">üìã Copia log</button>
                <button class="test-button" onclick="downloadSettingsLog()" style="background: #3b82f6;">üíæ Scarica log</button>
                <button class="test-button" onclick="clearSettingsLog()" style="background: #ef4444;">üóëÔ∏è Cancella log</button>
            </div>
        </div>

        <!-- Test 5: Service Worker (Modulo sw.js) -->
        <div id="section-sw" class="test-section has-module-header">
            <!-- Header modulo: Service Worker -->
            <div class="test-header" data-module="sw">
                <div class="test-header-top">
                    <div class="test-title">‚öôÔ∏è Test Service Worker (PWA)</div>
                    <div class="test-progress" id="sw-header-progress">0/14</div>
                    <span class="test-header-status status-pending" id="sw-header-status">In attesa</span>
                </div>
                <div class="test-stats">
                    <span>‚úÖ <span id="sw-header-passed">0</span></span>
                    <span>‚ùå <span id="sw-header-failed">0</span></span>
                    <span>‚è±Ô∏è <span id="sw-header-time">0ms</span></span>
                </div>
                <div class="test-timestamp" id="sw-header-timestamp" data-ts="">-</div>
                <div class="test-bar">
                    <div class="test-bar-fill" id="sw-header-bar" data-progress="0"></div>
                </div>
            </div>

            <!-- CARD UNICA che contiene tutti i gruppi -->
            <div class="test-groups-card">

                <!-- Gruppo 1: Registrazione e Base -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleSwGroup('group1')">
                        <div class="test-group-bar group-sw-1"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Registrazione e Base</div>
                            <div id="sw-group1-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="sw-group1-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="sw-group1-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="sw-group1-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-sw-registration">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-registration')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Registrazione Service Worker</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-sw-cache">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-cache')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Verifica cache</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-sw-version-not-cached">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-version-not-cached')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>version.json non in cache</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 2: Cache Management -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleSwGroup('group2')">
                        <div class="test-group-bar group-sw-2"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Cache Management</div>
                            <div id="sw-group2-subtitle" class="test-group-subtitle state-pending">4 test da completare</div>
                        </div>
                        <div id="sw-group2-badge" class="test-group-badge badge-pending">0/4</div>
                        <div id="sw-group2-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="sw-group2-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-sw-cache-size">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-cache-size')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Dimensione cache</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-sw-cache-cleanup">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-cache-cleanup')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Cache cleanup</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-sw-static-assets">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-static-assets')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Static assets verification</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-sw-fetch-strategy">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-fetch-strategy')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Fetch strategy (cache-first)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 3: Messaggi e Comunicazione -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleSwGroup('group3')">
                        <div class="test-group-bar group-sw-3"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Messaggi e Comunicazione</div>
                            <div id="sw-group3-subtitle" class="test-group-subtitle state-pending">4 test da completare</div>
                        </div>
                        <div id="sw-group3-badge" class="test-group-badge badge-pending">0/4</div>
                        <div id="sw-group3-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="sw-group3-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-sw-messages">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-messages')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Messaggi al Service Worker</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-sw-clear-cache-message">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-clear-cache-message')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>CLEAR_CACHE message</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-sw-skip-waiting-message">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-skip-waiting-message')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>SKIP_WAITING message</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-sw-offline-fallback">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-offline-fallback')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Offline fallback</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 4: Strategie e Patterns -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleSwGroup('group4')">
                        <div class="test-group-bar group-sw-4"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Strategie e Patterns</div>
                            <div id="sw-group4-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="sw-group4-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="sw-group4-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="sw-group4-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-sw-update-mechanism">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-update-mechanism')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Update mechanism</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-sw-github-pages-patterns">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-github-pages-patterns')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>GitHub Pages patterns</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-sw-error-handling">
                                <button class="test-run-single" onclick="runSingleSwTest('test-sw-error-handling')" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Error handling</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Fine Card Gruppi Test Service Worker -->

            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                <button class="test-button" onclick="testServiceWorker()" style="flex: 1; min-width: 150px;">üß™ Test Modulo Service Worker</button>
                <button class="test-button" onclick="toggleAllSwGroups(true)" style="background: #6b7280;">üìÇ Apri Tutti</button>
                <button class="test-button" onclick="toggleAllSwGroups(false)" style="background: #6b7280;">üìÅ Chiudi Tutti</button>
                <button class="test-button" onclick="resetSwTests()" style="background: #ef4444; transition: background-color 0.2s ease; min-width: 100px;">üîÑ Reset Test</button>
            </div>
            <div class="test-output" id="output-sw" style="display:none;" data-no-copy="true"></div>
            <div id="sw-log-buttons" style="display: none; gap: 0.5rem; margin-top: 0.5rem;">
                <button class="test-button" onclick="copySwLog()" style="background: #0d9488;">üìã Copia log</button>
                <button class="test-button" onclick="downloadSwLog()" style="background: #3b82f6;">üíæ Scarica log</button>
                <button class="test-button" onclick="clearSwLog()" style="background: #ef4444;">üóëÔ∏è Cancella log</button>
            </div>
        </div>

        <!-- Test 6: UI Components -->
        <div id="section-ui" class="test-section">
            <h2>üé® Test Componenti UI</h2>
            <div class="test-item" id="test-ui-selects">
                <span>Popolamento select</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-ui-swap">
                <span>Funzione swap percorso</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-ui-summary">
                <span>Aggiornamento riepilogo</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testUIComponents()">üß™ Test UI Components</button>
            <div class="test-output" id="output-ui" style="display:none;"></div>
        </div>

        <!-- Test 7: Manifest PWA -->
        <div id="section-manifest" class="test-section">
            <h2>üì± Test Manifest PWA</h2>
            <div class="test-item" id="test-manifest-load">
                <span>Caricamento manifest.webmanifest</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-manifest-icons">
                <span>Validazione icone</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testManifest()">üß™ Test Manifest</button>
            <div class="test-output" id="output-manifest" style="display:none;"></div>
        </div>

        <!-- Test 8: Performance -->
        <div id="section-performance" class="test-section">
            <h2>‚ö° Test Performance</h2>
            <div class="test-item" id="test-perf-load-time">
                <span>Tempo caricamento dati</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-perf-calc-time">
                <span>Tempo calcolo prezzo</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testPerformance()">üß™ Test Performance</button>
            <div class="test-output" id="output-performance" style="display:none;"></div>
        </div>

    </div>

    <!-- Pulsante torna su -->
    <button class="scroll-to-top" onclick="scrollToTop()" title="Torna su">
        ‚Üë
    </button>

    <!-- Modal conferma reset cache / verifica aggiornamenti -->
    <div id="cache-modal" class="cache-modal">
        <div class="cache-modal-content">
            <div class="cache-modal-header">
                <h3 id="modal-title">üîÑ Verifica Aggiornamenti</h3>
            </div>
            <div class="cache-modal-body">
                <p id="modal-message">Verifico se ci sono aggiornamenti disponibili...</p>
                <p class="cache-modal-warning" id="modal-warning" style="display: none;"></p>
            </div>
            <div class="cache-modal-footer">
                <button id="cache-cancel" class="cache-modal-btn cache-modal-cancel">Annulla</button>
                <button id="cache-confirm" class="cache-modal-btn cache-modal-confirm" style="display: none;">Riavvia e
                    Aggiorna</button>
            </div>
        </div>
    </div>

    <!-- Modal Notifica (per conferme e messaggi) -->
    <div id="notification-modal" class="notification-modal">
        <div class="notification-modal-content">
            <div class="notification-modal-header">
                <h3 id="notification-modal-title">‚úì Operazione completata</h3>
            </div>
            <div class="notification-modal-body">
                <p id="notification-modal-message"></p>
            </div>
            <div class="notification-modal-footer">
                <button id="notification-modal-ok" class="notification-modal-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Impostazioni -->
    <!-- L'HTML del modal viene caricato dinamicamente da components/settings-modal.html -->
    <!-- Vedi js/components/modals.js per la funzione loadSettingsModalHTML() -->
    <!-- Il div viene creato dinamicamente quando necessario, non √® presente qui -->

    <!-- Footer -->
    <footer class="footer">
        <!-- Footer generato dinamicamente da footer.js -->
    </footer>

    <!-- Script di test -->
    <!-- CORE: Storage (deve essere caricato PRIMA di features che lo usano) -->
    <script src="js/core/storage.js"></script>
    <!-- DATA: Tariffario (deve essere caricato PRIMA di route-selector.js) -->
    <script src="js/data/tariffario.js"></script>
    <script src="footer.js"></script>
    <script src="changelog.js"></script>
    <script src="js/features/updates.js"></script>
    <script src="js/features/settings.js"></script>
    <!-- modals.js caricato subito dopo settings.js perch√© SettingsModal dipende da Settings -->
    <script src="js/components/modals.js"></script>
    <script src="js/components/notification-modal.js"></script>
    <script src="js/features/tests-ui.js"></script>
    <script src="js/features/prezzi.js?v=20251102-2"></script>
    <script src="js/tests/test-prezzi.js"></script>
    <!-- Wrapper funzioni Prezzi test - IMPORTANTE: Deve essere caricato PRIMA del DOM per essere disponibile agli onclick -->
    <script src="js/tests/test-prezzi-wrappers.js"></script>
    <!-- Route Selector (dipende da tariffario.js e Pricing) -->
    <script src="js/features/route-selector.js"></script>
    <script src="js/tests/test-route-selector.js"></script>
    <!-- Wrapper funzioni Route Selector test - IMPORTANTE: Deve essere caricato PRIMA del DOM per essere disponibile agli onclick -->
    <script src="js/tests/test-route-selector-wrappers.js"></script>
    <!-- Modulo utility per test - Step 1 modularizzazione (02/11/2025) -->
    <script src="js/tests/test-utils.js"></script>
    <!-- Funzioni gestione log - Step 2 modularizzazione (06/11/2025) -->
    <!-- IMPORTANTE: Deve essere caricato PRIMA del DOM per essere disponibile agli onclick -->
    <script src="js/tests/test-log-helpers.js"></script>
    <!-- Wrapper funzioni accordion - Step 3 modularizzazione (06/11/2025) -->
    <!-- IMPORTANTE: Deve essere caricato PRIMA del DOM per essere disponibile agli onclick -->
    <script src="js/tests/test-accordion-wrappers.js"></script>
    <!-- Wrapper funzioni Storage test - Deve essere caricato PRIMA del DOM per essere disponibile agli onclick -->
    <script src="js/tests/test-storage-wrappers.js"></script>
    <!-- Modulo accordion per gruppi test - Step 3 modularizzazione (06/11/2025) -->
    <script src="js/tests/test-accordion.js"></script>
    <!-- Moduli test per categoria - Step 2 modularizzazione (02/11/2025) -->
    <script src="js/tests/test-database.js"></script>
    <!-- test-localstorage.js DEPRECATO - usa test-storage.js -->
    <script src="js/tests/test-storage.js"></script>
    <script src="js/tests/test-settings.js"></script>
    <script src="js/tests/test-settings-wrappers.js"></script>
    <script src="js/tests/test-darkmode.js"></script>
    <script src="js/tests/test-sw.js"></script>
    <script src="js/tests/test-sw-wrappers.js"></script>
    <script src="js/tests/test-all-wrappers.js"></script>
    <!-- File test non ancora creati - da implementare:
    <script src="js/tests/test-ui.js"></script>
    <script src="js/tests/test-manifest.js"></script>
    <script src="js/tests/test-performance.js"></script>
    <script src="js/utils/connection-monitor.js"></script>
    <script src="js/utils/offline-simulator.js"></script>
    <script src="js/utils/display-detector.js"></script>
    <script src="script.js"></script>
    <script src="test-config.js"></script>
    <script>
        // ===== FUNZIONI ACCORDION =====
        // Le funzioni sono ora definite in js/tests/test-accordion-wrappers.js
        // che viene caricato PRIMA del DOM per essere disponibile agli onclick

        // ===== ATTIVA PULSANTI COPIA LOG =====
        // Rimosso: i pulsanti vengono ora aggiunti solo quando si esegue il test

        // ===== WRAPPER LEGACY COMPATIBILITY =====
        // RIMOSSO: Le funzioni wrapper legacy sono state eliminate.
        // Ora si usa direttamente TestUtils.log(), TestUtils.updateTestStatus(), TestUtils.updateStats()

        // ===== TOGGLE ACCORDION GROUPS =====
        // Le funzioni sono gi√† definite all'inizio dello script per essere disponibili immediatamente
        // Questo blocco √® solo un commento di riferimento

        // ===== FUNZIONI GESTIONE LOG =====
        // RIMOSSO: Le funzioni gestione log sono state spostate in js/tests/test-log-helpers.js
        // Le funzioni sono ancora disponibili globalmente (window.copyDatabaseLog, ecc.)

        // ===== FUNZIONI HEADER =====
        // RIMOSSO: Le funzioni header sono state spostate nei rispettivi moduli:
        // - resetDatabaseTests() ‚Üí js/tests/test-database.js
        // - resetPriceTests() e updatePriceHeader() ‚Üí js/tests/test-prezzi.js
        // - resetSettingsTests() e updateSettingsHeader() ‚Üí js/tests/test-settings.js
        // - resetSwTests() e updateSwHeader() ‚Üí js/tests/test-sw.js
        // Le funzioni sono ancora disponibili globalmente (window.resetDatabaseTests, ecc.)

        // resetStorageTests DEPRECATO - funzione rimossa perch√© test-localstorage.js √® deprecato
        // NOTA: testStorage, resetStorageModuleTests e runSingleStorageTest sono ora definite
        // in js/tests/test-storage-wrappers.js per essere disponibili agli onclick

        // ===== GESTIONE MODALIT√Ä PWA TEST =====
        window.togglePWATestMode = function() {
            const btn = document.getElementById('toggle-pwa-mode');
            const icon = document.getElementById('pwa-mode-icon');
            const text = document.getElementById('pwa-mode-text');
            const statusDiv = document.getElementById('pwa-mode-status');
            const infoDiv = document.getElementById('pwa-mode-info');

            if (!btn || !icon || !text || !statusDiv || !infoDiv) return;

            // Leggi lo stato corrente
            const isTestMode = localStorage.getItem('tpl.pwaTestMode') === 'true';
            const newState = !isTestMode;

            // Salva il nuovo stato
            localStorage.setItem('tpl.pwaTestMode', newState);

            // Aggiorna l'UI del pulsante
            if (newState) {
                icon.textContent = '‚úÖ';
                text.textContent = 'Disattiva Modalit√† PWA';
                btn.style.background = '#dc3545';

                infoDiv.innerHTML = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px;">
                        <strong style="color: #22c55e; font-size: 1.1rem;">‚úÖ Modalit√† PWA Test: ATTIVA</strong><br>
                        <p style="margin: 0.5rem 0; color: var(--testo);">La bottom navigation √® ora visibile in tutte le pagine dell'app.</p>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bianco); border-radius: 8px; border: 1px solid var(--bordo);">
                        <strong style="color: var(--turchese);">üì± Cosa puoi fare ora:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li>Visita <a href="index.html" style="color: var(--turchese); font-weight: 600;">Home</a>, 
                            <a href="fermate.html" style="color: var(--turchese); font-weight: 600;">Fermate</a> o 
                            <a href="prezzi.html" style="color: var(--turchese); font-weight: 600;">Prezzi</a></li>
                            <li>La bottom navigation sar√† visibile in basso</li>
                            <li>La navbar superiore sar√† nascosta (solo PWA)</li>
                            <li>Il footer avr√† padding extra per non sovrapporsi</li>
                        </ul>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--testo-secondario); font-style: italic;">
                        <strong>üí° Nota:</strong> Questa √® una simulazione a scopo di test. In produzione, la bottom nav appare solo quando l'app √® installata come PWA.
                    </div>
                `;
                statusDiv.style.display = 'block';
                statusDiv.style.borderLeftColor = '#22c55e';
                statusDiv.style.background = 'rgba(34, 197, 94, 0.05)';
            } else {
                icon.textContent = 'üì±';
                text.textContent = 'Attiva Modalit√† PWA';
                btn.style.background = 'var(--turchese)';

                infoDiv.innerHTML = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        <strong style="color: #ef4444; font-size: 1.1rem;">‚ùå Modalit√† PWA Test: DISATTIVA</strong><br>
                        <p style="margin: 0.5rem 0; color: var(--testo);">La bottom navigation √® nascosta (comportamento normale del browser).</p>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bianco); border-radius: 8px; border: 1px solid var(--bordo);">
                        <strong style="color: var(--turchese);">üåê Stato Browser Normale:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li>La bottom navigation NON √® visibile</li>
                            <li>La navbar superiore √® visibile normalmente</li>
                            <li>Il layout √® quello standard del browser</li>
                            <li>Per vederla veramente, installa l'app come PWA</li>
                        </ul>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--testo-secondario); font-style: italic;">
                        <strong>üí° Suggerimento:</strong> Clicca sul pulsante sopra per simulare l'esperienza PWA senza dover installare l'app.
                    </div>
                `;
                statusDiv.style.display = 'block';
                statusDiv.style.borderLeftColor = '#ef4444';
                statusDiv.style.background = 'rgba(239, 68, 68, 0.05)';
            }

            // Trigger refresh della bottom navigation
            setTimeout(() => {
                // Dispatch evento custom per aggiornare altre finestre
                window.dispatchEvent(new Event('pwaTestModeChanged'));

                // Log per debug
                console.log('üîÑ Modalit√† PWA test aggiornata a:', newState);
            }, 100);
        }

        // Inizializza lo stato del pulsante PWA al caricamento
        window.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('toggle-pwa-mode');
            if (btn) {
                // Imposta lo stato iniziale del pulsante
                const isTestMode = localStorage.getItem('tpl.pwaTestMode') === 'true';
                const icon = document.getElementById('pwa-mode-icon');
                const text = document.getElementById('pwa-mode-text');
                const statusDiv = document.getElementById('pwa-mode-status');

                if (isTestMode) {
                    icon.textContent = '‚úÖ';
                    text.textContent = 'Disattiva Modalit√† PWA';
                    btn.style.background = '#dc3545';
                    // Mostra lo status se gi√† attivo
                    togglePWATestMode();
                    togglePWATestMode(); // Doppio toggle per mostrare lo status
                } else {
                    icon.textContent = 'üì±';
                    text.textContent = 'Attiva Modalit√† PWA';
                    btn.style.background = 'var(--turchese)';
                }

                // Aggiungi event listener
                btn.addEventListener('click', togglePWATestMode);
            }
        });

        // ===== GESTIONE SIMULAZIONE OFFLINE =====
        // Spostato in js/utils/offline-simulator.js

        // Test 1: Database - spostato in js/tests/test-database.js

        // Test 2: LocalStorage - DEPRECATO - ora usa test-storage.js

        // Test 3: Dark Mode - spostato in js/tests/test-darkmode.js
        window.testDarkMode = async function() {
            const output = 'output-darkmode';
            const outputEl = document.getElementById(output);
            if (outputEl) {
                outputEl.innerHTML = '';
                outputEl.style.display = 'block';
            }

            try {
                if (typeof DarkModeTests === 'undefined') {
                    TestUtils.log(output, '‚úó DarkModeTests non disponibile! Assicurati che test-darkmode.js sia caricato.', 'error');
                    return;
                }

                if (typeof Settings === 'undefined') {
                    TestUtils.log(output, '‚úó Settings non disponibile! Assicurati che settings.js sia caricato.', 'error');
                    return;
                }

                TestUtils.log(output, '‚úì DarkModeTests e Settings disponibili', 'success');

                const results = await DarkModeTests.runAll({
                    log: (message, type) => TestUtils.log(output, message, type),
                    updateStatus: (id, status) => TestUtils.updateTestStatus(id, status)
                });

                if (results) {
                    TestUtils.log(output, `‚úÖ Test completati: ${results.passed} passati, ${results.failed} falliti`, results.failed > 0 ? 'error' : 'success');
                }
            } catch (error) {
                TestUtils.log(output, `‚úó Errore fatale: ${error.message}`, 'error');
                console.error('Errore test dark mode:', error);
            }
        }

        // Test 3.5: Storage Module (js/core/storage.js)
        // NOTA: testStorage, resetStorageModuleTests, runSingleStorageTest e updateStorageHeader
        // sono ora definite in js/tests/test-storage-wrappers.js per essere disponibili agli onclick

        // RIMOSSO: testPriceCalculation() e runSinglePriceTest() spostate in js/tests/test-prezzi-wrappers.js
        // Le funzioni sono ancora disponibili globalmente (window.testPriceCalculation, window.runSinglePriceTest)
        // IMPORTANTE: js/tests/test-prezzi-wrappers.js deve essere caricato PRIMA del DOM per essere disponibile agli onclick

        // RIMOSSO: updatePriceHeader() spostata in js/tests/test-prezzi.js
        // La funzione √® ancora disponibile globalmente (window.updatePriceHeader)

        // ===== FUNZIONI TOGGLE PER SETTINGS =====
        // Le funzioni sono gi√† definite all'inizio dello script

        // RIMOSSO: resetSettingsTests() spostata in js/tests/test-settings.js
        // La funzione √® ancora disponibile globalmente (window.resetSettingsTests)

        // RIMOSSO: testSettings() e runSingleSettingsTest() spostate in js/tests/test-settings-wrappers.js
        // Le funzioni sono ancora disponibili globalmente (window.testSettings, window.runSingleSettingsTest)
        // IMPORTANTE: js/tests/test-settings-wrappers.js deve essere caricato PRIMA del DOM per essere disponibile agli onclick

        // RIMOSSO: testServiceWorker() spostata in js/tests/test-sw-wrappers.js
        // La funzione √® ancora disponibile globalmente (window.testServiceWorker)
        // IMPORTANTE: js/tests/test-sw-wrappers.js deve essere caricato PRIMA del DOM per essere disponibile agli onclick

        // RIMOSSO: updateSwHeader() spostata in js/tests/test-sw.js
        // La funzione √® ancora disponibile globalmente (window.updateSwHeader)

        // ===== FUNZIONI TOGGLE PER SERVICE WORKER =====
        // Le funzioni sono gi√† definite all'inizio dello script

        // RIMOSSO: resetSwTests() spostata in js/tests/test-sw.js
        // La funzione √® ancora disponibile globalmente (window.resetSwTests)

        window.runSingleSwTest = async function(testId) {
            const output = 'output-sw';
            const outputEl = document.getElementById(output);
            
            if (!outputEl) {
                console.error('Elemento output non trovato:', output);
                return;
            }

            // Mostra output
            outputEl.innerHTML = '';
            outputEl.style.display = 'block';

            // Utility functions
            const log = (message, type = 'info') => {
                if (typeof TestUtils !== 'undefined' && TestUtils.log) {
                    TestUtils.log(output, message, type);
                } else {
                    const logDiv = document.createElement('div');
                    logDiv.className = `console-log ${type}`;
                    logDiv.textContent = message;
                    outputEl.appendChild(logDiv);
                    console.log(`[${type}] ${message}`);
                }
            };

            const updateStatus = (id, status) => {
                if (typeof TestUtils !== 'undefined' && TestUtils.updateStatus) {
                    TestUtils.updateStatus(id, status);
                } else if (typeof TestUtils !== 'undefined' && TestUtils.updateTestStatus) {
                    TestUtils.updateTestStatus(id, status);
                }
            };

            log(`üß™ Esecuzione Test: ${testId}...`, 'info');
            log('', 'info');

            const startTime = performance.now();

            try {
                // Verifica che ServiceWorkerTests sia disponibile
                if (typeof ServiceWorkerTests === 'undefined') {
                    throw new Error('ServiceWorkerTests non disponibile! Assicurati che test-sw.js sia caricato.');
                }

                const callbacks = {
                    log: log,
                    updateStatus: updateStatus
                };

                // Mappatura testId -> funzione di test
                const testMap = {
                    'test-sw-registration': () => ServiceWorkerTests.testRegistration(callbacks),
                    'test-sw-cache': () => ServiceWorkerTests.testCache(callbacks),
                    'test-sw-version-not-cached': () => ServiceWorkerTests.testVersionNotCached(callbacks),
                    'test-sw-cache-size': () => ServiceWorkerTests.testCacheSize(callbacks),
                    'test-sw-messages': () => ServiceWorkerTests.testMessages(callbacks),
                    'test-sw-offline-fallback': () => ServiceWorkerTests.testOfflineFallback(callbacks),
                    'test-sw-update-mechanism': () => ServiceWorkerTests.testUpdateMechanism(callbacks),
                    'test-sw-cache-cleanup': () => ServiceWorkerTests.testCacheCleanup(callbacks),
                    'test-sw-static-assets': () => ServiceWorkerTests.testStaticAssets(callbacks),
                    'test-sw-fetch-strategy': () => ServiceWorkerTests.testFetchStrategy(callbacks),
                    'test-sw-clear-cache-message': () => ServiceWorkerTests.testClearCacheMessage(callbacks),
                    'test-sw-skip-waiting-message': () => ServiceWorkerTests.testSkipWaitingMessage(callbacks),
                    'test-sw-github-pages-patterns': () => ServiceWorkerTests.testGitHubPagesPatterns(callbacks),
                    'test-sw-error-handling': () => ServiceWorkerTests.testErrorHandling(callbacks)
                };

                if (testMap[testId]) {
                    await testMap[testId]();
                } else {
                    log(`‚ö†Ô∏è Test "${testId}" non riconosciuto`, 'warn');
                    return;
                }

                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                log('', 'info');
                log(`‚úÖ Test ${testId} completato in ${duration}ms`, 'success');

            } catch (error) {
                log(`‚úó Test ${testId} fallito: ${error.message}`, 'error');
                updateStatus(testId, 'fail');
            }
        }

        // Test 6: UI Components - spostato in js/tests/test-ui.js
        async function testUIComponents() {
            const output = 'output-ui';
            const outputEl = document.getElementById(output);
            if (outputEl) {
                outputEl.innerHTML = '';
                outputEl.style.display = 'block';
            }

            try {
                if (typeof UITests === 'undefined') {
                    TestUtils.log(output, '‚úó UITests non disponibile! Assicurati che test-ui.js sia caricato.', 'error');
                    return;
                }

                TestUtils.log(output, '‚úì UITests disponibile', 'success');

                const results = await UITests.runAll({
                    log: (message, type) => TestUtils.log(output, message, type),
                    updateStatus: (id, status) => TestUtils.updateTestStatus(id, status)
                });

                if (results) {
                    TestUtils.log(output, `‚úÖ Test completati: ${results.passed} passati, ${results.failed} falliti`, results.failed > 0 ? 'error' : 'success');
                }
            } catch (error) {
                TestUtils.log(output, `‚úó Errore fatale: ${error.message}`, 'error');
                console.error('Errore test UI components:', error);
            }
        }

        // Test 7: Manifest - spostato in js/tests/test-manifest.js
        async function testManifest() {
            const output = 'output-manifest';
            const outputEl = document.getElementById(output);
            if (outputEl) {
                outputEl.innerHTML = '';
                outputEl.style.display = 'block';
            }

            try {
                if (typeof ManifestTests === 'undefined') {
                    TestUtils.log(output, '‚úó ManifestTests non disponibile! Assicurati che test-manifest.js sia caricato.', 'error');
                    return;
                }

                TestUtils.log(output, '‚úì ManifestTests disponibile', 'success');

                const results = await ManifestTests.runAll({
                    log: (message, type) => TestUtils.log(output, message, type),
                    updateStatus: (id, status) => TestUtils.updateTestStatus(id, status)
                });

                if (results) {
                    TestUtils.log(output, `‚úÖ Test completati: ${results.passed} passati, ${results.failed} falliti`, results.failed > 0 ? 'error' : 'success');
                }
            } catch (error) {
                TestUtils.log(output, `‚úó Errore fatale: ${error.message}`, 'error');
                console.error('Errore test manifest:', error);
            }
        }

        // Test 8: Performance - spostato in js/tests/test-performance.js
        async function testPerformance() {
            const output = 'output-performance';
            const outputEl = document.getElementById(output);
            if (outputEl) {
                outputEl.innerHTML = '';
                outputEl.style.display = 'block';
            }

            try {
                if (typeof PerformanceTests === 'undefined') {
                    TestUtils.log(output, '‚úó PerformanceTests non disponibile! Assicurati che test-performance.js sia caricato.', 'error');
                    return;
                }

                TestUtils.log(output, '‚úì PerformanceTests disponibile', 'success');

                const results = await PerformanceTests.runAll({
                    log: (message, type) => TestUtils.log(output, message, type),
                    updateStatus: (id, status) => TestUtils.updateTestStatus(id, status)
                });

                if (results) {
                    TestUtils.log(output, `‚úÖ Test completati: ${results.passed} passati, ${results.failed} falliti`, results.failed > 0 ? 'error' : 'success');
                }
            } catch (error) {
                TestUtils.log(output, `‚úó Errore fatale: ${error.message}`, 'error');
                console.error('Errore test performance:', error);
            }
        }

        // Test 9: Geolocalizzazione (Versione Migliorata)

        // Funzione helper: Controlla permessi geolocalizzazione
        async function checkGeolocationPermission() {
            const statusDiv = document.getElementById('geo-permission-status');
            const statusText = document.getElementById('geo-permission-text');

            if (!statusDiv || !statusText) return;

            try {
                if (!navigator.permissions) {
                    statusText.textContent = 'API Permissions non supportata';
                    statusDiv.style.borderLeftColor = '#gray';
                    return;
                }

                const result = await navigator.permissions.query({ name: 'geolocation' });

                if (result.state === 'granted') {
                    statusText.innerHTML = '<span style="color: var(--verde);">‚úÖ Concesso</span>';
                    statusDiv.style.borderLeftColor = 'var(--verde)';
                    statusDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                } else if (result.state === 'denied') {
                    statusText.innerHTML = '<span style="color: var(--rosso);">‚ùå Negato</span>';
                    statusDiv.style.borderLeftColor = 'var(--rosso)';
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                } else if (result.state === 'prompt') {
                    statusText.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Richiesta in sospeso</span>';
                    statusDiv.style.borderLeftColor = '#f59e0b';
                    statusDiv.style.background = 'rgba(245, 158, 11, 0.1)';
                }

                // Ascolta cambiamenti permessi
                result.addEventListener('change', () => {
                    checkGeolocationPermission();
                });

            } catch (error) {
                console.error('Errore verifica permessi:', error);
                statusText.textContent = 'Impossibile verificare';
                statusDiv.style.borderLeftColor = '#gray';
            }
        }

        // ===== WATCH POSITION - MONITORAGGIO CONTINUO =====

        // Variabili globali per watch position
        let watchId = null;
        let watchActive = false;
        let watchCount = 0;
        let watchHistory = [];
        let watchTotalDistance = 0;
        let watchLastPosition = null;

        // Setup Watch Position
        (function setupWatchPosition() {
            const toggleBtn = document.getElementById('toggle-watch-btn');
            const statusCard = document.getElementById('watch-status-card');
            const countElement = document.getElementById('watch-count');
            const lastPositionData = document.getElementById('watch-last-position-data');
            const distanceElement = document.getElementById('watch-distance');
            const distanceValue = document.getElementById('watch-distance-value');
            const historySection = document.getElementById('watch-history');
            const historyList = document.getElementById('watch-history-list');
            const clearHistoryBtn = document.getElementById('clear-watch-history-btn');

            if (!toggleBtn) return;

            // Toggle monitoraggio
            toggleBtn.addEventListener('click', () => {
                if (!watchActive) {
                    startWatchPosition();
                } else {
                    stopWatchPosition();
                }
            });

            // Avvia monitoraggio
            function startWatchPosition() {
                if (!navigator.geolocation) {
                    alert('‚ùå Geolocalizzazione non supportata dal browser');
                    return;
                }

                // Reset contatori
                watchCount = 0;
                watchTotalDistance = 0;
                watchHistory = [];
                watchLastPosition = null;

                // Avvia watchPosition
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        // Successo - nuova posizione ricevuta
                        watchCount++;

                        // Aggiorna contatore
                        if (countElement) {
                            countElement.textContent = watchCount;
                            countElement.style.animation = 'pulse 0.3s ease';
                            setTimeout(() => {
                                countElement.style.animation = '';
                            }, 300);
                        }

                        // Calcola distanza se c'√® una posizione precedente
                        if (watchLastPosition) {
                            const distance = calculateDistance(
                                watchLastPosition.coords.latitude,
                                watchLastPosition.coords.longitude,
                                position.coords.latitude,
                                position.coords.longitude
                            );

                            watchTotalDistance += distance * 1000; // converti km in metri

                            if (distanceElement && distanceValue) {
                                distanceElement.style.display = 'block';
                                const distanceText = watchTotalDistance >= 1000
                                    ? (watchTotalDistance / 1000).toFixed(2) + ' km'
                                    : Math.round(watchTotalDistance) + ' metri';
                                distanceValue.textContent = watchTotalDistance >= 1000
                                    ? (watchTotalDistance / 1000).toFixed(2)
                                    : Math.round(watchTotalDistance);
                                distanceValue.parentElement.innerHTML = watchTotalDistance >= 1000
                                    ? '<span id="watch-distance-value">' + (watchTotalDistance / 1000).toFixed(2) + '</span> km'
                                    : '<span id="watch-distance-value">' + Math.round(watchTotalDistance) + '</span> metri';
                            }
                        }

                        // Salva posizione corrente
                        watchLastPosition = position;

                        // Aggiorna ultima posizione
                        if (lastPositionData) {
                            const coords = position.coords;
                            const timestamp = new Date(position.timestamp).toLocaleTimeString('it-IT');
                            const speedKmh = coords.speed !== null ? (coords.speed * 3.6).toFixed(1) : 'N/A';

                            lastPositionData.innerHTML = `
                                <strong style="color: #3b82f6;">${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}</strong><br>
                                <span style="font-size: 0.85rem;">
                                    ‚è∞ ${timestamp} | 
                                    üéØ ¬±${Math.round(coords.accuracy)}m | 
                                    üöó ${speedKmh} km/h
                                </span>
                            `;
                        }

                        // Aggiungi a cronologia (max 5)
                        watchHistory.unshift({
                            position: position,
                            timestamp: Date.now()
                        });
                        if (watchHistory.length > 5) {
                            watchHistory.pop();
                        }

                        // Aggiorna cronologia UI
                        updateHistoryUI();

                        // Aggiorna mappa se disponibile
                        if (map) {
                            initializeMap(position.coords.latitude, position.coords.longitude, position.coords.accuracy);
                        }

                        console.log('üß≠ Watch Position aggiornamento #' + watchCount, {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy + 'm'
                        });
                    },
                    (error) => {
                        // Errore
                        console.error('‚ùå Watch Position errore:', error);
                        stopWatchPosition();
                        alert('‚ùå Errore monitoraggio GPS:\n' + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 10000
                    }
                );

                // Aggiorna UI
                watchActive = true;
                toggleBtn.innerHTML = '‚è∏Ô∏è Ferma';
                toggleBtn.style.background = '#ef4444';
                if (statusCard) statusCard.style.display = 'block';
                if (historySection) historySection.style.display = 'block';

                console.log('‚ñ∂Ô∏è Watch Position AVVIATO (ID: ' + watchId + ')');
            }

            // Ferma monitoraggio
            function stopWatchPosition() {
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }

                watchActive = false;
                toggleBtn.innerHTML = '‚ñ∂Ô∏è Avvia';
                toggleBtn.style.background = '#3b82f6';

                console.log('‚èπÔ∏è Watch Position FERMATO');
            }

            // Aggiorna UI cronologia
            function updateHistoryUI() {
                if (!historyList) return;

                historyList.innerHTML = '';

                watchHistory.forEach((item, index) => {
                    const coords = item.position.coords;
                    const time = new Date(item.timestamp).toLocaleTimeString('it-IT');

                    const historyItem = document.createElement('div');
                    historyItem.style.cssText = 'padding: 0.75rem; background: white; border-radius: 8px; border-left: 3px solid #3b82f6; font-size: 0.9rem;';
                    historyItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <strong style="color: #1e40af;">#${watchCount - index}</strong>
                            <span style="color: #666; font-size: 0.85rem;">${time}</span>
                        </div>
                        <div style="color: #374151; font-size: 0.85rem;">
                            üìç ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}<br>
                            üéØ Accuratezza: ¬±${Math.round(coords.accuracy)}m
                        </div>
                    `;

                    historyList.appendChild(historyItem);
                });
            }

            // Cancella cronologia
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', () => {
                    if (confirm('üóëÔ∏è Cancellare la cronologia delle posizioni?')) {
                        watchHistory = [];
                        updateHistoryUI();
                        console.log('üóëÔ∏è Cronologia cancellata');
                    }
                });
            }
        })();

        // ===== SIMULAZIONE POSIZIONE FAKE =====

        // Variabili globali per fake position
        let useFakePosition = false;
        let fakePositionData = null;

        // Setup gestione simulazione posizione
        (function setupFakePosition() {
            const toggleCheckbox = document.getElementById('use-fake-position');
            const content = document.getElementById('fake-position-content');
            const applyBtn = document.getElementById('apply-fake-position');
            const presetBtns = document.querySelectorAll('.fake-position-preset');

            if (!toggleCheckbox || !content || !applyBtn) return;

            // Toggle on/off simulazione
            toggleCheckbox.addEventListener('change', (e) => {
                useFakePosition = e.target.checked;
                content.style.display = useFakePosition ? 'block' : 'none';

                if (useFakePosition) {
                    console.log('üé≠ Simulazione posizione ATTIVA');
                } else {
                    console.log('‚úÖ GPS reale ATTIVO');
                    fakePositionData = null;
                    document.getElementById('fake-position-info').style.display = 'none';
                }
            });

            // Preset citt√†
            presetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const lat = parseFloat(btn.dataset.lat);
                    const lng = parseFloat(btn.dataset.lng);
                    const name = btn.dataset.name;

                    // Popola input
                    document.getElementById('fake-lat').value = lat;
                    document.getElementById('fake-lng').value = lng;

                    // Visual feedback
                    presetBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    console.log(`üèôÔ∏è Preset selezionato: ${name}`);
                });
            });

            // Applica posizione fake
            applyBtn.addEventListener('click', () => {
                const lat = parseFloat(document.getElementById('fake-lat').value);
                const lng = parseFloat(document.getElementById('fake-lng').value);
                const accuracy = parseFloat(document.getElementById('fake-accuracy').value) || 10;
                const altitude = parseFloat(document.getElementById('fake-altitude').value) || 0;

                // Velocit√† e direzione (opzionali)
                const speedKmh = parseFloat(document.getElementById('fake-speed').value);
                const heading = parseFloat(document.getElementById('fake-heading').value);

                // Converti velocit√† da km/h a m/s (GPS usa m/s)
                const speedMs = !isNaN(speedKmh) && speedKmh > 0 ? speedKmh / 3.6 : null;
                const validHeading = !isNaN(heading) && heading >= 0 && heading <= 360 ? heading : null;

                // Validazione coordinate
                if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                    alert('‚ö†Ô∏è Inserisci coordinate valide!');
                    return;
                }

                if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    alert('‚ö†Ô∏è Coordinate fuori range!\nLatitudine: -90 to 90\nLongitudine: -180 to 180');
                    return;
                }

                // Crea oggetto fake position (simula Position API)
                fakePositionData = {
                    coords: {
                        latitude: lat,
                        longitude: lng,
                        accuracy: accuracy,
                        altitude: altitude,
                        altitudeAccuracy: accuracy * 2,
                        heading: validHeading,
                        speed: speedMs
                    },
                    timestamp: Date.now()
                };

                // Mostra info posizione fake
                const infoDiv = document.getElementById('fake-position-info');
                const detailsDiv = document.getElementById('fake-position-details');

                if (infoDiv && detailsDiv) {
                    let infoHTML = `
                        <strong>Coordinate:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                        <strong>Accuratezza:</strong> ¬±${accuracy}m<br>
                        <strong>Altitudine:</strong> ${altitude}m
                    `;

                    // Aggiungi velocit√†/direzione se impostate
                    if (speedMs !== null) {
                        infoHTML += `<br><strong>Velocit√†:</strong> ${speedKmh.toFixed(1)} km/h`;
                    }
                    if (validHeading !== null) {
                        infoHTML += `<br><strong>Direzione:</strong> ${validHeading}¬∞`;
                    }

                    detailsDiv.innerHTML = infoHTML;
                    infoDiv.style.display = 'block';
                }

                // Visual feedback
                applyBtn.textContent = '‚úÖ Posizione Applicata';
                setTimeout(() => {
                    applyBtn.innerHTML = 'üéØ Applica Posizione Fake';
                }, 2000);

                console.log('üéØ Posizione fake applicata:', {
                    lat: fakePositionData.coords.latitude,
                    lng: fakePositionData.coords.longitude,
                    accuracy: fakePositionData.coords.accuracy + 'm',
                    altitude: fakePositionData.coords.altitude + 'm',
                    speed: speedMs ? speedKmh.toFixed(1) + ' km/h' : 'null',
                    heading: validHeading ? validHeading + '¬∞' : 'null'
                });
            });
        })();

        // Funzione helper: Copia coordinate negli appunti
        async function copyCoordinates(lat, lng) {
            try {
                const coordsText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                await navigator.clipboard.writeText(coordsText);
                return true;
            } catch (error) {
                console.error('Errore copia coordinate:', error);
                return false;
            }
        }

        // Funzione helper: Reverse Geocoding (OpenStreetMap Nominatim API)
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
                    {
                        headers: {
                            'Accept-Language': 'it'
                        }
                    }
                );

                if (!response.ok) throw new Error('Errore reverse geocoding');

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Errore reverse geocoding:', error);
                return null;
            }
        }

        async function testGeolocation() {
            const btn = document.getElementById('test-location-btn');
            const icon = document.getElementById('test-location-icon');
            const text = document.getElementById('test-location-text');
            const result = document.getElementById('test-location-result');
            const info = document.getElementById('test-location-info');

            if (!btn || !icon || !text || !result || !info) return;

            // Stato di caricamento
            icon.textContent = '‚è≥';
            text.textContent = 'Rilevamento...';
            btn.disabled = true;
            result.style.display = 'none';

            try {
                let position;

                // ===== CONTROLLA SE USARE FAKE POSITION =====
                if (useFakePosition && fakePositionData) {
                    // Usa posizione fake
                    console.log('üé≠ Uso posizione simulata:', fakePositionData.coords);

                    // Simula delay realistico (500ms)
                    await new Promise(resolve => setTimeout(resolve, 500));

                    position = fakePositionData;

                    // Feedback visivo
                    icon.textContent = 'üé≠';
                    text.textContent = 'Posizione Simulata';

                } else if (useFakePosition && !fakePositionData) {
                    // Fake attivato ma nessuna posizione impostata
                    throw new Error('‚ö†Ô∏è Nessuna posizione fake impostata! Clicca "Applica Posizione Fake" prima.');

                } else {
                    // Usa GPS reale
                    // Verifica supporto geolocalizzazione
                    if (!navigator.geolocation) {
                        throw new Error('Geolocalizzazione non supportata dal browser');
                    }

                    // Richiedi posizione con timeout
                    position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            resolve,
                            reject,
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0 // Sempre posizione fresca
                            }
                        );
                    });

                    // Successo
                    icon.textContent = '‚úÖ';
                    text.textContent = 'Posizione Rilevata';
                }

                // Salva posizione per calcolo distanza
                lastKnownPosition = position;

                // Mostra calcolatore distanza
                const distanceCalculator = document.getElementById('distance-calculator');
                if (distanceCalculator) {
                    distanceCalculator.style.display = 'block';
                }

                // Mostra sezione Watch Position
                const watchSection = document.getElementById('watch-position-section');
                if (watchSection) {
                    watchSection.style.display = 'block';
                }

                // Mostra informazioni dettagliate
                const coords = position.coords;

                // Inizializza mappa con la posizione
                initializeMap(coords.latitude, coords.longitude, coords.accuracy);
                const timestamp = new Date(position.timestamp).toLocaleString('it-IT');

                // Velocit√† e direzione (se disponibili)
                const speedKmh = coords.speed !== null ? (coords.speed * 3.6).toFixed(1) : null;
                const heading = coords.heading !== null ? coords.heading.toFixed(0) : null;

                // Badge modalit√† (GPS reale o fake)
                const modeBadge = useFakePosition
                    ? '<span style="display: inline-block; padding: 0.25rem 0.75rem; background: linear-gradient(135deg, #a855f7, #9333ea); color: white; border-radius: 6px; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.75rem;">üé≠ MODALIT√Ä SIMULATA</span>'
                    : '<span style="display: inline-block; padding: 0.25rem 0.75rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 6px; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.75rem;">‚úÖ GPS REALE</span>';

                // Costruisci HTML base
                let html = `
                    ${modeBadge}
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üìç Coordinate:</strong>
                        <button id="copy-coords-btn" style="margin-left: 0.5rem; padding: 0.25rem 0.75rem; background: var(--turchese); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                            üìã Copia
                        </button>
                        <br>
                        Latitudine: <code>${coords.latitude.toFixed(6)}</code><br>
                        Longitudine: <code>${coords.longitude.toFixed(6)}</code>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üéØ Precisione:</strong><br>
                        Accuratezza: <code>${Math.round(coords.accuracy)} metri</code><br>
                        Altitudine: <code>${coords.altitude ? Math.round(coords.altitude) + ' metri' : 'Non disponibile'}</code>${coords.altitudeAccuracy ? ' (¬±' + Math.round(coords.altitudeAccuracy) + 'm)' : ''}
                    </div>
                `;

                // Aggiungi velocit√† e direzione (sempre, anche se null per debug)
                html += `
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üöó Movimento:</strong><br>
                        Velocit√†: <code>${speedKmh !== null ? speedKmh + ' km/h' : '‚ùå Non disponibile (dispositivo fermo)'}</code><br>
                        Direzione: <code>${heading !== null ? heading + '¬∞ ' + getCardinalDirection(heading) : '‚ùå Non disponibile (serve movimento)'}</code>
                    </div>
                `;

                html += `
                    <div style="margin-bottom: 0.5rem;">
                        <strong>‚è∞ Timestamp:</strong><br>
                        <code>${timestamp}</code>
                    </div>
                    <div id="address-container" style="margin-bottom: 0.5rem;">
                        <strong>
                            üì¨ Indirizzo 
                            <span style="display: inline-block; margin-left: 0.5rem; padding: 0.2rem 0.4rem; background: linear-gradient(135deg, #fecaca, #fca5a5); color: #7f1d1d; border-radius: 4px; font-size: 0.65rem; font-weight: 600;">üî¥ RICHIEDE INTERNET</span>
                        </strong>
                        <div id="address-connection-badge" style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; transition: all 0.3s;"></div>
                        <br>
                        <span style="color: #666;">üîÑ Recupero indirizzo...</span>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üîó Link Mappe:</strong><br>
                        <a href="https://www.google.com/maps?q=${coords.latitude},${coords.longitude}" target="_blank" style="color: var(--turchese); text-decoration: none;">
                            üìç Apri su Google Maps
                        </a><br>
                        <a href="https://www.openstreetmap.org/?mlat=${coords.latitude}&mlon=${coords.longitude}&zoom=15" target="_blank" style="color: var(--turchese); text-decoration: none;">
                            üó∫Ô∏è Apri su OpenStreetMap
                        </a>
                    </div>
                `;

                info.innerHTML = html;
                result.style.display = 'block';
                result.style.borderLeftColor = 'var(--verde)';
                result.style.background = 'rgba(34, 197, 94, 0.1)';

                // Setup badge dinamico indirizzo
                const addressBadge = document.getElementById('address-connection-badge');
                if (addressBadge) {
                    // Funzione aggiornamento badge
                    const updateAddressBadge = () => {
                        // Controlla sia navigator.onLine che simulazione offline
                        const offlineTest = localStorage.getItem('tpl.offlineTestMode') === 'true';
                        const isOnline = navigator.onLine && !offlineTest;

                        if (isOnline) {
                            addressBadge.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                            addressBadge.style.color = '#065f46';
                            addressBadge.textContent = 'üü¢ Online';
                            addressBadge.title = '‚úÖ Connessione attiva - Reverse geocoding disponibile';
                        } else {
                            addressBadge.style.background = 'linear-gradient(135deg, #fecaca, #fca5a5)';
                            addressBadge.style.color = '#7f1d1d';
                            addressBadge.textContent = offlineTest ? 'üî¥ Offline (simulato)' : 'üî¥ Offline';
                            addressBadge.title = 'üî¥ Nessuna connessione - Indirizzo non disponibile';
                        }
                    };

                    // Aggiorna stato iniziale
                    updateAddressBadge();

                    // Listener eventi online/offline (nativi)
                    window.addEventListener('online', updateAddressBadge);
                    window.addEventListener('offline', updateAddressBadge);

                    // Listener evento simulazione offline (custom)
                    window.addEventListener('offlineTestModeChanged', () => {
                        console.log('üì° Evento offlineTestModeChanged ricevuto - Aggiorno badge indirizzo');
                        // Piccolo delay per dare tempo a localStorage di aggiornarsi
                        setTimeout(updateAddressBadge, 50);
                    });
                }

                // Aggiungi event listener al pulsante copia
                const copyBtn = document.getElementById('copy-coords-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', async () => {
                        const success = await copyCoordinates(coords.latitude, coords.longitude);
                        if (success) {
                            copyBtn.textContent = '‚úÖ Copiato!';
                            setTimeout(() => {
                                copyBtn.textContent = 'üìã Copia';
                            }, 2000);
                        } else {
                            copyBtn.textContent = '‚ùå Errore';
                            setTimeout(() => {
                                copyBtn.textContent = 'üìã Copia';
                            }, 2000);
                        }
                    });
                }

                // Reverse Geocoding (asincrono)
                reverseGeocode(coords.latitude, coords.longitude).then(data => {
                    const addressContainer = document.getElementById('address-container');
                    if (addressContainer && data) {
                        const address = data.address;
                        let addressText = '';

                        if (address.road) {
                            addressText += address.road;
                            if (address.house_number) addressText += ' ' + address.house_number;
                            addressText += '<br>';
                        }
                        if (address.postcode || address.city || address.town || address.village) {
                            if (address.postcode) addressText += address.postcode + ' ';
                            addressText += address.city || address.town || address.village || '';
                            addressText += '<br>';
                        }
                        if (address.state) addressText += address.state + '<br>';
                        if (address.country) addressText += address.country;

                        addressContainer.innerHTML = `
                            <strong>üì¨ Indirizzo:</strong><br>
                            <span style="color: var(--grigio-scuro);">${addressText || data.display_name}</span>
                        `;
                    } else if (addressContainer) {
                        // Distingui tra offline e errore API
                        const isOffline = !navigator.onLine;
                        const errorMsg = isOffline
                            ? 'üü† <span style="color: #92400e;">Modalit√† offline - Indirizzo non disponibile</span>'
                            : '‚ùå <span style="color: #999;">Indirizzo non disponibile</span>';

                        addressContainer.innerHTML = `
                            <strong>üì¨ Indirizzo:</strong><br>
                            ${errorMsg}
                        `;
                    }
                }).catch(error => {
                    // Gestione errori esplicita
                    console.error('Errore reverse geocoding:', error);
                    const addressContainer = document.getElementById('address-container');
                    if (addressContainer) {
                        const isOffline = !navigator.onLine;
                        const errorMsg = isOffline
                            ? 'üü† <span style="color: #92400e;">Modalit√† offline - Richiede connessione internet</span>'
                            : '‚ùå <span style="color: #999;">Errore recupero indirizzo</span>';

                        addressContainer.innerHTML = `
                            <strong>üì¨ Indirizzo:</strong><br>
                            ${errorMsg}
                        `;
                    }
                });

            } catch (error) {
                // Errore
                icon.textContent = '‚ùå';
                text.textContent = 'Errore Rilevamento';

                let errorMessage = 'Errore sconosciuto';
                if (error.code === 1) {
                    errorMessage = 'Permesso di geolocalizzazione negato';
                } else if (error.code === 2) {
                    errorMessage = 'Posizione non disponibile';
                } else if (error.code === 3) {
                    errorMessage = 'Timeout durante il rilevamento';
                } else {
                    errorMessage = error.message;
                }

                info.innerHTML = `
                    <div style="color: var(--rosso);">
                        <strong>‚ùå Errore:</strong><br>
                        <code>${errorMessage}</code>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--grigio-scuro);">
                        <strong>Suggerimenti:</strong><br>
                        ‚Ä¢ Assicurati di aver concesso il permesso di geolocalizzazione<br>
                        ‚Ä¢ Verifica che il GPS sia attivo<br>
                        ‚Ä¢ Prova in un'area con buona copertura di rete<br>
                        ‚Ä¢ Su HTTPS: verifica le impostazioni del browser
                    </div>
                `;

                result.style.display = 'block';
                result.style.borderLeftColor = 'var(--rosso)';
                result.style.background = 'rgba(239, 68, 68, 0.1)';
            }

            // Reset dopo 5 secondi
            setTimeout(() => {
                icon.textContent = 'üìç';
                text.textContent = 'Rileva Posizione';
                btn.disabled = false;
            }, 5000);
        }

        // Helper: Converti gradi in direzione cardinale
        function getCardinalDirection(degrees) {
            const directions = ['‚¨ÜÔ∏è Nord', '‚ÜóÔ∏è Nord-Est', '‚û°Ô∏è Est', '‚ÜòÔ∏è Sud-Est', '‚¨áÔ∏è Sud', '‚ÜôÔ∏è Sud-Ovest', '‚¨ÖÔ∏è Ovest', '‚ÜñÔ∏è Nord-Ovest'];
            const index = Math.round(degrees / 45) % 8;
            return directions[index];
        }

        // Controlla permessi geolocalizzazione al caricamento
        if (document.getElementById('geo-permission-status')) {
            checkGeolocationPermission();
        }

        // Controlla HTTPS e mostra banner warning se necessario
        (function checkHttpsRequirement() {
            const banner = document.getElementById('https-warning-banner');
            if (!banner) return;

            const protocol = window.location.protocol;
            const hostname = window.location.hostname;

            // Mostra banner solo se NON √® HTTPS e NON √® localhost
            const isSecure = protocol === 'https:';
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '[::1]';

            if (!isSecure && !isLocalhost) {
                banner.style.display = 'block';
                console.warn('‚ö†Ô∏è Geolocalizzazione richiede HTTPS o localhost. Protocollo attuale:', protocol);
            } else {
                console.log('‚úÖ Connessione sicura - Geolocalizzazione disponibile');
            }
        })();

        // ===== CALCOLO DISTANZA =====

        // Variabile globale per memorizzare ultima posizione rilevata
        let lastKnownPosition = null;

        // Formula Haversine per calcolare distanza tra due coordinate (km)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raggio Terra in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            return distance;
        }

        // Calcola tempo stimato basato su distanza
        function estimateTime(distanceKm) {
            const walkingSpeed = 5; // km/h a piedi
            const carSpeed = 50; // km/h in citt√†
            const busSpeed = 30; // km/h autobus urbano

            const walkMinutes = Math.round((distanceKm / walkingSpeed) * 60);
            const carMinutes = Math.round((distanceKm / carSpeed) * 60);
            const busMinutes = Math.round((distanceKm / busSpeed) * 60);

            return { walk: walkMinutes, car: carMinutes, bus: busMinutes };
        }

        // Formatta tempo in ore e minuti
        function formatTime(minutes) {
            if (minutes < 60) {
                return `${minutes} min`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return mins > 0 ? `${hours}h ${mins}min` : `${hours}h`;
            }
        }

        // Setup event listeners per calcolo distanza
        (function setupDistanceCalculator() {
            const distanceCalculator = document.getElementById('distance-calculator');
            const calculateBtn = document.getElementById('calculate-distance-btn');
            const targetLatInput = document.getElementById('target-lat');
            const targetLngInput = document.getElementById('target-lng');
            const presetButtons = document.querySelectorAll('.distance-preset-btn');
            const distanceResult = document.getElementById('distance-result');
            const distanceInfo = document.getElementById('distance-info');

            if (!distanceCalculator || !calculateBtn) return;

            // Preset citt√† buttons
            presetButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    const lat = parseFloat(this.getAttribute('data-lat'));
                    const lng = parseFloat(this.getAttribute('data-lng'));
                    const name = this.getAttribute('data-name');

                    // Popola inputs
                    targetLatInput.value = lat;
                    targetLngInput.value = lng;

                    // Calcola automaticamente
                    calculateDistanceToTarget(lat, lng, name);
                });
            });

            // Pulsante calcola con input manuale
            calculateBtn.addEventListener('click', function () {
                const lat = parseFloat(targetLatInput.value);
                const lng = parseFloat(targetLngInput.value);

                if (isNaN(lat) || isNaN(lng)) {
                    distanceInfo.innerHTML = `
                        <div style="color: var(--rosso);">
                            <strong>‚ùå Errore:</strong><br>
                            Inserisci coordinate valide (es. 45.6495 per latitudine)
                        </div>
                    `;
                    distanceResult.style.display = 'block';
                    return;
                }

                calculateDistanceToTarget(lat, lng, 'Punto Personalizzato');
            });

            // Funzione per calcolare e mostrare distanza
            function calculateDistanceToTarget(targetLat, targetLng, targetName) {
                if (!lastKnownPosition) {
                    distanceInfo.innerHTML = `
                        <div style="color: var(--rosso);">
                            <strong>‚ùå Errore:</strong><br>
                            Devi prima rilevare la tua posizione GPS
                        </div>
                    `;
                    distanceResult.style.display = 'block';
                    return;
                }

                const myLat = lastKnownPosition.coords.latitude;
                const myLng = lastKnownPosition.coords.longitude;

                // Calcola distanza
                const distanceKm = calculateDistance(myLat, myLng, targetLat, targetLng);
                const distanceM = distanceKm * 1000;

                // Calcola tempi stimati
                const times = estimateTime(distanceKm);

                // Formato distanza
                let distanceText = '';
                if (distanceKm < 1) {
                    distanceText = `${Math.round(distanceM)} metri`;
                } else {
                    distanceText = `${distanceKm.toFixed(2)} km`;
                }

                // Mostra risultato
                distanceInfo.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <strong style="font-size: 1.2rem; color: #f59e0b;">üìè ${distanceText}</strong>
                        <br>
                        <span style="color: #666; font-size: 0.9rem;">distanza in linea d'aria da ${targetName}</span>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <strong style="color: #92400e;">üéØ Da:</strong> ${myLat.toFixed(6)}, ${myLng.toFixed(6)}<br>
                        <strong style="color: #92400e;">üéØ A:</strong> ${targetLat.toFixed(6)}, ${targetLng.toFixed(6)}
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <strong style="color: #374151;">‚è±Ô∏è Tempo Stimato:</strong>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.75rem;">
                        <div style="background: #e0f2fe; padding: 0.75rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem;">üö∂</div>
                            <div style="font-size: 0.85rem; color: #075985; margin-top: 0.25rem;">
                                <strong>${formatTime(times.walk)}</strong><br>
                                <span style="font-size: 0.75rem;">a piedi</span>
                            </div>
                        </div>
                        <div style="background: #dbeafe; padding: 0.75rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem;">üöå</div>
                            <div style="font-size: 0.85rem; color: #1e40af; margin-top: 0.25rem;">
                                <strong>${formatTime(times.bus)}</strong><br>
                                <span style="font-size: 0.75rem;">in bus</span>
                            </div>
                        </div>
                        <div style="background: #dcfce7; padding: 0.75rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem;">üöó</div>
                            <div style="font-size: 0.85rem; color: #166534; margin-top: 0.25rem;">
                                <strong>${formatTime(times.car)}</strong><br>
                                <span style="font-size: 0.75rem;">in auto</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; font-size: 0.85rem; color: #6b7280;">
                        üí° <strong>Nota:</strong> I tempi sono stime indicative basate su velocit√† medie. Il tempo reale pu√≤ variare per traffico, percorso e condizioni stradali.
                    </div>
                `;

                distanceResult.style.display = 'block';
                distanceResult.style.borderLeftColor = '#10b981';
                distanceResult.style.background = 'rgba(16, 185, 129, 0.1)';
            }
        })();

        // ===== BADGE DINAMICO CONNESSIONE MAPPA =====

        (function setupMapConnectionBadge() {
            function updateMapConnectionStatus() {
                const mapBadge = document.getElementById('map-connection-badge');
                const mapIcon = document.getElementById('map-connection-icon');
                const mapText = document.getElementById('map-connection-text');

                // Se elementi non esistono ancora, riprova tra poco
                if (!mapBadge || !mapIcon || !mapText) {
                    console.log('‚è≥ Badge mappa non ancora disponibile, riprovo tra 100ms...');
                    setTimeout(updateMapConnectionStatus, 100);
                    return;
                }

                // Controlla sia navigator.onLine che simulazione offline
                const offlineTest = localStorage.getItem('tpl.offlineTestMode') === 'true';
                const isOnline = navigator.onLine && !offlineTest;

                console.log('üîÑ Aggiornamento badge mappa:', {
                    navigatorOnLine: navigator.onLine,
                    offlineTest,
                    isOnline
                });

                if (isOnline) {
                    // Online
                    mapBadge.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                    mapBadge.style.color = '#065f46';
                    mapBadge.title = '‚úÖ Connessione attiva - Mappa disponibile';
                    mapIcon.textContent = 'üü¢';
                    mapText.textContent = 'Online';
                } else {
                    // Offline
                    mapBadge.style.background = 'linear-gradient(135deg, #fecaca, #fca5a5)';
                    mapBadge.style.color = '#7f1d1d';
                    mapBadge.title = 'üî¥ Nessuna connessione - Tile mappa non disponibili (GPS continua a funzionare)';
                    mapIcon.textContent = 'üî¥';
                    mapText.textContent = offlineTest ? 'Offline (simulato)' : 'Offline';
                }
            }

            // Aggiorna stato iniziale
            updateMapConnectionStatus();

            // Listener eventi online/offline (nativi)
            window.addEventListener('online', updateMapConnectionStatus);
            window.addEventListener('offline', updateMapConnectionStatus);

            // Listener evento simulazione offline (custom)
            window.addEventListener('offlineTestModeChanged', () => {
                console.log('üì° Evento offlineTestModeChanged ricevuto - Aggiorno badge mappa');
                // Piccolo delay per dare tempo a localStorage di aggiornarsi
                setTimeout(updateMapConnectionStatus, 50);
            });
        })();

        // ===== MAPPA INTERATTIVA LEAFLET =====

        // Variabili globali per la mappa
        let map = null;
        let marker = null;
        let accuracyCircle = null;
        let currentMapPosition = null;

        // Inizializza mappa Leaflet
        function initializeMap(lat, lng, accuracy) {
            const mapContainer = document.getElementById('map-container');
            const mapElement = document.getElementById('map');

            if (!mapContainer || !mapElement) return;

            // Mostra container mappa
            mapContainer.style.display = 'block';

            // Se la mappa non esiste, creala
            if (!map) {
                // Crea mappa centrata sulla posizione
                map = L.map('map').setView([lat, lng], 15);

                // Aggiungi tile layer OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    maxZoom: 19,
                    minZoom: 3
                }).addTo(map);

                // Aggiungi marker posizione
                marker = L.marker([lat, lng]).addTo(map);
                marker.bindPopup(`
                    <div style="text-align: center;">
                        <strong style="color: #3b82f6;">üìç La tua posizione</strong><br>
                        <span style="font-size: 0.85rem; color: #666;">
                            ${lat.toFixed(6)}, ${lng.toFixed(6)}
                        </span>
                    </div>
                `);

                // Aggiungi cerchio accuratezza
                accuracyCircle = L.circle([lat, lng], {
                    radius: accuracy,
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.15,
                    weight: 2
                }).addTo(map);

                // Zoom automatico per mostrare tutto il cerchio
                const bounds = accuracyCircle.getBounds();
                map.fitBounds(bounds, { padding: [50, 50] });

                // Setup pulsante ricentra
                const recenterBtn = document.getElementById('recenter-map-btn');
                if (recenterBtn) {
                    recenterBtn.addEventListener('click', () => {
                        if (currentMapPosition) {
                            map.setView([currentMapPosition.lat, currentMapPosition.lng], 15, {
                                animate: true,
                                duration: 0.5
                            });
                        }
                    });
                }

            } else {
                // Mappa esiste gi√†, aggiorna posizione
                map.setView([lat, lng], 15, { animate: true });

                // Aggiorna marker
                if (marker) {
                    marker.setLatLng([lat, lng]);
                    marker.setPopupContent(`
                        <div style="text-align: center;">
                            <strong style="color: #3b82f6;">üìç La tua posizione</strong><br>
                            <span style="font-size: 0.85rem; color: #666;">
                                ${lat.toFixed(6)}, ${lng.toFixed(6)}
                            </span>
                        </div>
                    `);
                }

                // Aggiorna cerchio accuratezza
                if (accuracyCircle) {
                    accuracyCircle.setLatLng([lat, lng]);
                    accuracyCircle.setRadius(accuracy);
                }

                // Zoom automatico
                if (accuracyCircle) {
                    const bounds = accuracyCircle.getBounds();
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }

            // Salva posizione corrente
            currentMapPosition = { lat, lng };

            // Fix per render issues (forza ridisegno)
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 100);
        }

        // RIMOSSO: runAllTests() spostata in js/tests/test-all-wrappers.js
        // La funzione √® ancora disponibile globalmente (window.runAllTests)
        // IMPORTANTE: js/tests/test-all-wrappers.js deve essere caricato PRIMA del DOM per essere disponibile agli onclick

        // Funzione per aggiornare lo status degli effetti
        window.updateEffectsStatus = function() {
            const effectsGrid = document.getElementById('effects-grid');
            if (!effectsGrid) return;

            const isDarkMode = document.documentElement.classList.contains('dark');
            const isMobile = window.innerWidth <= 768;
            const hasAnimationSupport = 'animation' in document.documentElement.style;
            const hasBackdropFilter = CSS.supports('backdrop-filter', 'blur(10px)');
            const hasServiceWorker = 'serviceWorker' in navigator;

            // Rileva gli effetti attivi
            const effects = [
                {
                    id: 'background-animation',
                    icon: 'üåà',
                    title: 'Animazione Background',
                    status: !isMobile ? 'active' : 'inactive',
                    details: isMobile ?
                        'Disabilitata su mobile per performance' :
                        'Gradiente animato (20s) per desktop'
                },
                {
                    id: 'glassmorphism',
                    icon: 'üîÆ',
                    title: 'Effetto Glassmorphism',
                    status: 'active',
                    details: 'Backdrop-filter e trasparenze su tutte le card'
                },
                {
                    id: 'light-refraction',
                    icon: '‚ú®',
                    title: 'Rifrazione Luce',
                    status: !isMobile ? 'active' : 'inactive',
                    details: isMobile ?
                        'Disabilitata su mobile per performance' :
                        'Effetti luce su navbar, card e pulsanti'
                },
                {
                    id: 'smooth-animations',
                    icon: 'üé≠',
                    title: 'Animazioni Fluide',
                    status: hasAnimationSupport ? 'active' : 'inactive',
                    details: 'Transizioni cubic-bezier su elementi interattivi'
                },
                {
                    id: 'dark-mode',
                    icon: isDarkMode ? 'üåô' : '‚òÄÔ∏è',
                    title: 'Modalit√† Scura',
                    status: isDarkMode ? 'active' : 'inactive',
                    details: isDarkMode ?
                        'Tema scuro attivo' :
                        'Tema chiaro attivo'
                },
                {
                    id: 'responsive-design',
                    icon: 'üì±',
                    title: 'Design Responsive',
                    status: 'active',
                    details: `Layout ottimizzato per ${isMobile ? 'mobile' : 'desktop'}`
                },
                {
                    id: 'pwa-features',
                    icon: '‚öôÔ∏è',
                    title: 'Funzionalit√† PWA',
                    status: hasServiceWorker ? 'conditional' : 'inactive',
                    details: hasServiceWorker ?
                        'Service Worker supportato' :
                        'Service Worker non supportato'
                },
                {
                    id: 'accessibility',
                    icon: '‚ôø',
                    title: 'Accessibilit√†',
                    status: 'active',
                    details: 'Font size regolabile, hamburger menu, keyboard navigation'
                }
            ];

            // Popola la griglia
            effectsGrid.innerHTML = effects.map(effect => `
                <div class="effect-card">
                    <div class="effect-header">
                        <span class="effect-icon">${effect.icon}</span>
                        <span class="effect-title">${effect.title}</span>
                        <span class="effect-status ${effect.status}">
                            ${effect.status === 'active' ? '‚úÖ Attivo' :
                    effect.status === 'inactive' ? '‚ùå Inattivo' :
                        '‚ö†Ô∏è Condizionale'}
                        </span>
                    </div>
                    <div class="effect-details">
                        ${effect.details}
                    </div>
                </div>
            `).join('');
        }

        // ===== RILEVAMENTO INFO DEVICE/BROWSER =====
        function detectDeviceInfo() {
            const ua = navigator.userAgent;

            // === Device Type ===
            let deviceType = 'üíª Desktop';
            if (/Mobile|Android|iPhone/i.test(ua)) {
                deviceType = 'üì± Mobile';
            } else if (/Tablet|iPad/i.test(ua)) {
                deviceType = 'üì± Tablet';
            }
            document.getElementById('device-type').textContent = deviceType;

            // === OS ===
            let os = 'Sconosciuto';
            if (/Windows NT 10/i.test(ua)) os = 'ü™ü Windows 10/11';
            else if (/Windows NT 6.3/i.test(ua)) os = 'ü™ü Windows 8.1';
            else if (/Windows NT 6.2/i.test(ua)) os = 'ü™ü Windows 8';
            else if (/Windows NT 6.1/i.test(ua)) os = 'ü™ü Windows 7';
            else if (/Windows/i.test(ua)) os = 'ü™ü Windows';
            else if (/Mac OS X 10[._](\d+)/i.test(ua)) {
                const version = ua.match(/Mac OS X 10[._](\d+)/i)[1];
                os = `üçé macOS 10.${version}`;
            } else if (/Mac/i.test(ua)) os = 'üçé macOS';
            else if (/Android (\d+)/i.test(ua)) {
                const version = ua.match(/Android (\d+)/i)[1];
                os = `ü§ñ Android ${version}`;
            } else if (/Android/i.test(ua)) os = 'ü§ñ Android';
            else if (/iPhone OS (\d+)/i.test(ua)) {
                const version = ua.match(/iPhone OS (\d+)/i)[1];
                os = `üì± iOS ${version}`;
            } else if (/iPad.*OS (\d+)/i.test(ua)) {
                const version = ua.match(/iPad.*OS (\d+)/i)[1];
                os = `üì± iPadOS ${version}`;
            } else if (/Linux/i.test(ua)) os = 'üêß Linux';
            document.getElementById('device-os').textContent = os;

            // === Browser ===
            let browser = 'Sconosciuto';
            if (/Edg\//i.test(ua)) {
                const version = ua.match(/Edg\/(\d+)/i)[1];
                browser = `Edge ${version}`;
            } else if (/Chrome\//i.test(ua) && !/Edg/i.test(ua)) {
                const version = ua.match(/Chrome\/(\d+)/i)[1];
                browser = `Chrome ${version}`;
            } else if (/Firefox\//i.test(ua)) {
                const version = ua.match(/Firefox\/(\d+)/i)[1];
                browser = `Firefox ${version}`;
            } else if (/Safari\//i.test(ua) && !/Chrome/i.test(ua)) {
                const version = ua.match(/Version\/(\d+)/i);
                browser = version ? `Safari ${version[1]}` : 'Safari';
            } else if (/Opera|OPR\//i.test(ua)) {
                browser = 'Opera';
            }
            document.getElementById('device-browser').textContent = browser;


            // Funzione per aggiornare colore card batteria
            function updateBatteryCardColor(level, isCharging, isSupported) {
                const batteryCard = document.getElementById('device-battery')?.closest('.device-info-card');
                if (!batteryCard) return;

                if (!isSupported) {
                    batteryCard.setAttribute('data-color', 'gray');
                } else if (isCharging) {
                    batteryCard.setAttribute('data-color', 'green');
                } else if (level >= 50) {
                    batteryCard.setAttribute('data-color', 'green');
                } else if (level >= 20) {
                    batteryCard.setAttribute('data-color', 'orange');
                } else {
                    batteryCard.setAttribute('data-color', 'red');
                }
            }

            // === Battery ===
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    const level = Math.round(battery.level * 100);
                    const charging = battery.charging ? 'üîå In carica' : 'üîã';
                    const batteryEl = document.getElementById('device-battery');
                    if (batteryEl) {
                        batteryEl.textContent = `${charging} ${level}%`;
                        updateBatteryCardColor(level, battery.charging, true);
                    }

                    // Aggiorna su cambio batteria
                    battery.addEventListener('levelchange', () => {
                        const newLevel = Math.round(battery.level * 100);
                        const newCharging = battery.charging ? 'üîå In carica' : 'üîã';
                        const batteryEl = document.getElementById('device-battery');
                        if (batteryEl) {
                            batteryEl.textContent = `${newCharging} ${newLevel}%`;
                            updateBatteryCardColor(newLevel, battery.charging, true);
                        }
                    });

                    battery.addEventListener('chargingchange', () => {
                        const currentLevel = Math.round(battery.level * 100);
                        const isCharging = battery.charging ? 'üîå In carica' : 'üîã';
                        const batteryEl = document.getElementById('device-battery');
                        if (batteryEl) {
                            batteryEl.textContent = `${isCharging} ${currentLevel}%`;
                            updateBatteryCardColor(currentLevel, battery.charging, true);
                        }
                    });
                });
            } else {
                const batteryEl = document.getElementById('device-battery');
                if (batteryEl) {
                    batteryEl.textContent = 'Non supportato';
                    updateBatteryCardColor(0, false, false);
                }
            }

            // === GPS Support ===
            const hasGPS = 'geolocation' in navigator;
            const gpsEl = document.getElementById('device-gps');
            const gpsCard = gpsEl?.closest('.device-info-card');

            if (gpsEl) {
                gpsEl.textContent = hasGPS ? '‚úÖ Supportato' : '‚ùå Non supportato';
                // Cambia colore card: verde se supportato, grigio se non supportato
                if (gpsCard) {
                    gpsCard.setAttribute('data-color', hasGPS ? 'green' : 'gray');
                }
            }

            // === Dettagli Tecnici ===
            // Touch Support
            const touchSupport = ('ontouchstart' in window || navigator.maxTouchPoints > 0);
            const touchEl = document.getElementById('device-touch');
            const touchCard = touchEl?.closest('.device-info-card');

            if (touchEl) {
                touchEl.textContent = touchSupport ? '‚úÖ S√¨' : '‚ùå No';
                // Cambia colore card: verde se "S√¨", grigio se "No"
                if (touchCard) {
                    touchCard.setAttribute('data-color', touchSupport ? 'green' : 'gray');
                }
            }

            // PWA Mode - funzione per aggiornare stato PWA
            function updatePWAMode() {
                const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                    window.matchMedia('(display-mode: minimal-ui)').matches ||
                    window.matchMedia('(display-mode: fullscreen)').matches ||
                    (window.navigator.standalone === true);
                const pwaEl = document.getElementById('device-pwa');
                const pwaCard = pwaEl?.closest('.device-info-card');

                if (pwaEl) {
                    pwaEl.textContent = isPWA ? '‚úÖ S√¨' : '‚ùå No';
                    // Cambia colore card: verde se "S√¨", grigio se "No"
                    if (pwaCard) {
                        pwaCard.setAttribute('data-color', isPWA ? 'green' : 'gray');
                    }
                }
            }

            // Aggiorna inizialmente
            updatePWAMode();

            // Listener per aggiornare PWA Mode quando cambia display-mode (installazione/disinstallazione)
            // Pesatura: praticamente zero - solo ascolto passivo di eventi
            if (window.matchMedia) {
                const standaloneQuery = window.matchMedia('(display-mode: standalone)');
                const minimalUIQuery = window.matchMedia('(display-mode: minimal-ui)');
                const fullscreenQuery = window.matchMedia('(display-mode: fullscreen)');

                // Ascolta cambiamenti (usando addEventListener se supportato, altrimenti addListener per compatibilit√†)
                if (standaloneQuery.addEventListener) {
                    standaloneQuery.addEventListener('change', updatePWAMode);
                    minimalUIQuery.addEventListener('change', updatePWAMode);
                    fullscreenQuery.addEventListener('change', updatePWAMode);
                } else if (standaloneQuery.addListener) {
                    // Fallback per browser pi√π vecchi
                    standaloneQuery.addListener(updatePWAMode);
                    minimalUIQuery.addListener(updatePWAMode);
                    fullscreenQuery.addListener(updatePWAMode);
                }
            }

            // Ascolta anche eventi di installazione PWA (se supportati)
            window.addEventListener('appinstalled', () => {
                console.log('üì≤ PWA installata - aggiorno stato');
                setTimeout(updatePWAMode, 100); // Piccolo delay per permettere al browser di aggiornare display-mode
            });
        }

        // ===== TEST RAPIDO GPS ONE-CLICK =====
        async function quickGPSTest() {
            const btn = document.getElementById('quick-gps-test-btn');
            const icon = document.getElementById('quick-test-icon');
            const text = document.getElementById('quick-test-text');
            const resultsDiv = document.getElementById('quick-test-results');
            const itemsDiv = document.getElementById('quick-test-items');
            const summaryDiv = document.getElementById('quick-test-summary');

            // Disabilita button e mostra loading
            btn.disabled = true;
            btn.style.opacity = '0.7';
            icon.textContent = '‚è≥';
            text.textContent = 'Test in corso...';

            // Mostra risultati (vuoti per ora)
            resultsDiv.style.display = 'block';
            itemsDiv.innerHTML = '<p style="text-align: center; color: #9ca3af;">Esecuzione test in corso...</p>';
            summaryDiv.innerHTML = '';

            const testResults = [];

            // === TEST 1: Permessi ===
            try {
                const permission = await navigator.permissions.query({ name: 'geolocation' });
                const status = permission.state;
                testResults.push({
                    name: 'Permessi Geolocalizzazione',
                    status: status === 'granted' ? 'success' : (status === 'prompt' ? 'warning' : 'error'),
                    message: status === 'granted' ? 'Permessi concessi' : (status === 'prompt' ? 'Permessi non richiesti' : 'Permessi negati'),
                    icon: status === 'granted' ? 'üü¢' : (status === 'prompt' ? 'üü°' : 'üî¥')
                });
            } catch (e) {
                testResults.push({
                    name: 'Permessi Geolocalizzazione',
                    status: 'warning',
                    message: 'Impossibile verificare permessi',
                    icon: 'üü°'
                });
            }

            // === TEST 2: Supporto GPS ===
            const hasGPS = 'geolocation' in navigator;
            testResults.push({
                name: 'Supporto GPS Hardware',
                status: hasGPS ? 'success' : 'error',
                message: hasGPS ? 'GPS supportato dal browser' : 'GPS non supportato',
                icon: hasGPS ? 'üü¢' : 'üî¥'
            });

            // === TEST 3: Rilevamento Posizione ===
            if (hasGPS) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });

                    const accuracy = position.coords.accuracy;
                    const hasSpeed = position.coords.speed !== null;
                    const hasAltitude = position.coords.altitude !== null;

                    // Valutazione accuratezza
                    let accuracyStatus = 'success';
                    let accuracyMsg = `Eccellente (¬±${accuracy.toFixed(0)}m)`;
                    if (accuracy > 50 && accuracy <= 100) {
                        accuracyStatus = 'warning';
                        accuracyMsg = `Buona (¬±${accuracy.toFixed(0)}m)`;
                    } else if (accuracy > 100) {
                        accuracyStatus = 'warning';
                        accuracyMsg = `Bassa (¬±${accuracy.toFixed(0)}m)`;
                    }

                    testResults.push({
                        name: 'Rilevamento Posizione',
                        status: 'success',
                        message: `Posizione rilevata con successo`,
                        icon: 'üü¢'
                    });

                    testResults.push({
                        name: 'Accuratezza GPS',
                        status: accuracyStatus,
                        message: accuracyMsg,
                        icon: accuracyStatus === 'success' ? 'üü¢' : 'üü°'
                    });

                    testResults.push({
                        name: 'Dati Avanzati (Velocit√†/Altitudine)',
                        status: (hasSpeed || hasAltitude) ? 'success' : 'warning',
                        message: hasSpeed && hasAltitude ? 'Velocit√† e altitudine disponibili' :
                            hasSpeed ? 'Solo velocit√† disponibile' :
                                hasAltitude ? 'Solo altitudine disponibile' :
                                    'Dati non disponibili (normale su alcuni device)',
                        icon: (hasSpeed || hasAltitude) ? 'üü¢' : 'üü°'
                    });

                    // === TEST 4: Reverse Geocoding ===
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&zoom=18&addressdetails=1`);
                        if (response.ok) {
                            const data = await response.json();
                            testResults.push({
                                name: 'Reverse Geocoding (API Nominatim)',
                                status: 'success',
                                message: `Indirizzo trovato: ${data.display_name || 'N/A'}`.substring(0, 80) + '...',
                                icon: 'üü¢'
                            });
                        } else {
                            testResults.push({
                                name: 'Reverse Geocoding (API Nominatim)',
                                status: 'warning',
                                message: 'API non risponde correttamente',
                                icon: 'üü°'
                            });
                        }
                    } catch (e) {
                        testResults.push({
                            name: 'Reverse Geocoding (API Nominatim)',
                            status: 'warning',
                            message: navigator.onLine ? 'Errore API' : 'Offline - Funzione non disponibile',
                            icon: 'üü°'
                        });
                    }

                    // === TEST 5: Libreria Mappa (Leaflet) ===
                    const hasLeaflet = typeof L !== 'undefined';
                    testResults.push({
                        name: 'Libreria Mappa (Leaflet.js)',
                        status: hasLeaflet ? 'success' : 'error',
                        message: hasLeaflet ? 'Leaflet caricato correttamente' : 'Leaflet non disponibile',
                        icon: hasLeaflet ? 'üü¢' : 'üî¥'
                    });

                } catch (error) {
                    testResults.push({
                        name: 'Rilevamento Posizione',
                        status: 'error',
                        message: error.code === 1 ? 'Permesso negato dall\'utente' :
                            error.code === 2 ? 'Posizione non disponibile' :
                                error.code === 3 ? 'Timeout richiesta' :
                                    'Errore sconosciuto',
                        icon: 'üî¥'
                    });
                }
            }

            // === RENDER RISULTATI ===
            itemsDiv.innerHTML = testResults.map(result => `
                <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem; background: ${result.status === 'success' ? '#f0fdf4' :
                    result.status === 'warning' ? '#fef3c7' :
                        '#fee2e2'
                }; border-radius: 8px; border-left: 4px solid ${result.status === 'success' ? '#10b981' :
                    result.status === 'warning' ? '#f59e0b' :
                        '#ef4444'
                };">
                    <div style="font-size: 1.5rem; flex-shrink: 0;">${result.icon}</div>
                    <div style="flex: 1;">
                        <strong style="color: #374151;">${result.name}</strong>
                        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.9rem;">${result.message}</p>
                    </div>
                </div>
            `).join('');

            // === SUMMARY ===
            const successCount = testResults.filter(r => r.status === 'success').length;
            const warningCount = testResults.filter(r => r.status === 'warning').length;
            const errorCount = testResults.filter(r => r.status === 'error').length;
            const total = testResults.length;

            let summaryColor, summaryIcon, summaryText;
            if (errorCount === 0 && warningCount === 0) {
                summaryColor = '#10b981';
                summaryIcon = '‚úÖ';
                summaryText = 'Tutti i test superati! GPS completamente funzionante!';
            } else if (errorCount === 0) {
                summaryColor = '#f59e0b';
                summaryIcon = '‚ö†Ô∏è';
                summaryText = `${successCount}/${total} test superati. Alcune funzioni potrebbero avere limitazioni.`;
            } else {
                summaryColor = '#ef4444';
                summaryIcon = '‚ùå';
                summaryText = `${errorCount} errori critici. Verifica configurazione GPS.`;
            }

            summaryDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem; color: ${summaryColor};">
                    <span style="font-size: 1.5rem;">${summaryIcon}</span>
                    <span>${summaryText}</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #6b7280; font-weight: normal;">
                    üü¢ ${successCount} successi ¬∑ üü° ${warningCount} avvisi ¬∑ üî¥ ${errorCount} errori
                </div>
            `;

            // Ripristina button
            btn.disabled = false;
            btn.style.opacity = '1';
            icon.textContent = 'üîÑ';
            text.textContent = 'Ripeti Test';
        }

        // ===== EXPORT REPORT GPS =====
        async function exportGPSReport(format) {
            const reportData = {
                timestamp: new Date().toISOString(),
                timestampReadable: new Date().toLocaleString('it-IT'),
                device: {
                    type: document.getElementById('device-type')?.textContent || 'N/A',
                    os: document.getElementById('device-os')?.textContent || 'N/A',
                    browser: document.getElementById('device-browser')?.textContent || 'N/A',
                    battery: document.getElementById('device-battery')?.textContent || 'N/A',
                    gpsSupport: document.getElementById('device-gps')?.textContent || 'N/A',
                    viewport: document.getElementById('device-viewport')?.textContent || 'N/A',
                    touchSupport: document.getElementById('device-touch')?.textContent || 'N/A',
                    pwaMode: document.getElementById('device-pwa')?.textContent || 'N/A',
                    userAgent: navigator.userAgent
                },
                gps: {
                    permissionStatus: document.getElementById('geo-permission-text')?.textContent || 'N/A',
                    lastPosition: null,
                    fakePositionActive: localStorage.getItem('tpl.useFakePosition') === 'true',
                    fakePositionData: localStorage.getItem('tpl.fakePositionData') ?
                        JSON.parse(localStorage.getItem('tpl.fakePositionData')) : null
                }
            };

            // Prova a ottenere posizione corrente
            if ('geolocation' in navigator) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 60000
                        });
                    });

                    reportData.gps.lastPosition = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude,
                        altitudeAccuracy: position.coords.altitudeAccuracy,
                        heading: position.coords.heading,
                        speed: position.coords.speed,
                        timestamp: new Date(position.timestamp).toLocaleString('it-IT')
                    };
                } catch (e) {
                    reportData.gps.lastPosition = { error: 'Impossibile rilevare posizione' };
                }
            }

            // Genera file
            let content, filename, mimeType;

            if (format === 'json') {
                content = JSON.stringify(reportData, null, 2);
                filename = `gps-report-${Date.now()}.json`;
                mimeType = 'application/json';
            } else {
                // Formato TXT
                content = `
========================================
  üìç REPORT TEST GPS - TPL FVG
========================================

Data e Ora: ${reportData.timestampReadable}

========================================
  üì± INFORMAZIONI DEVICE
========================================

Device Type:        ${reportData.device.type}
Sistema Operativo:  ${reportData.device.os}
Browser:            ${reportData.device.browser}
Batteria:           ${reportData.device.battery}
Supporto GPS:       ${reportData.device.gpsSupport}

Screen:             ${reportData.device.screen}
Viewport:           ${reportData.device.viewport}
Pixel Ratio:        ${reportData.device.pixelRatio}
Touch Support:      ${reportData.device.touchSupport}
PWA Mode:           ${reportData.device.pwaMode}

User Agent:
${reportData.device.userAgent}

========================================
  üõ∞Ô∏è INFORMAZIONI GPS
========================================

Permission Status:  ${reportData.gps.permissionStatus}
Fake Position:      ${reportData.gps.fakePositionActive ? 'Attiva' : 'Inattiva'}

${reportData.gps.lastPosition && !reportData.gps.lastPosition.error ? `
--- ULTIMA POSIZIONE ---
Latitudine:         ${reportData.gps.lastPosition.latitude}¬∞
Longitudine:        ${reportData.gps.lastPosition.longitude}¬∞
Accuratezza:        ¬±${reportData.gps.lastPosition.accuracy}m
Altitudine:         ${reportData.gps.lastPosition.altitude !== null ? reportData.gps.lastPosition.altitude + 'm' : 'N/A'}
Velocit√†:           ${reportData.gps.lastPosition.speed !== null ? (reportData.gps.lastPosition.speed * 3.6).toFixed(1) + ' km/h' : 'N/A'}
Direzione:          ${reportData.gps.lastPosition.heading !== null ? reportData.gps.lastPosition.heading + '¬∞' : 'N/A'}
Timestamp:          ${reportData.gps.lastPosition.timestamp}
` : `
--- ULTIMA POSIZIONE ---
${reportData.gps.lastPosition?.error || 'Non disponibile'}
`}

${reportData.gps.fakePositionActive && reportData.gps.fakePositionData ? `
--- FAKE POSITION DATA ---
${JSON.stringify(reportData.gps.fakePositionData, null, 2)}
` : ''}

========================================
  üìä FINE REPORT
========================================
                `.trim();
                filename = `gps-report-${Date.now()}.txt`;
                mimeType = 'text/plain';
            }

            // Download file
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Feedback visivo
            const btn = format === 'json' ? document.getElementById('export-json-btn') : document.getElementById('export-txt-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Scaricato!';
            btn.disabled = true;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        }

        // ===== RESET DATI GPS =====
        function showResetModal() {
            const modal = document.getElementById('reset-modal-overlay');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Previeni scroll durante modal
        }

        function hideResetModal() {
            const modal = document.getElementById('reset-modal-overlay');
            modal.style.display = 'none';
            document.body.style.overflow = ''; // Ripristina scroll
        }

        function confirmResetGPS() {
            // Nascondi modal
            hideResetModal();

            const btn = document.getElementById('reset-gps-btn');
            const originalText = btn.innerHTML;

            // Mostra loading
            btn.innerHTML = '‚è≥ Reset...';
            btn.disabled = true;

            // Lista chiavi da cancellare
            const gpsKeys = [
                'tpl.useFakePosition',
                'tpl.fakePositionData',
                'tpl.offlineTestMode'
            ];

            // Cancella localStorage
            gpsKeys.forEach(key => {
                localStorage.removeItem(key);
            });

            // Feedback successo
            btn.innerHTML = '‚úÖ Reset Completato!';
            btn.style.background = '#10b981';

            // Ricarica pagina dopo 1.5 secondi
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        // ===== LISTENER DOM CONTENT LOADED =====
        window.addEventListener('DOMContentLoaded', () => {
            // Inizializza info device
            detectDeviceInfo();

            // Inizializza statistiche e effetti
            TestUtils.updateStats();
            updateEffectsStatus();

            // Event listener per test geolocalizzazione
            const testLocationBtn = document.getElementById('test-location-btn');
            if (testLocationBtn) {
                testLocationBtn.addEventListener('click', testGeolocation);
            }

            // Event listener per test rapido GPS
            const quickTestBtn = document.getElementById('quick-gps-test-btn');
            if (quickTestBtn) {
                quickTestBtn.addEventListener('click', quickGPSTest);
            }

            // Event listener per export report
            const exportJsonBtn = document.getElementById('export-json-btn');
            if (exportJsonBtn) {
                exportJsonBtn.addEventListener('click', () => exportGPSReport('json'));
            }

            const exportTxtBtn = document.getElementById('export-txt-btn');
            if (exportTxtBtn) {
                exportTxtBtn.addEventListener('click', () => exportGPSReport('txt'));
            }

            // Event listener per reset dati GPS
            const resetGpsBtn = document.getElementById('reset-gps-btn');
            if (resetGpsBtn) {
                resetGpsBtn.addEventListener('click', showResetModal);
            }

            // Event listener per pulsanti modal reset
            const resetModalCancel = document.getElementById('reset-modal-cancel');
            if (resetModalCancel) {
                resetModalCancel.addEventListener('click', hideResetModal);
            }

            const resetModalConfirm = document.getElementById('reset-modal-confirm');
            if (resetModalConfirm) {
                resetModalConfirm.addEventListener('click', confirmResetGPS);
            }

            // Chiudi modal cliccando sull'overlay
            const resetModalOverlay = document.getElementById('reset-modal-overlay');
            if (resetModalOverlay) {
                resetModalOverlay.addEventListener('click', (e) => {
                    if (e.target === resetModalOverlay) {
                        hideResetModal();
                    }
                });
            }

            // Chiudi modal con tasto ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && resetModalOverlay && resetModalOverlay.style.display === 'block') {
                    hideResetModal();
                }
            });

            // Aggiorna l'anno nel footer
            const footerYear = document.getElementById('footer-year');
            if (footerYear) footerYear.textContent = new Date().getFullYear();

            // Aggiorna effetti quando cambia la modalit√†
            const darkModeToggle = document.getElementById('darkmode-toggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    setTimeout(updateEffectsStatus, 100); // Aspetta che il cambio modalit√† sia completato
                });
            }
        });

        // Aggiorna effetti quando cambia la dimensione schermo
        window.addEventListener('resize', () => {
            setTimeout(updateEffectsStatus, 100);
        });

        // Funzione scroll to top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Mostra/nascondi pulsante scroll to top
        function toggleScrollToTopButton() {
            const scrollButton = document.querySelector('.scroll-to-top');
            if (scrollButton) {
                if (window.pageYOffset > 300) {
                    scrollButton.classList.add('visible');
                } else {
                    scrollButton.classList.remove('visible');
                }
            }
        }

        // Event listener per lo scroll
        window.addEventListener('scroll', toggleScrollToTopButton);
        
        // Verifica iniziale al caricamento
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', toggleScrollToTopButton);
        } else {
            toggleScrollToTopButton();
        }

        // ===== MEGA DROPDOWN IMPOSTAZIONI (OPZIONE C) =====
        (function () {
            const dropdownBtn = document.getElementById('test-settings-dropdown-btn');
            const dropdown = document.getElementById('test-settings-dropdown');

            if (!dropdownBtn || !dropdown) return;

            // Toggle dropdown
            dropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isActive = dropdown.classList.contains('show');

                if (isActive) {
                    closeDropdown();
                } else {
                    openDropdown();
                }
            });

            function openDropdown() {
                dropdown.classList.add('show');
                dropdownBtn.classList.add('active');
            }

            function closeDropdown() {
                dropdown.classList.remove('show');
                dropdownBtn.classList.remove('active');
            }

            // Chiudi dropdown quando si clicca fuori
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && !dropdownBtn.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Gestione tema
            const themeRadios = document.querySelectorAll('input[name="test-theme"]');
            themeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const themeToggle = document.getElementById('darkmode-toggle');
                    if (themeToggle) {
                        if (radio.value === 'dark') {
                            document.body.classList.add('dark');
                        } else if (radio.value === 'light') {
                            document.body.classList.remove('dark');
                        } else {
                            // Sistema - segue preferenze dispositivo
                            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                document.body.classList.add('dark');
                            } else {
                                document.body.classList.remove('dark');
                            }
                        }
                    }
                });
            });

            // Gestione animazione sfondo
            const animationToggle = document.getElementById('test-animation-toggle');
            if (animationToggle) {
                animationToggle.addEventListener('change', () => {
                    const realToggle = document.getElementById('animationToggle');
                    if (realToggle) {
                        realToggle.click();
                    }
                });
            }

            // Gestione alto contrasto
            const highContrastToggle = document.getElementById('test-high-contrast');
            if (highContrastToggle) {
                highContrastToggle.addEventListener('change', () => {
                    document.body.classList.toggle('high-contrast', highContrastToggle.checked);
                });
            }

            // Gestione font size
            const fontButtons = dropdown.querySelectorAll('.dropdown-font-btn');
            fontButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const size = btn.dataset.size;

                    // Rimuovi active da tutti
                    fontButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Applica la dimensione
                    const realBtns = document.querySelectorAll('.font-size-btn');
                    realBtns.forEach(realBtn => {
                        if (realBtn.dataset.size === size) {
                            realBtn.click();
                        }
                    });
                });
            });

            // Gestione azioni rapide
            const openSettingsModalBtn = document.getElementById('test-open-settings-modal');
            if (openSettingsModalBtn) {
                openSettingsModalBtn.addEventListener('click', async () => {
                    closeDropdown();
                    // Usa la funzione pubblica SettingsModal che gestisce il caricamento dinamico
                    if (typeof window.SettingsModal !== 'undefined' && window.SettingsModal.open && typeof window.Settings !== 'undefined') {
                        try {
                            // Assicurati che il modal sia inizializzato prima di aprirlo
                            const modal = document.getElementById('settings-modal');
                            if (modal && !modal.dataset.initialized) {
                                console.log('üîß Inizializzazione SettingsModal dal dropdown...');
                                await window.SettingsModal.initialize({
                                    setThemeMode: window.Settings.setThemeMode || null,
                                    toggleAnimation: window.Settings.toggleAnimation || null,
                                    setHighContrast: window.Settings.setHighContrast || null,
                                    setTouchFriendly: window.Settings.setTouchFriendly || null,
                                    setHapticFeedback: window.Settings.setHapticFeedback || null,
                                    setReduceMotion: window.Settings.setReduceMotion || null,
                                    setKeepScreenOn: window.Settings.setKeepScreenOn || null,
                                    setExtraSpacing: window.Settings.setExtraSpacing || null,
                                    setCompactLayout: window.Settings.setCompactLayout || null,
                                    setBlueLightFilter: window.Settings.setBlueLightFilter || null,
                                    setInterfaceScale: window.Settings.setInterfaceScale || null,
                                    setFontSize: window.Settings.setFontSize || null,
                                    triggerHaptic: window.Settings.triggerHaptic || null,
                                    onCloseMobileMenu: () => {}
                                });
                            }
                            
                            // Apri il modal usando la funzione pubblica
                            await window.SettingsModal.open();
                        } catch (error) {
                            console.error('‚ùå Errore nell\'apertura del modal:', error);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è SettingsModal o Settings non disponibili!');
                    }
                });
            }

            const checkUpdatesBtn = document.getElementById('test-check-updates');
            if (checkUpdatesBtn) {
                checkUpdatesBtn.addEventListener('click', () => {
                    const cacheResetBtn = document.getElementById('cache-reset');
                    if (cacheResetBtn) {
                        cacheResetBtn.click();
                    }
                    closeDropdown();
                });
            }

            const clearCacheBtn = document.getElementById('test-clear-cache');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', () => {
                    const cacheResetBtn = document.getElementById('cache-reset');
                    if (cacheResetBtn) {
                        cacheResetBtn.click();
                    }
                    closeDropdown();
                });
            }
        })();
    </script>

    <script>
        // Aspetta che il DOM sia pronto
        document.addEventListener('DOMContentLoaded', () => {
            renderChangelog('changelog-container');
        });
    </script>

    <!-- Script Rilevamento Display - Spostato in js/utils/display-detector.js -->
    <script src="js/utils/display-detector.js"></script>

    <!-- Script Monitoraggio Connessione - Spostato in js/utils/connection-monitor.js -->
    <script src="js/utils/connection-monitor.js"></script>

    <script>
        // ===== INIZIALIZZAZIONE SETTINGS MODAL =====
        // Inizializza SettingsModal all'avvio per gestire correttamente il pulsante mobile
        async function initSettingsModal() {
            // Funzione per chiudere il menu mobile
            function closeMobileMenu() {
                const mobileMenu = document.getElementById('mobile-menu');
                const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
                const hamburgerToggle = document.getElementById('hamburger-toggle');
                
                if (mobileMenu) mobileMenu.classList.remove('active');
                if (mobileMenuOverlay) mobileMenuOverlay.classList.remove('active');
                if (hamburgerToggle) hamburgerToggle.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Nota: Le funzioni loadSettingsModalHTML() e initializeModalDirectly() sono state rimosse
            // perch√© ora usiamo sempre SettingsModal.loadHTML() e SettingsModal.initialize() da modals.js

            // Funzione per aprire il modal (usa sempre SettingsModal se disponibile)
            async function openSettingsDirect() {
                console.log('üîò Click su pulsante Impostazioni');
                closeMobileMenu();
                
                // Assicurati che SettingsModal e Settings siano disponibili
                if (typeof window.SettingsModal === 'undefined' || typeof window.Settings === 'undefined') {
                    console.warn('‚ö†Ô∏è SettingsModal o Settings non ancora disponibili, attendo...', {
                        SettingsModal: typeof window.SettingsModal,
                        Settings: typeof window.Settings
                    });
                    // Attendi fino a 3 secondi (30 tentativi x 100ms)
                    let attempts = 0;
                    const maxAttempts = 30;
                    while ((typeof window.SettingsModal === 'undefined' || typeof window.Settings === 'undefined') && attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                        if (attempts % 5 === 0) {
                            console.log(`‚è≥ Attesa... tentativo ${attempts}/${maxAttempts}`, {
                                SettingsModal: typeof window.SettingsModal,
                                Settings: typeof window.Settings
                            });
                        }
                    }
                    
                    if (typeof window.SettingsModal === 'undefined' || typeof window.Settings === 'undefined') {
                        console.error('‚ùå SettingsModal o Settings non disponibili dopo attesa', {
                            SettingsModal: typeof window.SettingsModal,
                            Settings: typeof window.Settings
                        });
                        return;
                    }
                    console.log('‚úÖ SettingsModal e Settings ora disponibili dopo attesa');
                }
                
                // Assicurati che il modal sia inizializzato
                const modal = document.getElementById('settings-modal');
                if (modal && !modal.dataset.initialized) {
                    console.log('üîß Modal non inizializzato, inizializzo ora...');
                    try {
                        await window.SettingsModal.initialize({
                            setThemeMode: window.Settings.setThemeMode || null,
                            toggleAnimation: window.Settings.toggleAnimation || null,
                            setHighContrast: window.Settings.setHighContrast || null,
                            setTouchFriendly: window.Settings.setTouchFriendly || null,
                            setHapticFeedback: window.Settings.setHapticFeedback || null,
                            setReduceMotion: window.Settings.setReduceMotion || null,
                            setKeepScreenOn: window.Settings.setKeepScreenOn || null,
                            setExtraSpacing: window.Settings.setExtraSpacing || null,
                            setCompactLayout: window.Settings.setCompactLayout || null,
                            setBlueLightFilter: window.Settings.setBlueLightFilter || null,
                            setInterfaceScale: window.Settings.setInterfaceScale || null,
                            setFontSize: window.Settings.setFontSize || null,
                            triggerHaptic: window.Settings.triggerHaptic || null,
                            onCloseMobileMenu: closeMobileMenu
                        });
                        console.log('‚úÖ Modal inizializzato');
                    } catch (error) {
                        console.error('‚ùå Errore nell\'inizializzazione:', error);
                    }
                }
                
                // Apri il modal usando SettingsModal
                try {
                    await window.SettingsModal.open();
                } catch (error) {
                    console.error('‚ùå Errore nell\'apertura del modal:', error);
                }
            }

            // Aggiungi listener diretto al pulsante come fallback
            const openSettingsBtn = document.getElementById('open-settings');
            if (openSettingsBtn && !openSettingsBtn.dataset.listenerAdded) {
                console.log('‚úÖ Aggiungo listener diretto al pulsante open-settings');
                openSettingsBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    await openSettingsDirect();
                });
                openSettingsBtn.dataset.listenerAdded = 'true';
            }

            // Prova ad inizializzare SettingsModal (massimo 10 tentativi per evitare loop infinito)
            let retryCount = 0;
            const maxRetries = 10;
            
            function tryInitSettingsModal() {
                if (retryCount >= maxRetries) {
                    console.warn('‚ö†Ô∏è SettingsModal non disponibile dopo', maxRetries, 'tentativi. Il listener diretto funzioner√† comunque.');
                    return;
                }
                
                if (typeof window.SettingsModal !== 'undefined' && typeof window.Settings !== 'undefined') {
                    try {
                        console.log('üîß Inizializzazione SettingsModal per test.html...');
                        window.SettingsModal.initialize({
                            setThemeMode: window.Settings.setThemeMode || null,
                            toggleAnimation: window.Settings.toggleAnimation || null,
                            setHighContrast: window.Settings.setHighContrast || null,
                            setTouchFriendly: window.Settings.setTouchFriendly || null,
                            setHapticFeedback: window.Settings.setHapticFeedback || null,
                            setReduceMotion: window.Settings.setReduceMotion || null,
                            setKeepScreenOn: window.Settings.setKeepScreenOn || null,
                            setExtraSpacing: window.Settings.setExtraSpacing || null,
                            setCompactLayout: window.Settings.setCompactLayout || null,
                            setBlueLightFilter: window.Settings.setBlueLightFilter || null,
                            setInterfaceScale: window.Settings.setInterfaceScale || null,
                            setFontSize: window.Settings.setFontSize || null,
                            triggerHaptic: window.Settings.triggerHaptic || null,
                            onCloseMobileMenu: closeMobileMenu
                        }).then(() => {
                            console.log('‚úÖ SettingsModal inizializzato correttamente');
                        }).catch((error) => {
                            console.error('‚ùå Errore nell\'inizializzazione SettingsModal:', error);
                        });
                    } catch (error) {
                        console.error('‚ùå Errore nell\'inizializzazione SettingsModal:', error);
                    }
                } else {
                    retryCount++;
                    if (retryCount < maxRetries) {
                        setTimeout(tryInitSettingsModal, 200);
                    }
                }
            }
            
            tryInitSettingsModal();
        }

        // ===== INIZIALIZZAZIONE MODALE AGGIORNAMENTI =====
        function initCacheModal() {
            const cacheCancelBtn = document.getElementById('cache-cancel');
            const cacheConfirmBtn = document.getElementById('cache-confirm');
            const cacheModal = document.getElementById('cache-modal');

            if (!cacheModal) {
                console.warn('‚ö†Ô∏è Modal cache-modal non trovato');
                return false;
            }

            // Listener per pulsante Annulla
            if (cacheCancelBtn && !cacheCancelBtn.dataset.listenerAdded) {
                cacheCancelBtn.addEventListener('click', () => {
                    if (typeof window.Updates !== 'undefined' && typeof window.Updates.cancelResetCache === 'function') {
                        window.Updates.cancelResetCache();
                    } else {
                        // Fallback diretto
                        cacheModal.style.display = 'none';
                    }
                });
                cacheCancelBtn.dataset.listenerAdded = 'true';
                console.log('‚úÖ Listener aggiunto a cache-cancel');
            }

            // Listener per pulsante Conferma
            if (cacheConfirmBtn && !cacheConfirmBtn.dataset.listenerAdded) {
                cacheConfirmBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const buttonText = cacheConfirmBtn.textContent.trim();
                    console.log('üîò Pulsante cache-confirm cliccato:', buttonText);
                    
                    // Sia "Aggiorna Ora" che "Riavvia App" fanno reset completo della cache
                    if (typeof window.Updates !== 'undefined' && typeof window.Updates.confirmResetCache === 'function') {
                        console.log('‚úÖ Chiamata a Updates.confirmResetCache()');
                        try {
                            window.Updates.confirmResetCache();
                        } catch (error) {
                            console.error('‚ùå Errore in confirmResetCache:', error);
                            // Fallback: riavvia direttamente
                            window.location.reload();
                        }
                    } else {
                        console.error('‚ùå Updates.confirmResetCache non disponibile, uso fallback');
                        // Fallback: riavvia direttamente
                        window.location.reload();
                    }
                });
                cacheConfirmBtn.dataset.listenerAdded = 'true';
                console.log('‚úÖ Listener aggiunto a cache-confirm');
            }

            // Chiudi modal cliccando fuori
            if (!cacheModal.dataset.overlayListenerAdded) {
                cacheModal.addEventListener('click', (e) => {
                    if (e.target === cacheModal) {
                        if (typeof window.Updates !== 'undefined' && typeof window.Updates.cancelResetCache === 'function') {
                            window.Updates.cancelResetCache();
                        } else {
                            cacheModal.style.display = 'none';
                        }
                    }
                });
                cacheModal.dataset.overlayListenerAdded = 'true';
                console.log('‚úÖ Listener overlay aggiunto a cache-modal');
            }

            // Chiudi modal con ESC
            const escHandler = (e) => {
                if (e.key === 'Escape' && cacheModal && cacheModal.style.display === 'block') {
                    if (typeof window.Updates !== 'undefined' && typeof window.Updates.cancelResetCache === 'function') {
                        window.Updates.cancelResetCache();
                    } else {
                        cacheModal.style.display = 'none';
                    }
                }
            };
            document.addEventListener('keydown', escHandler);

            console.log('‚úÖ Modale aggiornamenti inizializzato');
            return true;
        }

        // ===== INIZIALIZZAZIONE HAMBURGER MENU =====
        // Assicura che il hamburger menu funzioni anche se script.js viene caricato prima del DOM
        function initHamburgerMenu() {
            const hamburgerToggle = document.getElementById('hamburger-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
            const mobileMenuClose = document.getElementById('mobile-menu-close');

            if (!hamburgerToggle || !mobileMenu || !mobileMenuOverlay) {
                return false;
            }

            // Funzioni per aprire/chiudere menu
            function openMenu() {
                hamburgerToggle.classList.add('active');
                mobileMenu.classList.add('active');
                mobileMenuOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeMenu() {
                hamburgerToggle.classList.remove('active');
                mobileMenu.classList.remove('active');
                mobileMenuOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Verifica se gli event listener sono gi√† stati aggiunti (da script.js)
            // Se il pulsante ha gi√† un listener, non aggiungerne altri per evitare duplicati
            let hasListener = false;
            const testEvent = new Event('test');
            try {
                hamburgerToggle.dispatchEvent(testEvent);
                // Se non ci sono errori, potrebbe avere listener, ma non possiamo verificarlo facilmente
                // Quindi aggiungiamo sempre i listener con { once: false } e gestiamo i duplicati
            } catch (e) {
                // Ignora
            }

            // Aggiungi listener solo se non sono gi√† presenti
            // Usa una flag per evitare listener multipli
            if (!hamburgerToggle.dataset.listenerAdded) {
                hamburgerToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const menu = document.getElementById('mobile-menu');
                    if (menu && menu.classList.contains('active')) {
                        closeMenu();
                    } else {
                        openMenu();
                    }
                }, { once: false });
                hamburgerToggle.dataset.listenerAdded = 'true';
            }

            // Click su X per chiudere
            if (mobileMenuClose && !mobileMenuClose.dataset.listenerAdded) {
                mobileMenuClose.addEventListener('click', closeMenu, { once: false });
                mobileMenuClose.dataset.listenerAdded = 'true';
            }

            // Click su overlay per chiudere
            if (!mobileMenuOverlay.dataset.listenerAdded) {
                mobileMenuOverlay.addEventListener('click', closeMenu, { once: false });
                mobileMenuOverlay.dataset.listenerAdded = 'true';
            }

            // Chiudi menu quando si clicca su un link (escludi il pulsante Impostazioni che ha comportamento speciale)
            const mobileNavLinks = document.querySelectorAll('.mobile-nav-link:not(#open-settings)');
            mobileNavLinks.forEach(link => {
                if (!link.dataset.listenerAdded) {
                    link.addEventListener('click', closeMenu, { once: false });
                    link.dataset.listenerAdded = 'true';
                }
            });

            return true;
        }

        // Prova ad inizializzare immediatamente se il DOM √® gi√† pronto
        function initAll() {
            if (initHamburgerMenu()) {
                console.log('‚úÖ Hamburger menu inizializzato');
            }
            
            // Inizializza modale aggiornamenti
            if (initCacheModal()) {
                console.log('‚úÖ Modale aggiornamenti inizializzato');
            }
            
            // Inizializza SettingsModal (gestisce automaticamente il pulsante mobile)
            // Aspetta che modals.js sia caricato
            setTimeout(() => {
                initSettingsModal();
            }, 200);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                // Delay pi√π lungo per assicurarsi che modals.js sia caricato
                setTimeout(initAll, 100);
            });
        } else {
            // DOM gi√† pronto, ma aspetta un attimo per gli script
            setTimeout(initAll, 100);
        }

        // ===== ANIMAZIONE HEADER (Database & LocalStorage) =====
        // L'animazione shrink/expand dell'header √® gestita automaticamente da js/features/tests-ui.js
        console.log('‚ÑπÔ∏è Animazione header gestita da tests-ui.js');

        // ===== ANIMAZIONE SOBRIA GRUPPI TEST =====
        // Animazione subtile quando si clicca per aprire/chiudere i gruppi
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üé® Inizializzazione animazioni sobrie gruppi test');
            
            // Seleziona tutti i gruppi
            document.querySelectorAll('.test-group-separator').forEach(group => {
                const header = group.querySelector('.test-group-header');
                if (!header) return;
                
                header.addEventListener('click', function(e) {
                    // Non animare se si clicca sul pulsante test singolo
                    if (e.target.closest('.test-run-single')) {
                        return;
                    }
                    
                    const content = group.querySelector('.test-group-content');
                    const isExpanding = !content.classList.contains('expanded');
                    
                    // Animazione press (sempre)
                    group.classList.remove('clicking');
                    void group.offsetHeight; // Forza reflow
                    group.classList.add('clicking');
                    
                    setTimeout(() => {
                        group.classList.remove('clicking');
                    }, 200);
                    
                    // Animazione highlight (solo quando si apre)
                    if (isExpanding) {
                        group.classList.remove('opening');
                        void group.offsetHeight;
                        group.classList.add('opening');
                        
                        setTimeout(() => {
                            group.classList.remove('opening');
                        }, 300);
                    }
                });
            });
            
            console.log('‚úÖ Animazioni sobrie applicate a', document.querySelectorAll('.test-group-separator').length, 'gruppi');
        });
    </script>

    <!-- TOC Sidebar JavaScript - Highlight dinamico durante scroll -->
    <script>
        (function initTOCSidebar() {
            const sidebar = document.getElementById('toc-sidebar');
            const sidebarLinks = sidebar?.querySelectorAll('.toc-sidebar-link');
            const sections = [];

            if (!sidebar || !sidebarLinks || sidebarLinks.length === 0) {
                return;
            }

            // Raccogli tutte le sezioni
            sidebarLinks.forEach(link => {
                const sectionId = link.getAttribute('data-section');
                const section = document.getElementById(sectionId);
                if (section) {
                    sections.push({ link, section, id: sectionId });
                }
            });

            // Smooth scroll per i link della sidebar
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const targetId = link.getAttribute('href');
                    const target = document.querySelector(targetId);
                    if (target) {
                        e.preventDefault();
                        const offset = 80; // Offset per navbar
                        const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - offset;
                        
                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                        
                        // Aggiorna URL senza ricaricare
                        try {
                            history.replaceState(null, '', targetId);
                        } catch {}
                    }
                });
            });

            // Intersection Observer per highlight dinamico
            const observerOptions = {
                root: null,
                rootMargin: '-20% 0px -60% 0px', // Trigger quando sezione √® nel terzo superiore della viewport
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const sectionId = entry.target.id;
                        const correspondingLink = sidebar.querySelector(`[data-section="${sectionId}"]`);
                        
                        if (correspondingLink) {
                            // Rimuovi active da tutti i link
                            sidebarLinks.forEach(l => l.classList.remove('active'));
                            // Aggiungi active al link corrispondente
                            correspondingLink.classList.add('active');
                            
                            // Scroll della sidebar per mantenere il link visibile
                            const linkRect = correspondingLink.getBoundingClientRect();
                            const sidebarRect = sidebar.getBoundingClientRect();
                            
                            if (linkRect.top < sidebarRect.top || linkRect.bottom > sidebarRect.bottom) {
                                correspondingLink.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'nearest',
                                    inline: 'nearest'
                                });
                            }
                        }
                    }
                });
            }, observerOptions);

            // Osserva tutte le sezioni
            sections.forEach(({ section }) => {
                observer.observe(section);
            });

            // Evidenzia la prima sezione visibile all'avvio
            function highlightFirstVisible() {
                for (const { link, section } of sections) {
                    const rect = section.getBoundingClientRect();
                    if (rect.top >= 0 && rect.top < window.innerHeight * 0.5) {
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        break;
                    }
                }
            }

            // Esegui all'avvio e dopo un piccolo delay per assicurarsi che tutto sia caricato
            setTimeout(highlightFirstVisible, 100);
            window.addEventListener('load', highlightFirstVisible);
        })();
    </script>

</body>

</html>