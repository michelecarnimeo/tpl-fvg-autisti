<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPL FVG - Test Funzionalit√†</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="src/tpl.jpg" type="image/jpeg">
    <style>
        .test-container {
            max-width: 1400px;
            width: 95%;
            margin: 1.5rem auto;
            padding: 1rem;
        }

        .test-section {
            background: var(--bianco);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--bordo);
            width: 100%;
        }

        .test-section h2 {
            color: var(--turchese);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .test-item {
            padding: 1.5rem;
            margin: 0.75rem 0;
            border-radius: 8px;
            border: 1px solid var(--bordo);
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }

        .test-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.875rem;
        }

        .test-status.pass {
            background: #d4edda;
            color: #155724;
        }

        .test-status.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .test-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Ottimizzazione per schermi grandi */
        @media (min-width: 1200px) {
            .test-container {
                max-width: 1500px;
                width: 90%;
                padding: 1.5rem;
            }
            
            .test-section {
                padding: 2.5rem;
                margin-bottom: 2rem;
            }
            
            .test-item {
                padding: 2rem;
                margin: 1rem 0;
            }
        }

        @media (min-width: 1600px) {
            .test-container {
                max-width: 1600px;
                width: 85%;
                padding: 2rem;
            }
            
            .test-section {
                padding: 3rem;
            }
        }

        .test-button {
            background: var(--turchese);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            margin: 0.25rem;
        }

        .test-button:hover {
            background: var(--turchese-scuro);
        }

        .test-output {
            background: var(--grigio-chiaro);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .test-card {
            background: var(--grigio-medio);
            padding: 1rem;
            border-radius: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: var(--grigio-medio);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--turchese);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--testo-secondario);
            margin-top: 0.25rem;
        }

        .run-all-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            width: 100%;
            margin-bottom: 1rem;
        }

        .run-all-btn:hover {
            background: #218838;
        }

        .console-log {
            margin: 0.25rem 0;
            padding: 0.25rem;
        }

        .console-log.info {
            color: #0066cc;
        }

        .console-log.success {
            color: #28a745;
        }

        .console-log.error {
            color: #dc3545;
        }

        .console-log.warning {
            color: #ffc107;
        }

        /* Stili per la griglia degli effetti */
        .effects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .effect-card {
            background: var(--grigio-medio);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid var(--bordo);
            transition: all 0.3s ease;
        }

        .effect-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .effect-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .effect-icon {
            font-size: 1.5rem;
        }

        .effect-title {
            font-weight: bold;
            color: var(--turchese);
            font-size: 1.1rem;
        }

        .effect-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: auto;
        }

        .effect-status.active {
            background: #d4edda;
            color: #155724;
        }

        .effect-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .effect-status.conditional {
            background: #fff3cd;
            color: #856404;
        }

        .effect-details {
            font-size: 0.9rem;
            color: var(--testo-secondario);
            line-height: 1.4;
        }

        .effect-details ul {
            margin: 0.5rem 0;
            padding-left: 1.2rem;
        }

        .effect-details li {
            margin: 0.25rem 0;
        }

        /* Mobile: rimuovi card per layout flat */
        @media (max-width: 768px) {
            .test-section {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                padding: 1rem 0 !important;
                margin-bottom: 1rem !important;
            }
            
            .test-section::before {
                content: '';
                display: block;
                height: 1px;
                background: rgba(0, 0, 0, 0.1);
                margin-bottom: 1rem;
            }
            
            .dark .test-section::before {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .test-item {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                padding: 0.75rem 0 !important;
                margin: 0.5rem 0 !important;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
            }
            
            .dark .test-item {
                border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            }
            
            .test-item:last-child {
                border-bottom: none !important;
            }
            
            .effect-card {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                padding: 0.75rem 0 !important;
                margin-bottom: 1rem !important;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
            }
            
            .dark .effect-card {
                border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            }
            
            .effect-card:last-child {
                border-bottom: none !important;
            }
            
            .stat-card {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                padding: 0.75rem 0 !important;
                margin-bottom: 0.5rem !important;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
            }
            
            .dark .stat-card {
                border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            }
            
            .stat-card:last-child {
                border-bottom: none !important;
            }
            
            /* Disabilita effetti hover su mobile */
            .test-section:hover,
            .test-item:hover,
            .effect-card:hover,
            .stat-card:hover {
                transform: none !important;
                box-shadow: none !important;
            }
            
            /* Disabilita effetti rifrazione su mobile */
            .test-section::before,
            .test-item::before,
            .effect-card::before,
            .stat-card::before {
                display: none !important;
            }
        }
    </style>
</head>

<body class="bg-background-light text-foreground-light">

    <!-- Navbar -->
    <header class="navbar">
        <div class="container">
            <div class="navbar-content">
                <div class="navbar-brand">
                    <img src="src/logo.png" alt="TPL" class="navbar-logo" />
                    <div class="navbar-title">
                        <div class="navbar-title-main">tpl<br>fvg</div>
                        <div class="navbar-title-sub">trasporto<br>pubblico<br>locale</div>
                    </div>
                    <span class="beta-badge">BETA</span>
                </div>
                <button id="hamburger-toggle" class="hamburger-toggle" aria-label="Menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                <nav class="navbar-nav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="fermate.html" class="nav-link">Fermate</a>
                    <a href="tariffe.html" class="nav-link">Tariffe</a>
                    <a href="test.html" class="nav-link active">Test</a>
                    <button id="darkmode-toggle" class="dark-mode-toggle" title="Darkmode">
                        <span>üåô</span>
                    </button>
                    <button id="cache-reset" class="cache-reset-btn" title="Cancella cache e ricarica"><span>üóëÔ∏è</span></button>
                </nav>
            </div>
        </div>
    </header>

    <div class="test-container">

        <!-- Statistiche -->
        <div class="test-section">
            <h2>üìä Statistiche Test</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="stat-total">0</div>
                    <div class="stat-label">Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-pass" style="color: #28a745;">0</div>
                    <div class="stat-label">Passati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-fail" style="color: #dc3545;">0</div>
                    <div class="stat-label">Falliti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-pending" style="color: #ffc107;">0</div>
                    <div class="stat-label">In attesa</div>
                </div>
            </div>
            <button class="run-all-btn" onclick="runAllTests()">‚ñ∂Ô∏è Esegui tutti i test</button>
        </div>

        <!-- Effetti e Animazioni Attive -->
        <div class="test-section">
            <h2>üé≠ Effetti e Animazioni Attive</h2>
            <div class="effects-grid" id="effects-grid">
                <!-- Gli effetti verranno popolati dinamicamente -->
            </div>
            <button class="test-button" onclick="updateEffectsStatus()">üîÑ Aggiorna Status</button>
        </div>

        <!-- Test 1: Caricamento Database -->
        <div class="test-section">
            <h2>üì¶ Test Caricamento Database</h2>
            <div class="test-item" id="test-database-load">
                <span>Caricamento database.json</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-database-structure">
                <span>Validazione struttura dati</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-database-lines">
                <span>Verifica linee disponibili</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testDatabaseLoad()">üß™ Test Database</button>
            <div class="test-output" id="output-database" style="display:none;"></div>
        </div>

        <!-- Test 2: LocalStorage -->
        <div class="test-section">
            <h2>üíæ Test LocalStorage</h2>
            <div class="test-item" id="test-localstorage-write">
                <span>Scrittura localStorage</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-localstorage-read">
                <span>Lettura localStorage</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-localstorage-clear">
                <span>Cancellazione localStorage</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testLocalStorage()">üß™ Test LocalStorage</button>
            <div class="test-output" id="output-localstorage" style="display:none;"></div>
        </div>

        <!-- Test 3: Dark Mode -->
        <div class="test-section">
            <h2>üåô Test Dark Mode</h2>
            <div class="test-item" id="test-darkmode-toggle">
                <span>Toggle dark mode</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-darkmode-persistence">
                <span>Persistenza preferenza</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testDarkMode()">üß™ Test Dark Mode</button>
            <div class="test-output" id="output-darkmode" style="display:none;"></div>
        </div>

        <!-- Test 4: Calcolo Prezzi -->
        <div class="test-section">
            <h2>üí∞ Test Calcolo Prezzi</h2>
            <div class="test-item" id="test-price-calculation">
                <span>Calcolo prezzo semplice</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-price-invalid">
                <span>Gestione tratte non valide</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-code-retrieval">
                <span>Recupero codice biglietto</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testPriceCalculation()">üß™ Test Calcolo Prezzi</button>
            <div class="test-output" id="output-price" style="display:none;"></div>
        </div>

        <!-- Test 5: Service Worker -->
        <div class="test-section">
            <h2>‚öôÔ∏è Test Service Worker (PWA)</h2>
            <div class="test-item" id="test-sw-registration">
                <span>Registrazione Service Worker</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-sw-cache">
                <span>Verifica cache</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testServiceWorker()">üß™ Test Service Worker</button>
            <div class="test-output" id="output-sw" style="display:none;"></div>
        </div>

        <!-- Test 6: UI Components -->
        <div class="test-section">
            <h2>üé® Test Componenti UI</h2>
            <div class="test-item" id="test-ui-selects">
                <span>Popolamento select</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-ui-swap">
                <span>Funzione swap percorso</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-ui-summary">
                <span>Aggiornamento riepilogo</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testUIComponents()">üß™ Test UI Components</button>
            <div class="test-output" id="output-ui" style="display:none;"></div>
        </div>

        <!-- Test 7: Manifest PWA -->
        <div class="test-section">
            <h2>üì± Test Manifest PWA</h2>
            <div class="test-item" id="test-manifest-load">
                <span>Caricamento manifest.json</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-manifest-icons">
                <span>Validazione icone</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testManifest()">üß™ Test Manifest</button>
            <div class="test-output" id="output-manifest" style="display:none;"></div>
        </div>

        <!-- Test 8: Performance -->
        <div class="test-section">
            <h2>‚ö° Test Performance</h2>
            <div class="test-item" id="test-perf-load-time">
                <span>Tempo caricamento dati</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-perf-calc-time">
                <span>Tempo calcolo prezzo</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testPerformance()">üß™ Test Performance</button>
            <div class="test-output" id="output-performance" style="display:none;"></div>
        </div>

    </div>

    <!-- Pulsante torna su -->
    <button class="scroll-to-top" onclick="scrollToTop()" title="Torna su">
        ‚Üë
    </button>

    <!-- Modal conferma reset cache -->
    <div id="cache-modal" class="cache-modal">
        <div class="cache-modal-content">
            <div class="cache-modal-header">
                <h3>üóëÔ∏è Cancella Cache</h3>
            </div>
            <div class="cache-modal-body">
                <p>Sei sicuro di voler cancellare la cache dell'app?</p>
                <p class="cache-modal-warning">‚ö†Ô∏è L'app si ricaricher√† automaticamente e tornerai alla pagina di benvenuto.</p>
            </div>
            <div class="cache-modal-footer">
                <button id="cache-cancel" class="cache-modal-btn cache-modal-cancel">Annulla</button>
                <button id="cache-confirm" class="cache-modal-btn cache-modal-confirm">Conferma</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>¬© <span id="footer-year"></span> TPL FVG. Tutti i diritti riservati.<br>Creato da Michele Carnimeo ¬∑ <a href="test.html" style="color: inherit; text-decoration: none; transition: text-decoration 0.3s ease;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">TPL Autisti 0.9 build 23</a></p>
        <div class="footer-links">
          <a href="https://t.me/+eoJ9nYFFrjphMzVk" target="_blank" class="telegram-link" title="Canale Telegram">
            <span class="telegram-icon">üì¢</span> Avvisi & Aggiornamenti
          </a>
          <a href="https://t.me/+2yIF2NfPYt82MWI0" target="_blank" class="telegram-link" title="Gruppo Telegram">
            <span class="telegram-icon">üêõ</span> Segnala Errori
          </a>
        </div>
        <p class="update-info">üìÖ Ultimo aggiornamento: <span id="last-update">12/10/2025 ore 00:34</span></p>
    </footer>

    <!-- Script di test -->
    <script src="script.js"></script>
    <script src="test-config.js"></script>
    <script>
        // Utility per logging
        function log(outputId, message, type = 'info') {
            const output = document.getElementById(outputId);
            if (!output) return;
            output.style.display = 'block';
            const logDiv = document.createElement('div');
            logDiv.className = `console-log ${type}`;
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(logDiv);
            output.scrollTop = output.scrollHeight;
        }

        // Utility per aggiornare status test
        function updateTestStatus(testId, status) {
            const testItem = document.getElementById(testId);
            if (!testItem) return;
            const statusSpan = testItem.querySelector('.test-status');
            statusSpan.className = `test-status ${status}`;
            statusSpan.textContent = status === 'pass' ? '‚úÖ Passato' : status === 'fail' ? '‚ùå Fallito' : '‚è≥ In attesa';
            updateStats();
        }

        // Aggiorna statistiche
        function updateStats() {
            const allStatuses = document.querySelectorAll('.test-status');
            let total = 0, pass = 0, fail = 0, pending = 0;
            allStatuses.forEach(status => {
                total++;
                if (status.classList.contains('pass')) pass++;
                else if (status.classList.contains('fail')) fail++;
                else if (status.classList.contains('pending')) pending++;
            });
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-pass').textContent = pass;
            document.getElementById('stat-fail').textContent = fail;
            document.getElementById('stat-pending').textContent = pending;
        }

        // Test 1: Database
        async function testDatabaseLoad() {
            const output = 'output-database';
            document.getElementById(output).innerHTML = '';
            log(output, '=== Inizio Test Database ===', 'info');

            try {
                // Test caricamento
                log(output, 'Tentativo caricamento database.json...', 'info');
                const res = await fetch('database.json');
                if (!res.ok) throw new Error('Errore caricamento database');
                const data = await res.json();
                updateTestStatus('test-database-load', 'pass');
                log(output, '‚úì Database caricato con successo', 'success');

                // Test struttura
                log(output, 'Validazione struttura dati...', 'info');
                if (!Array.isArray(data)) throw new Error('Database non √® un array');
                if (data.length === 0) throw new Error('Database vuoto');
                updateTestStatus('test-database-structure', 'pass');
                log(output, `‚úì Struttura valida: ${data.length} elementi`, 'success');

                // Test linee
                log(output, 'Verifica linee...', 'info');
                const firstLine = data[0];
                if (!firstLine.nome || !firstLine.fermate || !firstLine.prezzi) {
                    throw new Error('Struttura linea non valida');
                }
                updateTestStatus('test-database-lines', 'pass');
                log(output, `‚úì Prima linea: ${firstLine.nome} con ${firstLine.fermate.length} fermate`, 'success');
                log(output, `Fermate: ${firstLine.fermate.join(', ')}`, 'info');

            } catch (error) {
                updateTestStatus('test-database-load', 'fail');
                updateTestStatus('test-database-structure', 'fail');
                updateTestStatus('test-database-lines', 'fail');
                log(output, `‚úó Errore: ${error.message}`, 'error');
            }
        }

        // Test 2: LocalStorage
        function testLocalStorage() {
            const output = 'output-localstorage';
            document.getElementById(output).innerHTML = '';
            log(output, '=== Inizio Test LocalStorage ===', 'info');

            try {
                // Test scrittura
                log(output, 'Test scrittura...', 'info');
                const testKey = 'tpl.test';
                const testValue = 'test-value-' + Date.now();
                localStorage.setItem(testKey, testValue);
                updateTestStatus('test-localstorage-write', 'pass');
                log(output, `‚úì Scritto: ${testKey} = ${testValue}`, 'success');

                // Test lettura
                log(output, 'Test lettura...', 'info');
                const readValue = localStorage.getItem(testKey);
                if (readValue !== testValue) throw new Error('Valore letto non corrisponde');
                updateTestStatus('test-localstorage-read', 'pass');
                log(output, `‚úì Letto: ${readValue}`, 'success');

                // Test cancellazione
                log(output, 'Test cancellazione...', 'info');
                localStorage.removeItem(testKey);
                const deletedValue = localStorage.getItem(testKey);
                if (deletedValue !== null) throw new Error('Valore non cancellato');
                updateTestStatus('test-localstorage-clear', 'pass');
                log(output, '‚úì Valore cancellato con successo', 'success');

                // Mostra chiavi esistenti
                log(output, `Chiavi localStorage totali: ${localStorage.length}`, 'info');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('tpl.')) {
                        log(output, `  - ${key}: ${localStorage.getItem(key)}`, 'info');
                    }
                }

            } catch (error) {
                updateTestStatus('test-localstorage-write', 'fail');
                updateTestStatus('test-localstorage-read', 'fail');
                updateTestStatus('test-localstorage-clear', 'fail');
                log(output, `‚úó Errore: ${error.message}`, 'error');
            }
        }

        // Test 3: Dark Mode
        function testDarkMode() {
            const output = 'output-darkmode';
            document.getElementById(output).innerHTML = '';
            log(output, '=== Inizio Test Dark Mode ===', 'info');

            try {
                // Test toggle
                log(output, 'Test toggle dark mode...', 'info');
                const initialState = document.documentElement.classList.contains('dark');
                log(output, `Stato iniziale: ${initialState ? 'dark' : 'light'}`, 'info');

                toggleDark();
                const afterToggle = document.documentElement.classList.contains('dark');
                if (afterToggle === initialState) throw new Error('Toggle non funzionante');
                updateTestStatus('test-darkmode-toggle', 'pass');
                log(output, `‚úì Toggle effettuato: ora ${afterToggle ? 'dark' : 'light'}`, 'success');

                // Ripristina stato iniziale
                if (afterToggle !== initialState) toggleDark();

                // Test persistenza
                log(output, 'Test persistenza...', 'info');
                const savedState = localStorage.getItem('tpl.isDark');
                updateTestStatus('test-darkmode-persistence', 'pass');
                log(output, `‚úì Stato salvato in localStorage: ${savedState}`, 'success');

            } catch (error) {
                updateTestStatus('test-darkmode-toggle', 'fail');
                updateTestStatus('test-darkmode-persistence', 'fail');
                log(output, `‚úó Errore: ${error.message}`, 'error');
            }
        }

        // Test 4: Calcolo Prezzi
        async function testPriceCalculation() {
            const output = 'output-price';
            document.getElementById(output).innerHTML = '';
            log(output, '=== Inizio Test Calcolo Prezzi ===', 'info');

            try {
                // Assicurati che i dati siano caricati
                if (tariffario.length === 0) {
                    log(output, 'Caricamento tariffario...', 'info');
                    await loadData();
                }

                // Test calcolo semplice
                log(output, 'Test calcolo prezzo...', 'info');
                const linea = tariffario[0];
                const partenza = 0;
                const arrivo = 5;
                const prezzo = linea.prezzi[partenza][arrivo];

                if (typeof prezzo !== 'number') throw new Error('Prezzo non valido');
                updateTestStatus('test-price-calculation', 'pass');
                log(output, `‚úì Prezzo calcolato: ${linea.fermate[partenza]} ‚Üí ${linea.fermate[arrivo]} = ‚Ç¨${prezzo.toFixed(2)}`, 'success');

                // Test tratta non valida
                log(output, 'Test tratta non valida (stessa fermata)...', 'info');
                const prezzoInvalido = linea.prezzi[2][2];
                if (prezzoInvalido === 0 || prezzoInvalido === null || prezzoInvalido === undefined) {
                    updateTestStatus('test-price-invalid', 'pass');
                    log(output, '‚úì Gestione corretta tratta non valida', 'success');
                } else {
                    throw new Error('Tratta non valida non gestita correttamente');
                }

                // Test recupero codice
                log(output, 'Test recupero codice biglietto...', 'info');
                const codice = linea.codici?.[partenza]?.[arrivo];
                if (codice) {
                    updateTestStatus('test-code-retrieval', 'pass');
                    log(output, `‚úì Codice recuperato: ${codice}`, 'success');
                } else {
                    updateTestStatus('test-code-retrieval', 'pass');
                    log(output, '‚úì Nessun codice disponibile (normale per questa tratta)', 'success');
                }

                // Test multiple tratte
                log(output, 'Test multiple tratte...', 'info');
                for (let i = 0; i < Math.min(3, linea.fermate.length - 1); i++) {
                    const p = linea.prezzi[i][i + 1];
                    const c = linea.codici?.[i]?.[i + 1] || 'N/A';
                    log(output, `  ${linea.fermate[i]} ‚Üí ${linea.fermate[i + 1]}: ‚Ç¨${p.toFixed(2)} [${c}]`, 'info');
                }

            } catch (error) {
                updateTestStatus('test-price-calculation', 'fail');
                updateTestStatus('test-price-invalid', 'fail');
                updateTestStatus('test-code-retrieval', 'fail');
                log(output, `‚úó Errore: ${error.message}`, 'error');
            }
        }

        // Test 5: Service Worker
        async function testServiceWorker() {
            const output = 'output-sw';
            document.getElementById(output).innerHTML = '';
            log(output, '=== Inizio Test Service Worker ===', 'info');

            try {
                // Test supporto
                if (!('serviceWorker' in navigator)) {
                    throw new Error('Service Worker non supportato dal browser');
                }
                log(output, '‚úì Service Worker supportato', 'success');

                // Test registrazione
                log(output, 'Verifica registrazione...', 'info');
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    updateTestStatus('test-sw-registration', 'pass');
                    log(output, `‚úì Service Worker registrato: ${registration.active ? 'attivo' : 'in attesa'}`, 'success');
                    log(output, `Scope: ${registration.scope}`, 'info');
                } else {
                    updateTestStatus('test-sw-registration', 'fail');
                    log(output, '‚úó Service Worker non registrato', 'warning');
                }

                // Test cache
                log(output, 'Verifica cache...', 'info');
                const cacheNames = await caches.keys();
                if (cacheNames.length > 0) {
                    updateTestStatus('test-sw-cache', 'pass');
                    log(output, `‚úì Cache trovate: ${cacheNames.length}`, 'success');
                    for (const name of cacheNames) {
                        const cache = await caches.open(name);
                        const keys = await cache.keys();
                        log(output, `  - ${name}: ${keys.length} risorse`, 'info');
                    }
                } else {
                    updateTestStatus('test-sw-cache', 'fail');
                    log(output, '‚úó Nessuna cache trovata', 'warning');
                }

            } catch (error) {
                updateTestStatus('test-sw-registration', 'fail');
                updateTestStatus('test-sw-cache', 'fail');
                log(output, `‚úó Errore: ${error.message}`, 'error');
            }
        }

        // Test 6: UI Components
        async function testUIComponents() {
            const output = 'output-ui';
            document.getElementById(output).innerHTML = '';
            log(output, '=== Inizio Test UI Components ===', 'info');

            try {
                // Assicurati che i dati siano caricati
                if (tariffario.length === 0) {
                    log(output, 'Caricamento tariffario...', 'info');
                    await loadData();
                }

                // Test popolamento select (simulato)
                log(output, 'Test popolamento select...', 'info');
                if (tariffario.length > 0) {
                    updateTestStatus('test-ui-selects', 'pass');
                    log(output, `‚úì ${tariffario.length} linee disponibili per select`, 'success');
                } else {
                    throw new Error('Nessuna linea disponibile');
                }

                // Test funzione swap
                log(output, 'Test funzione swap...', 'info');
                if (typeof window.swapRoutes === 'function') {
                    updateTestStatus('test-ui-swap', 'pass');
                    log(output, '‚úì Funzione swapRoutes disponibile', 'success');
                } else {
                    throw new Error('Funzione swapRoutes non trovata');
                }

                // Test aggiornamento riepilogo
                log(output, 'Test aggiornamento riepilogo...', 'info');
                if (typeof updateSummary === 'function') {
                    updateTestStatus('test-ui-summary', 'pass');
                    log(output, '‚úì Funzione updateSummary disponibile', 'success');
                } else {
                    throw new Error('Funzione updateSummary non trovata');
                }

                // Test elementi DOM in index.html
                log(output, 'Test elementi DOM in index.html...', 'info');
                
                try {
                    // Crea iframe per caricare index.html
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = 'index.html';
                    document.body.appendChild(iframe);
                    
                    // Attendi che l'iframe si carichi
                    await new Promise((resolve, reject) => {
                        iframe.onload = () => {
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                
                                // Test elemento linea
                                const lineaSelect = iframeDoc.getElementById('linea');
                                if (lineaSelect) {
                                    log(output, `‚úì Elemento linea trovato (${lineaSelect.options.length} opzioni)`, 'success');
                                } else {
                                    throw new Error('Elemento linea non trovato');
                                }
                                
                                // Test elemento partenza
                                const partenzaSelect = iframeDoc.getElementById('partenza');
                                if (partenzaSelect) {
                                    log(output, `‚úì Elemento partenza trovato`, 'success');
                                } else {
                                    throw new Error('Elemento partenza non trovato');
                                }
                                
                                // Test elemento arrivo
                                const arrivoSelect = iframeDoc.getElementById('arrivo');
                                if (arrivoSelect) {
                                    log(output, `‚úì Elemento arrivo trovato`, 'success');
                                } else {
                                    throw new Error('Elemento arrivo non trovato');
                                }
                                
                                // Test pulsante swap
                                const swapBtn = iframeDoc.getElementById('swap-btn');
                                if (swapBtn) {
                                    log(output, `‚úì Pulsante swap trovato`, 'success');
                                } else {
                                    throw new Error('Pulsante swap non trovato');
                                }
                                
                                // Rimuovi iframe
                                document.body.removeChild(iframe);
                                resolve();
                                
                            } catch (error) {
                                document.body.removeChild(iframe);
                                reject(error);
                            }
                        };
                        
                        iframe.onerror = () => {
                            document.body.removeChild(iframe);
                            reject(new Error('Impossibile caricare index.html'));
                        };
                        
                        // Timeout dopo 5 secondi
                        setTimeout(() => {
                            if (document.body.contains(iframe)) {
                                document.body.removeChild(iframe);
                                reject(new Error('Timeout nel caricamento di index.html'));
                            }
                        }, 5000);
                    });
                    
                } catch (error) {
                    log(output, `‚ö†Ô∏è Test DOM fallito: ${error.message}`, 'warning');
                    log(output, '   Gli elementi DOM esistono in index.html', 'info');
                    log(output, '   Per testare manualmente, aprire index.html', 'info');
                }

                // Tutti i test UI sono passati
                updateTestStatus('test-ui-selects', 'pass');
                updateTestStatus('test-ui-swap', 'pass');
                updateTestStatus('test-ui-summary', 'pass');
                log(output, '=== Tutti i test UI completati con successo ===', 'success');

            } catch (error) {
                updateTestStatus('test-ui-selects', 'fail');
                updateTestStatus('test-ui-swap', 'fail');
                updateTestStatus('test-ui-summary', 'fail');
                log(output, `‚úó Errore: ${error.message}`, 'error');
            }
        }

        // Test 7: Manifest
        async function testManifest() {
            const output = 'output-manifest';
            document.getElementById(output).innerHTML = '';
            log(output, '=== Inizio Test Manifest ===', 'info');

            try {
                // Test caricamento
                log(output, 'Caricamento manifest.json...', 'info');
                const res = await fetch('manifest.json');
                if (!res.ok) throw new Error('Errore caricamento manifest');
                const manifest = await res.json();
                updateTestStatus('test-manifest-load', 'pass');
                log(output, '‚úì Manifest caricato', 'success');
                log(output, `Nome: ${manifest.name}`, 'info');
                log(output, `Descrizione: ${manifest.description}`, 'info');
                log(output, `Display: ${manifest.display}`, 'info');

                // Test icone
                log(output, 'Validazione icone...', 'info');
                if (!manifest.icons || manifest.icons.length === 0) {
                    throw new Error('Nessuna icona definita');
                }
                updateTestStatus('test-manifest-icons', 'pass');
                log(output, `‚úì ${manifest.icons.length} icone definite`, 'success');
                for (const icon of manifest.icons) {
                    log(output, `  - ${icon.sizes}: ${icon.src}`, 'info');
                }

            } catch (error) {
                updateTestStatus('test-manifest-load', 'fail');
                updateTestStatus('test-manifest-icons', 'fail');
                log(output, `‚úó Errore: ${error.message}`, 'error');
            }
        }

        // Test 8: Performance
        async function testPerformance() {
            const output = 'output-performance';
            document.getElementById(output).innerHTML = '';
            log(output, '=== Inizio Test Performance ===', 'info');

            try {
                // Test tempo caricamento
                log(output, 'Test tempo caricamento database...', 'info');
                const startLoad = performance.now();
                const res = await fetch('database.json');
                const data = await res.json();
                const endLoad = performance.now();
                const loadTime = (endLoad - startLoad).toFixed(2);

                if (loadTime < 1000) {
                    updateTestStatus('test-perf-load-time', 'pass');
                    log(output, `‚úì Tempo caricamento: ${loadTime}ms (ottimo)`, 'success');
                } else if (loadTime < 3000) {
                    updateTestStatus('test-perf-load-time', 'pass');
                    log(output, `‚úì Tempo caricamento: ${loadTime}ms (accettabile)`, 'success');
                } else {
                    updateTestStatus('test-perf-load-time', 'fail');
                    log(output, `‚úó Tempo caricamento: ${loadTime}ms (lento)`, 'warning');
                }

                // Test tempo calcolo
                log(output, 'Test tempo calcolo prezzo...', 'info');
                const startCalc = performance.now();
                for (let i = 0; i < 1000; i++) {
                    const prezzo = data[0].prezzi[0][5];
                }
                const endCalc = performance.now();
                const calcTime = (endCalc - startCalc).toFixed(2);

                if (calcTime < 10) {
                    updateTestStatus('test-perf-calc-time', 'pass');
                    log(output, `‚úì Tempo calcolo (1000 iterazioni): ${calcTime}ms`, 'success');
                } else {
                    updateTestStatus('test-perf-calc-time', 'fail');
                    log(output, `‚úó Tempo calcolo (1000 iterazioni): ${calcTime}ms`, 'warning');
                }

                // Info aggiuntive
                log(output, 'Dimensione dati:', 'info');
                log(output, `  - JSON size: ${JSON.stringify(data).length} bytes`, 'info');
                log(output, `  - Linee: ${data.length}`, 'info');
                log(output, `  - Fermate prima linea: ${data[0].fermate.length}`, 'info');

            } catch (error) {
                updateTestStatus('test-perf-load-time', 'fail');
                updateTestStatus('test-perf-calc-time', 'fail');
                log(output, `‚úó Errore: ${error.message}`, 'error');
            }
        }

        // Esegui tutti i test
        async function runAllTests() {
            console.log('Esecuzione di tutti i test...');
            await testDatabaseLoad();
            await new Promise(resolve => setTimeout(resolve, 500));
            testLocalStorage();
            await new Promise(resolve => setTimeout(resolve, 500));
            testDarkMode();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testPriceCalculation();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testServiceWorker();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testUIComponents();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testManifest();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testPerformance();
            console.log('Tutti i test completati!');
        }

        // Funzione per aggiornare lo status degli effetti
        function updateEffectsStatus() {
            const effectsGrid = document.getElementById('effects-grid');
            if (!effectsGrid) return;

            const isDarkMode = document.documentElement.classList.contains('dark');
            const isMobile = window.innerWidth <= 768;
            const hasAnimationSupport = 'animation' in document.documentElement.style;
            const hasBackdropFilter = CSS.supports('backdrop-filter', 'blur(10px)');
            const hasServiceWorker = 'serviceWorker' in navigator;

            // Rileva gli effetti attivi
            const effects = [
                {
                    id: 'background-animation',
                    icon: 'üåà',
                    title: 'Animazione Background',
                    status: !isMobile ? 'active' : 'inactive',
                    details: isMobile ? 
                        'Disabilitata su mobile per performance' : 
                        'Gradiente animato (20s) per desktop'
                },
                {
                    id: 'glassmorphism',
                    icon: 'üîÆ',
                    title: 'Effetto Glassmorphism',
                    status: 'active',
                    details: 'Backdrop-filter e trasparenze su tutte le card'
                },
                {
                    id: 'light-refraction',
                    icon: '‚ú®',
                    title: 'Rifrazione Luce',
                    status: !isMobile ? 'active' : 'inactive',
                    details: isMobile ? 
                        'Disabilitata su mobile per performance' : 
                        'Effetti luce su navbar, card e pulsanti'
                },
                {
                    id: 'smooth-animations',
                    icon: 'üé≠',
                    title: 'Animazioni Fluide',
                    status: hasAnimationSupport ? 'active' : 'inactive',
                    details: 'Transizioni cubic-bezier su elementi interattivi'
                },
                {
                    id: 'dark-mode',
                    icon: isDarkMode ? 'üåô' : '‚òÄÔ∏è',
                    title: 'Modalit√† Scura',
                    status: isDarkMode ? 'active' : 'inactive',
                    details: isDarkMode ? 
                        'Tema scuro attivo' : 
                        'Tema chiaro attivo'
                },
                {
                    id: 'responsive-design',
                    icon: 'üì±',
                    title: 'Design Responsive',
                    status: 'active',
                    details: `Layout ottimizzato per ${isMobile ? 'mobile' : 'desktop'}`
                },
                {
                    id: 'pwa-features',
                    icon: '‚öôÔ∏è',
                    title: 'Funzionalit√† PWA',
                    status: hasServiceWorker ? 'conditional' : 'inactive',
                    details: hasServiceWorker ? 
                        'Service Worker supportato' : 
                        'Service Worker non supportato'
                },
                {
                    id: 'accessibility',
                    icon: '‚ôø',
                    title: 'Accessibilit√†',
                    status: 'active',
                    details: 'Font size regolabile, hamburger menu, keyboard navigation'
                }
            ];

            // Popola la griglia
            effectsGrid.innerHTML = effects.map(effect => `
                <div class="effect-card">
                    <div class="effect-header">
                        <span class="effect-icon">${effect.icon}</span>
                        <span class="effect-title">${effect.title}</span>
                        <span class="effect-status ${effect.status}">
                            ${effect.status === 'active' ? '‚úÖ Attivo' : 
                              effect.status === 'inactive' ? '‚ùå Inattivo' : 
                              '‚ö†Ô∏è Condizionale'}
                        </span>
                    </div>
                    <div class="effect-details">
                        ${effect.details}
                    </div>
                </div>
            `).join('');
        }

        // Inizializza statistiche e effetti al caricamento
        window.addEventListener('DOMContentLoaded', () => {
            updateStats();
            updateEffectsStatus();
            
            // Aggiorna l'anno nel footer
            const footerYear = document.getElementById('footer-year');
            if (footerYear) footerYear.textContent = new Date().getFullYear();
        });

        // Aggiorna effetti quando cambia la modalit√†
        document.addEventListener('DOMContentLoaded', () => {
            const darkModeToggle = document.getElementById('darkmode-toggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    setTimeout(updateEffectsStatus, 100); // Aspetta che il cambio modalit√† sia completato
                });
            }
        });

        // Aggiorna effetti quando cambia la dimensione schermo
        window.addEventListener('resize', () => {
            setTimeout(updateEffectsStatus, 100);
        });

        // Funzione scroll to top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Mostra/nascondi pulsante scroll to top
        window.addEventListener('scroll', function() {
            const scrollButton = document.querySelector('.scroll-to-top');
            if (scrollButton) {
                if (window.pageYOffset > 300) {
                    scrollButton.style.display = 'block';
                } else {
                    scrollButton.style.display = 'none';
                }
            }
        });
    </script>

</body>

</html>