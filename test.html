<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TPL FVG - Test Funzionalit√†</title>
    <link rel="stylesheet" href="style1.css">
    <!-- Animazioni e transizioni globali -->
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/components/footer.css">
    <link rel="stylesheet" href="css/components/modals.css">
    <!-- Test Modules (sticky headers, groups, animations) -->
    <link rel="stylesheet" href="css/components/tests/header.css">
    <link rel="stylesheet" href="css/components/tests/groups.css">
    <link rel="stylesheet" href="css/components/tests/test-animations.css">
    <!-- Test Modules (base styles, status, effects) -->
    <link rel="stylesheet" href="css/components/tests/test-base.css">
    <link rel="stylesheet" href="css/components/tests/test-status.css">
    <link rel="stylesheet" href="css/components/tests/test-effects.css">
    <!-- Test Page Specific (settings dropdown, distance, leaflet) -->
    <link rel="stylesheet" href="css/components/tests/test-page-specific.css">
    <!-- Test Device Info (device info cards) -->
    <link rel="stylesheet" href="css/components/tests/test-device-info.css">
    <!-- Test Prezzi Adaptive (tipografia adattiva) -->
    <link rel="stylesheet" href="css/components/tests/test-prezzi-adaptive.css">
    <!-- Settings (struttura modale) -->
    <link rel="stylesheet" href="css/components/settings/impostazioni.css">
    <link rel="stylesheet" href="css/components/settings/accessibilita.css">
    <link rel="stylesheet" href="css/components/settings/aspetto.css">
    <link rel="stylesheet" href="css/components/settings/info.css">
    <link rel="icon" href="src/tpl.jpg" type="image/jpeg">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body class="bg-background-light text-foreground-light">

    <!-- Navbar -->
    <header class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="navbar-brand-link">
                    <div class="navbar-brand">
                        <div class="navbar-logo-wrapper">
                            <img src="src/logo.png" alt="TPL" class="navbar-logo navbar-logo-default" />
                            <img src="src/logo1.png" alt="TPL" class="navbar-logo navbar-logo-hover" />
                        </div>
                        <div class="navbar-title">
                            <div class="logo-acronym">
                                <div>tpl</div>
                                <div>fvg</div>
                            </div>
                            <div class="logo-text">
                                <div>trasporto</div>
                                <div>pubblico</div>
                                <div>locale</div>
                            </div>
                        </div>
                    </div>
                </a>
                <!-- Hamburger button (mobile only) -->
                <button id="hamburger-toggle" class="hamburger-toggle" aria-label="Menu">
                    <span class="hamburger-icon"></span>
                </button>

                <nav class="navbar-nav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="fermate.html" class="nav-link">Fermate</a>
                    <a href="prezzi.html" class="nav-link">Prezzi</a>
                    <a href="test.html" class="nav-link active">Test</a>

                    <!-- Mega Dropdown Impostazioni (Opzione C) -->
                    <div class="settings-dropdown-container">
                        <button id="test-settings-dropdown-btn" class="nav-settings-dropdown-btn" title="Impostazioni">
                            <span class="settings-icon">‚öôÔ∏è</span>
                            <span class="settings-text">Impostazioni</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>

                        <div id="test-settings-dropdown" class="settings-mega-dropdown">
                            <!-- Sezione Aspetto -->
                            <div class="dropdown-section">
                                <h4 class="dropdown-section-title">üëÅÔ∏è Aspetto</h4>

                                <div class="dropdown-item">
                                    <span class="dropdown-label">üåì Tema</span>
                                    <div class="dropdown-theme-options">
                                        <label class="theme-radio">
                                            <input type="radio" name="test-theme" value="system" checked>
                                            <span>‚öôÔ∏è Sistema</span>
                                        </label>
                                        <label class="theme-radio">
                                            <input type="radio" name="test-theme" value="light">
                                            <span>‚òÄÔ∏è Chiaro</span>
                                        </label>
                                        <label class="theme-radio">
                                            <input type="radio" name="test-theme" value="dark">
                                            <span>üåô Scuro</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="dropdown-item">
                                    <label class="dropdown-label" for="test-animation-toggle">üé¨ Animazione
                                        Sfondo</label>
                                    <label class="dropdown-toggle">
                                        <input type="checkbox" id="test-animation-toggle"
                                            aria-label="Attiva/disattiva animazione sfondo">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Sezione Accessibilit√† -->
                            <div class="dropdown-section">
                                <h4 class="dropdown-section-title">‚ôø Accessibilit√†</h4>

                                <div class="dropdown-item">
                                    <span class="dropdown-label">A Dimensione Testo</span>
                                    <div class="dropdown-font-buttons">
                                        <button class="dropdown-font-btn active" data-size="normal">A</button>
                                        <button class="dropdown-font-btn" data-size="large">A</button>
                                        <button class="dropdown-font-btn" data-size="xlarge">A</button>
                                    </div>
                                </div>

                                <div class="dropdown-item">
                                    <label class="dropdown-label" for="test-high-contrast">üé® Alto Contrasto</label>
                                    <label class="dropdown-toggle">
                                        <input type="checkbox" id="test-high-contrast"
                                            aria-label="Attiva/disattiva alto contrasto">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Sezione Azioni Rapide -->
                            <div class="dropdown-section">
                                <h4 class="dropdown-section-title">‚ö° Azioni Rapide</h4>

                                <button class="dropdown-action-btn" id="test-check-updates">
                                    <span>üîÑ</span>
                                    <span>Verifica Aggiornamenti</span>
                                </button>

                                <button class="dropdown-action-btn" id="test-clear-cache">
                                    <span>üóëÔ∏è</span>
                                    <span>Cancella Cache</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pulsanti legacy nascosti per compatibilit√† JS -->
                    <button id="darkmode-toggle" class="dark-mode-toggle" title="Darkmode" style="display: none;">
                        <span>üåô</span>
                    </button>
                    <button id="cache-reset" class="cache-reset-btn" title="Cancella cache e ricarica"
                        style="display: none;"><span>üóëÔ∏è</span></button>
                    <div class="font-size-group" style="display: none;">
                        <button id="font-size-small" class="font-size-btn" data-size="normal" title="Testo normale">
                            <span>A</span>
                        </button>
                        <button id="font-size-medium" class="font-size-btn" data-size="large" title="Testo grande">
                            <span>A</span>
                        </button>
                        <button id="font-size-large" class="font-size-btn" data-size="xlarge"
                            title="Testo molto grande">
                            <span>A</span>
                        </button>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="mobile-menu">
        <div class="mobile-menu-header">
            <span class="mobile-menu-title">Menu</span>
            <button id="mobile-menu-close" class="mobile-menu-close" aria-label="Chiudi menu">√ó</button>
        </div>
        <nav class="mobile-menu-nav">
            <a href="index.html" class="mobile-nav-link">
                <span class="mobile-nav-icon">üè†</span>
                <span>Home</span>
            </a>
            <a href="fermate.html" class="mobile-nav-link">
                <span class="mobile-nav-icon">üöè</span>
                <span>Fermate</span>
            </a>
            <a href="prezzi.html" class="mobile-nav-link">
                <span class="mobile-nav-icon">üí∞</span>
                <span>Prezzi</span>
            </a>
            <a href="test.html" class="mobile-nav-link active">
                <span class="mobile-nav-icon">üß™</span>
                <span>Test</span>
            </a>
            <button id="open-settings" class="mobile-nav-link">
                <span class="mobile-nav-icon">‚öôÔ∏è</span>
                <span>Impostazioni</span>
            </button>
        </nav>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="mobile-menu-overlay"></div>

    <div class="test-container">

        <!-- Indice Rapido -->
        <div id="section-index" class="test-section"
            style="border: 3px solid #0ea5e9; background: linear-gradient(135deg, rgba(14, 165, 233, 0.06), rgba(2, 132, 199, 0.06));">
            <h2>üß≠ Indice rapido</h2>
            <div class="toc-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.5rem 0.75rem;">
                <a href="#section-stats" class="toc-link" data-section="section-stats" data-label="üìä Statistiche"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üìä
                    Statistiche</a>
                <a href="#section-pwa" class="toc-link" data-section="section-pwa" data-label="üì± Modalit√† PWA"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üì±
                    Modalit√† PWA</a>
                <a href="#section-quick-links" class="toc-link" data-section="section-quick-links"
                    data-label="üîó Link Rapidi"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üîó
                    Link Rapidi</a>
                <a href="#section-connectivity" class="toc-link" data-section="section-connectivity"
                    data-label="üåê Connettivit√†"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üåê
                    Connettivit√†</a>
                <a href="#section-device" class="toc-link" data-section="section-device"
                    data-label="üì± Device & Browser"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üì±
                    Device & Browser</a>
                <a href="#section-geolocation" class="toc-link" data-section="section-geolocation"
                    data-label="üìç Geolocalizzazione"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üìç
                    Geolocalizzazione</a>
                <a href="#section-database" class="toc-link" data-section="section-database" data-label="üì¶ Database"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üì¶
                    Database</a>
                <a href="#section-localstorage" class="toc-link" data-section="section-localstorage"
                    data-label="üíæ LocalStorage"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üíæ
                    LocalStorage</a>
                <a href="#section-darkmode" class="toc-link" data-section="section-darkmode" data-label="üåô Dark Mode"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üåô
                    Dark Mode</a>
                <a href="#section-prezzi" class="toc-link" data-section="section-prezzi" data-label="üí∞ Prezzi"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üí∞
                    Prezzi</a>
                <a href="#section-sw" class="toc-link" data-section="section-sw" data-label="‚öôÔ∏è Service Worker"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">‚öôÔ∏è
                    Service Worker</a>
                <a href="#section-ui" class="toc-link" data-section="section-ui" data-label="üé® UI"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üé®
                    UI</a>
                <a href="#section-manifest" class="toc-link" data-section="section-manifest" data-label="üì± Manifest"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">üì±
                    Manifest</a>
                <a href="#section-performance" class="toc-link" data-section="section-performance"
                    data-label="‚ö° Performance"
                    style="display:block; padding:0.5rem 0.75rem; background:white; border:1px solid #e5e7eb; border-radius:8px; text-decoration:none; color:inherit; transition: all 0.2s;">‚ö°
                    Performance</a>
            </div>
            <script>
                // Smooth scroll per i link dell'indice
                document.addEventListener('DOMContentLoaded', () => {
                    const toc = document.getElementById('section-index');
                    if (!toc) return;

                    toc.querySelectorAll('a[href^="#"]').forEach(a => {
                        a.addEventListener('click', (e) => {
                            const target = document.querySelector(a.getAttribute('href'));
                            if (target) {
                                e.preventDefault();
                                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                try { history.replaceState(null, '', a.getAttribute('href')); } catch { }
                            }
                        });
                    });
                });
            </script>
        </div>

        <!-- Statistiche -->
        <div id="section-stats" class="test-section">
            <h2>üìä Statistiche Test</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="stat-total">0</div>
                    <div class="stat-label">Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-pass" style="color: #28a745;">0</div>
                    <div class="stat-label">Passati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-fail" style="color: #dc3545;">0</div>
                    <div class="stat-label">Falliti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-pending" style="color: #ffc107;">0</div>
                    <div class="stat-label">In attesa</div>
                </div>
            </div>
            <button class="run-all-btn" onclick="runAllTests()">‚ñ∂Ô∏è Esegui tutti i test</button>
        </div>

        <!-- Test Modalit√† PWA -->
        <div id="section-pwa" class="test-section"
            style="border: 3px solid var(--turchese); background: linear-gradient(135deg, rgba(23, 183, 177, 0.05), rgba(0, 153, 170, 0.05));">
            <h2>üì± Test Modalit√† PWA</h2>
            <div class="test-item">
                <div>
                    <strong>Simulazione Bottom Navigation</strong>
                    <br>
                    <small>Attiva/disattiva la bottom navigation senza installare la PWA</small>
                </div>
                <div>
                    <button id="toggle-pwa-mode" class="test-btn"
                        style="background: var(--turchese); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                        <span id="pwa-mode-icon">üì±</span>
                        <span id="pwa-mode-text">Attiva Modalit√† PWA</span>
                    </button>
                </div>
            </div>
            <div id="pwa-mode-status"
                style="display: none; margin-top: 1rem; padding: 1.5rem; background: var(--grigio-chiaro); border-radius: 12px; border-left: 5px solid var(--turchese);">
                <h4 style="margin-top: 0; color: var(--turchese);">Status Modalit√† PWA:</h4>
                <div id="pwa-mode-info"></div>
            </div>
        </div>

        <!-- Link Rapidi -->
        <div id="section-quick-links" class="test-section"
            style="border: 3px solid #9333ea; background: linear-gradient(135deg, rgba(147, 51, 234, 0.05), rgba(168, 85, 247, 0.05));">
            <h2>üîó Link Rapidi</h2>
            <div class="test-item">
                <div>
                    <strong>Pagina Benvenuto</strong>
                    <br>
                    <small>Vai alla pagina di benvenuto dell'app</small>
                </div>
                <div>
                    <a href="benvenuto.html" class="test-btn"
                        style="background: #9333ea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                        <span>üëã</span>
                        <span>Vai a Benvenuto</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Test Connettivit√† -->
        <div id="section-connectivity" class="test-section"
            style="border: 3px solid #ef4444; background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(220, 38, 38, 0.05));">
            <h2>üåê Test Connettivit√†</h2>
            <div class="test-item">
                <div>
                    <strong>Simulazione Modalit√† Offline</strong>
                    <br>
                    <small>Simula la perdita di connessione per testare il banner offline</small>
                </div>
                <div>
                    <button id="toggle-offline-mode" class="test-btn"
                        style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                        <span id="offline-mode-icon">üì∂</span>
                        <span id="offline-mode-text">Simula Offline</span>
                    </button>
                </div>
            </div>
            <div id="offline-mode-status"
                style="display: none; margin-top: 1rem; padding: 1.5rem; background: var(--grigio-chiaro); border-radius: 12px; border-left: 5px solid #ef4444;">
                <h4 style="margin-top: 0; color: #ef4444;">Status Connettivit√†:</h4>
                <div id="offline-mode-info"></div>
            </div>
        </div>

        <!-- Info Device/Browser -->
        <div id="section-device" class="test-section"
            style="border: 3px solid #8b5cf6; background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(124, 58, 237, 0.05));">
            <h2>üì± Info Device & Browser</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">Informazioni sul dispositivo e ambiente di esecuzione per
                debug</p>

            <!-- Grid Cards (Desktop) / Lista Compatta (Mobile) -->
            <div id="device-info-container">
                <!-- Device Type -->
                <div class="device-info-card" data-color="purple">
                    <div class="device-info-icon">üì±</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Device Type</div>
                        <div id="device-type" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- OS -->
                <div class="device-info-card" data-color="pink">
                    <div class="device-info-icon">üíª</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Sistema Operativo</div>
                        <div id="device-os" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- Browser -->
                <div class="device-info-card" data-color="blue">
                    <div class="device-info-icon">üåê</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Browser</div>
                        <div id="device-browser" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- Battery -->
                <div class="device-info-card" data-color="orange">
                    <div class="device-info-icon">üîã</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Batteria</div>
                        <div id="device-battery" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- GPS Support -->
                <div class="device-info-card" data-color="amber">
                    <div class="device-info-icon">üõ∞Ô∏è</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Supporto GPS</div>
                        <div id="device-gps" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- Touch Support -->
                <div class="device-info-card" data-color="cyan">
                    <div class="device-info-icon">üëÜ</div>
                    <div class="device-info-content">
                        <div class="device-info-label">Touch Support</div>
                        <div id="device-touch" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- PWA Mode -->
                <div class="device-info-card" data-color="indigo">
                    <div class="device-info-icon">üì≤</div>
                    <div class="device-info-content">
                        <div class="device-info-label">PWA Mode</div>
                        <div id="device-pwa" class="device-info-value">Rilevamento...</div>
                    </div>
                </div>

                <!-- Stato Connessione -->
                <div class="device-info-card" data-color="green" style="grid-column: 1 / -1;">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 1rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 200px;">
                            <div class="device-info-icon">
                                <span id="connection-status-icon">üü¢</span>
                            </div>
                            <div class="device-info-content" style="flex: 1; min-width: 0;">
                                <div class="device-info-label">Stato Connessione</div>
                                <div id="connection-status-text" class="device-info-value"
                                    style="word-break: break-word;">Rilevamento...</div>
                                <div id="connection-test-date"
                                    style="font-size: 0.75rem; color: var(--testo-secondario); margin-top: 0.25rem; opacity: 0.7; word-break: break-word;">
                                    -</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0;">
                            <button id="check-connection-btn" class="test-btn"
                                style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 0.5rem 0.875rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 0.35rem; white-space: nowrap; flex-shrink: 0;"
                                title="Verifica stato connessione">
                                <span>üîÑ</span>
                                <span>Verifica</span>
                            </button>
                            <button id="reset-connection-btn" class="test-btn"
                                style="background: var(--grigio-medio); color: var(--testo-principale); border: none; padding: 0.5rem 0.875rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.35rem; white-space: nowrap; flex-shrink: 0; opacity: 0.6;"
                                title="Reset risultati" disabled>
                                <span>üóëÔ∏è</span>
                                <span>Reset</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Rilevamento Display -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--bordo);">
                <h3
                    style="margin: 0 0 1.5rem 0; color: var(--turchese); font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                    üñ•Ô∏è Rilevamento Display
                </h3>

                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">

                    <!-- Card Tipo Display -->
                    <div class="display-info-card">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div
                                style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                                üì±
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--testo-secondario); font-weight: 500;">Tipo
                                    Display</div>
                                <div id="test-display-type"
                                    style="font-size: 1rem; color: var(--testo-principale); font-weight: 600; margin-top: 0.25rem;">
                                    Rilevamento...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Device Pixel Ratio -->
                    <div class="display-info-card">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div
                                style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                                üîç
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--testo-secondario); font-weight: 500;">
                                    Device Pixel Ratio</div>
                                <div id="test-display-dpr"
                                    style="font-size: 1.1rem; color: #3b82f6; font-weight: 700; margin-top: 0.25rem;">-
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Risoluzione Logica -->
                    <div class="display-info-card">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div
                                style="width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                                üìê
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--testo-secondario); font-weight: 500;">
                                    Risoluzione Logica</div>
                                <div id="test-display-logical"
                                    style="font-size: 0.95rem; color: var(--testo-principale); font-weight: 600; margin-top: 0.25rem; font-family: 'Courier New', monospace;">
                                    -</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Risoluzione Fisica -->
                    <div class="display-info-card">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div
                                style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                                üñºÔ∏è
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--testo-secondario); font-weight: 500;">
                                    Risoluzione Fisica</div>
                                <div id="test-display-physical"
                                    style="font-size: 0.95rem; color: var(--testo-principale); font-weight: 600; margin-top: 0.25rem; font-family: 'Courier New', monospace;">
                                    -</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card High DPI -->
                    <div class="display-info-card">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div
                                style="width: 40px; height: 40px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                                ‚ú®
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--testo-secondario); font-weight: 500;">High
                                    DPI</div>
                                <div id="test-display-highdpi"
                                    style="font-size: 1rem; color: var(--testo-principale); font-weight: 600; margin-top: 0.25rem;">
                                    <span id="test-display-highdpi-badge"
                                        style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Viewport -->
                    <div class="display-info-card">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div
                                style="width: 40px; height: 40px; background: linear-gradient(135deg, #06b6d4, #0891b2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                                üìè
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--testo-secondario); font-weight: 500;">
                                    Viewport</div>
                                <div id="test-display-viewport"
                                    style="font-size: 0.95rem; color: var(--testo-principale); font-weight: 600; margin-top: 0.25rem; font-family: 'Courier New', monospace;">
                                    -</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: center; gap: 1rem;">
                    <button id="test-display-refresh" class="test-btn"
                        style="background: linear-gradient(135deg, var(--turchese), var(--turchese-scuro)); color: white; border: none; padding: 0.875rem 2rem; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1rem; box-shadow: 0 4px 12px rgba(0, 123, 138, 0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üîÑ</span>
                        <span>Aggiorna Rilevamento</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Geolocalizzazione -->
        <div id="section-geolocation" class="test-section">
            <h2>üìç Test Geolocalizzazione</h2>

            <!-- Test Rapido One-Click -->
            <div
                style="margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-radius: 12px; border: 2px solid #10b981;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h3 style="margin: 0 0 0.5rem 0; color: #059669;">‚ö° Test Rapido GPS</h3>
                        <p style="margin: 0; color: #666; font-size: 0.9rem;">Verifica automatica di tutte le funzioni
                            GPS con un click</p>
                    </div>
                    <button id="quick-gps-test-btn"
                        style="padding: 0.875rem 2rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.3s;">
                        <span id="quick-test-icon">üöÄ</span>
                        <span id="quick-test-text">Avvia Test</span>
                    </button>
                </div>

                <!-- Risultati Test Rapido (nascosto inizialmente) -->
                <div id="quick-test-results"
                    style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: white; border-radius: 10px; border: 2px solid #d1d5db;">
                    <h4 style="margin: 0 0 1rem 0; color: #374151;">üìä Risultati Test</h4>
                    <div id="quick-test-items" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
                    <div id="quick-test-summary"
                        style="margin-top: 1rem; padding: 1rem; border-radius: 8px; font-weight: 600;"></div>
                </div>

                <!-- Export Report -->
                <div style="margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button id="export-json-btn"
                        style="flex: 1; min-width: 200px; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);">
                        üìÑ Export JSON
                    </button>
                    <button id="export-txt-btn"
                        style="flex: 1; min-width: 200px; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);">
                        üìù Export TXT
                    </button>
                </div>

                <!-- Reset Tutto -->
                <div
                    style="margin-top: 0.75rem; padding: 1rem; background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(220, 38, 38, 0.05)); border-radius: 8px; border: 2px dashed #ef4444;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem;">
                        <div>
                            <strong style="color: #dc2626; display: block;">üîÑ Reset Dati GPS</strong>
                            <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.85rem;">Cancella tutti i dati GPS
                                salvati (fake position, test, ecc.)</p>
                        </div>
                        <button id="reset-gps-btn"
                            style="padding: 0.65rem 1.5rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);">
                            üóëÔ∏è Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal Conferma Reset -->
            <div id="reset-modal-overlay"
                style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 9999; animation: fadeIn 0.2s;">
                <div
                    style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem;">
                    <div id="reset-modal"
                        style="background: white; border-radius: 16px; max-width: 450px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: slideUp 0.3s; overflow: hidden;">
                        <!-- Header -->
                        <div
                            style="padding: 1.5rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="font-size: 2rem;">‚ö†Ô∏è</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 1.25rem;">Conferma Reset</h3>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.95;">Questa azione √®
                                        irreversibile</p>
                                </div>
                            </div>
                        </div>

                        <!-- Body -->
                        <div style="padding: 1.5rem;">
                            <p style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem; line-height: 1.6;">
                                Stai per <strong>cancellare tutti i dati GPS</strong> salvati localmente:
                            </p>

                            <ul style="margin: 0 0 1.5rem 0; padding-left: 1.25rem; color: #6b7280; line-height: 1.8;">
                                <li>üé≠ Posizione fake simulata</li>
                                <li>üåê Dati simulazione offline</li>
                                <li>üìú Cronologia test GPS</li>
                                <li>üíæ Tutte le impostazioni salvate</li>
                            </ul>

                            <div
                                style="padding: 1rem; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <strong style="color: #92400e; font-size: 0.9rem;">üí° Nota:</strong>
                                <p style="margin: 0.25rem 0 0 0; color: #78350f; font-size: 0.85rem; line-height: 1.5;">
                                    La pagina si ricaricher√† automaticamente dopo il reset.
                                </p>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div
                            style="padding: 1rem 1.5rem; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; gap: 0.75rem; justify-content: flex-end;">
                            <button id="reset-modal-cancel"
                                style="padding: 0.75rem 1.5rem; background: white; color: #374151; border: 2px solid #d1d5db; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.95rem;">
                                ‚ùå Annulla
                            </button>
                            <button id="reset-modal-confirm"
                                style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3); font-size: 0.95rem;">
                                üóëÔ∏è Conferma Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Permessi -->
            <div id="geo-permission-status"
                style="margin-bottom: 1rem; padding: 0.75rem; background: var(--grigio-chiaro); border-radius: 8px; border-left: 4px solid gray;">
                <strong>üîê Status Permessi:</strong>
                <span id="geo-permission-text" style="margin-left: 0.5rem; font-weight: 500;">Verifica in
                    corso...</span>
            </div>

            <!-- Banner HTTPS Warning (solo se non HTTPS/localhost) -->
            <div id="https-warning-banner"
                style="display: none; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 8px; border-left: 4px solid #f59e0b; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <div style="font-size: 1.5rem; flex-shrink: 0;">‚ö†Ô∏è</div>
                    <div style="flex: 1;">
                        <strong style="color: #92400e; display: block; margin-bottom: 0.25rem;">Attenzione:
                            Geolocalizzazione richiede HTTPS</strong>
                        <p style="margin: 0; color: #78350f; font-size: 0.9rem; line-height: 1.5;">
                            La geolocalizzazione funziona solo su connessioni sicure (HTTPS) o localhost.
                            <br>
                            <strong>Soluzione:</strong> Assicurati di accedere al sito tramite <code
                                style="background: rgba(0,0,0,0.1); padding: 0.1rem 0.3rem; border-radius: 3px;">https://</code>
                        </p>
                    </div>
                </div>
            </div>

            <div class="test-item">
                <div>
                    <strong>Rilevamento Posizione GPS</strong>
                    <span
                        style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üü¢
                        OFFLINE OK</span>
                    <br>
                    <small>Testa il rilevamento della posizione attuale per verificare la funzionalit√† GPS</small>
                </div>
                <div>
                    <button id="test-location-btn" class="test-btn"
                        style="background: var(--turchese); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <span id="test-location-icon">üìç</span>
                        <span id="test-location-text">Rileva Posizione</span>
                    </button>
                </div>
            </div>
            <div id="test-location-result" class="test-result"
                style="display: none; margin-top: 1rem; padding: 1rem; background: var(--grigio-chiaro); border-radius: 8px; border-left: 4px solid var(--turchese);">
                <h4>Risultato Rilevamento:</h4>
                <div id="test-location-info"></div>
            </div>

            <!-- Simulazione Posizione Fake -->
            <div id="fake-position-section"
                style="margin-top: 1rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(147, 51, 234, 0.1)); border-radius: 12px; border: 2px solid #a855f7;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4 style="margin: 0; color: #7e22ce;">
                            üé≠ Simulazione Posizione
                            <span
                                style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üü¢
                                OFFLINE OK</span>
                        </h4>
                        <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.85rem;">Usa coordinate fake per test
                            senza GPS reale</p>
                    </div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="use-fake-position"
                            style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-weight: 600; color: #7e22ce;">Attiva</span>
                    </label>
                </div>

                <!-- Contenuto collassabile -->
                <div id="fake-position-content" style="display: none;">
                    <!-- Warning -->
                    <div
                        style="padding: 0.75rem; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 1rem;">
                        <strong style="color: #92400e;">‚ö†Ô∏è Modalit√† Test Attiva</strong>
                        <p style="margin: 0.25rem 0 0 0; color: #78350f; font-size: 0.85rem;">
                            Stai usando coordinate simulate. Il GPS reale √® disabilitato.
                        </p>
                    </div>

                    <!-- Preset Citt√† -->
                    <div style="margin-bottom: 1rem;">
                        <strong style="display: block; margin-bottom: 0.5rem; color: #374151;">üèôÔ∏è Preset Citt√†
                            FVG:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <button class="fake-position-preset" data-lat="45.6495" data-lng="13.7768"
                                data-name="Trieste">Trieste</button>
                            <button class="fake-position-preset" data-lat="46.0710" data-lng="13.2345"
                                data-name="Udine">Udine</button>
                            <button class="fake-position-preset" data-lat="45.9632" data-lng="12.6603"
                                data-name="Pordenone">Pordenone</button>
                            <button class="fake-position-preset" data-lat="45.9405" data-lng="13.6222"
                                data-name="Gorizia">Gorizia</button>
                        </div>
                    </div>

                    <!-- Input Manuale -->
                    <div style="margin-bottom: 1rem;">
                        <strong style="display: block; margin-bottom: 0.5rem; color: #374151;">üìç Coordinate
                            Personalizzate:</strong>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            <input type="number" id="fake-lat" placeholder="Latitudine" step="0.000001"
                                style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                            <input type="number" id="fake-lng" placeholder="Longitudine" step="0.000001"
                                style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            <input type="number" id="fake-accuracy" placeholder="Accuratezza (metri)" value="10" min="1"
                                max="10000"
                                style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                            <input type="number" id="fake-altitude" placeholder="Altitudine (metri)" value="0"
                                style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <input type="number" id="fake-speed" placeholder="Velocit√† (km/h) [opzionale]" min="0"
                                max="300" step="0.1"
                                style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                            <input type="number" id="fake-heading" placeholder="Direzione (0-360¬∞) [opzionale]" min="0"
                                max="360" step="1"
                                style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                        </div>
                    </div>

                    <!-- Pulsante Applica -->
                    <button id="apply-fake-position"
                        style="width: 100%; padding: 0.75rem; background: #a855f7; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        üéØ Applica Posizione Fake
                    </button>

                    <!-- Info Posizione Corrente -->
                    <div id="fake-position-info"
                        style="display: none; margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px; border-left: 4px solid #a855f7;">
                        <strong style="color: #7e22ce;">üìç Posizione Fake Attiva:</strong>
                        <div id="fake-position-details" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Watch Position - Monitoraggio Continuo -->
            <div id="watch-position-section"
                style="display: none; margin-top: 1rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); border-radius: 12px; border: 2px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4 style="margin: 0; color: #1e40af;">
                            üß≠ Monitoraggio Continuo
                            <span
                                style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üü¢
                                OFFLINE OK</span>
                        </h4>
                        <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.85rem;">Traccia la posizione GPS in
                            tempo reale mentre ti muovi</p>
                    </div>
                    <button id="toggle-watch-btn"
                        style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.3s;">
                        ‚ñ∂Ô∏è Avvia
                    </button>
                </div>

                <!-- Status Card -->
                <div id="watch-status-card"
                    style="display: none; padding: 1rem; background: white; border-radius: 10px; border-left: 4px solid #3b82f6; margin-bottom: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <div style="flex: 1;">
                            <strong style="color: #1e40af; font-size: 1rem;">üì° Monitoraggio Attivo</strong>
                            <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.85rem;">Ricevi aggiornamenti
                                automatici ogni volta che ti muovi</p>
                        </div>
                        <div style="text-align: center;">
                            <div id="watch-count"
                                style="font-size: 2rem; font-weight: 700; color: #3b82f6; line-height: 1;">0</div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">aggiornamenti</div>
                        </div>
                    </div>

                    <!-- Ultima Posizione -->
                    <div id="watch-last-position"
                        style="padding: 0.75rem; background: #f8fafc; border-radius: 6px; font-size: 0.9rem;">
                        <strong style="color: #374151;">üìç Ultima Posizione:</strong>
                        <div id="watch-last-position-data" style="margin-top: 0.5rem; color: #666;">
                            In attesa primo aggiornamento...
                        </div>
                    </div>

                    <!-- Distanza Percorsa -->
                    <div id="watch-distance"
                        style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 6px;">
                        <strong style="color: #1e40af;">üìè Distanza Percorsa:</strong>
                        <div style="font-size: 1.25rem; font-weight: 600; color: #1e3a8a; margin-top: 0.25rem;">
                            <span id="watch-distance-value">0</span> metri
                        </div>
                    </div>
                </div>

                <!-- Cronologia Posizioni -->
                <div id="watch-history" style="display: none;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <strong style="color: #374151;">üìú Cronologia Posizioni (ultime 5)</strong>
                        <button id="clear-watch-history-btn"
                            style="padding: 0.375rem 0.75rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.3s;">
                            üóëÔ∏è Cancella
                        </button>
                    </div>
                    <div id="watch-history-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Calcolo Distanza -->
            <div id="distance-calculator"
                style="display: none; margin-top: 1rem; padding: 1.5rem; background: var(--grigio-chiaro); border-radius: 12px; border: 2px solid #f59e0b;">
                <h4 style="margin-top: 0; color: #92400e;">
                    üìè Calcolo Distanza
                    <span
                        style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üü¢
                        OFFLINE OK</span>
                </h4>
                <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">Calcola la distanza dalla tua posizione
                    attuale a un punto di riferimento</p>

                <!-- Preset Citt√† FVG -->
                <div style="margin-bottom: 1rem;">
                    <strong style="display: block; margin-bottom: 0.5rem; color: #374151;">üèôÔ∏è Citt√† Principali
                        FVG:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <button class="distance-preset-btn" data-lat="45.6495" data-lng="13.7768"
                            data-name="Trieste">Trieste</button>
                        <button class="distance-preset-btn" data-lat="46.0710" data-lng="13.2345"
                            data-name="Udine">Udine</button>
                        <button class="distance-preset-btn" data-lat="45.9632" data-lng="12.6603"
                            data-name="Pordenone">Pordenone</button>
                        <button class="distance-preset-btn" data-lat="45.9405" data-lng="13.6222"
                            data-name="Gorizia">Gorizia</button>
                    </div>
                </div>

                <!-- Input Manuale -->
                <div style="margin-bottom: 1rem;">
                    <strong style="display: block; margin-bottom: 0.5rem; color: #374151;">üìç O inserisci coordinate
                        personalizzate:</strong>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <input type="number" id="target-lat" placeholder="Latitudine" step="0.000001"
                            style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                        <input type="number" id="target-lng" placeholder="Longitudine" step="0.000001"
                            style="flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                    </div>
                </div>

                <!-- Pulsante Calcola -->
                <button id="calculate-distance-btn"
                    style="width: 100%; padding: 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    üìè Calcola Distanza
                </button>

                <!-- Risultato Distanza -->
                <div id="distance-result"
                    style="display: none; margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <div id="distance-info"></div>
                </div>
            </div>

            <!-- Mappa Interattiva -->
            <div id="map-container"
                style="display: none; margin-top: 1rem; padding: 1.5rem; background: var(--grigio-chiaro); border-radius: 12px; border: 2px solid #10b981;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; color: #065f46;">
                            üó∫Ô∏è Mappa Posizione
                            <span
                                style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: linear-gradient(135deg, #fecaca, #fca5a5); color: #7f1d1d; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üî¥
                                RICHIEDE INTERNET</span>
                        </h4>
                        <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.85rem;">Visualizzazione interattiva
                            della tua posizione GPS</p>

                        <!-- Badge Dinamico Status Connessione -->
                        <div id="map-connection-badge"
                            style="display: inline-block; margin-top: 0.5rem; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; transition: all 0.3s;">
                            <span id="map-connection-icon">üü¢</span>
                            <span id="map-connection-text">Online</span>
                        </div>
                    </div>
                    <button id="recenter-map-btn"
                        style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.3s;">
                        üéØ Centra
                    </button>
                </div>

                <!-- Container Mappa Leaflet -->
                <div id="map"
                    style="height: 400px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
                </div>

                <!-- Info Mappa -->
                <div
                    style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px; font-size: 0.85rem; color: #6b7280;">
                    <strong style="color: #374151;">üìç Legenda:</strong>
                    <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; line-height: 1.8;">
                        <li><strong style="color: #3b82f6;">Marker blu</strong> = La tua posizione attuale</li>
                        <li><strong style="color: #3b82f6;">Cerchio blu</strong> = Raggio di accuratezza GPS (¬±metri)
                        </li>
                        <li>Usa <strong>scroll/pinch</strong> per zoom, <strong>drag</strong> per muovere la mappa</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Effetti e Animazioni Attive -->
        <div id="section-effects" class="test-section">
            <h2>üé≠ Effetti e Animazioni Attive</h2>
            <div class="effects-grid" id="effects-grid">
                <!-- Gli effetti verranno popolati dinamicamente -->
            </div>
            <button class="test-button" onclick="updateEffectsStatus()">üîÑ Aggiorna Status</button>
        </div>

        <!-- Test 1: Caricamento Database -->
        <div id="section-database" class="test-section has-module-header">
            <!-- Nuovo header modulo: Database -->
            <div class="test-header" data-module="database">
                <div class="test-header-top">
                    <div class="test-header-left">
                        <div class="test-title">Test Database</div>
                        <div class="test-stats">
                            <span>‚úÖ <span id="db-header-passed">0</span></span>
                            <span>‚ùå <span id="db-header-failed">0</span></span>
                            <span>‚è±Ô∏è <span id="db-header-time">0ms</span></span>
                        </div>
                    </div>
                    <div class="test-header-right">
                        <div class="test-progress" id="db-header-progress">0/17</div>
                        <span class="test-header-status status-pending status-pending-small" id="db-header-status">In attesa</span>
                    </div>
                </div>
                <div class="test-timestamp" id="db-header-timestamp" data-ts="">-</div>
                <div class="test-bar">
                    <div class="test-bar-fill" id="db-header-bar" data-progress="0"></div>
                </div>
            </div>

            <!-- CARD UNICA che contiene tutti i gruppi (stile Mobile 3) -->
            <div class="test-groups-card">

                <!-- Gruppo 1: Caricamento & Struttura -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleDbGroup('group1')">
                        <div class="test-group-bar group-db-1"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Caricamento & Struttura</div>
                            <div id="db-group1-subtitle" class="test-group-subtitle state-pending">5 test da completare</div>
                        </div>
                        <div id="db-group1-badge" class="test-group-badge badge-pending">0/5</div>
                        <div id="db-group1-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="db-group1-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-database-load">
                                <span>üìÑ Caricamento database.json</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-structure">
                                <span>üèóÔ∏è Validazione struttura base</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-lines">
                                <span>üìã Campi obbligatori</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-types">
                                <span>üîç Tipi rigorosi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-null-undefined">
                                <span>üö´ Valori null/undefined</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 2: Validazione Dati -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleDbGroup('group2')">
                        <div class="test-group-bar group-db-2"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Validazione Dati</div>
                            <div id="db-group2-subtitle" class="test-group-subtitle state-pending">4 test da completare</div>
                        </div>
                        <div id="db-group2-badge" class="test-group-badge badge-pending">0/4</div>
                        <div id="db-group2-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="db-group2-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-database-prices">
                                <span>üí∞ Validazione prezzi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-stops">
                                <span>üöè Validazione fermate</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-codes">
                                <span>üè∑Ô∏è Validazione codici</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-encoding">
                                <span>üåê Encoding e caratteri speciali</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 3: Analisi Qualit√† -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleDbGroup('group3')">
                        <div class="test-group-bar group-db-3"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Analisi Qualit√†</div>
                            <div id="db-group3-subtitle" class="test-group-subtitle state-pending">7 test da completare</div>
                        </div>
                        <div id="db-group3-badge" class="test-group-badge badge-pending">0/7</div>
                        <div id="db-group3-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="db-group3-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-database-duplicates">
                                <span>üîÑ Nomi linee duplicati</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-range">
                                <span>üìä Range prezzi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-progression">
                                <span>üìà Progressivit√† prezzi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-format">
                                <span>üî§ Formato codici</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-consistency">
                                <span>üîó Consistenza dati</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-edge-cases">
                                <span>‚ö†Ô∏è Edge cases estremi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-database-size-limit">
                                <span>üìè Dimensioni massime</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 4: Performance -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleDbGroup('group4')">
                        <div class="test-group-bar group-db-4"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Performance</div>
                            <div id="db-group4-subtitle" class="test-group-subtitle state-pending">1 test da completare</div>
                        </div>
                        <div id="db-group4-badge" class="test-group-badge badge-pending">0/1</div>
                        <div id="db-group4-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="db-group4-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-database-performance">
                                <span>üöÄ Misurazione velocit√†</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                <button class="test-button" onclick="testDatabaseLoad()" style="flex: 1; min-width: 120px;">üß™ Esegui
                    Tutti i Test</button>
                <button class="test-button" onclick="toggleAllDbGroups(true)" style="background: #6b7280; min-width: 100px;">üìÇ Espandi
                    Tutti</button>
                <button class="test-button" onclick="toggleAllDbGroups(false)" style="background: #6b7280; min-width: 100px;">üìÅ Comprimi
                    Tutti</button>
                <button class="test-button" onclick="resetDatabaseTests()" style="background: #ef4444; transition: background-color 0.2s ease; min-width: 100px;">üîÑ Reset
                    Test</button>
            </div>
            <div class="test-output" id="output-database" style="display:none;"></div>
            <div id="db-log-buttons" style="display: none; gap: 0.5rem; margin-top: 0.5rem;">
                <button class="test-button" onclick="copyDatabaseLog()" style="background: #0d9488;">üìã Copia
                    log</button>
                <button class="test-button" onclick="downloadDatabaseLog()" style="background: #3b82f6;">üíæ Scarica
                    log</button>
                <button class="test-button" onclick="clearDatabaseLog()" style="background: #ef4444;">üóëÔ∏è Cancella
                    log</button>
            </div>
        </div>

        <!-- Test 2: LocalStorage -->
        <div id="section-localstorage" class="test-section has-module-header">
            <!-- Header modulo: LocalStorage -->
            <div class="test-header" data-module="localstorage">
                <div class="test-header-content">
                    <div class="test-header-left">
                        <div class="test-title">üíæ Test LocalStorage</div>
                        <div class="test-stats">
                            <span>‚úÖ <span id="storage-header-passed">0</span></span>
                            <span>‚ùå <span id="storage-header-failed">0</span></span>
                            <span>‚è±Ô∏è <span id="storage-header-time">0ms</span></span>
                        </div>
                    </div>
                    <div class="test-header-right">
                        <div class="test-progress" id="storage-header-progress">0/22</div>
                        <span class="test-header-status status-pending status-pending-small" id="storage-header-status">In attesa</span>
                    </div>
                </div>
                <div class="test-timestamp" id="storage-header-timestamp" data-ts="">-</div>
                <div class="test-bar">
                    <div class="test-bar-fill" id="storage-header-bar" data-progress="0"></div>
                </div>
            </div>

            <!-- CARD UNICA che contiene tutti i gruppi -->
            <div class="test-groups-card">

                <!-- Gruppo 1: Test Base -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group1')">
                        <div class="test-group-bar group-storage-1"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Base</div>
                            <div id="storage-group1-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="storage-group1-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="storage-group1-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group1-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-localstorage-write">
                                <button class="test-run-single" onclick="runSingleStorageTest(1)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Scrittura localStorage</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-read">
                                <button class="test-run-single" onclick="runSingleStorageTest(2)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Lettura localStorage</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-clear">
                                <button class="test-run-single" onclick="runSingleStorageTest(3)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Cancellazione localStorage</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 2: Test Dati Complessi -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group2')">
                        <div class="test-group-bar group-storage-2"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Dati Complessi</div>
                            <div id="storage-group2-subtitle" class="test-group-subtitle state-pending">5 test da completare</div>
                        </div>
                        <div id="storage-group2-badge" class="test-group-badge badge-pending">0/5</div>
                        <div id="storage-group2-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group2-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-localstorage-json">
                                <button class="test-run-single" onclick="runSingleStorageTest(4)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Salvataggio oggetto JSON</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-array">
                                <button class="test-run-single" onclick="runSingleStorageTest(5)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Salvataggio array</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-numbers">
                                <button class="test-run-single" onclick="runSingleStorageTest(6)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Salvataggio numeri</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-booleans">
                                <button class="test-run-single" onclick="runSingleStorageTest(7)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Salvataggio booleani</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-complex">
                                <button class="test-run-single" onclick="runSingleStorageTest(8)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Dati complessi annidati</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 3: Test Edge Cases -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group3')">
                        <div class="test-group-bar group-storage-3"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Edge Cases</div>
                            <div id="storage-group3-subtitle" class="test-group-subtitle state-pending">6 test da completare</div>
                        </div>
                        <div id="storage-group3-badge" class="test-group-badge badge-pending">0/6</div>
                        <div id="storage-group3-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group3-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-localstorage-null">
                                <button class="test-run-single" onclick="runSingleStorageTest(9)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Valori null e undefined</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-empty">
                                <button class="test-run-single" onclick="runSingleStorageTest(10)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Stringhe vuote</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-special">
                                <button class="test-run-single" onclick="runSingleStorageTest(11)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Caratteri speciali (emoji, unicode)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-long">
                                <button class="test-run-single" onclick="runSingleStorageTest(12)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Valori molto lunghi (10KB)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-multiple">
                                <button class="test-run-single" onclick="runSingleStorageTest(13)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Chiavi multiple</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-available">
                                <button class="test-run-single" onclick="runSingleStorageTest(14)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Disponibilit√† localStorage</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 4: Test Avanzati -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group4')">
                        <div class="test-group-bar group-storage-4"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Avanzati</div>
                            <div id="storage-group4-subtitle" class="test-group-subtitle state-pending">2 test da completare</div>
                        </div>
                        <div id="storage-group4-badge" class="test-group-badge badge-pending">0/2</div>
                        <div id="storage-group4-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group4-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-localstorage-quota">
                                <button class="test-run-single" onclick="runSingleStorageTest(15)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Quota Storage (Simulazione)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-performance">
                                <button class="test-run-single" onclick="runSingleStorageTest(16)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Performance (Scrittura/Lettura 100KB x100)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 5: Test Robustezza -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group5')">
                        <div class="test-group-bar group-storage-5"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Robustezza</div>
                            <div id="storage-group5-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="storage-group5-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="storage-group5-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group5-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-localstorage-iterate">
                                <button class="test-run-single" onclick="runSingleStorageTest(17)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Iterazione Chiavi (localStorage.key())</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-invalid-json">
                                <button class="test-run-single" onclick="runSingleStorageTest(18)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Lettura JSON Invalido</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-non-string">
                                <button class="test-run-single" onclick="runSingleStorageTest(19)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Scrittura Valori Non-Stringa</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 6: Test PWA Specifici -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="toggleStorageGroup('group6')">
                        <div class="test-group-bar group-storage-6"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test PWA Specifici</div>
                            <div id="storage-group6-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="storage-group6-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="storage-group6-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="storage-group6-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-localstorage-namespace">
                                <button class="test-run-single" onclick="runSingleStorageTest(20)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Validazione Namespace (tpl.*)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-migration">
                                <button class="test-run-single" onclick="runSingleStorageTest(21)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Migrazione isDark ‚Üí themeMode</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-localstorage-timestamp">
                                <button class="test-run-single" onclick="runSingleStorageTest(22)" title="Esegui solo questo test">‚ñ∂</button>
                                <span>Gestione Timestamp (pwa.dismissTs)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Fine Card Gruppi Test LocalStorage -->
            
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                <button class="test-button" onclick="testLocalStorage()" style="flex: 1; min-width: 150px;">üß™ Test LocalStorage (22 test)</button>
                <button class="test-button" onclick="toggleAllStorageGroups(true)" style="background: #6b7280;">üìÇ Apri Tutti</button>
                <button class="test-button" onclick="toggleAllStorageGroups(false)" style="background: #6b7280;">üìÅ Chiudi Tutti</button>
            </div>
            <div class="test-output" id="output-localstorage" style="display:none;"></div>
        </div>

        <!-- Test 3: Dark Mode -->
        <div id="section-darkmode" class="test-section">
            <h2>üåô Test Dark Mode</h2>
            <div class="test-item" id="test-darkmode-toggle">
                <span>Toggle dark mode</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-darkmode-persistence">
                <span>Persistenza preferenza</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testDarkMode()">üß™ Test Dark Mode</button>
            <div class="test-output" id="output-darkmode" style="display:none;"></div>
        </div>

        <!-- Test 4: Calcolo Prezzi (Modulo prezzi.js) -->
        <div id="section-prezzi" class="test-section has-module-header">
            <!-- Nuovo header modulo: Prezzi -->
            <div class="test-header" data-module="prezzi">
                <div class="test-header-top">
                    <div class="test-title">üí∞ Test Prezzi</div>
                    <div class="test-progress" id="price-header-progress">0/26</div>
                    <span class="test-header-status status-pending" id="price-header-status">In attesa</span>
                </div>
                <div class="test-stats">
                    <span>‚úÖ <span id="price-header-passed">0</span></span>
                    <span>‚ùå <span id="price-header-failed">0</span></span>
                    <span>‚è±Ô∏è <span id="price-header-time">0ms</span></span>
                </div>
                <div class="test-timestamp" id="price-header-timestamp" data-ts="">-</div>
                <div class="test-bar">
                    <div class="test-bar-fill" id="price-header-bar" data-progress="0"></div>
                </div>
            </div>

            <!-- CARD UNICA che contiene tutti i gruppi (stile Mobile 3) -->
            <div class="test-groups-card">

                <!-- Gruppo 1: Test Unitari -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="togglePriceGroup('group1')">
                        <div class="test-group-bar group-price-1"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Unitari</div>
                            <div id="price-group1-subtitle" class="test-group-subtitle state-pending">5 test da completare</div>
                        </div>
                        <div id="price-group1-badge" class="test-group-badge badge-pending">0/5</div>
                        <div id="price-group1-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="price-group1-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-pricing-calculate">
                                <span>Pricing.calculatePrice()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-ticket-code">
                                <span>Pricing.getTicketCode()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-format">
                                <span>Pricing.formatPrice()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-validation">
                                <span>Pricing.isValidSelection()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-route">
                                <span>Pricing.isRouteAvailable()</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 2: Edge Cases -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="togglePriceGroup('group2')">
                        <div class="test-group-bar group-price-2"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Edge Cases</div>
                            <div id="price-group2-subtitle" class="test-group-subtitle state-pending">3 test da completare</div>
                        </div>
                        <div id="price-group2-badge" class="test-group-badge badge-pending">0/3</div>
                        <div id="price-group2-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="price-group2-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-pricing-same-stop">
                                <span>Stessa fermata (partenza = arrivo)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-out-of-range">
                                <span>Indici fuori range</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-fallback">
                                <span>Fallback tariffarioAggiornato</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 3: Test Avanzati -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="togglePriceGroup('group3')">
                        <div class="test-group-bar group-price-3"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Test Avanzati</div>
                            <div id="price-group3-subtitle" class="test-group-subtitle state-pending">5 test da completare</div>
                        </div>
                        <div id="price-group3-badge" class="test-group-badge badge-pending">0/5</div>
                        <div id="price-group3-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="price-group3-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-pricing-empty-tariffario">
                                <span>Tariffario vuoto/null</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-negative-indices">
                                <span>Indici negativi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-string-indices">
                                <span>Indici come stringhe ("0", "5")</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-zero-price">
                                <span>Prezzo zero (gratuito)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-missing-matrices">
                                <span>Matrici prezzi/codici mancanti</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gruppo 4: Robustezza Dati -->
                <div class="test-group-separator">
                    <div class="test-group-header" onclick="togglePriceGroup('group4')">
                        <div class="test-group-bar group-price-4"></div>
                        <div class="test-group-title-container">
                            <div class="test-group-title">Robustezza Dati</div>
                            <div id="price-group4-subtitle" class="test-group-subtitle state-pending">13 test da completare</div>
                        </div>
                        <div id="price-group4-badge" class="test-group-badge badge-pending">0/13</div>
                        <div id="price-group4-icon" class="test-group-icon">‚ñ∂</div>
                    </div>
                    <div id="price-group4-content" class="test-group-content">
                        <div class="test-group-items-container">
                            <div class="test-item" id="test-pricing-null-price">
                                <span>Prezzo null nella matrice</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-undefined-price">
                                <span>Prezzo undefined nella matrice</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-string-price">
                                <span>Prezzo come stringa ("3.50")</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-line-not-exists">
                                <span>Linea non esistente (indice 999)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-result-structure">
                                <span>Struttura risultato corretta</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-nan-price">
                                <span>Prezzo NaN nella matrice</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-infinity-price">
                                <span>Prezzo Infinity nella matrice</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-negative-price">
                                <span>Prezzo negativo</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-fermate-not-array">
                                <span>fermate non array</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-code-with-spaces">
                                <span>Codice con spazi</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-price-code-only">
                                <span>Solo codice senza prezzo</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-multiple-lines">
                                <span>Test con pi√π linee diverse</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                            <div class="test-item" id="test-pricing-performance">
                                <span>Performance (1000 calcoli)</span>
                                <span class="test-status pending">In attesa</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Fine Card Gruppi Test Prezzi -->

            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 1rem;">
                <button class="test-button" onclick="testPriceCalculation()" style="flex: 1; min-width: 150px;">üß™ Test
                    Modulo Prezzi</button>
                <button class="test-button" onclick="toggleAllPriceGroups(true)" style="background: #6b7280;">üìÇ Apri
                    Tutti</button>
                <button class="test-button" onclick="toggleAllPriceGroups(false)" style="background: #6b7280;">üìÅ Chiudi
                    Tutti</button>
            </div>
            <div class="test-output" id="output-price" style="display:none;" data-no-copy="true"></div>
            <div id="price-log-buttons" style="display: none; gap: 0.5rem; margin-top: 0.5rem;">
                <button class="test-button" onclick="copyPriceLog()" style="background: #0d9488;">üìã Copia log</button>
                <button class="test-button" onclick="downloadPriceLog()" style="background: #3b82f6;">üíæ Scarica
                    log</button>
                <button class="test-button" onclick="clearPriceLog()" style="background: #ef4444;">üóëÔ∏è Cancella
                    log</button>
                <button class="test-button" onclick="resetPriceTests()" style="background: #f59e0b;">üîÑ Reset
                    Test</button>
            </div>
        </div>

        <!-- Test 5: Service Worker -->
        <div id="section-sw" class="test-section">
            <h2>‚öôÔ∏è Test Service Worker (PWA)</h2>
            <div class="test-item" id="test-sw-registration">
                <span>Registrazione Service Worker</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-sw-cache">
                <span>Verifica cache</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testServiceWorker()">üß™ Test Service Worker</button>
            <div class="test-output" id="output-sw" style="display:none;"></div>
        </div>

        <!-- Test 6: UI Components -->
        <div id="section-ui" class="test-section">
            <h2>üé® Test Componenti UI</h2>
            <div class="test-item" id="test-ui-selects">
                <span>Popolamento select</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-ui-swap">
                <span>Funzione swap percorso</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-ui-summary">
                <span>Aggiornamento riepilogo</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testUIComponents()">üß™ Test UI Components</button>
            <div class="test-output" id="output-ui" style="display:none;"></div>
        </div>

        <!-- Test 7: Manifest PWA -->
        <div id="section-manifest" class="test-section">
            <h2>üì± Test Manifest PWA</h2>
            <div class="test-item" id="test-manifest-load">
                <span>Caricamento manifest.json</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-manifest-icons">
                <span>Validazione icone</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testManifest()">üß™ Test Manifest</button>
            <div class="test-output" id="output-manifest" style="display:none;"></div>
        </div>

        <!-- Test 8: Performance -->
        <div id="section-performance" class="test-section">
            <h2>‚ö° Test Performance</h2>
            <div class="test-item" id="test-perf-load-time">
                <span>Tempo caricamento dati</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <div class="test-item" id="test-perf-calc-time">
                <span>Tempo calcolo prezzo</span>
                <span class="test-status pending">In attesa</span>
            </div>
            <button class="test-button" onclick="testPerformance()">üß™ Test Performance</button>
            <div class="test-output" id="output-performance" style="display:none;"></div>
        </div>

    </div>

    <!-- Pulsante torna su -->
    <button class="scroll-to-top" onclick="scrollToTop()" title="Torna su">
        ‚Üë
    </button>

    <!-- Modal conferma reset cache / verifica aggiornamenti -->
    <div id="cache-modal" class="cache-modal">
        <div class="cache-modal-content">
            <div class="cache-modal-header">
                <h3 id="modal-title">üîÑ Verifica Aggiornamenti</h3>
            </div>
            <div class="cache-modal-body">
                <p id="modal-message">Verifico se ci sono aggiornamenti disponibili...</p>
                <p class="cache-modal-warning" id="modal-warning" style="display: none;"></p>
            </div>
            <div class="cache-modal-footer">
                <button id="cache-cancel" class="cache-modal-btn cache-modal-cancel">Annulla</button>
                <button id="cache-confirm" class="cache-modal-btn cache-modal-confirm" style="display: none;">Riavvia e
                    Aggiorna</button>
            </div>
        </div>
    </div>

    <!-- Modal Impostazioni -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-modal-content">
            <!-- Header -->
            <div class="settings-modal-header">
                <h3>‚öôÔ∏è Impostazioni</h3>
                <button id="settings-modal-close" class="settings-modal-close" aria-label="Chiudi">√ó</button>
            </div>

            <!-- Tabs -->
            <div class="settings-tabs">
                <button class="settings-tab active" data-tab="appearance">
                    <span class="tab-icon">üëÅÔ∏è</span>
                    <span>Aspetto</span>
                </button>
                <button class="settings-tab" data-tab="accessibility">
                    <span class="tab-icon">‚ôø</span>
                    <span>Accessibilit√†</span>
                </button>
                <button class="settings-tab" data-tab="info">
                    <span class="tab-icon">‚ÑπÔ∏è</span>
                    <span>Info</span>
                </button>
            </div>

            <!-- Tab Content -->
            <div class="settings-content">

                <!-- Tab Aspetto -->
                <div class="settings-tab-content active" data-content="appearance">
                    <div class="settings-section">

                        <!-- Theme Mode -->
                        <div class="settings-item settings-item-vertical">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">üåì</span>
                                <div class="settings-item-text">
                                    <div class="settings-item-label">Tema</div>
                                    <div class="settings-item-description">Scegli l'aspetto dell'app</div>
                                </div>
                            </div>
                            <div class="settings-theme-options">
                                <label class="settings-theme-option">
                                    <input type="radio" name="theme-mode" value="system" id="theme-system" checked>
                                    <span class="theme-option-card">
                                        <span class="theme-option-icon">‚öôÔ∏è</span>
                                        <span class="theme-option-label">Sistema</span>
                                        <span class="theme-option-description">Segue il dispositivo</span>
                                    </span>
                                </label>
                                <label class="settings-theme-option">
                                    <input type="radio" name="theme-mode" value="light" id="theme-light">
                                    <span class="theme-option-card">
                                        <span class="theme-option-icon">‚òÄÔ∏è</span>
                                        <span class="theme-option-label">Chiara</span>
                                        <span class="theme-option-description">Sempre chiara</span>
                                    </span>
                                </label>
                                <label class="settings-theme-option">
                                    <input type="radio" name="theme-mode" value="dark" id="theme-dark">
                                    <span class="theme-option-card">
                                        <span class="theme-option-icon">üåô</span>
                                        <span class="theme-option-label">Scura</span>
                                        <span class="theme-option-description">Sempre scura</span>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Animazione Sfondo -->
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">üé¨</span>
                                <div class="settings-item-text">
                                    <label class="settings-item-label" for="settings-animation">Animazione
                                        sfondo</label>
                                    <div class="settings-item-description">Gradiente animato nello sfondo</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="settings-animation"
                                    aria-label="Attiva/disattiva animazione sfondo">
                                <span class="settings-toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Contrasto Alto -->
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">üëÅÔ∏è</span>
                                <div class="settings-item-text">
                                    <label class="settings-item-label" for="settings-high-contrast">Contrasto
                                        elevato</label>
                                    <div class="settings-item-description">Migliora leggibilit√† in pieno sole</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="settings-high-contrast"
                                    aria-label="Attiva/disattiva contrasto elevato">
                                <span class="settings-toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Riduci Animazioni -->
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">‚ö°</span>
                                <div class="settings-item-text">
                                    <div class="settings-item-label">Riduci animazioni</div>
                                    <div class="settings-item-description">Disabilita transizioni ed effetti visivi
                                    </div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="settings-reduce-motion"
                                    aria-label="Attiva/disattiva riduzione animazioni">
                                <span class="settings-toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Tab Accessibilit√† -->
                <div class="settings-tab-content" data-content="accessibility">
                    <div class="settings-section">

                        <!-- Dimensione Testo -->
                        <div class="settings-item settings-item-vertical">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">A</span>
                                <div class="settings-item-text">
                                    <div class="settings-item-label">Dimensione testo</div>
                                    <div class="settings-item-description">Scegli la dimensione pi√π comoda</div>
                                </div>
                            </div>
                            <div class="settings-font-buttons">
                                <button class="settings-font-btn active" data-size="normal">
                                    <span class="font-sample">A</span>
                                    <span class="font-label">Normale</span>
                                </button>
                                <button class="settings-font-btn" data-size="large">
                                    <span class="font-sample">A</span>
                                    <span class="font-label">Grande</span>
                                </button>
                                <button class="settings-font-btn" data-size="xlarge">
                                    <span class="font-sample">A</span>
                                    <span class="font-label">Molto Grande</span>
                                </button>
                            </div>
                        </div>

                        <!-- Pulsanti Grandi -->
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">üëÜ</span>
                                <div class="settings-item-text">
                                    <label class="settings-item-label" for="settings-touch-friendly">Modalit√†
                                        touch</label>
                                    <div class="settings-item-description">Pulsanti pi√π grandi e spaziati</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="settings-touch-friendly"
                                    aria-label="Attiva/disattiva modalit√† touch">
                                <span class="settings-toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Feedback Aptico -->
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">üì≥</span>
                                <div class="settings-item-text">
                                    <div class="settings-item-label">Feedback aptico</div>
                                    <div class="settings-item-description">Vibrazione su azioni e conferme</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="settings-haptic-feedback"
                                    aria-label="Attiva/disattiva feedback aptico">
                                <span class="settings-toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Keep Screen On -->
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">‚òÄÔ∏è</span>
                                <div class="settings-item-text">
                                    <div class="settings-item-label">Schermo sempre attivo</div>
                                    <div class="settings-item-description">Impedisce lo spegnimento automatico</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="settings-keep-screen-on"
                                    aria-label="Attiva/disattiva schermo sempre attivo">
                                <span class="settings-toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Spaziatura Extra -->
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">üìè</span>
                                <div class="settings-item-text">
                                    <div class="settings-item-label">Spaziatura extra</div>
                                    <div class="settings-item-description">Pulsanti pi√π grandi e spaziati</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="settings-extra-spacing"
                                    aria-label="Attiva/disattiva spaziatura extra">
                                <span class="settings-toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Layout Compatto -->
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">üìê</span>
                                <div class="settings-item-text">
                                    <div class="settings-item-label">Layout compatto</div>
                                    <div class="settings-item-description">Riduce spazi per mostrare pi√π contenuto</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="settings-compact-layout"
                                    aria-label="Attiva/disattiva layout compatto">
                                <span class="settings-toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Filtro Luce Blu -->
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <span class="settings-item-icon">üîµ</span>
                                <div class="settings-item-text">
                                    <div class="settings-item-label">Filtro luce blu</div>
                                    <div class="settings-item-description">Riduce affaticamento occhi (uso notturno)
                                    </div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="settings-blue-light-filter"
                                    aria-label="Attiva/disattiva filtro luce blu">
                                <span class="settings-toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Sezione Dimensione Interfaccia -->
                    <div class="settings-section">
                        <h4 class="settings-section-title">üîç Dimensione Interfaccia</h4>

                        <div class="scale-preset-selector">
                            <div class="scale-preset-description">
                                Scala l'intera interfaccia della web app
                            </div>

                            <div class="scale-preset-options">
                                <label class="scale-preset-option">
                                    <input type="radio" name="interface-scale" value="75" id="scale-75">
                                    <div class="scale-preset-card">
                                        <div class="scale-preset-info">
                                            <div class="scale-preset-name">Molto Compatta</div>
                                            <div class="scale-preset-percent">75%</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="scale-preset-option">
                                    <input type="radio" name="interface-scale" value="85" id="scale-85">
                                    <div class="scale-preset-card">
                                        <div class="scale-preset-info">
                                            <div class="scale-preset-name">Compatta</div>
                                            <div class="scale-preset-percent">85%</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="scale-preset-option">
                                    <input type="radio" name="interface-scale" value="100" id="scale-100" checked>
                                    <div class="scale-preset-card">
                                        <div class="scale-preset-info">
                                            <div class="scale-preset-name">Normale</div>
                                            <div class="scale-preset-percent">100%</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="scale-preset-option">
                                    <input type="radio" name="interface-scale" value="115" id="scale-115">
                                    <div class="scale-preset-card">
                                        <div class="scale-preset-info">
                                            <div class="scale-preset-name">Grande</div>
                                            <div class="scale-preset-percent">115%</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="scale-preset-option">
                                    <input type="radio" name="interface-scale" value="125" id="scale-125">
                                    <div class="scale-preset-card">
                                        <div class="scale-preset-info">
                                            <div class="scale-preset-name">Molto Grande</div>
                                            <div class="scale-preset-percent">125%</div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Sezione Ottimizzazione Display -->
                    <div class="settings-section">
                        <h4 class="settings-section-title">üñ•Ô∏è Ottimizzazione Display</h4>

                        <!-- Info Display Rilevato -->
                        <div class="display-optimization-card">
                            <div class="display-detection">
                                <div class="display-detection-header">
                                    <span class="display-detection-icon">üì±</span>
                                    <div class="display-detection-info">
                                        <div class="display-detection-title">Display rilevato</div>
                                        <div class="display-detection-type" id="display-type-indicator">
                                            <span id="display-type-text">Rilevamento...</span>
                                            <span class="display-dpr-badge" id="display-dpr-badge">-</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="display-specs">
                                    <div class="display-spec-item">
                                        <span class="display-spec-label">Device Pixel Ratio</span>
                                        <span class="display-spec-value" id="dpr-value">-</span>
                                    </div>
                                    <div class="display-spec-item">
                                        <span class="display-spec-label">Risoluzione fisica</span>
                                        <span class="display-spec-value" id="resolution-value">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Preset Ottimizzazione -->
                            <div class="display-preset-selector"
                                style="margin-top: 1rem; border-top: 1px solid var(--bordo); padding-top: 1rem;">
                                <div class="preset-header">
                                    <span class="preset-header-icon">üé®</span>
                                    <div class="preset-header-text">
                                        <div class="preset-header-title">Livello di ottimizzazione</div>
                                        <div class="preset-header-description">Scegli il preset pi√π adatto al tuo
                                            display</div>
                                    </div>
                                </div>

                                <div class="preset-options">
                                    <label class="preset-option" data-preset="auto">
                                        <input type="radio" name="display-preset" value="auto" id="preset-auto">
                                        <div class="preset-card">
                                            <div class="preset-icon">‚ö°</div>
                                            <div class="preset-info">
                                                <div class="preset-name">
                                                    Automatico
                                                    <span class="recommended-badge" id="auto-badge"
                                                        style="display: none;">Consigliato</span>
                                                </div>
                                                <div class="preset-description">Rileva e ottimizza automaticamente</div>
                                            </div>
                                        </div>
                                    </label>

                                    <label class="preset-option" data-preset="standard">
                                        <input type="radio" name="display-preset" value="standard" id="preset-standard">
                                        <div class="preset-card">
                                            <div class="preset-icon">üì∫</div>
                                            <div class="preset-info">
                                                <div class="preset-name">Standard</div>
                                                <div class="preset-description">Nessuna ottimizzazione (DPR 1.0x)</div>
                                            </div>
                                        </div>
                                    </label>

                                    <label class="preset-option" data-preset="retina">
                                        <input type="radio" name="display-preset" value="retina" id="preset-retina">
                                        <div class="preset-card">
                                            <div class="preset-icon">üíé</div>
                                            <div class="preset-info">
                                                <div class="preset-name">Retina</div>
                                                <div class="preset-description">Ottimizzato per DPR 2.0x (HiDPI)</div>
                                            </div>
                                        </div>
                                    </label>

                                    <label class="preset-option" data-preset="ultra">
                                        <input type="radio" name="display-preset" value="ultra" id="preset-ultra">
                                        <div class="preset-card">
                                            <div class="preset-icon">‚ú®</div>
                                            <div class="preset-info">
                                                <div class="preset-name">Ultra HD</div>
                                                <div class="preset-description">Massima qualit√† per DPR 3.0x+</div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Suggerimenti -->
                            <div class="display-recommendations" id="display-recommendations" style="display: none;">
                                <div class="recommendation-header">
                                    <span class="recommendation-icon">üí°</span>
                                    <span class="recommendation-title">Suggerimenti per il tuo display</span>
                                </div>
                                <ul class="recommendation-list" id="recommendation-list">
                                    <!-- Popolato dinamicamente -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Info e Aggiornamenti -->
                <div class="settings-tab-content" data-content="info">
                    <div class="settings-section">

                        <!-- Informazioni App -->
                        <div class="info-card">
                            <div class="info-header">
                                <img src="src/logo.png" alt="TPL FVG" class="info-logo">
                                <div class="info-title">
                                    <h3>TPL FVG Autisti</h3>
                                    <p class="info-version">Versione ...</p>
                                    <p class="info-date">27 Ottobre 2025 - 19:30</p>
                                </div>
                            </div>

                            <div class="info-description">
                                <p>App per calcolare i prezzi dei biglietti e visualizzare le fermate del trasporto
                                    pubblico locale del Friuli Venezia Giulia.</p>
                            </div>

                            <div class="info-features">
                                <div class="info-feature">
                                    <span class="info-feature-icon">üí∞</span>
                                    <span>Calcolo prezzi biglietti</span>
                                </div>
                                <div class="info-feature">
                                    <span class="info-feature-icon">üöå</span>
                                    <span>Elenco fermate per linea</span>
                                </div>
                                <div class="info-feature">
                                    <span class="info-feature-icon">üì±</span>
                                    <span>Installabile come PWA</span>
                                </div>
                                <div class="info-feature">
                                    <span class="info-feature-icon">üåô</span>
                                    <span>Modalit√† scura</span>
                                </div>
                            </div>
                        </div>

                        <!-- Verifica Aggiornamenti -->
                        <div class="info-card update-check-card">
                            <div class="update-check-header">
                                <div class="update-check-icon">üîÑ</div>
                                <div class="update-check-text">
                                    <h4 class="update-check-title">Verifica Aggiornamenti</h4>
                                    <p class="update-check-description">Controlla se √® disponibile una nuova versione
                                        dell'app</p>
                                </div>
                            </div>
                            <button id="pwa-cache-reset" class="update-check-btn">
                                Verifica Aggiornamenti
                            </button>
                        </div>

                        <!-- Riavvia App -->
                        <div class="info-card update-check-card">
                            <div class="update-check-header">
                                <div class="update-check-icon">üì≤</div>
                                <div class="update-check-text">
                                    <h4 class="update-check-title">Riavvia App</h4>
                                    <p class="update-check-description">Riavvia l'applicazione per applicare le
                                        modifiche</p>
                                </div>
                            </div>
                            <button id="restart-app-btn" class="update-check-btn restart-app-btn">
                                Riavvia Ora
                            </button>
                        </div>

                        <!-- Aggiornamenti Recenti -->
                        <div class="info-card">
                            <h4 class="info-card-title">üìã Aggiornamenti Recenti</h4>

                            <!-- Contenitore dinamico per il changelog -->
                            <div id="changelog-container">
                                <!-- Il changelog verr√† inserito qui da changelog.js -->
                            </div>
                        </div>

                        <!-- Link Utili -->
                        <div class="info-card">
                            <h4 class="info-card-title">üîó Link Utili</h4>

                            <a href="https://t.me/+eoJ9nYFFrjphMzVk" target="_blank" class="info-link external-link">
                                <span class="info-link-icon">üì¢</span>
                                <span>Canale Telegram - Avvisi & Aggiornamenti</span>
                                <span>‚Üó</span>
                            </a>

                            <a href="benvenuto.html" class="info-link">
                                <span class="info-link-icon">üëã</span>
                                <span>Pagina Benvenuto</span>
                                <span>‚Üí</span>
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <!-- Footer generato dinamicamente da footer.js -->
    </footer>

    <!-- Script di test -->
    <script src="footer.js"></script>
    <script src="changelog.js"></script>
    <script src="js/features/updates.js"></script>
    <script src="js/features/settings.js"></script>
    <script src="js/features/tests-ui.js"></script>
    <script src="js/features/prezzi.js?v=20251102-2"></script>
    <script src="js/tests/test-prezzi.js"></script>
    <!-- Modulo utility per test - Step 1 modularizzazione (02/11/2025) -->
    <script src="js/tests/test-utils.js"></script>
    <!-- Moduli test per categoria - Step 2 modularizzazione (02/11/2025) -->
    <script src="js/tests/test-database.js"></script>
    <script src="js/tests/test-localstorage.js"></script>
    <!-- File test non ancora creati - da implementare:
    <script src="js/tests/test-darkmode.js"></script>
    <script src="js/tests/test-sw.js"></script>
    <script src="js/tests/test-ui.js"></script>
    <script src="js/tests/test-manifest.js"></script>
    <script src="js/tests/test-performance.js"></script>
    -->
    <script src="js/components/modals.js"></script>
    <script src="script.js"></script>
    <script src="test-config.js"></script>
    <script>
        // ===== ATTIVA PULSANTI COPIA LOG =====
        // Rimosso: i pulsanti vengono ora aggiunti solo quando si esegue il test

        // ===== WRAPPER LEGACY COMPATIBILITY =====
        // Manteniamo le funzioni globali per retrocompatibilit√†, ma delegano a TestUtils
        function log(outputId, message, type = 'info') {
            if (typeof TestUtils !== 'undefined' && TestUtils.log) {
                TestUtils.log(outputId, message, type);
            } else {
                console.error('TestUtils non disponibile! Assicurati che test-utils.js sia caricato.');
                // Fallback base per non bloccare completamente
                const output = document.getElementById(outputId);
                if (output) {
                    output.style.display = 'block';
                    const logDiv = document.createElement('div');
                    logDiv.className = `console-log ${type}`;
                    logDiv.textContent = `[${new Date().toLocaleTimeString('it-IT')}] ${message}`;
                    output.appendChild(logDiv);
                    output.scrollTop = output.scrollHeight;
                }
            }
        }

        function updateTestStatus(testId, status) {
            if (typeof TestUtils !== 'undefined' && TestUtils.updateTestStatus) {
                TestUtils.updateTestStatus(testId, status);
            } else {
                console.error('TestUtils non disponibile!');
            }
        }

        function updateStats() {
            if (typeof TestUtils !== 'undefined' && TestUtils.updateStats) {
                TestUtils.updateStats();
            } else {
                console.error('TestUtils non disponibile!');
            }
        }

        // ===== TOGGLE ACCORDION DATABASE GROUPS =====
        function toggleDbGroup(groupId) {
            const content = document.getElementById(`db-${groupId}-content`);
            const icon = document.getElementById(`db-${groupId}-icon`);
            // Trova il separator partendo dal contenuto (pi√π affidabile)
            const separator = content?.closest('.test-group-separator');

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                // Aggiungi animazione bounce PRIMA di espandere
                if (separator) {
                    // Rimuovi eventuali classi precedenti
                    separator.classList.remove('expanding');
                    
                    // Forza un reflow per assicurarsi che l'animazione parta
                    separator.offsetHeight;
                    
                    // Aggiungi la classe expanding
                    separator.classList.add('expanding');
                    
                    // Debug: verifica che la classe sia stata aggiunta
                    console.log('‚úÖ Animazione applicata a:', separator, 'Classe expanding:', separator.classList.contains('expanding'));
                    
                    // Rimuovi dopo l'animazione
                    setTimeout(() => {
                        separator.classList.remove('expanding');
                    }, 500);
                } else {
                    console.warn('‚ö†Ô∏è Separator non trovato per gruppo:', groupId, 'Content:', content);
                }
                
                // Poi espandi il contenuto
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        function togglePriceGroup(groupId) {
            const content = document.getElementById(`price-${groupId}-content`);
            const icon = document.getElementById(`price-${groupId}-icon`);

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        function toggleAllDbGroups(open) {
            const groups = ['group1', 'group2', 'group3', 'group4'];
            groups.forEach(groupId => {
                const content = document.getElementById(`db-${groupId}-content`);
                const icon = document.getElementById(`db-${groupId}-icon`);

                if (open) {
                    content.classList.add('expanded');
                    icon.classList.add('expanded');
                } else {
                    content.classList.remove('expanded');
                    icon.classList.remove('expanded');
                }
            });
        }

        // ===== FUNZIONI TOGGLE PER LOCALSTORAGE =====
        function toggleStorageGroup(groupId) {
            const content = document.getElementById(`storage-${groupId}-content`);
            const icon = document.getElementById(`storage-${groupId}-icon`);
            const separator = content?.closest('.test-group-separator');

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                // Aggiungi animazione bounce PRIMA di espandere
                if (separator) {
                    separator.classList.remove('expanding');
                    separator.offsetHeight;
                    separator.classList.add('expanding');
                    
                    setTimeout(() => {
                        separator.classList.remove('expanding');
                    }, 600);
                }
                
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        function toggleAllStorageGroups(open) {
            const groups = ['group1', 'group2', 'group3', 'group4', 'group5', 'group6'];
            groups.forEach(groupId => {
                const content = document.getElementById(`storage-${groupId}-content`);
                const icon = document.getElementById(`storage-${groupId}-icon`);

                if (open) {
                    content.classList.add('expanded');
                    icon.classList.add('expanded');
                } else {
                    content.classList.remove('expanded');
                    icon.classList.remove('expanded');
                }
            });
        }

        function toggleAllPriceGroups(open) {
            const groups = ['group1', 'group2', 'group3', 'group4'];
            groups.forEach(groupId => {
                const content = document.getElementById(`price-${groupId}-content`);
                const icon = document.getElementById(`price-${groupId}-icon`);

                if (open) {
                    content.classList.add('expanded');
                    icon.classList.add('expanded');
                } else {
                    content.classList.remove('expanded');
                    icon.classList.remove('expanded');
                }
            });
        }

        // ===== FUNZIONI GESTIONE LOG =====
        function copyDatabaseLog() {
            const output = document.getElementById('output-database');
            if (output && output.textContent) {
                navigator.clipboard.writeText(output.textContent).then(() => {
                    alert('Log Database copiato negli appunti!');
                }).catch(err => {
                    console.error('Errore copia log:', err);
                });
            }
        }

        function downloadDatabaseLog() {
            const output = document.getElementById('output-database');
            if (output && output.textContent) {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `test-database-${timestamp}.txt`;
                const blob = new Blob([output.textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        function clearDatabaseLog() {
            const output = document.getElementById('output-database');
            const buttons = document.getElementById('db-log-buttons');
            if (output) {
                output.innerHTML = '';
                output.style.display = 'none';
            }
            if (buttons) {
                buttons.style.display = 'none';
            }
        }

        function copyPriceLog() {
            const output = document.getElementById('output-price');
            if (output && output.textContent) {
                navigator.clipboard.writeText(output.textContent).then(() => {
                    alert('Log Prezzi copiato negli appunti!');
                }).catch(err => {
                    console.error('Errore copia log:', err);
                });
            }
        }

        function downloadPriceLog() {
            const output = document.getElementById('output-price');
            if (output && output.textContent) {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `test-prezzi-${timestamp}.txt`;
                const blob = new Blob([output.textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        function clearPriceLog() {
            const output = document.getElementById('output-price');
            const buttons = document.getElementById('price-log-buttons');
            if (output) {
                output.innerHTML = '';
                output.style.display = 'none';
            }
            if (buttons) {
                buttons.style.display = 'none';
            }
        }

        function resetDatabaseTests() {
            // Resetta il log
            clearDatabaseLog();

            // Resetta l'header
            const progressEl = document.getElementById('db-header-progress');
            const statusEl = document.getElementById('db-header-status');
            const passedEl = document.getElementById('db-header-passed');
            const failedEl = document.getElementById('db-header-failed');
            const timeEl = document.getElementById('db-header-time');
            const timestampEl = document.getElementById('db-header-timestamp');
            const barEl = document.getElementById('db-header-bar');

            if (progressEl) progressEl.textContent = '0/17';
            if (statusEl) {
                statusEl.className = 'test-header-status status-pending';
                statusEl.textContent = 'In attesa';
            }
            if (passedEl) passedEl.textContent = '0';
            if (failedEl) failedEl.textContent = '0';
            if (timeEl) timeEl.textContent = '0ms';
            if (timestampEl) {
                timestampEl.textContent = '-';
                timestampEl.setAttribute('data-ts', '');
            }
            if (barEl) barEl.setAttribute('data-progress', '0');

            // Resetta i badge e subtitle dei gruppi
            const groups = [
                { id: 'group1', total: 5, text: '5 test' },
                { id: 'group2', total: 4, text: '4 test' },
                { id: 'group3', total: 7, text: '7 test' },
                { id: 'group4', total: 1, text: '1 test' }
            ];

            groups.forEach(group => {
                const badge = document.getElementById(`db-${group.id}-badge`);
                const subtitle = document.getElementById(`db-${group.id}-subtitle`);
                if (badge) {
                    badge.textContent = `0/${group.total}`;
                    badge.classList.remove('badge-partial', 'badge-complete');
                    badge.classList.add('badge-pending');
                }
                if (subtitle) {
                    subtitle.textContent = `${group.text} da completare`;
                    subtitle.classList.remove('state-partial', 'state-complete');
                    subtitle.classList.add('state-pending');
                }
            });

            // Resetta tutti gli status dei test a "pending"
            const testIds = [
                // Gruppo 1: Caricamento & Struttura
                'test-database-load', 'test-database-structure', 'test-database-lines',
                'test-database-types', 'test-database-null-undefined',
                // Gruppo 2: Validazione Dati
                'test-database-prices', 'test-database-stops', 'test-database-codes',
                'test-database-encoding',
                // Gruppo 3: Analisi Qualit√†
                'test-database-duplicates', 'test-database-range', 'test-database-progression',
                'test-database-format', 'test-database-consistency',
                'test-database-edge-cases', 'test-database-size-limit',
                // Gruppo 4: Performance
                'test-database-performance'
            ];

            testIds.forEach(id => {
                const testElement = document.getElementById(id);
                if (testElement) {
                    const statusSpan = testElement.querySelector('.test-status');
                    if (statusSpan) {
                        statusSpan.className = 'test-status pending';
                        statusSpan.textContent = 'In attesa';
                    }
                }
            });

            // Chiudi tutti i gruppi
            toggleAllDbGroups(false);
        }

        function resetPriceTests() {
            // Resetta il log
            clearPriceLog();

            // Resetta l'header
            const progressEl = document.getElementById('price-header-progress');
            const statusEl = document.getElementById('price-header-status');
            const passedEl = document.getElementById('price-header-passed');
            const failedEl = document.getElementById('price-header-failed');
            const timeEl = document.getElementById('price-header-time');
            const timestampEl = document.getElementById('price-header-timestamp');
            const barEl = document.getElementById('price-header-bar');

            if (progressEl) progressEl.textContent = '0/26';
            if (statusEl) {
                statusEl.className = 'test-header-status status-pending';
                statusEl.textContent = 'In attesa';
            }
            if (passedEl) passedEl.textContent = '0';
            if (failedEl) failedEl.textContent = '0';
            if (timeEl) timeEl.textContent = '0ms';
            if (timestampEl) {
                timestampEl.textContent = '-';
                timestampEl.setAttribute('data-ts', '');
            }
            if (barEl) barEl.setAttribute('data-progress', '0');

            // Resetta i badge e subtitle dei gruppi
            const groups = [
                { id: 'group1', total: 5, text: '5 test' },
                { id: 'group2', total: 3, text: '3 test' },
                { id: 'group3', total: 5, text: '5 test' },
                { id: 'group4', total: 13, text: '13 test' }
            ];

            groups.forEach(group => {
                const badge = document.getElementById(`price-${group.id}-badge`);
                const subtitle = document.getElementById(`price-${group.id}-subtitle`);
                if (badge) {
                    badge.textContent = `0/${group.total}`;
                    badge.classList.remove('badge-partial', 'badge-complete');
                    badge.classList.add('badge-pending');
                }
                if (subtitle) {
                    subtitle.textContent = `${group.text} da completare`;
                    subtitle.classList.remove('state-partial', 'state-complete');
                    subtitle.classList.add('state-pending');
                }
            });

            // Resetta tutti gli status dei test a "pending"
            // Gruppo 1: Test Unitari (5 test)
            const group1Tests = [
                'test-price-zona1', 'test-price-zona2', 'test-price-zona3',
                'test-price-zona4', 'test-price-zona5'
            ];

            // Gruppo 2: Edge Cases (3 test)
            const group2Tests = [
                'test-price-boundary-z1z2', 'test-price-boundary-z2z3', 'test-price-boundary-z4z5'
            ];

            // Gruppo 3: Test Avanzati (5 test)
            const group3Tests = [
                'test-price-validation', 'test-price-consistency', 'test-price-progressive',
                'test-price-zone-logic', 'test-price-roundtrip'
            ];

            // Gruppo 4: Robustezza Dati (13 test)
            const group4Tests = [
                'test-price-null-zona', 'test-price-undefined-zona', 'test-price-empty-zona',
                'test-price-invalid-zona', 'test-price-negative-zona', 'test-price-zero-zona',
                'test-price-float-zona', 'test-price-string-zona', 'test-price-large-zona',
                'test-price-null-tariffario', 'test-price-empty-tariffario',
                'test-price-malformed-tariffario', 'test-price-missing-keys'
            ];

            const allTests = [...group1Tests, ...group2Tests, ...group3Tests, ...group4Tests];

            allTests.forEach(id => {
                const testElement = document.getElementById(id);
                if (testElement) {
                    const statusSpan = testElement.querySelector('.test-status');
                    if (statusSpan) {
                        statusSpan.className = 'test-status pending';
                        statusSpan.textContent = 'In attesa';
                    }
                }
            });

            // Chiudi tutti i gruppi
            toggleAllPriceGroups(false);
        }

        // ===== GESTIONE MODALIT√Ä PWA TEST =====
        function togglePWATestMode() {
            const btn = document.getElementById('toggle-pwa-mode');
            const icon = document.getElementById('pwa-mode-icon');
            const text = document.getElementById('pwa-mode-text');
            const statusDiv = document.getElementById('pwa-mode-status');
            const infoDiv = document.getElementById('pwa-mode-info');

            if (!btn || !icon || !text || !statusDiv || !infoDiv) return;

            // Leggi lo stato corrente
            const isTestMode = localStorage.getItem('tpl.pwaTestMode') === 'true';
            const newState = !isTestMode;

            // Salva il nuovo stato
            localStorage.setItem('tpl.pwaTestMode', newState);

            // Aggiorna l'UI del pulsante
            if (newState) {
                icon.textContent = '‚úÖ';
                text.textContent = 'Disattiva Modalit√† PWA';
                btn.style.background = '#dc3545';

                infoDiv.innerHTML = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px;">
                        <strong style="color: #22c55e; font-size: 1.1rem;">‚úÖ Modalit√† PWA Test: ATTIVA</strong><br>
                        <p style="margin: 0.5rem 0; color: var(--testo);">La bottom navigation √® ora visibile in tutte le pagine dell'app.</p>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bianco); border-radius: 8px; border: 1px solid var(--bordo);">
                        <strong style="color: var(--turchese);">üì± Cosa puoi fare ora:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li>Visita <a href="index.html" style="color: var(--turchese); font-weight: 600;">Home</a>, 
                            <a href="fermate.html" style="color: var(--turchese); font-weight: 600;">Fermate</a> o 
                            <a href="prezzi.html" style="color: var(--turchese); font-weight: 600;">Prezzi</a></li>
                            <li>La bottom navigation sar√† visibile in basso</li>
                            <li>La navbar superiore sar√† nascosta (solo PWA)</li>
                            <li>Il footer avr√† padding extra per non sovrapporsi</li>
                        </ul>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--testo-secondario); font-style: italic;">
                        <strong>üí° Nota:</strong> Questa √® una simulazione a scopo di test. In produzione, la bottom nav appare solo quando l'app √® installata come PWA.
                    </div>
                `;
                statusDiv.style.display = 'block';
                statusDiv.style.borderLeftColor = '#22c55e';
                statusDiv.style.background = 'rgba(34, 197, 94, 0.05)';
            } else {
                icon.textContent = 'üì±';
                text.textContent = 'Attiva Modalit√† PWA';
                btn.style.background = 'var(--turchese)';

                infoDiv.innerHTML = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        <strong style="color: #ef4444; font-size: 1.1rem;">‚ùå Modalit√† PWA Test: DISATTIVA</strong><br>
                        <p style="margin: 0.5rem 0; color: var(--testo);">La bottom navigation √® nascosta (comportamento normale del browser).</p>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bianco); border-radius: 8px; border: 1px solid var(--bordo);">
                        <strong style="color: var(--turchese);">üåê Stato Browser Normale:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li>La bottom navigation NON √® visibile</li>
                            <li>La navbar superiore √® visibile normalmente</li>
                            <li>Il layout √® quello standard del browser</li>
                            <li>Per vederla veramente, installa l'app come PWA</li>
                        </ul>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--testo-secondario); font-style: italic;">
                        <strong>üí° Suggerimento:</strong> Clicca sul pulsante sopra per simulare l'esperienza PWA senza dover installare l'app.
                    </div>
                `;
                statusDiv.style.display = 'block';
                statusDiv.style.borderLeftColor = '#ef4444';
                statusDiv.style.background = 'rgba(239, 68, 68, 0.05)';
            }

            // Trigger refresh della bottom navigation
            setTimeout(() => {
                // Dispatch evento custom per aggiornare altre finestre
                window.dispatchEvent(new Event('pwaTestModeChanged'));

                // Log per debug
                console.log('üîÑ Modalit√† PWA test aggiornata a:', newState);
            }, 100);
        }

        // Inizializza lo stato del pulsante PWA al caricamento
        window.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('toggle-pwa-mode');
            if (btn) {
                // Imposta lo stato iniziale del pulsante
                const isTestMode = localStorage.getItem('tpl.pwaTestMode') === 'true';
                const icon = document.getElementById('pwa-mode-icon');
                const text = document.getElementById('pwa-mode-text');
                const statusDiv = document.getElementById('pwa-mode-status');

                if (isTestMode) {
                    icon.textContent = '‚úÖ';
                    text.textContent = 'Disattiva Modalit√† PWA';
                    btn.style.background = '#dc3545';
                    // Mostra lo status se gi√† attivo
                    togglePWATestMode();
                    togglePWATestMode(); // Doppio toggle per mostrare lo status
                } else {
                    icon.textContent = 'üì±';
                    text.textContent = 'Attiva Modalit√† PWA';
                    btn.style.background = 'var(--turchese)';
                }

                // Aggiungi event listener
                btn.addEventListener('click', togglePWATestMode);
            }
        });

        // ===== GESTIONE SIMULAZIONE OFFLINE =====
        function getOfflineSimulatedState() {
            return localStorage.getItem('tpl.offlineTestMode') === 'true';
        }

        function setOfflineSimulatedState(value) {
            localStorage.setItem('tpl.offlineTestMode', value);
        }

        function toggleOfflineMode() {
            const btn = document.getElementById('toggle-offline-mode');
            const icon = document.getElementById('offline-mode-icon');
            const text = document.getElementById('offline-mode-text');
            const statusDiv = document.getElementById('offline-mode-status');
            const infoDiv = document.getElementById('offline-mode-info');

            if (!btn || !icon || !text || !statusDiv || !infoDiv) return;

            const isOfflineSimulated = !getOfflineSimulatedState();
            setOfflineSimulatedState(isOfflineSimulated);

            if (isOfflineSimulated) {
                // Attiva modalit√† offline
                icon.textContent = 'üìµ';
                text.textContent = 'Torna Online';
                btn.style.background = '#ef4444';

                // Trigger evento offline
                window.dispatchEvent(new Event('offline'));

                // Trigger evento custom per badge dinamici
                window.dispatchEvent(new Event('offlineTestModeChanged'));

                infoDiv.innerHTML = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        <strong style="color: #ef4444; font-size: 1.1rem;">üìµ Modalit√† Offline: ATTIVA</strong><br>
                        <p style="margin: 0.5rem 0; color: var(--testo);">Simulazione della perdita di connessione internet.</p>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bianco); border-radius: 8px; border: 1px solid var(--bordo);">
                        <strong style="color: #ef4444;">üö´ Cosa succede ora:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li>Il banner "Sei offline" dovrebbe apparire in alto</li>
                            <li>Le richieste di rete falliranno (simulato)</li>
                            <li>L'app continua a funzionare in modalit√† offline (PWA)</li>
                            <li>I dati cached rimangono disponibili</li>
                        </ul>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bianco); border-radius: 8px; border: 1px solid var(--bordo);">
                        <strong style="color: var(--turchese);">üìä Status corrente:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li><strong>navigator.onLine:</strong> <code>${navigator.onLine}</code></li>
                            <li><strong>Evento offline:</strong> <code>dispatched</code></li>
                            <li><strong>Banner offline:</strong> <code>dovrebbe essere visibile</code></li>
                        </ul>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--testo-secondario); font-style: italic;">
                        <strong>üí° Nota:</strong> Questa √® una simulazione. Per testare realmente la modalit√† offline, usa DevTools ‚Üí Network ‚Üí Offline.
                    </div>
                `;
                statusDiv.style.display = 'block';
                statusDiv.style.borderLeftColor = '#ef4444';
                statusDiv.style.background = 'rgba(239, 68, 68, 0.05)';

                console.log('üî¥ Modalit√† offline simulata: ATTIVA');

                // Notifica altre pagine/tab
                window.dispatchEvent(new Event('offlineTestModeChanged'));
            } else {
                // Disattiva modalit√† offline
                icon.textContent = 'üì∂';
                text.textContent = 'Simula Offline';
                btn.style.background = '#10b981';

                // Trigger evento online
                window.dispatchEvent(new Event('online'));

                // Trigger evento custom per badge dinamici
                window.dispatchEvent(new Event('offlineTestModeChanged'));

                infoDiv.innerHTML = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                        <strong style="color: #10b981; font-size: 1.1rem;">üì∂ Modalit√† Online: ATTIVA</strong><br>
                        <p style="margin: 0.5rem 0; color: var(--testo);">Connessione internet ripristinata (simulato).</p>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bianco); border-radius: 8px; border: 1px solid var(--bordo);">
                        <strong style="color: #10b981;">‚úÖ Cosa succede ora:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li>Il banner "Sei offline" dovrebbe scomparire</li>
                            <li>Le richieste di rete funzionano normalmente</li>
                            <li>Sincronizzazione dati ripristinata</li>
                            <li>Accesso completo a tutte le funzionalit√†</li>
                        </ul>
                    </div>
                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bianco); border-radius: 8px; border: 1px solid var(--bordo);">
                        <strong style="color: var(--turchese);">üìä Status corrente:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li><strong>navigator.onLine:</strong> <code>${navigator.onLine}</code></li>
                            <li><strong>Evento online:</strong> <code>dispatched</code></li>
                            <li><strong>Banner offline:</strong> <code>nascosto</code></li>
                        </ul>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--testo-secondario); font-style: italic;">
                        <strong>üí° Suggerimento:</strong> Clicca su "Simula Offline" per testare nuovamente il comportamento offline dell'app.
                    </div>
                `;
                statusDiv.style.display = 'block';
                statusDiv.style.borderLeftColor = '#10b981';
                statusDiv.style.background = 'rgba(16, 185, 129, 0.05)';

                console.log('üü¢ Modalit√† offline simulata: DISATTIVA');

                // Notifica altre pagine/tab
                window.dispatchEvent(new Event('offlineTestModeChanged'));
            }
        }

        // Event listener per il pulsante toggle offline
        window.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('toggle-offline-mode');
            if (btn) {
                // Imposta lo stato iniziale del pulsante
                const isOfflineMode = getOfflineSimulatedState();
                const icon = document.getElementById('offline-mode-icon');
                const text = document.getElementById('offline-mode-text');
                const statusDiv = document.getElementById('offline-mode-status');

                if (isOfflineMode) {
                    icon.textContent = 'üìµ';
                    text.textContent = 'Torna Online';
                    btn.style.background = '#ef4444';
                    // Mostra lo status se gi√† attivo
                    toggleOfflineMode();
                    toggleOfflineMode(); // Doppio toggle per mostrare lo status
                } else {
                    icon.textContent = 'üì∂';
                    text.textContent = 'Simula Offline';
                    btn.style.background = '#10b981';
                }

                // Aggiungi event listener
                btn.addEventListener('click', toggleOfflineMode);
                console.log('‚úÖ Pulsante simulazione offline inizializzato');
            }
        });

        // Test 1: Database - spostato in js/tests/test-database.js

        // Test 2: LocalStorage - spostato in js/tests/test-localstorage.js

        // Test 3: Dark Mode - spostato in js/tests/test-darkmode.js

        // Test 4: Calcolo Prezzi (Modulo prezzi.js)
        async function testPriceCalculation() {
            const output = 'output-price';
            document.getElementById(output).innerHTML = '';

            try {
                // Verifica che PrezziTests sia disponibile
                if (typeof PrezziTests === 'undefined') {
                    log(output, '‚úó PrezziTests non disponibile! Assicurati che test-prezzi.js sia caricato.', 'error');
                    log(output, 'Verifica che lo script sia incluso: js/tests/test-prezzi.js', 'info');
                    return;
                }

                log(output, '‚úì PrezziTests disponibile', 'success');

                // Verifica che Pricing sia disponibile
                if (typeof Pricing === 'undefined') {
                    log(output, '‚úó Pricing non disponibile! Assicurati che prezzi.js sia caricato PRIMA di test-prezzi.js.', 'error');
                    log(output, 'Ordine script corretto: prezzi.js ‚Üí test-prezzi.js', 'info');
                    return;
                }

                log(output, '‚úì Pricing disponibile', 'success');

                // Ottieni tariffario da window (esposto da script.js dopo loadData) o usa array vuoto
                const tariffario = (typeof window !== 'undefined' && window.tariffario && Array.isArray(window.tariffario))
                    ? window.tariffario
                    : [];
                const tariffarioAggiornato = (typeof window !== 'undefined' && window.tariffarioAggiornato)
                    ? window.tariffarioAggiornato
                    : null;

                log(output, `Tariffario: ${tariffario.length > 0 ? 'disponibile (' + tariffario.length + ' linee)' : 'vuoto - verr√† caricato'}`, 'info');

                // Verifica se loadData √® disponibile (da script.js)
                const loadDataFn = (typeof loadData === 'function') ? loadData : null;

                if (!loadDataFn) {
                    log(output, '‚ö† loadData non disponibile. Il tariffario deve essere gi√† caricato.', 'info');
                }

                // Esegui tutti i test usando il modulo modulare
                await PrezziTests.runAll(
                    tariffario,
                    tariffarioAggiornato,
                    {
                        log: (message, type) => log(output, message, type),
                        updateStatus: (id, status) => updateTestStatus(id, status)
                    },
                    loadDataFn // Callback per caricamento dati se necessario
                );
            } catch (error) {
                log(output, `‚úó Errore fatale: ${error.message}`, 'error');
                log(output, `Stack: ${error.stack}`, 'info');
                console.error('Errore test prezzi:', error);
            }

            // Mostra i pulsanti log dopo l'esecuzione
            const logButtons = document.getElementById('price-log-buttons');
            if (logButtons) {
                logButtons.style.display = 'flex';
            }
        }

        // Test 5: Service Worker - spostato in js/tests/test-sw.js

        // Test 6: UI Components - spostato in js/tests/test-ui.js

        // Test 7: Manifest - spostato in js/tests/test-manifest.js

        // Test 8: Performance - spostato in js/tests/test-performance.js

        // Test 9: Geolocalizzazione (Versione Migliorata)

        // Funzione helper: Controlla permessi geolocalizzazione
        async function checkGeolocationPermission() {
            const statusDiv = document.getElementById('geo-permission-status');
            const statusText = document.getElementById('geo-permission-text');

            if (!statusDiv || !statusText) return;

            try {
                if (!navigator.permissions) {
                    statusText.textContent = 'API Permissions non supportata';
                    statusDiv.style.borderLeftColor = '#gray';
                    return;
                }

                const result = await navigator.permissions.query({ name: 'geolocation' });

                if (result.state === 'granted') {
                    statusText.innerHTML = '<span style="color: var(--verde);">‚úÖ Concesso</span>';
                    statusDiv.style.borderLeftColor = 'var(--verde)';
                    statusDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                } else if (result.state === 'denied') {
                    statusText.innerHTML = '<span style="color: var(--rosso);">‚ùå Negato</span>';
                    statusDiv.style.borderLeftColor = 'var(--rosso)';
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                } else if (result.state === 'prompt') {
                    statusText.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Richiesta in sospeso</span>';
                    statusDiv.style.borderLeftColor = '#f59e0b';
                    statusDiv.style.background = 'rgba(245, 158, 11, 0.1)';
                }

                // Ascolta cambiamenti permessi
                result.addEventListener('change', () => {
                    checkGeolocationPermission();
                });

            } catch (error) {
                console.error('Errore verifica permessi:', error);
                statusText.textContent = 'Impossibile verificare';
                statusDiv.style.borderLeftColor = '#gray';
            }
        }

        // ===== WATCH POSITION - MONITORAGGIO CONTINUO =====

        // Variabili globali per watch position
        let watchId = null;
        let watchActive = false;
        let watchCount = 0;
        let watchHistory = [];
        let watchTotalDistance = 0;
        let watchLastPosition = null;

        // Setup Watch Position
        (function setupWatchPosition() {
            const toggleBtn = document.getElementById('toggle-watch-btn');
            const statusCard = document.getElementById('watch-status-card');
            const countElement = document.getElementById('watch-count');
            const lastPositionData = document.getElementById('watch-last-position-data');
            const distanceElement = document.getElementById('watch-distance');
            const distanceValue = document.getElementById('watch-distance-value');
            const historySection = document.getElementById('watch-history');
            const historyList = document.getElementById('watch-history-list');
            const clearHistoryBtn = document.getElementById('clear-watch-history-btn');

            if (!toggleBtn) return;

            // Toggle monitoraggio
            toggleBtn.addEventListener('click', () => {
                if (!watchActive) {
                    startWatchPosition();
                } else {
                    stopWatchPosition();
                }
            });

            // Avvia monitoraggio
            function startWatchPosition() {
                if (!navigator.geolocation) {
                    alert('‚ùå Geolocalizzazione non supportata dal browser');
                    return;
                }

                // Reset contatori
                watchCount = 0;
                watchTotalDistance = 0;
                watchHistory = [];
                watchLastPosition = null;

                // Avvia watchPosition
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        // Successo - nuova posizione ricevuta
                        watchCount++;

                        // Aggiorna contatore
                        if (countElement) {
                            countElement.textContent = watchCount;
                            countElement.style.animation = 'pulse 0.3s ease';
                            setTimeout(() => {
                                countElement.style.animation = '';
                            }, 300);
                        }

                        // Calcola distanza se c'√® una posizione precedente
                        if (watchLastPosition) {
                            const distance = calculateDistance(
                                watchLastPosition.coords.latitude,
                                watchLastPosition.coords.longitude,
                                position.coords.latitude,
                                position.coords.longitude
                            );

                            watchTotalDistance += distance * 1000; // converti km in metri

                            if (distanceElement && distanceValue) {
                                distanceElement.style.display = 'block';
                                const distanceText = watchTotalDistance >= 1000
                                    ? (watchTotalDistance / 1000).toFixed(2) + ' km'
                                    : Math.round(watchTotalDistance) + ' metri';
                                distanceValue.textContent = watchTotalDistance >= 1000
                                    ? (watchTotalDistance / 1000).toFixed(2)
                                    : Math.round(watchTotalDistance);
                                distanceValue.parentElement.innerHTML = watchTotalDistance >= 1000
                                    ? '<span id="watch-distance-value">' + (watchTotalDistance / 1000).toFixed(2) + '</span> km'
                                    : '<span id="watch-distance-value">' + Math.round(watchTotalDistance) + '</span> metri';
                            }
                        }

                        // Salva posizione corrente
                        watchLastPosition = position;

                        // Aggiorna ultima posizione
                        if (lastPositionData) {
                            const coords = position.coords;
                            const timestamp = new Date(position.timestamp).toLocaleTimeString('it-IT');
                            const speedKmh = coords.speed !== null ? (coords.speed * 3.6).toFixed(1) : 'N/A';

                            lastPositionData.innerHTML = `
                                <strong style="color: #3b82f6;">${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}</strong><br>
                                <span style="font-size: 0.85rem;">
                                    ‚è∞ ${timestamp} | 
                                    üéØ ¬±${Math.round(coords.accuracy)}m | 
                                    üöó ${speedKmh} km/h
                                </span>
                            `;
                        }

                        // Aggiungi a cronologia (max 5)
                        watchHistory.unshift({
                            position: position,
                            timestamp: Date.now()
                        });
                        if (watchHistory.length > 5) {
                            watchHistory.pop();
                        }

                        // Aggiorna cronologia UI
                        updateHistoryUI();

                        // Aggiorna mappa se disponibile
                        if (map) {
                            initializeMap(position.coords.latitude, position.coords.longitude, position.coords.accuracy);
                        }

                        console.log('üß≠ Watch Position aggiornamento #' + watchCount, {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy + 'm'
                        });
                    },
                    (error) => {
                        // Errore
                        console.error('‚ùå Watch Position errore:', error);
                        stopWatchPosition();
                        alert('‚ùå Errore monitoraggio GPS:\n' + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 10000
                    }
                );

                // Aggiorna UI
                watchActive = true;
                toggleBtn.innerHTML = '‚è∏Ô∏è Ferma';
                toggleBtn.style.background = '#ef4444';
                if (statusCard) statusCard.style.display = 'block';
                if (historySection) historySection.style.display = 'block';

                console.log('‚ñ∂Ô∏è Watch Position AVVIATO (ID: ' + watchId + ')');
            }

            // Ferma monitoraggio
            function stopWatchPosition() {
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }

                watchActive = false;
                toggleBtn.innerHTML = '‚ñ∂Ô∏è Avvia';
                toggleBtn.style.background = '#3b82f6';

                console.log('‚èπÔ∏è Watch Position FERMATO');
            }

            // Aggiorna UI cronologia
            function updateHistoryUI() {
                if (!historyList) return;

                historyList.innerHTML = '';

                watchHistory.forEach((item, index) => {
                    const coords = item.position.coords;
                    const time = new Date(item.timestamp).toLocaleTimeString('it-IT');

                    const historyItem = document.createElement('div');
                    historyItem.style.cssText = 'padding: 0.75rem; background: white; border-radius: 8px; border-left: 3px solid #3b82f6; font-size: 0.9rem;';
                    historyItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <strong style="color: #1e40af;">#${watchCount - index}</strong>
                            <span style="color: #666; font-size: 0.85rem;">${time}</span>
                        </div>
                        <div style="color: #374151; font-size: 0.85rem;">
                            üìç ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}<br>
                            üéØ Accuratezza: ¬±${Math.round(coords.accuracy)}m
                        </div>
                    `;

                    historyList.appendChild(historyItem);
                });
            }

            // Cancella cronologia
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', () => {
                    if (confirm('üóëÔ∏è Cancellare la cronologia delle posizioni?')) {
                        watchHistory = [];
                        updateHistoryUI();
                        console.log('üóëÔ∏è Cronologia cancellata');
                    }
                });
            }
        })();

        // ===== SIMULAZIONE POSIZIONE FAKE =====

        // Variabili globali per fake position
        let useFakePosition = false;
        let fakePositionData = null;

        // Setup gestione simulazione posizione
        (function setupFakePosition() {
            const toggleCheckbox = document.getElementById('use-fake-position');
            const content = document.getElementById('fake-position-content');
            const applyBtn = document.getElementById('apply-fake-position');
            const presetBtns = document.querySelectorAll('.fake-position-preset');

            if (!toggleCheckbox || !content || !applyBtn) return;

            // Toggle on/off simulazione
            toggleCheckbox.addEventListener('change', (e) => {
                useFakePosition = e.target.checked;
                content.style.display = useFakePosition ? 'block' : 'none';

                if (useFakePosition) {
                    console.log('üé≠ Simulazione posizione ATTIVA');
                } else {
                    console.log('‚úÖ GPS reale ATTIVO');
                    fakePositionData = null;
                    document.getElementById('fake-position-info').style.display = 'none';
                }
            });

            // Preset citt√†
            presetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const lat = parseFloat(btn.dataset.lat);
                    const lng = parseFloat(btn.dataset.lng);
                    const name = btn.dataset.name;

                    // Popola input
                    document.getElementById('fake-lat').value = lat;
                    document.getElementById('fake-lng').value = lng;

                    // Visual feedback
                    presetBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    console.log(`üèôÔ∏è Preset selezionato: ${name}`);
                });
            });

            // Applica posizione fake
            applyBtn.addEventListener('click', () => {
                const lat = parseFloat(document.getElementById('fake-lat').value);
                const lng = parseFloat(document.getElementById('fake-lng').value);
                const accuracy = parseFloat(document.getElementById('fake-accuracy').value) || 10;
                const altitude = parseFloat(document.getElementById('fake-altitude').value) || 0;

                // Velocit√† e direzione (opzionali)
                const speedKmh = parseFloat(document.getElementById('fake-speed').value);
                const heading = parseFloat(document.getElementById('fake-heading').value);

                // Converti velocit√† da km/h a m/s (GPS usa m/s)
                const speedMs = !isNaN(speedKmh) && speedKmh > 0 ? speedKmh / 3.6 : null;
                const validHeading = !isNaN(heading) && heading >= 0 && heading <= 360 ? heading : null;

                // Validazione coordinate
                if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                    alert('‚ö†Ô∏è Inserisci coordinate valide!');
                    return;
                }

                if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    alert('‚ö†Ô∏è Coordinate fuori range!\nLatitudine: -90 to 90\nLongitudine: -180 to 180');
                    return;
                }

                // Crea oggetto fake position (simula Position API)
                fakePositionData = {
                    coords: {
                        latitude: lat,
                        longitude: lng,
                        accuracy: accuracy,
                        altitude: altitude,
                        altitudeAccuracy: accuracy * 2,
                        heading: validHeading,
                        speed: speedMs
                    },
                    timestamp: Date.now()
                };

                // Mostra info posizione fake
                const infoDiv = document.getElementById('fake-position-info');
                const detailsDiv = document.getElementById('fake-position-details');

                if (infoDiv && detailsDiv) {
                    let infoHTML = `
                        <strong>Coordinate:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                        <strong>Accuratezza:</strong> ¬±${accuracy}m<br>
                        <strong>Altitudine:</strong> ${altitude}m
                    `;

                    // Aggiungi velocit√†/direzione se impostate
                    if (speedMs !== null) {
                        infoHTML += `<br><strong>Velocit√†:</strong> ${speedKmh.toFixed(1)} km/h`;
                    }
                    if (validHeading !== null) {
                        infoHTML += `<br><strong>Direzione:</strong> ${validHeading}¬∞`;
                    }

                    detailsDiv.innerHTML = infoHTML;
                    infoDiv.style.display = 'block';
                }

                // Visual feedback
                applyBtn.textContent = '‚úÖ Posizione Applicata';
                setTimeout(() => {
                    applyBtn.innerHTML = 'üéØ Applica Posizione Fake';
                }, 2000);

                console.log('üéØ Posizione fake applicata:', {
                    lat: fakePositionData.coords.latitude,
                    lng: fakePositionData.coords.longitude,
                    accuracy: fakePositionData.coords.accuracy + 'm',
                    altitude: fakePositionData.coords.altitude + 'm',
                    speed: speedMs ? speedKmh.toFixed(1) + ' km/h' : 'null',
                    heading: validHeading ? validHeading + '¬∞' : 'null'
                });
            });
        })();

        // Funzione helper: Copia coordinate negli appunti
        async function copyCoordinates(lat, lng) {
            try {
                const coordsText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                await navigator.clipboard.writeText(coordsText);
                return true;
            } catch (error) {
                console.error('Errore copia coordinate:', error);
                return false;
            }
        }

        // Funzione helper: Reverse Geocoding (OpenStreetMap Nominatim API)
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
                    {
                        headers: {
                            'Accept-Language': 'it'
                        }
                    }
                );

                if (!response.ok) throw new Error('Errore reverse geocoding');

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Errore reverse geocoding:', error);
                return null;
            }
        }

        async function testGeolocation() {
            const btn = document.getElementById('test-location-btn');
            const icon = document.getElementById('test-location-icon');
            const text = document.getElementById('test-location-text');
            const result = document.getElementById('test-location-result');
            const info = document.getElementById('test-location-info');

            if (!btn || !icon || !text || !result || !info) return;

            // Stato di caricamento
            icon.textContent = '‚è≥';
            text.textContent = 'Rilevamento...';
            btn.disabled = true;
            result.style.display = 'none';

            try {
                let position;

                // ===== CONTROLLA SE USARE FAKE POSITION =====
                if (useFakePosition && fakePositionData) {
                    // Usa posizione fake
                    console.log('üé≠ Uso posizione simulata:', fakePositionData.coords);

                    // Simula delay realistico (500ms)
                    await new Promise(resolve => setTimeout(resolve, 500));

                    position = fakePositionData;

                    // Feedback visivo
                    icon.textContent = 'üé≠';
                    text.textContent = 'Posizione Simulata';

                } else if (useFakePosition && !fakePositionData) {
                    // Fake attivato ma nessuna posizione impostata
                    throw new Error('‚ö†Ô∏è Nessuna posizione fake impostata! Clicca "Applica Posizione Fake" prima.');

                } else {
                    // Usa GPS reale
                    // Verifica supporto geolocalizzazione
                    if (!navigator.geolocation) {
                        throw new Error('Geolocalizzazione non supportata dal browser');
                    }

                    // Richiedi posizione con timeout
                    position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            resolve,
                            reject,
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0 // Sempre posizione fresca
                            }
                        );
                    });

                    // Successo
                    icon.textContent = '‚úÖ';
                    text.textContent = 'Posizione Rilevata';
                }

                // Salva posizione per calcolo distanza
                lastKnownPosition = position;

                // Mostra calcolatore distanza
                const distanceCalculator = document.getElementById('distance-calculator');
                if (distanceCalculator) {
                    distanceCalculator.style.display = 'block';
                }

                // Mostra sezione Watch Position
                const watchSection = document.getElementById('watch-position-section');
                if (watchSection) {
                    watchSection.style.display = 'block';
                }

                // Mostra informazioni dettagliate
                const coords = position.coords;

                // Inizializza mappa con la posizione
                initializeMap(coords.latitude, coords.longitude, coords.accuracy);
                const timestamp = new Date(position.timestamp).toLocaleString('it-IT');

                // Velocit√† e direzione (se disponibili)
                const speedKmh = coords.speed !== null ? (coords.speed * 3.6).toFixed(1) : null;
                const heading = coords.heading !== null ? coords.heading.toFixed(0) : null;

                // Badge modalit√† (GPS reale o fake)
                const modeBadge = useFakePosition
                    ? '<span style="display: inline-block; padding: 0.25rem 0.75rem; background: linear-gradient(135deg, #a855f7, #9333ea); color: white; border-radius: 6px; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.75rem;">üé≠ MODALIT√Ä SIMULATA</span>'
                    : '<span style="display: inline-block; padding: 0.25rem 0.75rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 6px; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.75rem;">‚úÖ GPS REALE</span>';

                // Costruisci HTML base
                let html = `
                    ${modeBadge}
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üìç Coordinate:</strong>
                        <button id="copy-coords-btn" style="margin-left: 0.5rem; padding: 0.25rem 0.75rem; background: var(--turchese); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                            üìã Copia
                        </button>
                        <br>
                        Latitudine: <code>${coords.latitude.toFixed(6)}</code><br>
                        Longitudine: <code>${coords.longitude.toFixed(6)}</code>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üéØ Precisione:</strong><br>
                        Accuratezza: <code>${Math.round(coords.accuracy)} metri</code><br>
                        Altitudine: <code>${coords.altitude ? Math.round(coords.altitude) + ' metri' : 'Non disponibile'}</code>${coords.altitudeAccuracy ? ' (¬±' + Math.round(coords.altitudeAccuracy) + 'm)' : ''}
                    </div>
                `;

                // Aggiungi velocit√† e direzione (sempre, anche se null per debug)
                html += `
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üöó Movimento:</strong><br>
                        Velocit√†: <code>${speedKmh !== null ? speedKmh + ' km/h' : '‚ùå Non disponibile (dispositivo fermo)'}</code><br>
                        Direzione: <code>${heading !== null ? heading + '¬∞ ' + getCardinalDirection(heading) : '‚ùå Non disponibile (serve movimento)'}</code>
                    </div>
                `;

                html += `
                    <div style="margin-bottom: 0.5rem;">
                        <strong>‚è∞ Timestamp:</strong><br>
                        <code>${timestamp}</code>
                    </div>
                    <div id="address-container" style="margin-bottom: 0.5rem;">
                        <strong>
                            üì¨ Indirizzo 
                            <span style="display: inline-block; margin-left: 0.5rem; padding: 0.2rem 0.4rem; background: linear-gradient(135deg, #fecaca, #fca5a5); color: #7f1d1d; border-radius: 4px; font-size: 0.65rem; font-weight: 600;">üî¥ RICHIEDE INTERNET</span>
                        </strong>
                        <div id="address-connection-badge" style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; transition: all 0.3s;"></div>
                        <br>
                        <span style="color: #666;">üîÑ Recupero indirizzo...</span>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üîó Link Mappe:</strong><br>
                        <a href="https://www.google.com/maps?q=${coords.latitude},${coords.longitude}" target="_blank" style="color: var(--turchese); text-decoration: none;">
                            üìç Apri su Google Maps
                        </a><br>
                        <a href="https://www.openstreetmap.org/?mlat=${coords.latitude}&mlon=${coords.longitude}&zoom=15" target="_blank" style="color: var(--turchese); text-decoration: none;">
                            üó∫Ô∏è Apri su OpenStreetMap
                        </a>
                    </div>
                `;

                info.innerHTML = html;
                result.style.display = 'block';
                result.style.borderLeftColor = 'var(--verde)';
                result.style.background = 'rgba(34, 197, 94, 0.1)';

                // Setup badge dinamico indirizzo
                const addressBadge = document.getElementById('address-connection-badge');
                if (addressBadge) {
                    // Funzione aggiornamento badge
                    const updateAddressBadge = () => {
                        // Controlla sia navigator.onLine che simulazione offline
                        const offlineTest = localStorage.getItem('tpl.offlineTestMode') === 'true';
                        const isOnline = navigator.onLine && !offlineTest;

                        if (isOnline) {
                            addressBadge.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                            addressBadge.style.color = '#065f46';
                            addressBadge.textContent = 'üü¢ Online';
                            addressBadge.title = '‚úÖ Connessione attiva - Reverse geocoding disponibile';
                        } else {
                            addressBadge.style.background = 'linear-gradient(135deg, #fecaca, #fca5a5)';
                            addressBadge.style.color = '#7f1d1d';
                            addressBadge.textContent = offlineTest ? 'üî¥ Offline (simulato)' : 'üî¥ Offline';
                            addressBadge.title = 'üî¥ Nessuna connessione - Indirizzo non disponibile';
                        }
                    };

                    // Aggiorna stato iniziale
                    updateAddressBadge();

                    // Listener eventi online/offline (nativi)
                    window.addEventListener('online', updateAddressBadge);
                    window.addEventListener('offline', updateAddressBadge);

                    // Listener evento simulazione offline (custom)
                    window.addEventListener('offlineTestModeChanged', () => {
                        console.log('üì° Evento offlineTestModeChanged ricevuto - Aggiorno badge indirizzo');
                        // Piccolo delay per dare tempo a localStorage di aggiornarsi
                        setTimeout(updateAddressBadge, 50);
                    });
                }

                // Aggiungi event listener al pulsante copia
                const copyBtn = document.getElementById('copy-coords-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', async () => {
                        const success = await copyCoordinates(coords.latitude, coords.longitude);
                        if (success) {
                            copyBtn.textContent = '‚úÖ Copiato!';
                            setTimeout(() => {
                                copyBtn.textContent = 'üìã Copia';
                            }, 2000);
                        } else {
                            copyBtn.textContent = '‚ùå Errore';
                            setTimeout(() => {
                                copyBtn.textContent = 'üìã Copia';
                            }, 2000);
                        }
                    });
                }

                // Reverse Geocoding (asincrono)
                reverseGeocode(coords.latitude, coords.longitude).then(data => {
                    const addressContainer = document.getElementById('address-container');
                    if (addressContainer && data) {
                        const address = data.address;
                        let addressText = '';

                        if (address.road) {
                            addressText += address.road;
                            if (address.house_number) addressText += ' ' + address.house_number;
                            addressText += '<br>';
                        }
                        if (address.postcode || address.city || address.town || address.village) {
                            if (address.postcode) addressText += address.postcode + ' ';
                            addressText += address.city || address.town || address.village || '';
                            addressText += '<br>';
                        }
                        if (address.state) addressText += address.state + '<br>';
                        if (address.country) addressText += address.country;

                        addressContainer.innerHTML = `
                            <strong>üì¨ Indirizzo:</strong><br>
                            <span style="color: var(--grigio-scuro);">${addressText || data.display_name}</span>
                        `;
                    } else if (addressContainer) {
                        // Distingui tra offline e errore API
                        const isOffline = !navigator.onLine;
                        const errorMsg = isOffline
                            ? 'üü† <span style="color: #92400e;">Modalit√† offline - Indirizzo non disponibile</span>'
                            : '‚ùå <span style="color: #999;">Indirizzo non disponibile</span>';

                        addressContainer.innerHTML = `
                            <strong>üì¨ Indirizzo:</strong><br>
                            ${errorMsg}
                        `;
                    }
                }).catch(error => {
                    // Gestione errori esplicita
                    console.error('Errore reverse geocoding:', error);
                    const addressContainer = document.getElementById('address-container');
                    if (addressContainer) {
                        const isOffline = !navigator.onLine;
                        const errorMsg = isOffline
                            ? 'üü† <span style="color: #92400e;">Modalit√† offline - Richiede connessione internet</span>'
                            : '‚ùå <span style="color: #999;">Errore recupero indirizzo</span>';

                        addressContainer.innerHTML = `
                            <strong>üì¨ Indirizzo:</strong><br>
                            ${errorMsg}
                        `;
                    }
                });

            } catch (error) {
                // Errore
                icon.textContent = '‚ùå';
                text.textContent = 'Errore Rilevamento';

                let errorMessage = 'Errore sconosciuto';
                if (error.code === 1) {
                    errorMessage = 'Permesso di geolocalizzazione negato';
                } else if (error.code === 2) {
                    errorMessage = 'Posizione non disponibile';
                } else if (error.code === 3) {
                    errorMessage = 'Timeout durante il rilevamento';
                } else {
                    errorMessage = error.message;
                }

                info.innerHTML = `
                    <div style="color: var(--rosso);">
                        <strong>‚ùå Errore:</strong><br>
                        <code>${errorMessage}</code>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--grigio-scuro);">
                        <strong>Suggerimenti:</strong><br>
                        ‚Ä¢ Assicurati di aver concesso il permesso di geolocalizzazione<br>
                        ‚Ä¢ Verifica che il GPS sia attivo<br>
                        ‚Ä¢ Prova in un'area con buona copertura di rete<br>
                        ‚Ä¢ Su HTTPS: verifica le impostazioni del browser
                    </div>
                `;

                result.style.display = 'block';
                result.style.borderLeftColor = 'var(--rosso)';
                result.style.background = 'rgba(239, 68, 68, 0.1)';
            }

            // Reset dopo 5 secondi
            setTimeout(() => {
                icon.textContent = 'üìç';
                text.textContent = 'Rileva Posizione';
                btn.disabled = false;
            }, 5000);
        }

        // Helper: Converti gradi in direzione cardinale
        function getCardinalDirection(degrees) {
            const directions = ['‚¨ÜÔ∏è Nord', '‚ÜóÔ∏è Nord-Est', '‚û°Ô∏è Est', '‚ÜòÔ∏è Sud-Est', '‚¨áÔ∏è Sud', '‚ÜôÔ∏è Sud-Ovest', '‚¨ÖÔ∏è Ovest', '‚ÜñÔ∏è Nord-Ovest'];
            const index = Math.round(degrees / 45) % 8;
            return directions[index];
        }

        // Controlla permessi geolocalizzazione al caricamento
        if (document.getElementById('geo-permission-status')) {
            checkGeolocationPermission();
        }

        // Controlla HTTPS e mostra banner warning se necessario
        (function checkHttpsRequirement() {
            const banner = document.getElementById('https-warning-banner');
            if (!banner) return;

            const protocol = window.location.protocol;
            const hostname = window.location.hostname;

            // Mostra banner solo se NON √® HTTPS e NON √® localhost
            const isSecure = protocol === 'https:';
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '[::1]';

            if (!isSecure && !isLocalhost) {
                banner.style.display = 'block';
                console.warn('‚ö†Ô∏è Geolocalizzazione richiede HTTPS o localhost. Protocollo attuale:', protocol);
            } else {
                console.log('‚úÖ Connessione sicura - Geolocalizzazione disponibile');
            }
        })();

        // ===== CALCOLO DISTANZA =====

        // Variabile globale per memorizzare ultima posizione rilevata
        let lastKnownPosition = null;

        // Formula Haversine per calcolare distanza tra due coordinate (km)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raggio Terra in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            return distance;
        }

        // Calcola tempo stimato basato su distanza
        function estimateTime(distanceKm) {
            const walkingSpeed = 5; // km/h a piedi
            const carSpeed = 50; // km/h in citt√†
            const busSpeed = 30; // km/h autobus urbano

            const walkMinutes = Math.round((distanceKm / walkingSpeed) * 60);
            const carMinutes = Math.round((distanceKm / carSpeed) * 60);
            const busMinutes = Math.round((distanceKm / busSpeed) * 60);

            return { walk: walkMinutes, car: carMinutes, bus: busMinutes };
        }

        // Formatta tempo in ore e minuti
        function formatTime(minutes) {
            if (minutes < 60) {
                return `${minutes} min`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return mins > 0 ? `${hours}h ${mins}min` : `${hours}h`;
            }
        }

        // Setup event listeners per calcolo distanza
        (function setupDistanceCalculator() {
            const distanceCalculator = document.getElementById('distance-calculator');
            const calculateBtn = document.getElementById('calculate-distance-btn');
            const targetLatInput = document.getElementById('target-lat');
            const targetLngInput = document.getElementById('target-lng');
            const presetButtons = document.querySelectorAll('.distance-preset-btn');
            const distanceResult = document.getElementById('distance-result');
            const distanceInfo = document.getElementById('distance-info');

            if (!distanceCalculator || !calculateBtn) return;

            // Preset citt√† buttons
            presetButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    const lat = parseFloat(this.getAttribute('data-lat'));
                    const lng = parseFloat(this.getAttribute('data-lng'));
                    const name = this.getAttribute('data-name');

                    // Popola inputs
                    targetLatInput.value = lat;
                    targetLngInput.value = lng;

                    // Calcola automaticamente
                    calculateDistanceToTarget(lat, lng, name);
                });
            });

            // Pulsante calcola con input manuale
            calculateBtn.addEventListener('click', function () {
                const lat = parseFloat(targetLatInput.value);
                const lng = parseFloat(targetLngInput.value);

                if (isNaN(lat) || isNaN(lng)) {
                    distanceInfo.innerHTML = `
                        <div style="color: var(--rosso);">
                            <strong>‚ùå Errore:</strong><br>
                            Inserisci coordinate valide (es. 45.6495 per latitudine)
                        </div>
                    `;
                    distanceResult.style.display = 'block';
                    return;
                }

                calculateDistanceToTarget(lat, lng, 'Punto Personalizzato');
            });

            // Funzione per calcolare e mostrare distanza
            function calculateDistanceToTarget(targetLat, targetLng, targetName) {
                if (!lastKnownPosition) {
                    distanceInfo.innerHTML = `
                        <div style="color: var(--rosso);">
                            <strong>‚ùå Errore:</strong><br>
                            Devi prima rilevare la tua posizione GPS
                        </div>
                    `;
                    distanceResult.style.display = 'block';
                    return;
                }

                const myLat = lastKnownPosition.coords.latitude;
                const myLng = lastKnownPosition.coords.longitude;

                // Calcola distanza
                const distanceKm = calculateDistance(myLat, myLng, targetLat, targetLng);
                const distanceM = distanceKm * 1000;

                // Calcola tempi stimati
                const times = estimateTime(distanceKm);

                // Formato distanza
                let distanceText = '';
                if (distanceKm < 1) {
                    distanceText = `${Math.round(distanceM)} metri`;
                } else {
                    distanceText = `${distanceKm.toFixed(2)} km`;
                }

                // Mostra risultato
                distanceInfo.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <strong style="font-size: 1.2rem; color: #f59e0b;">üìè ${distanceText}</strong>
                        <br>
                        <span style="color: #666; font-size: 0.9rem;">distanza in linea d'aria da ${targetName}</span>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <strong style="color: #92400e;">üéØ Da:</strong> ${myLat.toFixed(6)}, ${myLng.toFixed(6)}<br>
                        <strong style="color: #92400e;">üéØ A:</strong> ${targetLat.toFixed(6)}, ${targetLng.toFixed(6)}
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <strong style="color: #374151;">‚è±Ô∏è Tempo Stimato:</strong>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.75rem;">
                        <div style="background: #e0f2fe; padding: 0.75rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem;">üö∂</div>
                            <div style="font-size: 0.85rem; color: #075985; margin-top: 0.25rem;">
                                <strong>${formatTime(times.walk)}</strong><br>
                                <span style="font-size: 0.75rem;">a piedi</span>
                            </div>
                        </div>
                        <div style="background: #dbeafe; padding: 0.75rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem;">üöå</div>
                            <div style="font-size: 0.85rem; color: #1e40af; margin-top: 0.25rem;">
                                <strong>${formatTime(times.bus)}</strong><br>
                                <span style="font-size: 0.75rem;">in bus</span>
                            </div>
                        </div>
                        <div style="background: #dcfce7; padding: 0.75rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem;">üöó</div>
                            <div style="font-size: 0.85rem; color: #166534; margin-top: 0.25rem;">
                                <strong>${formatTime(times.car)}</strong><br>
                                <span style="font-size: 0.75rem;">in auto</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; font-size: 0.85rem; color: #6b7280;">
                        üí° <strong>Nota:</strong> I tempi sono stime indicative basate su velocit√† medie. Il tempo reale pu√≤ variare per traffico, percorso e condizioni stradali.
                    </div>
                `;

                distanceResult.style.display = 'block';
                distanceResult.style.borderLeftColor = '#10b981';
                distanceResult.style.background = 'rgba(16, 185, 129, 0.1)';
            }
        })();

        // ===== BADGE DINAMICO CONNESSIONE MAPPA =====

        (function setupMapConnectionBadge() {
            function updateMapConnectionStatus() {
                const mapBadge = document.getElementById('map-connection-badge');
                const mapIcon = document.getElementById('map-connection-icon');
                const mapText = document.getElementById('map-connection-text');

                // Se elementi non esistono ancora, riprova tra poco
                if (!mapBadge || !mapIcon || !mapText) {
                    console.log('‚è≥ Badge mappa non ancora disponibile, riprovo tra 100ms...');
                    setTimeout(updateMapConnectionStatus, 100);
                    return;
                }

                // Controlla sia navigator.onLine che simulazione offline
                const offlineTest = localStorage.getItem('tpl.offlineTestMode') === 'true';
                const isOnline = navigator.onLine && !offlineTest;

                console.log('üîÑ Aggiornamento badge mappa:', {
                    navigatorOnLine: navigator.onLine,
                    offlineTest,
                    isOnline
                });

                if (isOnline) {
                    // Online
                    mapBadge.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                    mapBadge.style.color = '#065f46';
                    mapBadge.title = '‚úÖ Connessione attiva - Mappa disponibile';
                    mapIcon.textContent = 'üü¢';
                    mapText.textContent = 'Online';
                } else {
                    // Offline
                    mapBadge.style.background = 'linear-gradient(135deg, #fecaca, #fca5a5)';
                    mapBadge.style.color = '#7f1d1d';
                    mapBadge.title = 'üî¥ Nessuna connessione - Tile mappa non disponibili (GPS continua a funzionare)';
                    mapIcon.textContent = 'üî¥';
                    mapText.textContent = offlineTest ? 'Offline (simulato)' : 'Offline';
                }
            }

            // Aggiorna stato iniziale
            updateMapConnectionStatus();

            // Listener eventi online/offline (nativi)
            window.addEventListener('online', updateMapConnectionStatus);
            window.addEventListener('offline', updateMapConnectionStatus);

            // Listener evento simulazione offline (custom)
            window.addEventListener('offlineTestModeChanged', () => {
                console.log('üì° Evento offlineTestModeChanged ricevuto - Aggiorno badge mappa');
                // Piccolo delay per dare tempo a localStorage di aggiornarsi
                setTimeout(updateMapConnectionStatus, 50);
            });
        })();

        // ===== MAPPA INTERATTIVA LEAFLET =====

        // Variabili globali per la mappa
        let map = null;
        let marker = null;
        let accuracyCircle = null;
        let currentMapPosition = null;

        // Inizializza mappa Leaflet
        function initializeMap(lat, lng, accuracy) {
            const mapContainer = document.getElementById('map-container');
            const mapElement = document.getElementById('map');

            if (!mapContainer || !mapElement) return;

            // Mostra container mappa
            mapContainer.style.display = 'block';

            // Se la mappa non esiste, creala
            if (!map) {
                // Crea mappa centrata sulla posizione
                map = L.map('map').setView([lat, lng], 15);

                // Aggiungi tile layer OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    maxZoom: 19,
                    minZoom: 3
                }).addTo(map);

                // Aggiungi marker posizione
                marker = L.marker([lat, lng]).addTo(map);
                marker.bindPopup(`
                    <div style="text-align: center;">
                        <strong style="color: #3b82f6;">üìç La tua posizione</strong><br>
                        <span style="font-size: 0.85rem; color: #666;">
                            ${lat.toFixed(6)}, ${lng.toFixed(6)}
                        </span>
                    </div>
                `);

                // Aggiungi cerchio accuratezza
                accuracyCircle = L.circle([lat, lng], {
                    radius: accuracy,
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.15,
                    weight: 2
                }).addTo(map);

                // Zoom automatico per mostrare tutto il cerchio
                const bounds = accuracyCircle.getBounds();
                map.fitBounds(bounds, { padding: [50, 50] });

                // Setup pulsante ricentra
                const recenterBtn = document.getElementById('recenter-map-btn');
                if (recenterBtn) {
                    recenterBtn.addEventListener('click', () => {
                        if (currentMapPosition) {
                            map.setView([currentMapPosition.lat, currentMapPosition.lng], 15, {
                                animate: true,
                                duration: 0.5
                            });
                        }
                    });
                }

            } else {
                // Mappa esiste gi√†, aggiorna posizione
                map.setView([lat, lng], 15, { animate: true });

                // Aggiorna marker
                if (marker) {
                    marker.setLatLng([lat, lng]);
                    marker.setPopupContent(`
                        <div style="text-align: center;">
                            <strong style="color: #3b82f6;">üìç La tua posizione</strong><br>
                            <span style="font-size: 0.85rem; color: #666;">
                                ${lat.toFixed(6)}, ${lng.toFixed(6)}
                            </span>
                        </div>
                    `);
                }

                // Aggiorna cerchio accuratezza
                if (accuracyCircle) {
                    accuracyCircle.setLatLng([lat, lng]);
                    accuracyCircle.setRadius(accuracy);
                }

                // Zoom automatico
                if (accuracyCircle) {
                    const bounds = accuracyCircle.getBounds();
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }

            // Salva posizione corrente
            currentMapPosition = { lat, lng };

            // Fix per render issues (forza ridisegno)
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 100);
        }

        // Esegui tutti i test
        async function runAllTests() {
            console.log('Esecuzione di tutti i test...');
            await testDatabaseLoad();
            await new Promise(resolve => setTimeout(resolve, 500));
            testLocalStorage();
            await new Promise(resolve => setTimeout(resolve, 500));
            testDarkMode();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testPriceCalculation();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testServiceWorker();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testUIComponents();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testManifest();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testPerformance();
            console.log('Tutti i test completati!');
        }

        // Funzione per aggiornare lo status degli effetti
        function updateEffectsStatus() {
            const effectsGrid = document.getElementById('effects-grid');
            if (!effectsGrid) return;

            const isDarkMode = document.documentElement.classList.contains('dark');
            const isMobile = window.innerWidth <= 768;
            const hasAnimationSupport = 'animation' in document.documentElement.style;
            const hasBackdropFilter = CSS.supports('backdrop-filter', 'blur(10px)');
            const hasServiceWorker = 'serviceWorker' in navigator;

            // Rileva gli effetti attivi
            const effects = [
                {
                    id: 'background-animation',
                    icon: 'üåà',
                    title: 'Animazione Background',
                    status: !isMobile ? 'active' : 'inactive',
                    details: isMobile ?
                        'Disabilitata su mobile per performance' :
                        'Gradiente animato (20s) per desktop'
                },
                {
                    id: 'glassmorphism',
                    icon: 'üîÆ',
                    title: 'Effetto Glassmorphism',
                    status: 'active',
                    details: 'Backdrop-filter e trasparenze su tutte le card'
                },
                {
                    id: 'light-refraction',
                    icon: '‚ú®',
                    title: 'Rifrazione Luce',
                    status: !isMobile ? 'active' : 'inactive',
                    details: isMobile ?
                        'Disabilitata su mobile per performance' :
                        'Effetti luce su navbar, card e pulsanti'
                },
                {
                    id: 'smooth-animations',
                    icon: 'üé≠',
                    title: 'Animazioni Fluide',
                    status: hasAnimationSupport ? 'active' : 'inactive',
                    details: 'Transizioni cubic-bezier su elementi interattivi'
                },
                {
                    id: 'dark-mode',
                    icon: isDarkMode ? 'üåô' : '‚òÄÔ∏è',
                    title: 'Modalit√† Scura',
                    status: isDarkMode ? 'active' : 'inactive',
                    details: isDarkMode ?
                        'Tema scuro attivo' :
                        'Tema chiaro attivo'
                },
                {
                    id: 'responsive-design',
                    icon: 'üì±',
                    title: 'Design Responsive',
                    status: 'active',
                    details: `Layout ottimizzato per ${isMobile ? 'mobile' : 'desktop'}`
                },
                {
                    id: 'pwa-features',
                    icon: '‚öôÔ∏è',
                    title: 'Funzionalit√† PWA',
                    status: hasServiceWorker ? 'conditional' : 'inactive',
                    details: hasServiceWorker ?
                        'Service Worker supportato' :
                        'Service Worker non supportato'
                },
                {
                    id: 'accessibility',
                    icon: '‚ôø',
                    title: 'Accessibilit√†',
                    status: 'active',
                    details: 'Font size regolabile, hamburger menu, keyboard navigation'
                }
            ];

            // Popola la griglia
            effectsGrid.innerHTML = effects.map(effect => `
                <div class="effect-card">
                    <div class="effect-header">
                        <span class="effect-icon">${effect.icon}</span>
                        <span class="effect-title">${effect.title}</span>
                        <span class="effect-status ${effect.status}">
                            ${effect.status === 'active' ? '‚úÖ Attivo' :
                    effect.status === 'inactive' ? '‚ùå Inattivo' :
                        '‚ö†Ô∏è Condizionale'}
                        </span>
                    </div>
                    <div class="effect-details">
                        ${effect.details}
                    </div>
                </div>
            `).join('');
        }

        // ===== RILEVAMENTO INFO DEVICE/BROWSER =====
        function detectDeviceInfo() {
            const ua = navigator.userAgent;

            // === Device Type ===
            let deviceType = 'üíª Desktop';
            if (/Mobile|Android|iPhone/i.test(ua)) {
                deviceType = 'üì± Mobile';
            } else if (/Tablet|iPad/i.test(ua)) {
                deviceType = 'üì± Tablet';
            }
            document.getElementById('device-type').textContent = deviceType;

            // === OS ===
            let os = 'Sconosciuto';
            if (/Windows NT 10/i.test(ua)) os = 'ü™ü Windows 10/11';
            else if (/Windows NT 6.3/i.test(ua)) os = 'ü™ü Windows 8.1';
            else if (/Windows NT 6.2/i.test(ua)) os = 'ü™ü Windows 8';
            else if (/Windows NT 6.1/i.test(ua)) os = 'ü™ü Windows 7';
            else if (/Windows/i.test(ua)) os = 'ü™ü Windows';
            else if (/Mac OS X 10[._](\d+)/i.test(ua)) {
                const version = ua.match(/Mac OS X 10[._](\d+)/i)[1];
                os = `üçé macOS 10.${version}`;
            } else if (/Mac/i.test(ua)) os = 'üçé macOS';
            else if (/Android (\d+)/i.test(ua)) {
                const version = ua.match(/Android (\d+)/i)[1];
                os = `ü§ñ Android ${version}`;
            } else if (/Android/i.test(ua)) os = 'ü§ñ Android';
            else if (/iPhone OS (\d+)/i.test(ua)) {
                const version = ua.match(/iPhone OS (\d+)/i)[1];
                os = `üì± iOS ${version}`;
            } else if (/iPad.*OS (\d+)/i.test(ua)) {
                const version = ua.match(/iPad.*OS (\d+)/i)[1];
                os = `üì± iPadOS ${version}`;
            } else if (/Linux/i.test(ua)) os = 'üêß Linux';
            document.getElementById('device-os').textContent = os;

            // === Browser ===
            let browser = 'Sconosciuto';
            if (/Edg\//i.test(ua)) {
                const version = ua.match(/Edg\/(\d+)/i)[1];
                browser = `Edge ${version}`;
            } else if (/Chrome\//i.test(ua) && !/Edg/i.test(ua)) {
                const version = ua.match(/Chrome\/(\d+)/i)[1];
                browser = `Chrome ${version}`;
            } else if (/Firefox\//i.test(ua)) {
                const version = ua.match(/Firefox\/(\d+)/i)[1];
                browser = `Firefox ${version}`;
            } else if (/Safari\//i.test(ua) && !/Chrome/i.test(ua)) {
                const version = ua.match(/Version\/(\d+)/i);
                browser = version ? `Safari ${version[1]}` : 'Safari';
            } else if (/Opera|OPR\//i.test(ua)) {
                browser = 'Opera';
            }
            document.getElementById('device-browser').textContent = browser;


            // Funzione per aggiornare colore card batteria
            function updateBatteryCardColor(level, isCharging, isSupported) {
                const batteryCard = document.getElementById('device-battery')?.closest('.device-info-card');
                if (!batteryCard) return;

                if (!isSupported) {
                    batteryCard.setAttribute('data-color', 'gray');
                } else if (isCharging) {
                    batteryCard.setAttribute('data-color', 'green');
                } else if (level >= 50) {
                    batteryCard.setAttribute('data-color', 'green');
                } else if (level >= 20) {
                    batteryCard.setAttribute('data-color', 'orange');
                } else {
                    batteryCard.setAttribute('data-color', 'red');
                }
            }

            // === Battery ===
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    const level = Math.round(battery.level * 100);
                    const charging = battery.charging ? 'üîå In carica' : 'üîã';
                    const batteryEl = document.getElementById('device-battery');
                    if (batteryEl) {
                        batteryEl.textContent = `${charging} ${level}%`;
                        updateBatteryCardColor(level, battery.charging, true);
                    }

                    // Aggiorna su cambio batteria
                    battery.addEventListener('levelchange', () => {
                        const newLevel = Math.round(battery.level * 100);
                        const newCharging = battery.charging ? 'üîå In carica' : 'üîã';
                        const batteryEl = document.getElementById('device-battery');
                        if (batteryEl) {
                            batteryEl.textContent = `${newCharging} ${newLevel}%`;
                            updateBatteryCardColor(newLevel, battery.charging, true);
                        }
                    });

                    battery.addEventListener('chargingchange', () => {
                        const currentLevel = Math.round(battery.level * 100);
                        const isCharging = battery.charging ? 'üîå In carica' : 'üîã';
                        const batteryEl = document.getElementById('device-battery');
                        if (batteryEl) {
                            batteryEl.textContent = `${isCharging} ${currentLevel}%`;
                            updateBatteryCardColor(currentLevel, battery.charging, true);
                        }
                    });
                });
            } else {
                const batteryEl = document.getElementById('device-battery');
                if (batteryEl) {
                    batteryEl.textContent = 'Non supportato';
                    updateBatteryCardColor(0, false, false);
                }
            }

            // === GPS Support ===
            const hasGPS = 'geolocation' in navigator;
            const gpsEl = document.getElementById('device-gps');
            const gpsCard = gpsEl?.closest('.device-info-card');

            if (gpsEl) {
                gpsEl.textContent = hasGPS ? '‚úÖ Supportato' : '‚ùå Non supportato';
                // Cambia colore card: verde se supportato, grigio se non supportato
                if (gpsCard) {
                    gpsCard.setAttribute('data-color', hasGPS ? 'green' : 'gray');
                }
            }

            // === Dettagli Tecnici ===
            // Touch Support
            const touchSupport = ('ontouchstart' in window || navigator.maxTouchPoints > 0);
            const touchEl = document.getElementById('device-touch');
            const touchCard = touchEl?.closest('.device-info-card');

            if (touchEl) {
                touchEl.textContent = touchSupport ? '‚úÖ S√¨' : '‚ùå No';
                // Cambia colore card: verde se "S√¨", grigio se "No"
                if (touchCard) {
                    touchCard.setAttribute('data-color', touchSupport ? 'green' : 'gray');
                }
            }

            // PWA Mode - funzione per aggiornare stato PWA
            function updatePWAMode() {
                const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                    window.matchMedia('(display-mode: minimal-ui)').matches ||
                    window.matchMedia('(display-mode: fullscreen)').matches ||
                    (window.navigator.standalone === true);
                const pwaEl = document.getElementById('device-pwa');
                const pwaCard = pwaEl?.closest('.device-info-card');

                if (pwaEl) {
                    pwaEl.textContent = isPWA ? '‚úÖ S√¨' : '‚ùå No';
                    // Cambia colore card: verde se "S√¨", grigio se "No"
                    if (pwaCard) {
                        pwaCard.setAttribute('data-color', isPWA ? 'green' : 'gray');
                    }
                }
            }

            // Aggiorna inizialmente
            updatePWAMode();

            // Listener per aggiornare PWA Mode quando cambia display-mode (installazione/disinstallazione)
            // Pesatura: praticamente zero - solo ascolto passivo di eventi
            if (window.matchMedia) {
                const standaloneQuery = window.matchMedia('(display-mode: standalone)');
                const minimalUIQuery = window.matchMedia('(display-mode: minimal-ui)');
                const fullscreenQuery = window.matchMedia('(display-mode: fullscreen)');

                // Ascolta cambiamenti (usando addEventListener se supportato, altrimenti addListener per compatibilit√†)
                if (standaloneQuery.addEventListener) {
                    standaloneQuery.addEventListener('change', updatePWAMode);
                    minimalUIQuery.addEventListener('change', updatePWAMode);
                    fullscreenQuery.addEventListener('change', updatePWAMode);
                } else if (standaloneQuery.addListener) {
                    // Fallback per browser pi√π vecchi
                    standaloneQuery.addListener(updatePWAMode);
                    minimalUIQuery.addListener(updatePWAMode);
                    fullscreenQuery.addListener(updatePWAMode);
                }
            }

            // Ascolta anche eventi di installazione PWA (se supportati)
            window.addEventListener('appinstalled', () => {
                console.log('üì≤ PWA installata - aggiorno stato');
                setTimeout(updatePWAMode, 100); // Piccolo delay per permettere al browser di aggiornare display-mode
            });
        }

        // ===== TEST RAPIDO GPS ONE-CLICK =====
        async function quickGPSTest() {
            const btn = document.getElementById('quick-gps-test-btn');
            const icon = document.getElementById('quick-test-icon');
            const text = document.getElementById('quick-test-text');
            const resultsDiv = document.getElementById('quick-test-results');
            const itemsDiv = document.getElementById('quick-test-items');
            const summaryDiv = document.getElementById('quick-test-summary');

            // Disabilita button e mostra loading
            btn.disabled = true;
            btn.style.opacity = '0.7';
            icon.textContent = '‚è≥';
            text.textContent = 'Test in corso...';

            // Mostra risultati (vuoti per ora)
            resultsDiv.style.display = 'block';
            itemsDiv.innerHTML = '<p style="text-align: center; color: #9ca3af;">Esecuzione test in corso...</p>';
            summaryDiv.innerHTML = '';

            const testResults = [];

            // === TEST 1: Permessi ===
            try {
                const permission = await navigator.permissions.query({ name: 'geolocation' });
                const status = permission.state;
                testResults.push({
                    name: 'Permessi Geolocalizzazione',
                    status: status === 'granted' ? 'success' : (status === 'prompt' ? 'warning' : 'error'),
                    message: status === 'granted' ? 'Permessi concessi' : (status === 'prompt' ? 'Permessi non richiesti' : 'Permessi negati'),
                    icon: status === 'granted' ? 'üü¢' : (status === 'prompt' ? 'üü°' : 'üî¥')
                });
            } catch (e) {
                testResults.push({
                    name: 'Permessi Geolocalizzazione',
                    status: 'warning',
                    message: 'Impossibile verificare permessi',
                    icon: 'üü°'
                });
            }

            // === TEST 2: Supporto GPS ===
            const hasGPS = 'geolocation' in navigator;
            testResults.push({
                name: 'Supporto GPS Hardware',
                status: hasGPS ? 'success' : 'error',
                message: hasGPS ? 'GPS supportato dal browser' : 'GPS non supportato',
                icon: hasGPS ? 'üü¢' : 'üî¥'
            });

            // === TEST 3: Rilevamento Posizione ===
            if (hasGPS) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });

                    const accuracy = position.coords.accuracy;
                    const hasSpeed = position.coords.speed !== null;
                    const hasAltitude = position.coords.altitude !== null;

                    // Valutazione accuratezza
                    let accuracyStatus = 'success';
                    let accuracyMsg = `Eccellente (¬±${accuracy.toFixed(0)}m)`;
                    if (accuracy > 50 && accuracy <= 100) {
                        accuracyStatus = 'warning';
                        accuracyMsg = `Buona (¬±${accuracy.toFixed(0)}m)`;
                    } else if (accuracy > 100) {
                        accuracyStatus = 'warning';
                        accuracyMsg = `Bassa (¬±${accuracy.toFixed(0)}m)`;
                    }

                    testResults.push({
                        name: 'Rilevamento Posizione',
                        status: 'success',
                        message: `Posizione rilevata con successo`,
                        icon: 'üü¢'
                    });

                    testResults.push({
                        name: 'Accuratezza GPS',
                        status: accuracyStatus,
                        message: accuracyMsg,
                        icon: accuracyStatus === 'success' ? 'üü¢' : 'üü°'
                    });

                    testResults.push({
                        name: 'Dati Avanzati (Velocit√†/Altitudine)',
                        status: (hasSpeed || hasAltitude) ? 'success' : 'warning',
                        message: hasSpeed && hasAltitude ? 'Velocit√† e altitudine disponibili' :
                            hasSpeed ? 'Solo velocit√† disponibile' :
                                hasAltitude ? 'Solo altitudine disponibile' :
                                    'Dati non disponibili (normale su alcuni device)',
                        icon: (hasSpeed || hasAltitude) ? 'üü¢' : 'üü°'
                    });

                    // === TEST 4: Reverse Geocoding ===
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&zoom=18&addressdetails=1`);
                        if (response.ok) {
                            const data = await response.json();
                            testResults.push({
                                name: 'Reverse Geocoding (API Nominatim)',
                                status: 'success',
                                message: `Indirizzo trovato: ${data.display_name || 'N/A'}`.substring(0, 80) + '...',
                                icon: 'üü¢'
                            });
                        } else {
                            testResults.push({
                                name: 'Reverse Geocoding (API Nominatim)',
                                status: 'warning',
                                message: 'API non risponde correttamente',
                                icon: 'üü°'
                            });
                        }
                    } catch (e) {
                        testResults.push({
                            name: 'Reverse Geocoding (API Nominatim)',
                            status: 'warning',
                            message: navigator.onLine ? 'Errore API' : 'Offline - Funzione non disponibile',
                            icon: 'üü°'
                        });
                    }

                    // === TEST 5: Libreria Mappa (Leaflet) ===
                    const hasLeaflet = typeof L !== 'undefined';
                    testResults.push({
                        name: 'Libreria Mappa (Leaflet.js)',
                        status: hasLeaflet ? 'success' : 'error',
                        message: hasLeaflet ? 'Leaflet caricato correttamente' : 'Leaflet non disponibile',
                        icon: hasLeaflet ? 'üü¢' : 'üî¥'
                    });

                } catch (error) {
                    testResults.push({
                        name: 'Rilevamento Posizione',
                        status: 'error',
                        message: error.code === 1 ? 'Permesso negato dall\'utente' :
                            error.code === 2 ? 'Posizione non disponibile' :
                                error.code === 3 ? 'Timeout richiesta' :
                                    'Errore sconosciuto',
                        icon: 'üî¥'
                    });
                }
            }

            // === RENDER RISULTATI ===
            itemsDiv.innerHTML = testResults.map(result => `
                <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem; background: ${result.status === 'success' ? '#f0fdf4' :
                    result.status === 'warning' ? '#fef3c7' :
                        '#fee2e2'
                }; border-radius: 8px; border-left: 4px solid ${result.status === 'success' ? '#10b981' :
                    result.status === 'warning' ? '#f59e0b' :
                        '#ef4444'
                };">
                    <div style="font-size: 1.5rem; flex-shrink: 0;">${result.icon}</div>
                    <div style="flex: 1;">
                        <strong style="color: #374151;">${result.name}</strong>
                        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.9rem;">${result.message}</p>
                    </div>
                </div>
            `).join('');

            // === SUMMARY ===
            const successCount = testResults.filter(r => r.status === 'success').length;
            const warningCount = testResults.filter(r => r.status === 'warning').length;
            const errorCount = testResults.filter(r => r.status === 'error').length;
            const total = testResults.length;

            let summaryColor, summaryIcon, summaryText;
            if (errorCount === 0 && warningCount === 0) {
                summaryColor = '#10b981';
                summaryIcon = '‚úÖ';
                summaryText = 'Tutti i test superati! GPS completamente funzionante!';
            } else if (errorCount === 0) {
                summaryColor = '#f59e0b';
                summaryIcon = '‚ö†Ô∏è';
                summaryText = `${successCount}/${total} test superati. Alcune funzioni potrebbero avere limitazioni.`;
            } else {
                summaryColor = '#ef4444';
                summaryIcon = '‚ùå';
                summaryText = `${errorCount} errori critici. Verifica configurazione GPS.`;
            }

            summaryDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem; color: ${summaryColor};">
                    <span style="font-size: 1.5rem;">${summaryIcon}</span>
                    <span>${summaryText}</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #6b7280; font-weight: normal;">
                    üü¢ ${successCount} successi ¬∑ üü° ${warningCount} avvisi ¬∑ üî¥ ${errorCount} errori
                </div>
            `;

            // Ripristina button
            btn.disabled = false;
            btn.style.opacity = '1';
            icon.textContent = 'üîÑ';
            text.textContent = 'Ripeti Test';
        }

        // ===== EXPORT REPORT GPS =====
        async function exportGPSReport(format) {
            const reportData = {
                timestamp: new Date().toISOString(),
                timestampReadable: new Date().toLocaleString('it-IT'),
                device: {
                    type: document.getElementById('device-type')?.textContent || 'N/A',
                    os: document.getElementById('device-os')?.textContent || 'N/A',
                    browser: document.getElementById('device-browser')?.textContent || 'N/A',
                    battery: document.getElementById('device-battery')?.textContent || 'N/A',
                    gpsSupport: document.getElementById('device-gps')?.textContent || 'N/A',
                    viewport: document.getElementById('device-viewport')?.textContent || 'N/A',
                    touchSupport: document.getElementById('device-touch')?.textContent || 'N/A',
                    pwaMode: document.getElementById('device-pwa')?.textContent || 'N/A',
                    userAgent: navigator.userAgent
                },
                gps: {
                    permissionStatus: document.getElementById('geo-permission-text')?.textContent || 'N/A',
                    lastPosition: null,
                    fakePositionActive: localStorage.getItem('tpl.useFakePosition') === 'true',
                    fakePositionData: localStorage.getItem('tpl.fakePositionData') ?
                        JSON.parse(localStorage.getItem('tpl.fakePositionData')) : null
                }
            };

            // Prova a ottenere posizione corrente
            if ('geolocation' in navigator) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 60000
                        });
                    });

                    reportData.gps.lastPosition = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude,
                        altitudeAccuracy: position.coords.altitudeAccuracy,
                        heading: position.coords.heading,
                        speed: position.coords.speed,
                        timestamp: new Date(position.timestamp).toLocaleString('it-IT')
                    };
                } catch (e) {
                    reportData.gps.lastPosition = { error: 'Impossibile rilevare posizione' };
                }
            }

            // Genera file
            let content, filename, mimeType;

            if (format === 'json') {
                content = JSON.stringify(reportData, null, 2);
                filename = `gps-report-${Date.now()}.json`;
                mimeType = 'application/json';
            } else {
                // Formato TXT
                content = `
========================================
  üìç REPORT TEST GPS - TPL FVG
========================================

Data e Ora: ${reportData.timestampReadable}

========================================
  üì± INFORMAZIONI DEVICE
========================================

Device Type:        ${reportData.device.type}
Sistema Operativo:  ${reportData.device.os}
Browser:            ${reportData.device.browser}
Batteria:           ${reportData.device.battery}
Supporto GPS:       ${reportData.device.gpsSupport}

Screen:             ${reportData.device.screen}
Viewport:           ${reportData.device.viewport}
Pixel Ratio:        ${reportData.device.pixelRatio}
Touch Support:      ${reportData.device.touchSupport}
PWA Mode:           ${reportData.device.pwaMode}

User Agent:
${reportData.device.userAgent}

========================================
  üõ∞Ô∏è INFORMAZIONI GPS
========================================

Permission Status:  ${reportData.gps.permissionStatus}
Fake Position:      ${reportData.gps.fakePositionActive ? 'Attiva' : 'Inattiva'}

${reportData.gps.lastPosition && !reportData.gps.lastPosition.error ? `
--- ULTIMA POSIZIONE ---
Latitudine:         ${reportData.gps.lastPosition.latitude}¬∞
Longitudine:        ${reportData.gps.lastPosition.longitude}¬∞
Accuratezza:        ¬±${reportData.gps.lastPosition.accuracy}m
Altitudine:         ${reportData.gps.lastPosition.altitude !== null ? reportData.gps.lastPosition.altitude + 'm' : 'N/A'}
Velocit√†:           ${reportData.gps.lastPosition.speed !== null ? (reportData.gps.lastPosition.speed * 3.6).toFixed(1) + ' km/h' : 'N/A'}
Direzione:          ${reportData.gps.lastPosition.heading !== null ? reportData.gps.lastPosition.heading + '¬∞' : 'N/A'}
Timestamp:          ${reportData.gps.lastPosition.timestamp}
` : `
--- ULTIMA POSIZIONE ---
${reportData.gps.lastPosition?.error || 'Non disponibile'}
`}

${reportData.gps.fakePositionActive && reportData.gps.fakePositionData ? `
--- FAKE POSITION DATA ---
${JSON.stringify(reportData.gps.fakePositionData, null, 2)}
` : ''}

========================================
  üìä FINE REPORT
========================================
                `.trim();
                filename = `gps-report-${Date.now()}.txt`;
                mimeType = 'text/plain';
            }

            // Download file
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Feedback visivo
            const btn = format === 'json' ? document.getElementById('export-json-btn') : document.getElementById('export-txt-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Scaricato!';
            btn.disabled = true;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        }

        // ===== RESET DATI GPS =====
        function showResetModal() {
            const modal = document.getElementById('reset-modal-overlay');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Previeni scroll durante modal
        }

        function hideResetModal() {
            const modal = document.getElementById('reset-modal-overlay');
            modal.style.display = 'none';
            document.body.style.overflow = ''; // Ripristina scroll
        }

        function confirmResetGPS() {
            // Nascondi modal
            hideResetModal();

            const btn = document.getElementById('reset-gps-btn');
            const originalText = btn.innerHTML;

            // Mostra loading
            btn.innerHTML = '‚è≥ Reset...';
            btn.disabled = true;

            // Lista chiavi da cancellare
            const gpsKeys = [
                'tpl.useFakePosition',
                'tpl.fakePositionData',
                'tpl.offlineTestMode'
            ];

            // Cancella localStorage
            gpsKeys.forEach(key => {
                localStorage.removeItem(key);
            });

            // Feedback successo
            btn.innerHTML = '‚úÖ Reset Completato!';
            btn.style.background = '#10b981';

            // Ricarica pagina dopo 1.5 secondi
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        // ===== LISTENER DOM CONTENT LOADED =====
        window.addEventListener('DOMContentLoaded', () => {
            // Inizializza info device
            detectDeviceInfo();

            // Inizializza statistiche e effetti
            updateStats();
            updateEffectsStatus();

            // Event listener per test geolocalizzazione
            const testLocationBtn = document.getElementById('test-location-btn');
            if (testLocationBtn) {
                testLocationBtn.addEventListener('click', testGeolocation);
            }

            // Event listener per test rapido GPS
            const quickTestBtn = document.getElementById('quick-gps-test-btn');
            if (quickTestBtn) {
                quickTestBtn.addEventListener('click', quickGPSTest);
            }

            // Event listener per export report
            const exportJsonBtn = document.getElementById('export-json-btn');
            if (exportJsonBtn) {
                exportJsonBtn.addEventListener('click', () => exportGPSReport('json'));
            }

            const exportTxtBtn = document.getElementById('export-txt-btn');
            if (exportTxtBtn) {
                exportTxtBtn.addEventListener('click', () => exportGPSReport('txt'));
            }

            // Event listener per reset dati GPS
            const resetGpsBtn = document.getElementById('reset-gps-btn');
            if (resetGpsBtn) {
                resetGpsBtn.addEventListener('click', showResetModal);
            }

            // Event listener per pulsanti modal reset
            const resetModalCancel = document.getElementById('reset-modal-cancel');
            if (resetModalCancel) {
                resetModalCancel.addEventListener('click', hideResetModal);
            }

            const resetModalConfirm = document.getElementById('reset-modal-confirm');
            if (resetModalConfirm) {
                resetModalConfirm.addEventListener('click', confirmResetGPS);
            }

            // Chiudi modal cliccando sull'overlay
            const resetModalOverlay = document.getElementById('reset-modal-overlay');
            if (resetModalOverlay) {
                resetModalOverlay.addEventListener('click', (e) => {
                    if (e.target === resetModalOverlay) {
                        hideResetModal();
                    }
                });
            }

            // Chiudi modal con tasto ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && resetModalOverlay && resetModalOverlay.style.display === 'block') {
                    hideResetModal();
                }
            });

            // Aggiorna l'anno nel footer
            const footerYear = document.getElementById('footer-year');
            if (footerYear) footerYear.textContent = new Date().getFullYear();

            // Aggiorna effetti quando cambia la modalit√†
            const darkModeToggle = document.getElementById('darkmode-toggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    setTimeout(updateEffectsStatus, 100); // Aspetta che il cambio modalit√† sia completato
                });
            }
        });

        // Aggiorna effetti quando cambia la dimensione schermo
        window.addEventListener('resize', () => {
            setTimeout(updateEffectsStatus, 100);
        });

        // Funzione scroll to top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Mostra/nascondi pulsante scroll to top
        window.addEventListener('scroll', function () {
            const scrollButton = document.querySelector('.scroll-to-top');
            if (scrollButton) {
                if (window.pageYOffset > 300) {
                    scrollButton.style.display = 'block';
                } else {
                    scrollButton.style.display = 'none';
                }
            }
        });

        // ===== MEGA DROPDOWN IMPOSTAZIONI (OPZIONE C) =====
        (function () {
            const dropdownBtn = document.getElementById('test-settings-dropdown-btn');
            const dropdown = document.getElementById('test-settings-dropdown');

            if (!dropdownBtn || !dropdown) return;

            // Toggle dropdown
            dropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isActive = dropdown.classList.contains('show');

                if (isActive) {
                    closeDropdown();
                } else {
                    openDropdown();
                }
            });

            function openDropdown() {
                dropdown.classList.add('show');
                dropdownBtn.classList.add('active');
            }

            function closeDropdown() {
                dropdown.classList.remove('show');
                dropdownBtn.classList.remove('active');
            }

            // Chiudi dropdown quando si clicca fuori
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && !dropdownBtn.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Gestione tema
            const themeRadios = document.querySelectorAll('input[name="test-theme"]');
            themeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const themeToggle = document.getElementById('darkmode-toggle');
                    if (themeToggle) {
                        if (radio.value === 'dark') {
                            document.body.classList.add('dark');
                        } else if (radio.value === 'light') {
                            document.body.classList.remove('dark');
                        } else {
                            // Sistema - segue preferenze dispositivo
                            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                document.body.classList.add('dark');
                            } else {
                                document.body.classList.remove('dark');
                            }
                        }
                    }
                });
            });

            // Gestione animazione sfondo
            const animationToggle = document.getElementById('test-animation-toggle');
            if (animationToggle) {
                animationToggle.addEventListener('change', () => {
                    const realToggle = document.getElementById('animationToggle');
                    if (realToggle) {
                        realToggle.click();
                    }
                });
            }

            // Gestione alto contrasto
            const highContrastToggle = document.getElementById('test-high-contrast');
            if (highContrastToggle) {
                highContrastToggle.addEventListener('change', () => {
                    document.body.classList.toggle('high-contrast', highContrastToggle.checked);
                });
            }

            // Gestione font size
            const fontButtons = dropdown.querySelectorAll('.dropdown-font-btn');
            fontButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const size = btn.dataset.size;

                    // Rimuovi active da tutti
                    fontButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Applica la dimensione
                    const realBtns = document.querySelectorAll('.font-size-btn');
                    realBtns.forEach(realBtn => {
                        if (realBtn.dataset.size === size) {
                            realBtn.click();
                        }
                    });
                });
            });

            // Gestione azioni rapide
            const checkUpdatesBtn = document.getElementById('test-check-updates');
            if (checkUpdatesBtn) {
                checkUpdatesBtn.addEventListener('click', () => {
                    const cacheResetBtn = document.getElementById('cache-reset');
                    if (cacheResetBtn) {
                        cacheResetBtn.click();
                    }
                    closeDropdown();
                });
            }

            const clearCacheBtn = document.getElementById('test-clear-cache');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', () => {
                    const cacheResetBtn = document.getElementById('cache-reset');
                    if (cacheResetBtn) {
                        cacheResetBtn.click();
                    }
                    closeDropdown();
                });
            }
        })();
    </script>

    <!-- Render del Changelog -->
    <script>
        // Aspetta che il DOM sia pronto
        document.addEventListener('DOMContentLoaded', () => {
            renderChangelog('changelog-container');
        });
    </script>

    <!-- Script Rilevamento Display -->
    <script>
        (function () {
            // Rileva info display
            function detectDisplayInfo() {
                const dpr = window.devicePixelRatio || 1;
                const screenWidth = window.screen.width;
                const screenHeight = window.screen.height;
                const physicalWidth = Math.round(screenWidth * dpr);
                const physicalHeight = Math.round(screenHeight * dpr);

                let typeName = 'Standard';

                if (dpr >= 3) {
                    typeName = 'Super Retina / Ultra HD';
                } else if (dpr >= 2) {
                    typeName = 'Retina / HiDPI';
                } else if (dpr > 1) {
                    typeName = 'Alta Densit√†';
                }

                return {
                    dpr,
                    typeName,
                    screenWidth,
                    screenHeight,
                    physicalWidth,
                    physicalHeight,
                    isHighDPI: dpr >= 2
                };
            }

            // Aggiorna UI
            function updateDisplayUI(displayInfo) {
                const typeEl = document.getElementById('test-display-type');
                const dprEl = document.getElementById('test-display-dpr');
                const logicalEl = document.getElementById('test-display-logical');
                const physicalEl = document.getElementById('test-display-physical');
                const highDpiBadge = document.getElementById('test-display-highdpi-badge');
                const viewportEl = document.getElementById('test-display-viewport');

                if (typeEl) typeEl.textContent = displayInfo.typeName;
                if (dprEl) dprEl.textContent = displayInfo.dpr.toFixed(2) + 'x';
                if (logicalEl) logicalEl.textContent = displayInfo.screenWidth + ' √ó ' + displayInfo.screenHeight + ' px';
                if (physicalEl) physicalEl.textContent = displayInfo.physicalWidth + ' √ó ' + displayInfo.physicalHeight + ' px';

                // Viewport (aggiornato automaticamente)
                if (viewportEl) {
                    viewportEl.textContent = window.innerWidth + ' √ó ' + window.innerHeight + ' px';
                }

                // Badge High DPI con colori
                if (highDpiBadge) {
                    if (displayInfo.isHighDPI) {
                        highDpiBadge.textContent = 'S√¨';
                        highDpiBadge.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                        highDpiBadge.style.color = 'white';
                    } else {
                        highDpiBadge.textContent = 'No';
                        highDpiBadge.style.background = 'var(--grigio-medio)';
                        highDpiBadge.style.color = 'var(--testo-secondario)';
                    }
                }

                // Log console
                console.log('üñ•Ô∏è Display rilevato:', {
                    tipo: displayInfo.typeName,
                    dpr: displayInfo.dpr,
                    risoluzione: displayInfo.screenWidth + 'x' + displayInfo.screenHeight,
                    fisica: displayInfo.physicalWidth + 'x' + displayInfo.physicalHeight,
                    viewport: window.innerWidth + 'x' + window.innerHeight,
                    highDPI: displayInfo.isHighDPI
                });
            }

            // Inizializzazione
            function init() {
                const displayInfo = detectDisplayInfo();
                updateDisplayUI(displayInfo);
            }

            // Avvia al caricamento
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            // Bottone refresh
            const refreshBtn = document.getElementById('test-display-refresh');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    const displayInfo = detectDisplayInfo();
                    updateDisplayUI(displayInfo);
                });
            }

            // Re-detect su resize (rotazione, zoom) - aggiorna anche viewport
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const displayInfo = detectDisplayInfo();
                    updateDisplayUI(displayInfo);

                    // Aggiorna viewport anche in modo rapido (senza rifare tutto)
                    const viewportEl = document.getElementById('test-display-viewport');
                    if (viewportEl) {
                        viewportEl.textContent = window.innerWidth + ' √ó ' + window.innerHeight + ' px';
                    }
                }, 250);
            });
        })();
    </script>

    <!-- Script Monitoraggio Connessione -->
    <script>
        (function () {
            // Elementi info connessione
            const statusIconEl = document.getElementById('connection-status-icon');
            const statusTextEl = document.getElementById('connection-status-text');
            const testDateEl = document.getElementById('connection-test-date');
            const resetBtn = document.getElementById('reset-connection-btn');

            // Storico test connessione
            let lastTestDate = null;
            let lastTestStatus = null;

            // Formatta data/ora per visualizzazione
            function formatTestDate(date) {
                if (!date) return '-';
                const d = new Date(date);
                const now = new Date();
                const diffMs = now - d;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                // Data completa
                const dateStr = d.toLocaleDateString('it-IT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const timeStr = d.toLocaleTimeString('it-IT', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // Tempo relativo
                if (diffMins < 1) return 'Adesso';
                if (diffMins < 60) return `${diffMins} min fa`;
                if (diffHours < 24) return `${diffHours} ore fa`;
                if (diffDays < 7) return `${diffDays} giorni fa`;

                return `${dateStr} ${timeStr}`;
            }

            // Rileva stato connessione (solo Online/Offline)
            async function detectConnectionInfo(showDate = true) {
                // Verifica reale della connessione
                let isOnline = navigator.onLine;

                // Se navigator.onLine dice online, verifica con richiesta reale
                if (navigator.onLine) {
                    try {
                        const controller = new AbortController();
                        const timeout = setTimeout(() => controller.abort(), 1500);

                        await fetch('https://www.google.com/favicon.ico?t=' + Date.now(), {
                            method: 'HEAD',
                            mode: 'no-cors',
                            cache: 'no-cache',
                            signal: controller.signal
                        });

                        clearTimeout(timeout);
                        isOnline = true;
                    } catch (e) {
                        // Se la richiesta fallisce, probabilmente offline
                        isOnline = false;
                        console.log('üî¥ Verifica reale: OFFLINE');
                    }
                } else {
                    isOnline = false;
                }

                // Aggiorna storico se c'√® un cambiamento o √® una verifica manuale
                if (showDate && (lastTestStatus !== isOnline || !lastTestDate)) {
                    lastTestDate = new Date();
                    lastTestStatus = isOnline;
                }

                // Aggiorna UI
                if (statusIconEl) {
                    statusIconEl.textContent = isOnline ? 'üü¢' : 'üî¥';
                }
                if (statusTextEl) {
                    statusTextEl.textContent = isOnline ? 'Online' : 'Offline';
                    statusTextEl.style.color = isOnline ? '#10b981' : '#ef4444';
                }
                if (testDateEl && showDate && lastTestDate) {
                    testDateEl.textContent = `Test: ${formatTestDate(lastTestDate)}`;
                    testDateEl.style.opacity = '1';
                }

                // Abilita/disabilita pulsante reset
                if (resetBtn) {
                    resetBtn.disabled = !lastTestDate;
                    resetBtn.style.opacity = lastTestDate ? '1' : '0.6';
                }
            }

            // Reset risultati
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    lastTestDate = null;
                    lastTestStatus = null;

                    if (statusTextEl) {
                        statusTextEl.textContent = 'Non testato';
                        statusTextEl.style.color = 'var(--testo-secondario)';
                    }
                    if (statusIconEl) {
                        statusIconEl.textContent = '‚ö™';
                    }
                    if (testDateEl) {
                        testDateEl.textContent = '-';
                        testDateEl.style.opacity = '0.7';
                    }

                    resetBtn.disabled = true;
                    resetBtn.style.opacity = '0.6';
                });
            }

            // Inizializza monitoraggio connessione (solo eventi del browser, NO aggiornamento automatico)
            async function initConnectionMonitoring() {
                // Verifica iniziale (senza data, solo per mostrare stato corrente)
                await detectConnectionInfo(false);

                // Ascolta SOLO eventi online/offline del browser (per le notifiche)
                // Questi eventi scatenano anche le notifiche in script.js
                window.addEventListener('online', async () => {
                    await detectConnectionInfo(true); // Con data quando √® un evento reale
                    console.log('üü¢ Connessione ripristinata');
                });

                window.addEventListener('offline', async () => {
                    await detectConnectionInfo(true); // Con data quando √® un evento reale
                    console.log('üî¥ Connessione persa');
                });
            }

            // Pulsante verifica manuale
            const checkConnectionBtn = document.getElementById('check-connection-btn');
            if (checkConnectionBtn) {
                checkConnectionBtn.addEventListener('click', async () => {
                    // Disabilita pulsante durante verifica
                    checkConnectionBtn.disabled = true;
                    checkConnectionBtn.style.opacity = '0.6';
                    const btnText = checkConnectionBtn.querySelector('span:last-child');
                    const originalText = btnText.textContent;
                    btnText.textContent = 'Verifica...';

                    // Verifica connessione (con data perch√© √® un test manuale)
                    await detectConnectionInfo(true);

                    // Reabilita pulsante dopo 1 secondo
                    setTimeout(() => {
                        checkConnectionBtn.disabled = false;
                        checkConnectionBtn.style.opacity = '1';
                        btnText.textContent = originalText;
                    }, 1000);
                });
            }

            // Inizializza al caricamento
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initConnectionMonitoring);
            } else {
                initConnectionMonitoring();
            }
        })();

        // ===== ANIMAZIONE HEADER (Database & LocalStorage) =====
        // L'animazione shrink/expand dell'header √® gestita automaticamente da js/features/tests-ui.js
        console.log('‚ÑπÔ∏è Animazione header gestita da tests-ui.js');

        // ===== ANIMAZIONE SOBRIA GRUPPI TEST =====
        // Animazione subtile quando si clicca per aprire/chiudere i gruppi
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üé® Inizializzazione animazioni sobrie gruppi test');
            
            // Seleziona tutti i gruppi
            document.querySelectorAll('.test-group-separator').forEach(group => {
                const header = group.querySelector('.test-group-header');
                if (!header) return;
                
                header.addEventListener('click', function(e) {
                    // Non animare se si clicca sul pulsante test singolo
                    if (e.target.closest('.test-run-single')) {
                        return;
                    }
                    
                    const content = group.querySelector('.test-group-content');
                    const isExpanding = !content.classList.contains('expanded');
                    
                    // Animazione press (sempre)
                    group.classList.remove('clicking');
                    void group.offsetHeight; // Forza reflow
                    group.classList.add('clicking');
                    
                    setTimeout(() => {
                        group.classList.remove('clicking');
                    }, 200);
                    
                    // Animazione highlight (solo quando si apre)
                    if (isExpanding) {
                        group.classList.remove('opening');
                        void group.offsetHeight;
                        group.classList.add('opening');
                        
                        setTimeout(() => {
                            group.classList.remove('opening');
                        }, 300);
                    }
                });
            });
            
            console.log('‚úÖ Animazioni sobrie applicate a', document.querySelectorAll('.test-group-separator').length, 'gruppi');
        });
    </script>

</body>

</html>