<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>TPL FVG - Prototipo iOS 26</title>
    <!-- Preset CSS - Scegli uno: desktop, tablet, mobile, pwa -->
    <!-- Per desktop: css/presets/desktop.css -->
    <!-- Per tablet: css/presets/tablet.css -->
    <!-- Per mobile: css/presets/mobile.css -->
    <!-- Per PWA: css/presets/pwa.css -->
    <link rel="stylesheet" href="css/presets/desktop.css" />
    <link rel="stylesheet" href="css/pages/home-page.css" />
  </head>
  <body>
    <!-- Navbar -->
    <header class="navbar">
      <div class="navbar-content">
        <a
          href="home-ios26-prototype.html"
          class="navbar-brand"
          aria-label="Vai alla home TPL FVG"
        >
          <div class="navbar-logo-wrapper">
            <img
              src="../src/logo.png"
              alt="TPL"
              class="navbar-logo"
              onerror="this.style.display='none'"
            />
          </div>
          <div class="navbar-title">
            <div class="logo-acronym">
              <span class="logo-line">tpl</span>
              <span class="logo-line">fvg</span>
            </div>
            <div class="logo-text">
              <span class="logo-text-line">trasporto</span>
              <span class="logo-text-line">pubblico</span>
              <span class="logo-text-line">locale</span>
            </div>
          </div>
        </a>

        <nav class="navbar-nav">
          <a
            href="home-ios26-prototype.html"
            class="nav-link active"
            aria-current="page"
            >Home</a
          >
          <a href="fermate-ios26-prototype.html" class="nav-link">Fermate</a>
          <a href="prezzi-ios26-prototype.html" class="nav-link">Prezzi</a>
        </nav>

        <div class="navbar-actions">
          <button
            class="settings-button"
            aria-label="Impostazioni"
            title="Impostazioni"
          >
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"
              ></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
          <button
            class="hamburger-toggle"
            onclick="toggleMobileMenu()"
            aria-label="Menu"
            id="hamburger-toggle"
            data-section="home"
          >
            <span class="hamburger-section-label">Home</span>
            <span class="hamburger-separator"></span>
            <div class="hamburger-icon-wrapper">
              <div class="hamburger-icon">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </button>
        </div>
      </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>

    <!-- Mobile Menu - Popup iOS 26 Style -->
    <div class="mobile-menu" id="mobile-menu">
      <nav class="mobile-menu-nav">
        <a href="home-ios26-prototype.html" class="mobile-nav-link active">
          <span class="mobile-nav-icon">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="0.8"
              stroke-linecap="round"
              stroke-linejoin="round"
              width="20"
              height="20"
            >
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </span>
          <span>Home</span>
        </a>
        <a href="fermate-ios26-prototype.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="0.8"
              stroke-linecap="round"
              stroke-linejoin="round"
              width="20"
              height="20"
            >
              <rect x="6" y="5" width="12" height="14" rx="2" />
              <line x1="6" y1="9" x2="18" y2="9" />
              <line x1="6" y1="14" x2="18" y2="14" />
              <line x1="8" y1="17" x2="9" y2="17" />
              <line x1="15" y1="17" x2="16" y2="17" />
              <path d="M6 8c-2 0 -3 1 -3 3v2" />
              <path d="M18 8c2 0 3 1 3 3v2" />
              <path d="M8 19v1a1.5 1.5 0 0 0 3 0v-1" />
              <path d="M13 19v1a1.5 1.5 0 0 0 3 0v-1" />
            </svg>
          </span>
          <span>Fermate</span>
        </a>
        <a href="prezzi-ios26-prototype.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="0.8"
              stroke-linecap="round"
              stroke-linejoin="round"
              width="20"
              height="20"
            >
              <path
                d="M19 5H5a2 2 0 0 0-2 2v2.5a2.5 2.5 0 0 1 0 5V17a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-2.5a2.5 2.5 0 0 1 0-5V7a2 2 0 0 0-2-2z"
              />
              <circle cx="8" cy="9" r="1" fill="currentColor" stroke="none" />
              <circle cx="8" cy="12" r="1" fill="currentColor" stroke="none" />
              <circle cx="8" cy="15" r="1" fill="currentColor" stroke="none" />
              <line x1="12" y1="9" x2="17" y2="9" />
              <line x1="12" y1="12" x2="17" y2="12" />
              <line x1="12" y1="15" x2="17" y2="15" />
            </svg>
          </span>
          <span>Prezzi</span>
        </a>
        <div class="mobile-nav-separator"></div>
        <button class="mobile-nav-link" onclick="toggleTheme()">
          <span class="mobile-nav-icon">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
              width="20"
              height="20"
            >
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </span>
          <span>Tema</span>
        </button>
      </nav>
    </div>

    <div class="step-nav-sticky" aria-label="Navigazione rapida step">
      <div class="step-nav-container">
        <button
          type="button"
          class="step-nav-button active"
          data-step-target="1"
          onclick="handleStepNavClick(1)"
          draggable="true"
          ondragstart="handleStepDragStart(event)"
          ondragend="handleStepDragEnd(event)"
          ondragenter="handleStepDragEnter(event)"
          ondragover="handleStepDragOver(event)"
          ondragleave="handleStepDragLeave(event)"
          ondrop="handleStepDrop(event)"
        >
          <span class="step-nav-index">1</span>
          <span>Linea</span>
        </button>
        <button
          type="button"
          class="step-nav-button"
          data-step-target="2"
          onclick="handleStepNavClick(2)"
          draggable="true"
          ondragstart="handleStepDragStart(event)"
          ondragend="handleStepDragEnd(event)"
          ondragenter="handleStepDragEnter(event)"
          ondragover="handleStepDragOver(event)"
          ondragleave="handleStepDragLeave(event)"
          ondrop="handleStepDrop(event)"
        >
          <span class="step-nav-index">2</span>
          <span>Percorso</span>
        </button>
        <button
          type="button"
          class="step-nav-button"
          data-step-target="3"
          onclick="handleStepNavClick(3)"
          draggable="true"
          ondragstart="handleStepDragStart(event)"
          ondragend="handleStepDragEnd(event)"
          ondragenter="handleStepDragEnter(event)"
          ondragover="handleStepDragOver(event)"
          ondragleave="handleStepDragLeave(event)"
          ondrop="handleStepDrop(event)"
        >
          <span class="step-nav-index">3</span>
          <span>Codice</span>
        </button>
      </div>
    </div>

    <div class="container">
      <div class="main-card">
        <!-- Desktop Tabs Navigation -->
        <div class="desktop-step-tabs" aria-label="Navigazione step desktop">
          <button
            type="button"
            class="desktop-tab active"
            data-step-target="1"
            onclick="handleStepNavClick(1)"
          >
            <span class="desktop-tab-number">1</span>
            <div class="desktop-tab-label-wrapper">
              <span class="desktop-tab-label">Linea</span>
              <span
                class="desktop-tab-selected"
                id="selected-linea-tab-indicator"
              ></span>
            </div>
          </button>
          <button
            type="button"
            class="desktop-tab"
            data-step-target="2"
            onclick="handleStepNavClick(2)"
          >
            <span class="desktop-tab-number">2</span>
            <div class="desktop-tab-label-wrapper">
              <span class="desktop-tab-label">Percorso</span>
              <span
                class="desktop-tab-selected"
                id="selected-partenza-tab-indicator"
              ></span>
              <span
                class="desktop-tab-selected"
                id="selected-destinazione-tab-indicator"
              ></span>
            </div>
          </button>
          <button
            type="button"
            class="desktop-tab"
            data-step-target="3"
            onclick="handleStepNavClick(3)"
          >
            <span class="desktop-tab-number">3</span>
            <span class="desktop-tab-label">Codice</span>
          </button>

          <div class="desktop-tabs-actions">
            <button class="desktop-tab-action" onclick="resetRoute()">
              ↺ Cambia percorso
            </button>
            <button class="desktop-tab-action" onclick="resetAll()">
              ⟲ Riparti da capo
            </button>
          </div>
        </div>
        <!-- Step 1: Selezione Linea -->
        <div class="step-content active" data-step="1">
          <h1 class="step-title">Scegli la tua linea</h1>
          <p class="step-subtitle">Seleziona una linea per iniziare</p>

          <button
            class="selection-button"
            id="line-400-button"
            data-linea-id="400"
            data-linea-nome="Linea 400 Udine-Grado"
          >
            <div class="line-icon-badge">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="0.8"
                stroke-linecap="round"
                stroke-linejoin="round"
                width="24"
                height="24"
              >
                <rect x="6" y="5" width="12" height="14" rx="2" />
                <line x1="6" y1="9" x2="18" y2="9" />
                <line x1="6" y1="14" x2="18" y2="14" />
                <line x1="8" y1="17" x2="9" y2="17" />
                <line x1="15" y1="17" x2="16" y2="17" />
                <path d="M6 8c-2 0 -3 1 -3 3v2" />
                <path d="M18 8c2 0 3 1 3 3v2" />
                <path d="M8 19v1a1.5 1.5 0 0 0 3 0v-1" />
                <path d="M13 19v1a1.5 1.5 0 0 0 3 0v-1" />
              </svg>
              <span class="line-number">400</span>
            </div>
            <div class="line-info">
              <span class="line-name">Udine-Grado</span>
              <span class="line-stops-badge">
                <span class="stops-count">42 fermate</span>
              </span>
            </div>
            <span class="arrow">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                width="20"
                height="20"
              >
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
              </svg>
            </span>
          </button>

          <button
            class="selection-button"
            onclick="selectLinea('401', 'Linea 401 Udine-San Daniele', event)"
          >
            <div class="line-icon-badge">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="0.8"
                stroke-linecap="round"
                stroke-linejoin="round"
                width="24"
                height="24"
              >
                <rect x="6" y="5" width="12" height="14" rx="2" />
                <line x1="6" y1="9" x2="18" y2="9" />
                <line x1="6" y1="14" x2="18" y2="14" />
                <line x1="8" y1="17" x2="9" y2="17" />
                <line x1="15" y1="17" x2="16" y2="17" />
                <path d="M6 8c-2 0 -3 1 -3 3v2" />
                <path d="M18 8c2 0 3 1 3 3v2" />
                <path d="M8 19v1a1.5 1.5 0 0 0 3 0v-1" />
                <path d="M13 19v1a1.5 1.5 0 0 0 3 0v-1" />
              </svg>
              <span class="line-number">401</span>
            </div>
            <div class="line-info">
              <span class="line-name">Udine-San Daniele</span>
              <span class="line-stops-badge">
                <span class="stops-count">31 fermate</span>
              </span>
            </div>
            <span class="arrow">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                width="20"
                height="20"
              >
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
              </svg>
            </span>
          </button>
        </div>

        <!-- Step 2: Selezione Partenza e Destinazione -->
        <div class="step-content" data-step="2">
          <h1 class="step-title">Dove vorresti andare?</h1>
          <p class="step-subtitle">
            Completa il percorso principale selezionando partenza e
            destinazione: otterrai il codice e il prezzo da mostrare
          </p>
          <div class="route-section">
            <div class="route-item">
              <div class="route-label">Partenza</div>
              <div class="route-button-container">
                <button
                  class="selection-button"
                  onclick="openFermateModal('partenza')"
                >
                  <span id="partenza-text">Seleziona partenza</span>
                  <span class="arrow">
                    <svg
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      width="20"
                      height="20"
                    >
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                      <polyline points="12 5 19 12 12 19"></polyline>
                    </svg>
                  </span>
                </button>
                <button
                  class="route-action-button route-action-button--geo"
                  onclick="useMyLocation()"
                  id="geolocation-btn"
                  title="Usa la mia posizione"
                  aria-label="Usa la mia posizione per selezionare la partenza"
                >
                  <span class="route-action-button__icon geolocation-icon">
                    <svg
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="0.8"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      width="18"
                      height="18"
                    >
                      <path
                        d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                      ></path>
                      <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                  </span>
                </button>
              </div>
            </div>

            <div class="route-item">
              <div class="route-label">Destinazione</div>
              <div class="route-button-container">
                <button
                  class="selection-button"
                  onclick="openFermateModal('destinazione')"
                >
                  <span id="destinazione-text">Seleziona destinazione</span>
                  <span class="arrow">
                    <svg
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      width="20"
                      height="20"
                    >
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                      <polyline points="12 5 19 12 12 19"></polyline>
                    </svg>
                  </span>
                </button>
              </div>
            </div>
          </div>

          <div
            class="route-ready-banner"
            id="route-ready-banner"
            aria-live="polite"
          >
            <div class="route-ready-header">
              <div class="route-ready-icon">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  width="20"
                  height="20"
                  aria-hidden="true"
                >
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>
              <div>
                <p class="route-ready-title">Percorso pronto</p>
                <p class="route-ready-summary" id="route-ready-summary">
                  Seleziona partenza e destinazione per continuare
                </p>
              </div>
            </div>
            <div class="route-ready-actions">
              <button
                type="button"
                class="route-ready-continue"
                onclick="proceedToTicketStep()"
                id="route-ready-continue"
                disabled
              >
                Vai allo step 3
              </button>
            </div>
          </div>
        </div>

        <!-- Step 3: Card Prezzo con Partenza e Destinazione -->
        <div class="step-content" data-step="3">
          <h1 class="step-title">Il tuo biglietto</h1>
          <p class="step-subtitle">Ecco il tuo percorso e il prezzo</p>

          <div class="price-card">
            <div class="price-card-content">
              <!-- Logo a sinistra -->
              <div class="price-card-logo-section">
                <div class="price-card-logo-wrapper">
                  <img
                    src="../src/tpl.jpg"
                    alt="TPL FVG"
                    class="price-card-logo-icon"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                  />
                  <div class="price-card-logo-fallback" style="display: none">
                    <svg
                      width="80"
                      height="80"
                      viewBox="0 0 80 80"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <circle
                        cx="40"
                        cy="40"
                        r="35"
                        stroke="white"
                        stroke-width="3"
                        fill="none"
                      />
                      <path
                        d="M25 40 L35 50 L55 30"
                        stroke="white"
                        stroke-width="3"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </div>
                </div>
                <div class="price-card-brand price-card-brand-mobile">
                  <div class="price-card-acronym">
                    <span class="price-card-line">tpl</span>
                    <span class="price-card-line">fvg</span>
                  </div>
                  <div class="price-card-text">
                    <span class="price-card-text-line">trasporto</span>
                    <span class="price-card-text-line">pubblico</span>
                    <span class="price-card-text-line">locale</span>
                  </div>
                </div>
              </div>

              <!-- Contenuto a destra -->
              <div class="price-card-info-section">
                <div class="price-card-brand price-card-brand-desktop">
                  <div class="price-card-acronym">
                    <span class="price-card-line">tpl</span>
                    <span class="price-card-line">fvg</span>
                  </div>
                  <div class="price-card-text">
                    <span class="price-card-text-line">trasporto</span>
                    <span class="price-card-text-line">pubblico</span>
                    <span class="price-card-text-line">locale</span>
                  </div>
                </div>

                <div class="price-card-details">
                  <div class="price-route-info">
                    <div class="price-route-item">
                      <div class="price-route-label">Partenza</div>
                      <div class="price-route-value" id="price-partenza">-</div>
                    </div>
                    <div class="price-route-arrow">
                      <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        width="20"
                        height="20"
                      >
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                      </svg>
                    </div>
                    <div class="price-route-item">
                      <div class="price-route-label">Destinazione</div>
                      <div class="price-route-value" id="price-destinazione">
                        -
                      </div>
                    </div>
                  </div>

                  <div class="price-info">
                    <div class="price-section">
                      <div class="price-label">Codice</div>
                      <div class="code-value" id="codice-value">-</div>
                    </div>
                    <div class="price-section">
                      <div class="price-label">Prezzo</div>
                      <div class="price-value" id="prezzo-value">-</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="ticket-actions" aria-label="Azioni percorso">
            <button
              type="button"
              class="ticket-action-button ticket-action-button--swap"
              onclick="swapRoute()"
              id="swap-btn"
              title="Inverti partenza e destinazione"
              aria-label="Inverti partenza e destinazione"
              disabled
            >
              <span class="ticket-action-icon">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  width="20"
                  height="20"
                  aria-hidden="true"
                >
                  <path d="M3 8h13l-3-3"></path>
                  <path d="M21 16H8l3 3"></path>
                  <polyline points="7 12 3 8 7 4"></polyline>
                  <polyline points="17 12 21 16 17 20"></polyline>
                </svg>
              </span>
              <span class="ticket-action-label">Inverti fermate</span>
            </button>
            <button
              type="button"
              class="ticket-action-button ticket-action-button--edit"
              onclick="goToStep(2)"
              title="Modifica partenza o destinazione"
              aria-label="Torna allo step 2 per modificare le fermate"
            >
              <span class="ticket-action-icon">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  width="18"
                  height="18"
                  aria-hidden="true"
                >
                  <path
                    d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"
                  ></path>
                  <path d="M14.06 4.94l3.75 3.75"></path>
                </svg>
              </span>
              <span class="ticket-action-label">Modifica percorso</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Banner installazione PWA -->
      <div
        id="pwa-install-banner"
        class="pwa-install-banner"
        style="display: none"
      >
        <div class="pwa-install-content">
          <div class="pwa-install-text">
            <span class="pwa-install-title">📱 Installa l'app</span>
            <span class="pwa-install-subtitle"
              >Accedi più velocemente e offline</span
            >
          </div>
          <div class="pwa-install-actions">
            <button
              id="pwa-install-later"
              class="pwa-btn pwa-btn-secondary"
              type="button"
            >
              Più tardi
            </button>
            <button
              id="pwa-install-button"
              class="pwa-btn pwa-btn-primary"
              type="button"
            >
              Installa
            </button>
          </div>
        </div>
        <div id="pwa-ios-hint" class="pwa-ios-hint" style="display: none">
          <div class="ios-hint-title">📲 Come installare su iPhone/iPad:</div>
          <ol class="ios-hint-steps">
            <li>
              <span class="step-number">1.</span> Tocca il pulsante
              <strong>Condividi</strong>
              <span class="ios-share-icon">📤</span> in basso (Safari)
            </li>
            <li>
              <span class="step-number">2.</span> Scorri e seleziona
              <strong>"Aggiungi a Home"</strong>
              <span class="ios-plus-icon">➕</span>
            </li>
            <li>
              <span class="step-number">3.</span> Tocca
              <strong>"Aggiungi"</strong> in alto a destra ✅
            </li>
          </ol>
          <div class="ios-hint-note">
            💡 L'app apparirà sulla tua schermata Home come un'app nativa
          </div>
        </div>
        <div
          id="pwa-android-hint"
          class="pwa-android-hint"
          style="display: none"
        >
          <div class="android-hint-title">🤖 Come installare su Android:</div>
          <ol class="android-hint-steps">
            <li>
              <span class="step-number">1.</span> Tocca il pulsante
              <strong>"Installa"</strong> sopra
            </li>
            <li>
              <span class="step-number">2.</span> Conferma l'installazione nel
              popup
              <span class="android-check-icon">✓</span>
            </li>
            <li>
              <span class="step-number">3.</span> L'app apparirà nella schermata
              Home
              <span class="android-home-icon">🏠</span>
            </li>
          </ol>
          <div class="android-hint-note">
            💡 L'app funzionerà anche offline dopo l'installazione
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      class="toast-container"
      id="toast-container"
      aria-live="polite"
      aria-atomic="true"
    ></div>

    <!-- Modal Selezione Fermate -->
    <div
      class="fermate-modal-overlay"
      id="fermate-modal-overlay"
      onclick="closeFermateModal()"
    ></div>
    <div
      class="fermate-modal"
      id="fermate-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="fermate-modal-title"
    >
      <div class="fermate-modal-header">
        <div class="fermate-modal-handle"></div>
        <div class="fermate-modal-header-row">
          <h2 class="fermate-modal-title" id="fermate-modal-title">
            Seleziona
          </h2>
          <div class="fermate-modal-header-actions">
            <button
              class="fermate-modal-close"
              onclick="closeFermateModal()"
              aria-label="Chiudi"
            >
              ×
            </button>
          </div>
        </div>
      </div>
      <div class="fermate-modal-content" id="fermate-modal-content">
        <!-- Popolato dinamicamente -->
      </div>
    </div>

    <script>
      let currentStep = 1;
      let selectedLinea = null;
      let selectedPartenza = null;
      let selectedDestinazione = null;
      let currentModalType = null;

      // Ripple Effect Function
      function createRipple(event) {
        const button = event.currentTarget;
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = event.clientX - rect.left - size / 2;
        const y = event.clientY - rect.top - size / 2;

        const ripple = document.createElement("span");
        ripple.className = "ripple";
        ripple.style.width = ripple.style.height = size + "px";
        ripple.style.left = x + "px";
        ripple.style.top = y + "px";

        button.appendChild(ripple);

        setTimeout(() => {
          ripple.remove();
        }, 600);
      }

      // Aggiungi ripple effect a tutti i pulsanti interattivi
      document.addEventListener("DOMContentLoaded", () => {
        const buttons = document.querySelectorAll(
          ".selection-button, .geolocation-button-small, .swap-button-small, .reset-button"
        );
        buttons.forEach((button) => {
          button.addEventListener("click", createRipple);
        });

        // Aggiungi anche ai pulsanti che vengono creati dinamicamente
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === 1) {
                // Element node
                const newButtons = node.querySelectorAll?.(
                  ".selection-button, .geolocation-button-small, .swap-button-small, .reset-button"
                );
                newButtons?.forEach((button) => {
                  button.addEventListener("click", createRipple);
                });
              }
            });
          });
        });

        observer.observe(document.body, {
          childList: true,
          subtree: true,
        });
      });

      // Sistema Toast Notifications
      function showToast(message, type = "info", duration = 3000) {
        const container = document.getElementById("toast-container");
        if (!container) return;

        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.setAttribute("role", type === "error" ? "alert" : "status");

        const icons = {
          success: "✓",
          error: "✕",
          info: "ℹ",
        };

        toast.innerHTML = `
          <span class="toast-icon">${icons[type] || icons.info}</span>
          <span class="toast-message">${message}</span>
        `;

        container.appendChild(toast);

        // Rimuovi dopo la durata
        setTimeout(() => {
          toast.classList.add("slide-out");
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 200);
        }, duration);
      }

      // Modal Selezione Fermate
      function openFermateModal(type) {
        // Previeni doppi click
        if (currentModalType === type) {
          return;
        }

        currentModalType = type;
        const modal = document.getElementById("fermate-modal");
        const overlay = document.getElementById("fermate-modal-overlay");
        const title = document.getElementById("fermate-modal-title");
        const content = document.getElementById("fermate-modal-content");

        if (!modal || !overlay || !content) {
          console.error("Elementi modale non trovati");
          return;
        }

        const fermate = [
          "Udine",
          "Palmanova",
          "Cervignano FS",
          "Grado",
          "Aquileia",
          "Monfalcone",
        ];

        title.textContent = `Seleziona ${
          type === "partenza" ? "partenza" : "destinazione"
        }`;

        // Pulisci contenuto
        content.innerHTML = "";

        // Aggiungi pulsante rilevamento posizione
        const geolocationButton = document.createElement("button");
        geolocationButton.className = "fermate-modal-geolocation-large";
        geolocationButton.id = "fermate-modal-geolocation-btn";
        geolocationButton.setAttribute("aria-label", "Rileva distanze");
        geolocationButton.setAttribute("title", "Rileva distanze");
        geolocationButton.onclick = detectDistances;
        geolocationButton.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" aria-hidden="true">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          <span>Rileva distanze</span>
        `;
        content.appendChild(geolocationButton);

        // Aggiungi items
        fermate.forEach((fermata, index) => {
          const item = document.createElement("div");
          item.className = "fermate-modal-item";
          item.setAttribute("role", "button");
          item.setAttribute("tabindex", "0");
          item.setAttribute("aria-label", `Seleziona ${fermata}`);

          const isSelected =
            (type === "partenza" && selectedPartenza === fermata) ||
            (type === "destinazione" && selectedDestinazione === fermata);

          if (isSelected) {
            item.classList.add("selected");
          }

          item.innerHTML = `
            <span class="fermate-modal-item-name">${fermata}</span>
            <span class="fermate-modal-item-check">✓</span>
          `;

          item.onclick = () => selectFermata(fermata);
          item.onkeydown = (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              selectFermata(fermata);
            }
          };

          content.appendChild(item);
        });

        // Mostra modal
        overlay.classList.add("active");
        modal.classList.add("active");
        document.body.style.overflow = "hidden";

        // Inizializza drag per mobile/PWA
        setTimeout(() => {
          initModalDrag();
        }, 100);

        // Focus sul primo elemento
        setTimeout(() => {
          const firstItem = content.querySelector(".fermate-modal-item");
          if (firstItem) firstItem.focus();
        }, 100);
      }

      function closeFermateModal() {
        const modal = document.getElementById("fermate-modal");
        const overlay = document.getElementById("fermate-modal-overlay");

        if (modal && overlay) {
          // Rimuovi le classi active per avviare l'animazione di chiusura
          modal.classList.remove("active");
          overlay.classList.remove("active");

          // Ripristina overflow dopo l'animazione
          setTimeout(() => {
            document.body.style.overflow = "";
            currentModalType = null;
          }, 300); // Tempo dell'animazione CSS
        }
      }

      // Drag/Swipe per chiudere il bottom sheet (solo mobile/PWA)
      let dragStartY = 0;
      let dragCurrentY = 0;
      let isDragging = false;
      let modalInitialTransform = 0;

      function initModalDrag() {
        const modal = document.getElementById("fermate-modal");
        if (!modal) return;

        // Solo su mobile/PWA (non desktop/tablet)
        const isMobile =
          window.innerWidth < 768 ||
          (window.matchMedia &&
            window.matchMedia("(display-mode: standalone)").matches);

        if (!isMobile) return;

        modal.addEventListener("touchstart", handleTouchStart, {
          passive: true,
        });
        modal.addEventListener("touchmove", handleTouchMove, {
          passive: false,
        });
        modal.addEventListener("touchend", handleTouchEnd, { passive: true });
      }

      function handleTouchStart(e) {
        const modal = document.getElementById("fermate-modal");
        if (!modal || !modal.classList.contains("active")) return;

        dragStartY = e.touches[0].clientY;
        isDragging = false;
        modalInitialTransform = 0;
        modal.style.transition = "none";
      }

      function handleTouchMove(e) {
        const modal = document.getElementById("fermate-modal");
        if (!modal || !modal.classList.contains("active")) return;

        dragCurrentY = e.touches[0].clientY;
        const deltaY = dragCurrentY - dragStartY;

        // Solo permettere drag verso il basso
        if (deltaY > 0) {
          isDragging = true;
          e.preventDefault();

          // Applica la trasformazione in tempo reale
          const translateY = Math.max(0, deltaY);
          modal.style.transform = `translateY(${translateY}px)`;

          // Opacità dell'overlay basata sulla distanza
          const overlay = document.getElementById("fermate-modal-overlay");
          if (overlay) {
            const opacity = Math.max(0, 1 - deltaY / 300);
            overlay.style.opacity = opacity;
          }
        }
      }

      function handleTouchEnd(e) {
        const modal = document.getElementById("fermate-modal");
        if (!modal || !modal.classList.contains("active")) return;

        modal.style.transition = "transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)";

        const deltaY = dragCurrentY - dragStartY;
        const threshold = 100; // Soglia per chiudere (px)

        if (isDragging && deltaY > threshold) {
          // Chiudi il modale
          closeFermateModal();
        } else {
          // Ripristina la posizione
          modal.style.transform = "";
          const overlay = document.getElementById("fermate-modal-overlay");
          if (overlay) {
            overlay.style.opacity = "";
          }
        }

        isDragging = false;
        dragStartY = 0;
        dragCurrentY = 0;
      }

      // Chiudi modale quando si clicca sull'overlay
      document.addEventListener("DOMContentLoaded", () => {
        const overlay = document.getElementById("fermate-modal-overlay");
        const modal = document.getElementById("fermate-modal");

        if (overlay && modal) {
          overlay.addEventListener("click", (e) => {
            // Chiudi solo se si clicca direttamente sull'overlay, non sul modale
            if (e.target === overlay) {
              closeFermateModal();
            }
          });

          // Inizializza drag al caricamento
          initModalDrag();

          // Chiudi modale con ESC
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && modal.classList.contains("active")) {
              closeFermateModal();
            }
          });
        }
      });

      function selectFermata(fermata) {
        if (!currentModalType) return;

        // Trova l'item selezionato e aggiungi animazione
        const items = document.querySelectorAll(".fermate-modal-item");
        items.forEach((item) => {
          const itemName = item.querySelector(
            ".fermate-modal-item-name"
          )?.textContent;
          if (itemName === fermata) {
            // Rimuovi selected da tutti
            items.forEach((i) => i.classList.remove("selected"));
            // Aggiungi animazione
            item.classList.add("selecting");
            item.classList.add("selected");

            // Rimuovi classe animazione dopo l'animazione
            setTimeout(() => {
              item.classList.remove("selecting");
            }, 400);
          }
        });

        if (currentModalType === "partenza") {
          selectedPartenza = fermata;
          const partenzaBtn = document.querySelector(
            "[onclick*=\"openFermateModal('partenza')\"]"
          );
          if (partenzaBtn) {
            partenzaBtn.classList.add("selected");
            partenzaBtn.classList.add("has-selection");
            setTimeout(() => partenzaBtn.classList.remove("selected"), 600);
          }
          const partenzaText = document.getElementById("partenza-text");
          if (partenzaText) {
            partenzaText.textContent = fermata;
          }
          showToast(`Partenza impostata: ${fermata}`, "success");
        } else {
          selectedDestinazione = fermata;
          const destinazioneBtn = document.querySelector(
            "[onclick*=\"openFermateModal('destinazione')\"]"
          );
          if (destinazioneBtn) {
            destinazioneBtn.classList.add("selected");
            destinazioneBtn.classList.add("has-selection");
            setTimeout(() => destinazioneBtn.classList.remove("selected"), 600);
          }
          const destinazioneText = document.getElementById("destinazione-text");
          if (destinazioneText) {
            destinazioneText.textContent = fermata;
          }
          showToast(`Destinazione impostata: ${fermata}`, "success");
        }

        // Aggiorna stato pulsanti
        updateButtonStates();
        updateSelectedInfoSummary();

        updateRouteReadyBanner();

        // Chiudi modal dopo un breve delay per mostrare l'animazione
        setTimeout(() => {
          closeFermateModal();
        }, 200);

        if (selectedPartenza && selectedDestinazione) {
          showToast(
            "Percorso pronto! Puoi invertire o andare allo step 3.",
            "success"
          );
        }
      }

      // Gestione chiusura modal con ESC
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeFermateModal();
        }
      });

      function handleStepNavClick(step) {
        if (step === currentStep) {
          return;
        }

        if (!canNavigateToStep(step)) {
          return;
        }

        goToStep(step);
      }

      function canNavigateToStep(step) {
        if (step === 2 && !selectedLinea) {
          showToast("Seleziona prima una linea per continuare.", "info");
          return false;
        }

        if (step === 3 && (!selectedPartenza || !selectedDestinazione)) {
          showToast(
            "Imposta partenza e destinazione per visualizzare il codice.",
            "info"
          );
          return false;
        }

        return true;
      }

      let draggingStep = null;

      function handleStepDragStart(event) {
        const button = event.currentTarget;
        draggingStep = Number(button.dataset.stepTarget);

        if (draggingStep !== currentStep) {
          event.preventDefault();
          draggingStep = null;
          return;
        }

        button.classList.add("drag-source");
        event.dataTransfer.effectAllowed = "move";
        event.dataTransfer.setData("text/plain", String(draggingStep));
      }

      function handleStepDragEnd(event) {
        const button = event.currentTarget;
        button.classList.remove("drag-source");
        document
          .querySelectorAll(".step-nav-button")
          .forEach((btn) => btn.classList.remove("drop-target"));
        draggingStep = null;
      }

      function handleStepDragOver(event) {
        if (!draggingStep) {
          return;
        }

        event.preventDefault();
        const target = Number(event.currentTarget.dataset.stepTarget);
        if (target === draggingStep) {
          return;
        }

        event.currentTarget.classList.add("drop-target");
      }

      function handleStepDragEnter(event) {
        if (!draggingStep) {
          return;
        }
        const target = Number(event.currentTarget.dataset.stepTarget);
        if (target !== draggingStep) {
          event.currentTarget.classList.add("drop-target");
        }
      }

      function handleStepDragLeave(event) {
        event.currentTarget.classList.remove("drop-target");
      }

      function handleStepDrop(event) {
        event.preventDefault();
        const targetBtn = event.currentTarget;
        targetBtn.classList.remove("drop-target");

        if (!draggingStep) {
          return;
        }

        const targetStep = Number(targetBtn.dataset.stepTarget);
        if (targetStep === draggingStep || targetStep === currentStep) {
          return;
        }

        if (!canNavigateToStep(targetStep)) {
          return;
        }

        goToStep(targetStep);
      }

      function updateStepIndicator(step) {
        updateStepNav(step);
        updateSelectedLineaIndicator();
      }

      function updateSelectedLineaIndicator() {
        // Indicatore nel tab
        const tabIndicator = document.getElementById(
          "selected-linea-tab-indicator"
        );

        if (selectedLinea && tabIndicator) {
          // Estrai solo la parte dopo "Linea XXX " (es. "Udine-Grado" da "Linea 400 Udine-Grado")
          const nome = selectedLinea.nome;
          const match = nome.match(/Linea \d+\s+(.+)/);
          const displayText = match ? match[1] : nome;
          tabIndicator.textContent = displayText;
          tabIndicator.style.display = "block";
        } else if (tabIndicator) {
          tabIndicator.textContent = "";
          tabIndicator.style.display = "none";
        }

        // Aggiorna anche il riepilogo
        updateSelectedInfoSummary();
      }

      function updateSelectedInfoSummary() {
        // Indicatori nel tab laterale
        const partenzaTabIndicator = document.getElementById(
          "selected-partenza-tab-indicator"
        );
        const destinazioneTabIndicator = document.getElementById(
          "selected-destinazione-tab-indicator"
        );

        // Aggiorna indicatori nel tab
        if (selectedPartenza && partenzaTabIndicator) {
          partenzaTabIndicator.textContent = selectedPartenza;
          partenzaTabIndicator.style.display = "block";
        } else if (partenzaTabIndicator) {
          partenzaTabIndicator.textContent = "";
          partenzaTabIndicator.style.display = "none";
        }

        if (selectedDestinazione && destinazioneTabIndicator) {
          destinazioneTabIndicator.textContent = selectedDestinazione;
          destinazioneTabIndicator.style.display = "block";
        } else if (destinazioneTabIndicator) {
          destinazioneTabIndicator.textContent = "";
          destinazioneTabIndicator.style.display = "none";
        }
      }

      function updateStepNav(step) {
        // Aggiorna pulsanti mobile (progress bar)
        const buttons = document.querySelectorAll(".step-nav-button");
        buttons.forEach((btn) => {
          const target = Number(btn.dataset.stepTarget);
          if (target === step) {
            btn.classList.add("active");
            btn.setAttribute("aria-current", "step");
            btn.classList.remove("completed");
          } else {
            btn.classList.remove("active");
            btn.removeAttribute("aria-current");

            // Aggiungi indicatore completato per step precedenti
            if (target < step) {
              btn.classList.add("completed");
            } else {
              btn.classList.remove("completed");
            }
          }
        });

        // Aggiorna tab desktop
        const desktopTabs = document.querySelectorAll(".desktop-tab");
        desktopTabs.forEach((tab) => {
          const target = Number(tab.dataset.stepTarget);
          if (target === step) {
            tab.classList.add("active");
            tab.setAttribute("aria-current", "step");
          } else {
            tab.classList.remove("active");
            tab.removeAttribute("aria-current");
          }
        });

        // Mostra/nascondi pulsanti azione in base allo step (solo da step 2 in poi)
        const desktopTabsActions = document.querySelector(
          ".desktop-tabs-actions"
        );
        if (desktopTabsActions) {
          if (step >= 2) {
            desktopTabsActions.classList.add("show");
          } else {
            desktopTabsActions.classList.remove("show");
          }
        }
      }

      // Aggiorna stati dei pulsanti (disabled/enabled)
      function updateButtonStates() {
        const swapBtn = document.getElementById("swap-btn");
        if (swapBtn) {
          if (selectedPartenza && selectedDestinazione) {
            swapBtn.disabled = false;
            swapBtn.setAttribute(
              "aria-label",
              "Inverti partenza e destinazione"
            );
          } else {
            swapBtn.disabled = true;
            swapBtn.setAttribute(
              "aria-label",
              "Seleziona partenza e destinazione per invertire"
            );
          }
        }

        updateRouteReadyBanner();
      }

      function updateRouteReadyBanner() {
        const banner = document.getElementById("route-ready-banner");
        const summary = document.getElementById("route-ready-summary");
        const continueBtn = document.getElementById("route-ready-continue");
        const isReady = Boolean(selectedPartenza && selectedDestinazione);

        if (!banner) return;

        if (isReady && currentStep === 2) {
          banner.classList.add("active");
          if (summary) {
            summary.textContent = `${selectedPartenza} → ${selectedDestinazione}`;
          }
          if (continueBtn) {
            continueBtn.disabled = false;
          }
        } else {
          banner.classList.remove("active");
          if (continueBtn) {
            continueBtn.disabled = true;
          }
        }
      }

      function goToStep(step) {
        console.log("goToStep chiamata:", { from: currentStep, to: step });

        // Verifica che lo step esista PRIMA di fare qualsiasi modifica
        const newStep = document.querySelector(
          `.step-content[data-step="${step}"]`
        );
        if (!newStep) {
          console.error(`Step ${step} non trovato nel DOM`);
          return;
        }

        // Nascondi step corrente
        const currentStepEl = document.querySelector(
          `.step-content[data-step="${currentStep}"]`
        );
        if (currentStepEl) {
          currentStepEl.classList.remove("active");
          console.log("Step corrente nascosto:", currentStep);
        }

        // Aggiorna currentStep solo se tutto è OK
        currentStep = step;

        // Mostra nuovo step
        newStep.classList.add("active");
        console.log("Nuovo step mostrato:", step);

        // Aggiorna indicator
        updateStepIndicator(step);

        // Aggiorna navigazione step (include visibilità pulsanti)
        updateStepNav(step);
        updateRouteReadyBanner();

        // Animazione
        newStep.style.animation = "none";
        setTimeout(() => {
          newStep.style.animation =
            "fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1)";
        }, 10);
      }

      function selectLinea(id, nome, event) {
        // Preveni il default e ferma la propagazione
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        selectedLinea = { id, nome };
        console.log("Linea selezionata:", nome);
        showToast(`Linea selezionata: ${nome}`, "success");

        // Aggiorna indicatore linea selezionata
        updateSelectedLineaIndicator();
        // Aggiorna riepilogo selezioni
        updateSelectedInfoSummary();

        // Trova il pulsante - cerca il button anche se l'evento proviene da un elemento interno
        let button = null;
        if (event) {
          button = event.currentTarget || event.target;
          // Se l'elemento cliccato non è il button, cerca il button padre
          if (button && !button.classList.contains("selection-button")) {
            button = button.closest(".selection-button");
          }
        }

        if (button) {
          button.style.transform = "scale(0.95)";
          setTimeout(() => {
            button.style.transform = "";
            goToStep(2);
            updateButtonStates();
          }, 200);
        } else {
          goToStep(2);
          updateButtonStates();
        }
      }

      function detectDistances() {
        const btn = document.getElementById("fermate-modal-geolocation-btn");
        if (!btn) return;

        // Aggiungi la classe loading PRIMA di disabilitare per evitare il flash
        btn.classList.add("loading");
        // Usa requestAnimationFrame per assicurare che l'animazione parta subito
        requestAnimationFrame(() => {
          btn.disabled = true;
        });

        if (!navigator.geolocation) {
          showToast(
            "La geolocalizzazione non è supportata dal tuo browser.",
            "error"
          );
          btn.disabled = false;
          btn.classList.remove("loading");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // Coordinate delle fermate (simulate)
            const fermate = [
              { nome: "Udine", lat: 46.07, lng: 13.24 },
              { nome: "Palmanova", lat: 45.906, lng: 13.31 },
              { nome: "Cervignano FS", lat: 45.82, lng: 13.33 },
              { nome: "Grado", lat: 45.68, lng: 13.4 },
              { nome: "Aquileia", lat: 45.77, lng: 13.37 },
              { nome: "Monfalcone", lat: 45.8, lng: 13.53 },
            ];

            // Calcola distanze e aggiorna gli item nel modale
            const items = document.querySelectorAll(".fermate-modal-item");
            items.forEach((item) => {
              const itemName = item.querySelector(
                ".fermate-modal-item-name"
              )?.textContent;
              const fermata = fermate.find((f) => f.nome === itemName);

              if (fermata) {
                // Formula Haversine semplificata per calcolare distanza in km
                const R = 6371; // Raggio della Terra in km
                const dLat = ((fermata.lat - lat) * Math.PI) / 180;
                const dLng = ((fermata.lng - lng) * Math.PI) / 180;
                const a =
                  Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos((lat * Math.PI) / 180) *
                    Math.cos((fermata.lat * Math.PI) / 180) *
                    Math.sin(dLng / 2) *
                    Math.sin(dLng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const distance = R * c;

                // Aggiungi o aggiorna l'indicatore di distanza
                let distanceBadge = item.querySelector(
                  ".fermate-modal-item-distance"
                );
                if (!distanceBadge) {
                  distanceBadge = document.createElement("span");
                  distanceBadge.className = "fermate-modal-item-distance";
                  item.appendChild(distanceBadge);
                }

                if (distance < 1) {
                  distanceBadge.textContent = `${Math.round(distance * 1000)}m`;
                } else {
                  distanceBadge.textContent = `${distance.toFixed(1)}km`;
                }

                // Ordina gli item per distanza (più vicini prima)
                item.dataset.distance = distance;
              }
            });

            // Riordina gli item per distanza (preservando il pulsante geolocation)
            const content = document.getElementById("fermate-modal-content");
            if (content) {
              const geolocationBtn = document.getElementById(
                "fermate-modal-geolocation-btn"
              );
              const sortedItems = Array.from(items).sort((a, b) => {
                const distA = parseFloat(a.dataset.distance) || Infinity;
                const distB = parseFloat(b.dataset.distance) || Infinity;
                return distA - distB;
              });

              // Rimuovi temporaneamente il pulsante se presente
              if (geolocationBtn && geolocationBtn.parentNode === content) {
                content.removeChild(geolocationBtn);
              }

              // Riordina gli item
              sortedItems.forEach((item) => content.appendChild(item));

              // Reinserisci il pulsante all'inizio
              if (geolocationBtn) {
                content.insertBefore(geolocationBtn, content.firstChild);
              }
            }

            showToast("Distanze rilevate", "success");
            btn.disabled = false;
            btn.classList.remove("loading");
          },
          (error) => {
            console.error("Errore geolocalizzazione:", error);
            let errorMessage = "Impossibile ottenere la tua posizione.";
            if (error.code === error.PERMISSION_DENIED) {
              errorMessage = "Permesso di geolocalizzazione negato.";
            } else if (error.code === error.POSITION_UNAVAILABLE) {
              errorMessage = "Posizione non disponibile.";
            } else if (error.code === error.TIMEOUT) {
              errorMessage = "Timeout nella richiesta di posizione.";
            }
            showToast(errorMessage, "error");
            btn.disabled = false;
            btn.classList.remove("loading");
          }
        );
      }

      function useMyLocation() {
        const btn = document.getElementById("geolocation-btn");
        if (!btn) return;

        // Disabilita il pulsante durante il caricamento
        btn.disabled = true;
        btn.classList.add("loading");

        if (!navigator.geolocation) {
          showToast(
            "La geolocalizzazione non è supportata dal tuo browser.",
            "error"
          );
          btn.disabled = false;
          btn.classList.remove("loading");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            console.log("Posizione ottenuta:", lat, lng);

            // Simula la ricerca della fermata più vicina
            // In produzione, qui faremmo una chiamata API per trovare la fermata più vicina
            const fermate = [
              { nome: "Udine", lat: 46.07, lng: 13.24 },
              { nome: "Palmanova", lat: 45.906, lng: 13.31 },
              { nome: "Cervignano FS", lat: 45.82, lng: 13.33 },
              { nome: "Grado", lat: 45.68, lng: 13.4 },
              { nome: "Aquileia", lat: 45.77, lng: 13.37 },
              { nome: "Monfalcone", lat: 45.8, lng: 13.53 },
            ];

            // Calcola la distanza da ogni fermata (formula Haversine semplificata)
            let nearestFermata = null;
            let minDistance = Infinity;

            fermate.forEach((fermata) => {
              const distance = Math.sqrt(
                Math.pow(fermata.lat - lat, 2) + Math.pow(fermata.lng - lng, 2)
              );
              if (distance < minDistance) {
                minDistance = distance;
                nearestFermata = fermata;
              }
            });

            if (nearestFermata) {
              // Imposta la fermata più vicina come partenza
              selectedPartenza = nearestFermata.nome;
              document.getElementById("partenza-text").textContent =
                nearestFermata.nome;

              showToast(
                `Partenza impostata: ${nearestFermata.nome}`,
                "success"
              );
              updateButtonStates();

              // Se anche la destinazione è selezionata, vai allo step 3
              if (selectedPartenza && selectedDestinazione) {
                document.getElementById("price-partenza").textContent =
                  selectedPartenza;
                document.getElementById("price-destinazione").textContent =
                  selectedDestinazione;
                calculatePrice();

                setTimeout(() => {
                  goToStep(3);
                  showToast("Percorso completato!", "success");
                }, 500);
              }
            } else {
              showToast("Nessuna fermata trovata nelle vicinanze", "error");
            }

            btn.disabled = false;
            btn.classList.remove("loading");
          },
          (error) => {
            console.error("Errore geolocalizzazione:", error);
            let errorMessage = "Impossibile ottenere la tua posizione.";

            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMessage = "Permesso di geolocalizzazione negato.";
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = "Posizione non disponibile.";
                break;
              case error.TIMEOUT:
                errorMessage = "Timeout nella richiesta di posizione.";
                break;
            }

            showToast(errorMessage, "error");
            btn.disabled = false;
            btn.classList.remove("loading");
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0,
          }
        );
      }

      function calculatePrice() {
        // Simulazione calcolo prezzo
        const codici = ["A1-B2", "C3-D4", "E5-F6"];
        const prezzi = ["€ 3,50", "€ 4,00", "€ 5,50"];

        const randomCodice = codici[Math.floor(Math.random() * codici.length)];
        const randomPrezzo = prezzi[Math.floor(Math.random() * prezzi.length)];

        const codiceEl = document.getElementById("codice-value");
        const prezzoEl = document.getElementById("prezzo-value");
        const priceCard = document.querySelector(".price-card");

        // Animazione celebrativa
        if (priceCard) {
          priceCard.classList.add("celebrate");
          setTimeout(() => {
            priceCard.classList.remove("celebrate");
          }, 1000);
        }

        // Animazione dei valori quando vengono aggiornati
        if (codiceEl) {
          codiceEl.style.animation = "none";
          setTimeout(() => {
            codiceEl.textContent = randomCodice;
            codiceEl.style.animation =
              "valuePop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)";
          }, 10);
        }

        if (prezzoEl) {
          prezzoEl.style.animation = "none";
          setTimeout(() => {
            prezzoEl.textContent = randomPrezzo;
            prezzoEl.style.animation =
              "valuePop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s";
          }, 10);
        }
      }

      function proceedToTicketStep() {
        if (!(selectedPartenza && selectedDestinazione)) {
          showToast("Prima seleziona partenza e destinazione", "info");
          return;
        }

        document.getElementById("price-partenza").textContent =
          selectedPartenza;
        document.getElementById("price-destinazione").textContent =
          selectedDestinazione;

        calculatePrice();
        showToast("Percorso completato!", "success");
        goToStep(3);
        updateRouteReadyBanner();
      }

      function swapRoute() {
        // Inverte partenza e destinazione solo se entrambe sono selezionate
        if (!selectedPartenza || !selectedDestinazione) {
          showToast("Seleziona partenza e destinazione per invertire", "info");
          return;
        }

        // Scambia i valori
        const temp = selectedPartenza;
        selectedPartenza = selectedDestinazione;
        selectedDestinazione = temp;

        // Aggiorna i testi
        const partenzaText = document.getElementById("partenza-text");
        const destinazioneText = document.getElementById("destinazione-text");

        if (partenzaText) {
          partenzaText.textContent = selectedPartenza;
        }
        if (destinazioneText) {
          destinazioneText.textContent = selectedDestinazione;
        }

        // Aggiorna anche i valori nella card prezzo se siamo nello step 3
        const pricePartenza = document.getElementById("price-partenza");
        const priceDestinazione = document.getElementById("price-destinazione");

        if (pricePartenza) pricePartenza.textContent = selectedPartenza;
        if (priceDestinazione)
          priceDestinazione.textContent = selectedDestinazione;

        // Ricalcola il prezzo
        if (selectedPartenza && selectedDestinazione) {
          calculatePrice();
        }

        showToast("Percorso invertito", "success");
        updateButtonStates();
        updateSelectedInfoSummary();
        updateRouteReadyBanner();
        console.log("Percorso invertito:", {
          partenza: selectedPartenza,
          destinazione: selectedDestinazione,
        });
      }

      function resetRoute() {
        console.log("resetRoute chiamata, currentStep:", currentStep);

        try {
          selectedPartenza = null;
          selectedDestinazione = null;

          const partenzaText = document.getElementById("partenza-text");
          const destinazioneText = document.getElementById("destinazione-text");
          const partenzaBtn = document.querySelector(
            "[onclick*=\"openFermateModal('partenza')\"]"
          );
          const destinazioneBtn = document.querySelector(
            "[onclick*=\"openFermateModal('destinazione')\"]"
          );

          if (partenzaText) {
            partenzaText.textContent = "Seleziona partenza";
          }
          if (destinazioneText) {
            destinazioneText.textContent = "Seleziona destinazione";
          }
          if (partenzaBtn) {
            partenzaBtn.classList.remove("has-selection");
          }
          if (destinazioneBtn) {
            destinazioneBtn.classList.remove("has-selection");
          }

          // Reset valori nella card prezzo
          const pricePartenza = document.getElementById("price-partenza");
          const priceDestinazione =
            document.getElementById("price-destinazione");
          const codiceValue = document.getElementById("codice-value");
          const prezzoValue = document.getElementById("prezzo-value");

          if (pricePartenza) pricePartenza.textContent = "-";
          if (priceDestinazione) priceDestinazione.textContent = "-";
          if (codiceValue) codiceValue.textContent = "-";
          if (prezzoValue) prezzoValue.textContent = "-";

          updateButtonStates();

          // Torna sempre allo step 2 (sia se siamo nello step 2 che nello step 3)
          console.log("Chiamata goToStep(2) da resetRoute");
          goToStep(2);
        } catch (error) {
          console.error("Errore in resetRoute:", error);
        }
      }

      function resetAll() {
        selectedLinea = null;
        updateSelectedLineaIndicator();
        selectedPartenza = null;
        selectedDestinazione = null;
        resetRoute();
        updateButtonStates();
        goToStep(1);
        showToast("Ripartenza da capo", "info");
      }

      function toggleTheme() {
        document.body.classList.toggle("light");
        const theme = document.body.classList.contains("light")
          ? "light"
          : "dark";
        localStorage.setItem("theme", theme);
      }

      function toggleMobileMenu() {
        const overlay = document.getElementById("mobile-menu-overlay");
        const menu = document.getElementById("mobile-menu");
        const hamburger = document.getElementById("hamburger-toggle");

        const isOpen = menu.classList.contains("active");

        if (isOpen) {
          // Chiudi menu - animazione verso il basso
          menu.classList.remove("active");
          menu.classList.add("closing");
          setTimeout(() => {
            menu.classList.remove("closing");
            overlay.classList.remove("active");
          }, 250);
          if (hamburger) {
            hamburger.classList.remove("active");
            hamburger.blur(); // Rimuovi il focus per evitare cambi di colore
          }
        } else {
          // Apri menu - animazione dal basso
          overlay.classList.add("active");
          // Piccolo delay per permettere al overlay di apparire prima
          setTimeout(() => {
            menu.classList.add("active");
            menu.classList.remove("closing");
          }, 10);
          if (hamburger) {
            hamburger.classList.add("active");
            // Rimuovi il focus dopo un breve delay per evitare cambi di colore
            setTimeout(() => {
              hamburger.blur();
            }, 100);
          }
        }
      }

      // Previeni la chiusura quando si clicca sul menu stesso
      const menu = document.getElementById("mobile-menu");
      if (menu) {
        menu.addEventListener("click", (e) => {
          e.stopPropagation();
        });
      }

      // Chiudi menu quando si clicca sull'overlay o fuori
      const overlay = document.getElementById("mobile-menu-overlay");
      if (overlay) {
        overlay.addEventListener("click", (e) => {
          // Chiudi solo se si clicca direttamente sull'overlay (non su elementi figli)
          if (e.target === overlay) {
            toggleMobileMenu();
          }
        });
      }

      // Chiudi menu quando si clicca fuori dal menu e dal pulsante hamburger
      document.addEventListener("click", (e) => {
        const menu = document.getElementById("mobile-menu");
        const hamburger = document.getElementById("hamburger-toggle");

        // Se il menu è aperto e il click non è sul menu o sul pulsante hamburger
        if (
          menu &&
          menu.classList.contains("active") &&
          !menu.contains(e.target) &&
          hamburger &&
          !hamburger.contains(e.target)
        ) {
          // Se non è un click sull'overlay (che ha già il suo handler)
          if (overlay && e.target !== overlay) {
            toggleMobileMenu();
          }
        }
      });

      // Chiudi menu mobile quando si clicca su un link
      document.querySelectorAll(".mobile-nav-link").forEach((link) => {
        link.addEventListener("click", () => {
          setTimeout(() => toggleMobileMenu(), 300);
        });
      });

      // Carica tema salvato
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "light") {
        document.body.classList.add("light");
      }

      // Inizializza
      updateStepIndicator(1);
      updateButtonStates();
    </script>

    <!-- PWA Install Banner Script -->
    <script>
      (function () {
        "use strict";

        let deferredInstallPrompt = null;
        const pwaBanner = document.getElementById("pwa-install-banner");
        const pwaBtnInstall = document.getElementById("pwa-install-button");
        const pwaBtnLater = document.getElementById("pwa-install-later");
        const pwaIosHint = document.getElementById("pwa-ios-hint");
        const pwaAndroidHint = document.getElementById("pwa-android-hint");

        if (!pwaBanner) return;

        // Rileva dispositivo
        const userAgent = window.navigator.userAgent.toLowerCase();
        const isIOS =
          /iphone|ipod|ipad/.test(userAgent) ||
          (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
        const isSafari = /^((?!chrome|android).)*safari/i.test(
          window.navigator.userAgent
        );
        const isMobile = window.innerWidth <= 768;

        // Verifica se già installato
        const isStandalone =
          window.matchMedia("(display-mode: standalone)").matches ||
          window.navigator.standalone ||
          document.referrer.includes("android-app://");

        // Nascondi se già installato o desktop
        if (isStandalone || !isMobile) {
          pwaBanner.style.display = "none";
          return;
        }

        // Gestione beforeinstallprompt (Android/Chrome)
        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();
          deferredInstallPrompt = e;

          // Mostra banner Android
          if (pwaAndroidHint) pwaAndroidHint.style.display = "block";
          if (pwaIosHint) pwaIosHint.style.display = "none";

          showBanner();
        });

        // Pulsante Installa
        if (pwaBtnInstall) {
          pwaBtnInstall.addEventListener("click", async () => {
            if (deferredInstallPrompt) {
              // Android/Chrome: mostra prompt nativo
              deferredInstallPrompt.prompt();
              const { outcome } = await deferredInstallPrompt.userChoice;
              console.log("Installazione:", outcome);
              deferredInstallPrompt = null;
              hideBanner();
            } else if (isIOS && isSafari) {
              // iOS Safari: mostra istruzioni
              if (pwaIosHint) pwaIosHint.style.display = "block";
              if (pwaAndroidHint) pwaAndroidHint.style.display = "none";
            }
          });
        }

        // Pulsante Più tardi
        if (pwaBtnLater) {
          pwaBtnLater.addEventListener("click", () => {
            hideBanner();
            // Salva preferenza (7 giorni)
            const hideUntil = Date.now() + 7 * 24 * 60 * 60 * 1000;
            localStorage.setItem("pwa-banner-hide-until", hideUntil.toString());
          });
        }

        // Verifica se mostrare banner
        function shouldShowBanner() {
          const hideUntil = localStorage.getItem("pwa-banner-hide-until");
          if (hideUntil && Date.now() < parseInt(hideUntil)) {
            return false;
          }
          return true;
        }

        // Mostra banner
        function showBanner() {
          if (!shouldShowBanner()) return;

          pwaBanner.style.display = "block";
          pwaBanner.classList.remove("closing");

          // Se iOS, mostra hint iOS
          if (isIOS && isSafari) {
            if (pwaIosHint) pwaIosHint.style.display = "block";
            if (pwaAndroidHint) pwaAndroidHint.style.display = "none";
          }
        }

        // Nascondi banner
        function hideBanner() {
          pwaBanner.classList.add("closing");
          setTimeout(() => {
            pwaBanner.style.display = "none";
          }, 300);
        }

        // App installata
        window.addEventListener("appinstalled", () => {
          console.log("✅ PWA installata");
          hideBanner();
          deferredInstallPrompt = null;
        });

        // Mostra banner dopo 3 secondi (solo se non installato)
        if (!isStandalone && shouldShowBanner()) {
          setTimeout(() => {
            if (!deferredInstallPrompt && isIOS && isSafari) {
              showBanner();
            }
          }, 3000);
        }
      })();
    </script>

    <script>
      // Aggiunge la classe per triggerare le animazioni dei desktop-tab
      (function () {
        function triggerAnimations() {
          const desktopStepTabs = document.querySelector(".desktop-step-tabs");
          const mainCard = document.querySelector(".main-card");

          if (desktopStepTabs) {
            desktopStepTabs.classList.add("animate-tabs");
          } else if (mainCard) {
            mainCard.classList.add("animate-tabs");
          }
        }

        // Prova quando il DOM è pronto
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", function () {
            setTimeout(triggerAnimations, 100);
          });
        } else {
          setTimeout(triggerAnimations, 100);
        }
      })();
    </script>

    <script>
      // Fix per i pulsanti di selezione linea - assicura che siano completamente cliccabili
      document.addEventListener("DOMContentLoaded", function () {
        // Fix specifico per il primo pulsante (Linea 400) - approccio semplice
        const firstButton = document.getElementById("line-400-button");
        if (firstButton) {
          // Rimuovi qualsiasi onclick esistente
          firstButton.removeAttribute("onclick");

          // Gestisci i click su QUALSIASI elemento del pulsante usando event delegation
          // Aggiungi il listener sul pulsante stesso e lascia che catturi tutti i click interni
          function handleClick(event) {
            // Se il click è sul pulsante o su qualsiasi suo elemento figlio, procedi
            if (
              firstButton.contains(event.target) ||
              event.target === firstButton
            ) {
              event.preventDefault();
              event.stopPropagation();

              if (typeof selectLinea === "function") {
                const id = firstButton.getAttribute("data-linea-id") || "400";
                const nome =
                  firstButton.getAttribute("data-linea-nome") ||
                  "Linea 400 Udine-Grado";
                selectLinea(id, nome, event);
              }
            }
          }

          // Aggiungi listener sia in capture che in bubble phase per massima copertura
          firstButton.addEventListener("click", handleClick, true); // Capture
          firstButton.addEventListener("click", handleClick, false); // Bubble

          // Aggiungi anche un listener sul document come fallback per catturare click nella parte superiore
          document.addEventListener(
            "click",
            function (event) {
              const clickedElement = event.target;
              const rect = firstButton.getBoundingClientRect();
              const clickX = event.clientX;
              const clickY = event.clientY;

              // Se il click è sul pulsante o sui suoi figli
              if (
                firstButton.contains(clickedElement) ||
                clickedElement === firstButton
              ) {
                event.preventDefault();
                event.stopPropagation();

                if (typeof selectLinea === "function") {
                  const id = firstButton.getAttribute("data-linea-id") || "400";
                  const nome =
                    firstButton.getAttribute("data-linea-nome") ||
                    "Linea 400 Udine-Grado";
                  selectLinea(id, nome, event);
                }
              }
              // Se il click è sopra il pulsante (nell'area estesa della parte superiore)
              else if (
                clickX >= rect.left &&
                clickX <= rect.right &&
                clickY < rect.top &&
                clickY > rect.top - 16
              ) {
                event.preventDefault();
                event.stopPropagation();

                if (typeof selectLinea === "function") {
                  const id = firstButton.getAttribute("data-linea-id") || "400";
                  const nome =
                    firstButton.getAttribute("data-linea-nome") ||
                    "Linea 400 Udine-Grado";
                  selectLinea(id, nome, event);
                }
              }
            },
            true
          ); // Capture phase

          console.log(
            "✅ Primo pulsante configurato con handler completo incluso area superiore"
          );
        }

        // Trova tutti gli altri pulsanti di selezione linea
        const selectionButtons = document.querySelectorAll(
          '.step-content[data-step="1"] .selection-button:not(#line-400-button)'
        );

        selectionButtons.forEach(function (button, index) {
          // Estrai i parametri dall'onclick o dagli attributi data
          let id, nome;
          const onclickAttr = button.getAttribute("onclick");
          const dataId = button.getAttribute("data-linea-id");
          const dataNome = button.getAttribute("data-linea-nome");

          if (onclickAttr) {
            const match = onclickAttr.match(
              /selectLinea\(['"]([^'"]+)['"]\s*,\s*['"]([^'"]+)['"]\s*,\s*event\)/
            );
            if (match) {
              id = match[1];
              nome = match[2];
            }
          }

          // Usa i dati dagli attributi data se disponibili
          if (dataId) id = dataId;
          if (dataNome) nome = dataNome;

          // Se non abbiamo ancora id/nome, prova a estrarli dal contenuto
          if (!id || !nome) {
            const lineNameElement = button.querySelector(".line-name");
            const lineNumberElement = button.querySelector(".line-number");
            if (lineNumberElement) {
              id = lineNumberElement.textContent.trim();
            }
            if (lineNameElement) {
              nome = "Linea " + id + " " + lineNameElement.textContent.trim();
            }
          }

          // Rimuovi l'onclick originale e sostituiscilo con un handler più robusto
          if (onclickAttr) {
            button.removeAttribute("onclick");
          }

          // Aggiungi un nuovo event listener che gestisce TUTTI i click
          button.addEventListener(
            "click",
            function (event) {
              // Previeni qualsiasi comportamento di default
              event.preventDefault();
              event.stopPropagation();

              // Crea un evento sintetico
              const syntheticEvent = {
                currentTarget: button,
                target: button,
                preventDefault: function () {},
                stopPropagation: function () {},
              };

              // Chiama la funzione selectLinea
              if (typeof selectLinea === "function" && id && nome) {
                selectLinea(id, nome, syntheticEvent);
              }
            },
            true
          ); // Capture phase per intercettare prima
        });
      });
    </script>
  </body>
</html>
